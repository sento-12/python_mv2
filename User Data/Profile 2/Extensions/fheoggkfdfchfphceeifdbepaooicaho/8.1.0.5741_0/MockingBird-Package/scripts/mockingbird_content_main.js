/*!
 * 
 *     MCAFEE RESTRICTED CONFIDENTIAL
 *     Copyright (c) 2024 McAfee, LLC
 *
 *     The source code contained or described herein and all documents related
 *     to the source code ("Material") are owned by McAfee or its
 *     suppliers or licensors. Title to the Material remains with McAfee
 *     or its suppliers and licensors. The Material contains trade
 *     secrets and proprietary and confidential information of McAfee or its
 *     suppliers and licensors. The Material is protected by worldwide copyright
 *     and trade secret laws and treaty provisions. No part of the Material may
 *     be used, copied, reproduced, modified, published, uploaded, posted,
 *     transmitted, distributed, or disclosed in any way without McAfee's prior
 *     express written permission.
 *
 *     No license under any patent, copyright, trade secret or other intellectual
 *     property right is granted to or conferred upon you by disclosure or
 *     delivery of the Materials, either expressly, by implication, inducement,
 *     estoppel or otherwise. Any license under such intellectual property rights
 *     must be expressed and approved by McAfee in writing.
 *
 */(()=>{"use strict";const e=0,t="PRINT_IN_BACKGROUND",o={NONE:0,INFO:1,ERROR:2,WARN:3,DEBUG:4,ALL_IN_BACKGROUND:99},i=1,s=2,n=3,r=4,a={BACKGROUND:"BACKGROUND",CONTENT:"CONTENT",TELEMETRY:"TELEMETRY"},d={DEFAULT:"color: #000000; font-weight: normal; font-style:normal; background: #FFFFFF;",BACKGROUND:"color: #8D0DBA; font-weight: bold; background: #FFFFFF;",CONTENT:"color: #F54A26; font-weight: bold; background: #FFFFFF;",TELEMETRY:"color: #147831; font-weight: bold; background: #FFFFFF;"};const c=new class{constructor(){this.storageChecked=!1,this.logLevel=null,this.queue=[];const t="MCLOGLEVEL";chrome?.storage?.local.get([t]).then((i=>{const s=Object.values(o).includes(i[t]);this.logLevel=s?i[t]:e,this.logLevel!==o.NONE&&this.queue.forEach((({callback:e,message:t,processType:o})=>{e(t,o)})),this.queue=[],this.storageChecked=!0}))}log(e,t=null){this.storageChecked?this.processLog(e,i,t,this.logLevel):this.queue.push({callback:this.log.bind(this),message:e,processType:t})}error(e,t=null){this.storageChecked?this.processLog(e,s,t,this.logLevel):this.queue.push({callback:this.error.bind(this),message:e,processType:t})}warn(e,t=null){this.storageChecked?this.processLog(e,n,t,this.logLevel):this.queue.push({callback:this.warn.bind(this),message:e,processType:t})}debug(e,t=null){this.storageChecked?this.processLog(e,r,t,this.logLevel):this.queue.push({callback:this.debug.bind(this),message:e,processType:t})}processLog(e,i,n,r){if(r===o.NONE)return;let d="chrome-extension:"===location.protocol?a.BACKGROUND:a.CONTENT;n&&a[n]&&(d=n);const c=new Date,u=i===s?e:`%c[${d} ${c.toLocaleString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!0})}]: %c${e}`;d===a.CONTENT&&this.logLevel===o.ALL_IN_BACKGROUND&&chrome.runtime.sendMessage({command:t,logMessage:u,processType:d,logType:i,logLevel:r}),this.printLog(u,d,i,r)}printLog(e,t,a,c){const u=d.DEFAULT,l=d[t]||u;if(c>=o.ERROR&&a===s&&console.error(e),c>=o.INFO&&a===i&&console.log(e,l,u),c>=o.WARN&&a===n){const t="color: #FFA500; font-family: sans-serif; font-weight: bolder; text-shadow: #000 1px 1px;";console.log(`%cWARN - ${e}`,t,l,u)}if(c>=o.DEBUG&&a===r){const t="color: #FF33D7; font-family: sans-serif; font-weight: bolder; text-shadow: #000 1px 1px;";console.log(`%cDEBUG - ${e}`,t,l,u)}}},u=(e,t=null,o)=>{"function"==typeof o?chrome.runtime.onMessage.addListener(((i,s,n)=>{if(s.id===chrome.runtime.id&&"object"==typeof i&&!Array.isArray(i)&&i?.ipcId===e)return o({promises:t,request:i,sender:s,sendResponse:n})})):c.error("Provided with invalid callback function")},l=e=>{"undefined"!=typeof document&&null!==document&&("complete"===document.readyState||"loading"!==document.readyState&&!document.documentElement.doScroll?e():document.addEventListener("DOMContentLoaded",e))},h=(e=document.body,t={},o={})=>{new MutationObserver((e=>{for(const o of e){"attributes"===o.type&&t.attributeChangedCb&&t.attributeChangedCb(o.target);for(const e of o.addedNodes)t.addedNodeCb&&t.addedNodeCb(e);for(const e of o.removedNodes)t.removedNodeCb&&t.removedNodeCb(e)}})).observe(e,{childList:!0,subtree:!0,...o})},m=(e,t,o={})=>{const{add:i=!1,remove:s=!1}=o;if(!Array.isArray(t))return!1;for(let o=0;o<t.length;o+=1){if(t[o].node.isSameNode(e))return s&&t.splice(o,1),!0}return i&&t.push({node:e,url:window.location.href}),!1},g=()=>{let e=null;const t=navigator.userAgent.toLowerCase(),o=/(edge)\/([\w.]+)/.exec(t)||/(edg)\/([\w.]+)/.exec(t)||/(opr)[/]([\w.]+)/.exec(t)||/(chrome)[ /]([\w.]+)/.exec(t)||/(iemobile)[/]([\w.]+)/.exec(t)||/(version)(applewebkit)[ /]([\w.]+).*(safari)[ /]([\w.]+)/.exec(t)||/(webkit)[ /]([\w.]+).*(version)[ /]([\w.]+).*(safari)[ /]([\w.]+)/.exec(t)||/(webkit)[ /]([\w.]+)/.exec(t)||/(opera)(?:.*version|)[ /]([\w.]+)/.exec(t)||/(msie) ([\w.]+)/.exec(t)||t.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(t)||t.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(t)||[],i=/(ipad)/.exec(t)||/(ipod)/.exec(t)||/(windows phone)/.exec(t)||/(iphone)/.exec(t)||/(kindle)/.exec(t)||/(silk)/.exec(t)||/(android)/.exec(t)||/(win)/.exec(t)||/(mac)/.exec(t)||/(linux)/.exec(t)||/(cros)/.exec(t)||/(playbook)/.exec(t)||/(bb)/.exec(t)||/(blackberry)/.exec(t)||[];return e={browser:o[5]||o[3]||o[1]||"",version:o[4]||o[2]||"0",platform:i[0]||""},"mozilla"===e.browser&&(e.browser="firefox"),"edg"===e.browser&&(e.browser="edge"),e||e},p=()=>{const e=new Uint8Array(24);crypto.getRandomValues(e);let t=Date.now().toString()+Math.random().toString().substring(2);for(let o=0;o<24;++o)t+=e[o].toString();let o="";for(let e=0;e<36;++e)if(8===e||13===e||18===e||23===e)o+="-";else{o+=t[Math.floor(Math.random()*t.length)]}return`{${o}}`};class f{constructor(e,t){this.pingCommand=e,this.ipcId=t,this.mainFunction="function"==typeof this.main?((e,t)=>{let o;return(...i)=>(e&&(o=e.apply(t||void 0,i),e=null,t=null),o)})(this.main,this):()=>{},this.basePingListener(),this.addIdentifier()}basePingListener(){u(this.ipcId,null,(({request:e,sendResponse:t})=>{const{command:o,...i}=e;if(o===this.pingCommand)return c.debug(`File Injection [pinged]: Received ${o} command`),t({content:!0}),"function"==typeof this.mainFunction&&this.mainFunction(i),"function"==typeof this.callback&&this.callback(),!0}))}addIdentifier(){l((()=>{const e=document.createElement("span");e.id=this.pingCommand,e.style.cssText="display:none",document.body.appendChild(e)}))}}const w=async(e,t,o,i)=>{try{chrome.tabs.sendMessage(i,{ipcId:e,command:t,...o},{},(()=>{chrome.runtime.lastError}))}catch(e){c.warn(`[broadcast] Unexpected error when calling command: "${t}", err: ${e.message}`)}},b=(e,t,o,i,s=null)=>{if(!chrome.tabs)throw new Error('"tabs" permission not set in manifest.');const n={};return"number"==typeof s&&(n.frameId=s),chrome.tabs.sendMessage(i,{ipcId:e,command:t,...o},n)},v="MC_SHADOW_ADDED",S="MC_SHADOW_PROCESSED",E="MC_CONTENT_SCRIPT_INITIALIZED",A="MB_PROCESS_SHADOW_BY_ID",y="MB",M=1,R=(e,t={},o)=>(async(e,t,o={},i={})=>{try{if(i?.tabId){const{tabId:s,frameId:n}=i;return await b(e,t,o,s,n)}if(i?.broadcast){const s=await chrome.tabs.query({}),{broadcastIgnoreId:n=[]}=i;return s.filter((({id:e})=>!n.includes(e))).forEach((({id:i})=>{w(e,t,o,i)})),!0}return await chrome.runtime.sendMessage({ipcId:e,command:t,...o})}catch(e){return c.warn(`Unexpected error when calling command: "${t}", err: ${e.message}`),null}})(y,e,t,o),k="NATIVE_STREAM",N="CAPTURE_WITH_PERMISSION",T="AUDIO_NODE_REMOVED",C="MB_SEND_VIDEO_ENDED_EVENT_TO_WA",I="GET_SOCKET_DETAILS",L="PROMPT_PERMISSION_AND_STREAM",P="MB_ENABLEMENT_STATE",O="STOP_STREAMING",D="GET_STREAMING_AUDIOS",F="PING_CONTENT_MB_MAIN";class _{constructor(){this.audioInfos=[]}add(e){const t={id:p(),element:e,recorder:null,websocket:null,listening:!1,capturing:!1,permissionRequired:!1,tabStream:null,canvas:null,src:null,workletNodePort:null,pageElement:!1,stopstreamTriggered:!1,streamId:0,totalSend:0};return this.audioInfos.push(t),t}get(e){for(const t of this.audioInfos)if(t.element.isSameNode(e))return t;return null}getById(e){for(const t of this.audioInfos)if(t.id===e)return t;return null}getAll(){return this.audioInfos}}class x{constructor(){window.audioMonitor=new _}init(e,t){this.featureEnabled=e,this.secret=t.secret,this.port=t.port,this.samplerate=t.settings.samplerate,this.chunksize=t.settings.chunksize,this.isOnAudioRecorder=t.settings.isOnAudioRecorder,this.uniqueMessageId=t.uniqueMessageId,this.windowid=t.windowid,this.tabid=t.tabid,this.frameid=t.frameid,this.workletUrl=t.workletUrl,this.socketUri=`ws://127.0.0.1:${this.port}/`,this.version=1}handleAudioFound(e,t){[...e,...t].forEach((e=>this.monitorElement(e)))}handleAudioRemoved(e,t){[...e,...t].forEach((e=>{const t=window?.audioMonitor.get(e)||null;if(t){const e={tabId:this.tabid,frameId:this.frameid,id:t.id};R(T,{payload:e})}}))}async monitorElement(e){let t=window.audioMonitor.get(e);if(t||(t=window.audioMonitor.add(e),t.listening=!1),!t.listening){this.addListeners(t);await this.waitforUpto(500,3,(()=>this.isPlaying(e)))&&(t.listener="monitorElement",this.startStream(t))}}addListeners(e){e.isListening=!0;const{element:t}=e;["play","playing"].forEach((o=>{t.addEventListener(o,(()=>{e.listener=o,this.startStream(e)}))})),["pause","stalled","ended","error","abort"].forEach((o=>{t.addEventListener(o,(()=>{e.listener=o,this.stopStream(e)}))})),t.addEventListener("ended",(e=>{R(C,{videoSrc:e.target.src})})),t.addEventListener("volumechange",(()=>{e.listener="volumechange",this.isPlaying(t)?this.startStream(e):this.stopStream(e)})),t.addEventListener("loadeddata",(async()=>{await this.waitforUpto(500,3,(()=>this.isPlaying(t)))&&(e.listener="loadeddata",this.startStream(e))}))}isPlaying(e){return!(e.paused||e.ended||!(e.readyState>2))}streamPlayingAudio(){window.audioMonitor.getAll().forEach((e=>this.monitorElement(e.element)))}waitforUpto(e,t,o){const i=(t,s)=>{o()?s(!0):(t||s(!1),setTimeout((()=>{i(t--,s)}),e))};return new Promise((e=>{i(t,e)}))}handShakeWebSocket(e){const{id:t,element:o}=e,i={version:this.version,topurl:document.location.href,secretcode:this.secret,frameid:this.frameid,tabid:this.tabid,windowid:this.windowid,defsamplerate:e.defaultSampleRate,defchannels:e.defaultChannels,id:t,srcurl:o.currentSrc||"",cachekey:this.getCacheKey(e)};c.log(`[MB:handShakeWebSocket] socket handshake request: ${JSON.stringify(i)}`),e.websocket.send(JSON.stringify(i))}downloadAudioRawData(e){c.log("[MB:downloadAudioRawData] start downloading raw audio data");const t=new Blob([e.buffer],{type:"audio/pcm"}),o=URL.createObjectURL(t),i=document.createElement("a");i.style.display="none",i.href=o,i.download=`${document.location.href}.pcm`,document.body.appendChild(i),i.click(),URL.revokeObjectURL(o),document.body.removeChild(i),c.log("[MB:downloadAudioRawData] finish downloading raw audio data")}async startStream(e){if(!this.featureEnabled)return c.log("[MB:startStream] feature not enabled"),!1;c.log("startStream called with monitoring object:"),c.log(JSON.stringify(e)),e.url=window.location.href;const t=e.element.src||e.element.currentSrc;e.src?e.src!==t&&this.stopStream(e):e.src=t;const{element:o,capturing:i,permissionRequired:s,tabStream:n,id:r}=e;if(i||s&&!n)return!0;let a=null;try{a=n||(o.captureStream?o.captureStream():o.mozCaptureStream()),e.capturing=!0,e.stopstreamTriggered=!1}catch(t){c.warn(`Failed to capture stream error: ${t.message}`);const{state:o}=await(navigator?.permissions?.query({name:"microphone"}))||{};if(!o)return c.warn('Failed to request permission due to unsupported api "navigator.permissions"'),!1;switch(o){case"granted":return this.promptPermissionAndStream(r),!0;case"prompt":return this.stopStream(e),this.captureStreamWithPermission(e),!0;case"denied":return c.warn("User has denied permission, unable to prompt and record audio."),!1;default:return c.warn(`navigator.permissions returned unsupported state, state='${o}'`),!1}}if(!a)return this.stopStream(e),!1;const d=await this.getAudioTracks(a);if(!d||d.length<=0)return this.stopStream(e),!1;const u={sampleRate:"firefox"!==g().browser?this.samplerate:void 0};if(!o.captureStream){const e=new AudioContext(u);e.createMediaStreamSource(a).connect(e.destination)}const l=new AudioContext(u);if(e.defaultSampleRate=l.sampleRate,e.defaultChannels=1,"running"!==l.state)return c.warn(`Audio context has ${l.state} state, stopping stream`),e.capturing=!1,!1;try{await l.audioWorklet.addModule(this.workletUrl);const t=l.createMediaStreamSource(a),o=new AudioWorkletNode(l,"pcm-processor");t.connect(o),e.workletNodePort=o.port,e.workletNodePort.onmessage=({data:t})=>{this.featureEnabled?this.isOnAudioRecorder?this.downloadAudioRawData(t):(e.capturing||t.isLast)&&t.buffer&&t.buffer.byteLength>0&&(e.stopstreamTriggered||(e.totalSend+=t.buffer.byteLength),e.streamId++,e.websocket&&e.websocket.readyState===M?this.streamWebSocket(e,t.buffer,t.isLast):this.streamNativeMessage(e,t.buffer,t.isLast)):this.stopStream(e)}}catch(t){return c.error(`Failed to initialize audioWorklet, err: ${t?.message}`),this.stopStream(e),!1}if(!e.defaultSampleRate||!e.defaultChannels)return this.stopStream(e),!1;if(!this.port)return e.workletNodePort.postMessage({state:"start",sampleRate:this.samplerate,chunksize:this.chunksize}),!0;try{await this.startWebSocket(e)}catch(t){c.error(`Failed to connect through websocket, defaulting to fallback messaging, err: ${t?.message}`),e.workletNodePort.postMessage({state:"start",sampleRate:this.samplerate,chunksize:this.chunksize})}return!0}stopStream(e){c.log("stopStream called with monitoring object:"),c.log(JSON.stringify(e)),e.permissionRequired||(e.workletNodePort&&(e.workletNodePort.postMessage({state:"stop"}),e.workletNodePort=null),e.websocket&&(e.websocket?.close(),e.websocket=null),e.capturing=!1,e.src=null,e.streamId=0,e.totalSend=0,"abort"===e.listener&&e.url!==window.location.href&&this.handleAudioRemoved([e.element],[]),"play"===e.listener&&e.src!==e.element.currentSrc&&this.handleAudioRemoved([e.element],[]))}getCacheKey(e){let t="";const o=document.location.href;try{t=new URL(o).hostname}catch(e){return c.error(`Failed to get cache key, err: ${e.message}`),o}let i=e.element.currentSrc||o;return(t.toLowerCase().includes("youtube.com")||i.startsWith("blob:"))&&(i=o),i}async getAudioTracks(e){const t=e=>{const t=e.getAudioTracks();return!t||t.length<=0?null:t};return new Promise((o=>{const i=t(e);i?o(i):setTimeout((()=>o(t(e))),500)}))}async startWebSocket(e){return new Promise(((t,o)=>{const i=new WebSocket(this.socketUri);i.onopen=()=>{e.websocket=i,this.handShakeWebSocket(e),e.workletNodePort&&e.workletNodePort.postMessage({state:"start",sampleRate:this.samplerate,chunksize:this.chunksize}),t()},i.onerror=t=>{c.error(`Websocket error: ${t.message}`),e.listener="onerror",e.websocket=null,o(t)},i.onclose=()=>{c.log("Websocket closed")}}))}streamWebSocket(e,t,o){const{element:i,id:s,defaultSampleRate:n,defaultChannels:r,streamId:a,stopstreamTriggered:d,websocket:u,totalSend:l}=e,h=i.currentTime??-1,m=i.duration??-1,g=i.muted??null,p=navigator.language,f=JSON.stringify({curtime:h,duration:m,muted:g,browserurllocale:p,type:i.getAttribute("type")}),w={id:s,islastchunk:o||!1,srcurl:i.currentSrc??"",curtime:h,muted:g,duration:m,browserurllocale:p,defsamplerate:n,defchannels:r,streamid:a,stopstreamtriggered:d,data:f};u.send(JSON.stringify(w)),d||u.send(t),c.log(`[streamWebSocket] buffered: ${u.bufferedAmount}, total: ${l}, streamid: ${a}, stopstreamtriggered: ${d}`)}streamNativeMessage(e,t,o){const{element:i,id:s,defaultSampleRate:n,defaultChannels:r,streamId:a,stopstreamTriggered:d,totalSend:u}=e,l=(t=null)=>{const l=i.currentTime??-1,h=i.duration??-1,m=i.muted??null,g=navigator.language,p=JSON.stringify({curtime:l,duration:h,muted:m,browserurllocale:g,type:i.getAttribute("type")}),f={id:s,version:this.version,islastchunk:o||!1,topurl:document.location.href,srcurl:i.currentSrc??"",curtime:l,duration:h,muted:m,tabid:this.tabid,frameid:this.frameId,windowid:this.windowid,data64:t,data:p,browserurllocale:g,defsamplerate:n,defchannels:r,streamid:a,cachekey:this.getCacheKey(e),stopstreamtriggered:d};R(k,{payload:f}),c.log(`[nativeStream] total: ${u}, streamid: ${a}, stopstreamtriggered: ${d}`)};if(d)l();else if(t){l((e=>{let t="";const o=new Uint8Array(e),i=o.byteLength;for(let e=0;e<i;e++)t+=String.fromCharCode(o[e]);return`data:audio/pcm;base64,${btoa(t)}`})(t))}}captureStreamWithPermission(e){if(navigator?.mediaDevice)return void c.warn("Unable to captureStreamWithPermission since navigator.mediaDevices is undefined");e.permissionRequired=!0;const{element:t,id:o}=e,i=t.currentTime??-1,s=t.duration??-1,n=t.muted??null,r=navigator.language,a=JSON.stringify({curtime:i,duration:s,muted:n,browserurllocale:r,type:t.getAttribute("type")}),d={id:o,topurl:document.location.href,frameurl:t.ownerDocument?.location?.href||"",srcurl:t.currentSrc??"",tabid:this.tabid,frameid:this.frameid,permissionRequired:!0,data:a};R(N,{payload:d})}async promptPermissionAndStream(e){try{const t=await(navigator?.mediaDevices?.getUserMedia({video:!1,audio:!0}));if(!t)return;const o=window.audioMonitor.getById(e);o.tabStream=t,o.permissionRequired=!1,this.isPlaying(o.element)&&this.startStream(o)}catch(e){c.warn(`promptPermissionAndStream err, ${e.message}`)}}handleCanvasFound(e){e.forEach((e=>this.attachCanvasListener(e)))}attachCanvasListener(e){let t=window.audioMonitor.get(e);t||(t=window.audioMonitor.add(e),t.listening=!1),t.listening||(e.addEventListener(this.uniqueMessageId,(({detail:e={}})=>{"MB_PROCESS_CANVAS"===e.command&&this.handleCanvasListener(e,t)})),t.listening=!0)}handleCanvasListener(e,t){const{event:o="",id:i,data:s}=e;"ATTACHED_ID"===o?(t.id=i,t.pageElement=!0):"CAPTURE_START"===o?t.capturing=!0:"CAPTURE_STOP"===o?t.capturing=!1:"NATIVE_STREAM"===o?R(k,{payload:s}):"VIDEO_REMOVED"===o&&this.handleAudioRemoved([t.element],[])}stopProcessingAudio(){this.featureEnabled=!1;(window.audioMonitor.audioInfos||[]).forEach((e=>{this.stopStream(e)}))}getStreamingAudios(e=null){const t=[],o=window?.audioMonitor?.audioInfos||[];if(!o.length)return c.error("[MB:getStreamingAudios] audioInfos is empty"),t;for(let i=0;i<o.length;i+=1){const s=o[i],n={topurl:document.location.href,frameid:this.frameid,tabid:this.tabid,windowid:this.windowid,id:s.id,srcurl:s.element.currentSrc||"",curtime:s.element.currentTime??-1,duration:s.element.duration??-1,cachekey:this.getCacheKey(s),pageElement:s.pageElement};if(e){if(s.id===e){t.push(n);break}}else s.capturing&&t.push(n)}return t}}class ${constructor(e={}){this.uniqueMessageId=null,this.type={video:"video",canvas:"canvas"},this.onAudioFound=null,this.onAudioRemoved=null,this.onCanvasFound=null;const{video:t=!0,canvas:o=!0}=e;this.supported=[],t&&this.supported.push(this.type.video),o&&this.supported.push(this.type.canvas),this.processedElements=[]}init(e){if(this.uniqueMessageId=e,"function"!=typeof this.onAudioFound||"function"!=typeof this.onAudioRemoved)return void c.error("Please provide a callback function (onAudioFound / onAudioRemoved)");this.processDom(document.body),this.initDocumentListener(),c.log(`[MB:AudioRetriever] requesting initial shadow for id: ${this.uniqueMessageId}`);const t=new CustomEvent(this.uniqueMessageId,{detail:{command:E}});document.dispatchEvent(t)}initDocumentListener(){document.addEventListener(`shadow_${this.uniqueMessageId}`,(e=>{const{command:t,id:o}=e.detail;if(t===A){const e=document.querySelector(`[sd-id='${o}']`);if(!e||e.getAttribute(S))return;e.setAttribute(S,"true");const t=this.getShadowRoot(e);t&&this.processDom(t)}}))}processDom(e){h(e,{addedNodeCb:this.handleAddedMutation.bind(this),removedNodeCb:this.handleRemovedMutation.bind(this)}),h(e,{attributeChangedCb:this.handleAttributeMutation.bind(this)},{attributeFilter:["src"]});const t=()=>{const t=this.findAudioElements(e);t.video.length>0||t.audio.length>0?(c.log(`[MB:processDom] Audio found when processing dom: video=${t.video.length}, audio=${t.audio.length}`),this.onAudioFound(t)):c.log("[MB:processDom] No audio found when processing dom."),t.canvas.length>0&&this.onCanvasFound(t.canvas)};t(),setTimeout((()=>{t()}),1e3)}findAudioElements(e){const t={video:[],audio:[],canvas:[]},o=e=>e instanceof HTMLMediaElement&&!m(e,this.processedElements,{add:!0})?(t.video.push(e),!0):e instanceof HTMLAudioElement&&!m(e,this.processedElements,{add:!0})?(t.audio.push(e),!0):e instanceof HTMLCanvasElement&&!m(e,this.processedElements,{add:!0})&&(t.canvas.push(e),!0);if(!o(e)&&e?.querySelectorAll){const t=this.supported.join(","),i=e?.querySelectorAll(t)||[];Array.from(i).forEach((e=>o(e)))}return t}handleAddedMutation(e){if(e?.id===v){const{parentNode:t}=e;if(e.remove(),!t||t.getAttribute(S))return;t.setAttribute(S,"true");const o=this.getShadowRoot(t);o&&this.processDom(o)}else{const t=this.findAudioElements(e);(t.video.length>0||t.audio.length>0)&&(c.log(`[MB:handleAddedMutation] Audio found from mutation observer: video=${t.video.length}, audio=${t.audio.length}`),this.onAudioFound&&this.onAudioFound(t)),t.canvas.length>0&&this.onCanvasFound&&this.onCanvasFound(t.canvas)}}handleRemovedMutation(e){const t={video:[],audio:[]};if(e instanceof HTMLMediaElement&&m(e,this.processedElements)){window.audioMonitor.get(e).capturing=!1,t.video.push(e)}if(e instanceof HTMLAudioElement&&m(e,this.processedElements)){window.audioMonitor.get(e).capturing=!1,t.audio.push(e)}(t.video.length>0||t.audio.length>0)&&this.onAudioRemoved&&this.onAudioRemoved(t)}handleAttributeMutation(e){if(e.getAttribute("src")&&0!==e.offsetWidth&&0!==e.offsetHeight||this.handleRemovedMutation(e),e instanceof HTMLMediaElement&&m(e,this.processedElements)&&0===e.buffered.length){const t=((e,t)=>{if(!Array.isArray(t))return"";for(let o=0;o<t.length;o+=1)if(t[o].node.isSameNode(e))return t[o].url;return""})(e,this.processedElements);t!==window.location.href&&this.handleRemovedMutation(e)}}getShadowRoot(e){try{return chrome.dom?.openOrClosedShadowRoot(e)||e?.openOrClosedShadowRoot||null}catch(e){return null}}}class U{constructor(){this.audioProcessor=null,this.audioRetriever=null,this.featureEnabled=!0,this.socketDetails=null}init(e){this.socketDetails=e,this.initListeners(),this.initAudioProcessorAndRetriever(e)}initAudioProcessorAndRetriever(e){this.socketDetails=e;let t=!1;this.audioProcessor?t=!0:this.audioProcessor=new x,this.audioRetriever||(this.audioRetriever=new $,this.audioRetriever.onAudioFound=({video:e,audio:t})=>this.audioProcessor.handleAudioFound(e,t),this.audioRetriever.onAudioRemoved=({video:e,audio:t})=>this.audioProcessor.handleAudioRemoved(e,t),this.audioRetriever.onCanvasFound=e=>this.audioProcessor.handleCanvasFound(e)),this.audioProcessor.init(this.featureEnabled,e),this.audioRetriever.init(e.uniqueMessageId),this.featureEnabled&&t&&this.audioProcessor.streamPlayingAudio()}initListeners(){u(y,null,(async({request:e,sendResponse:t})=>{const{command:o}=e;if(o===L)return this.audioProcessor.promptPermissionAndStream(e.elementId),t(!0),!0;if(o===P){this.featureEnabled=e.enabled;let o={};this.featureEnabled?(o=await R(I),this.initAudioProcessorAndRetriever(o)):(o={uniqueMessageId:this.socketDetails.uniqueMessageId},this.audioProcessor.stopProcessingAudio());const i=new CustomEvent(this.socketDetails.uniqueMessageId,{detail:{command:P,featureEnabled:this.featureEnabled,newSocketDetails:o}});return document?.dispatchEvent(i),t({content:!0}),!0}if(o===D){const o=this.audioProcessor.getStreamingAudios(e.id);if(o.find((e=>e.pageElement))){const e=`m${(Math.random()+1).toString(36).slice(2)}`;document?.addEventListener(e,(({detail:e})=>{e.streams&&e.streams.forEach((e=>{o.forEach((t=>{t.id===e.id&&(t.curtime=e.curtime)}))})),c.log(`[MB:ContentProcessor] GET_STREAMING_AUDIOS: sent canvas message - received: ${JSON.stringify(o)}`),t({streams:o})})),c.log("[MB:ContentProcessor] GET_STREAMING_AUDIOS: sent canvas message.");const i=new CustomEvent(this.socketDetails.uniqueMessageId,{detail:{command:D,callbackId:e}});document?.dispatchEvent(i)}else t({streams:o});return!0}if(o===O){c.log("[MB:ContentProcessor] STOP_STREAMING: command received.");const{videoId:o,srcUrl:i}=e,s=window.audioMonitor.getById(o);s?s?.element?.currentSrc===i?(c.log(`[MB:ContentProcessor] STOP_STREAMING: (${o}) calling stop stream on video id.`),s.stopstreamTriggered=!0):c.log(`[MB:ContentProcessor] STOP_STREAMING: (${o}) not tagged since currentSrc (${s?.element?.currentSrc}) is different than srcUrl(${i})`):c.log(`[MB:ContentProcessor] STOP_STREAMING: (${o}) monitoring item not found matching video id.`);const n=new CustomEvent(this.socketDetails.uniqueMessageId,{detail:{command:O,videoId:o,srcUrl:i}});return document?.dispatchEvent(n),t(!0),!0}}))}}(new class extends f{constructor(){super(F,y)}async start(){const e=await R(I);l((()=>{(new U).init(e)}))}}).start()})();
//# sourceMappingURL=../../sourceMap/chrome/MockingBird-Package/scripts/mockingbird_content_main.js.map