import{p as d,n as C,q as D,l as R,G as A,A as x,u as F,h as K,aI as ee,g as z,b as te,a as H,a5 as ie,ak as se,al as ae,aJ as q,L as re}from"./start-C5OgI2kj.js";import{c as ne}from"./index-Baxyqz_z.js";import{EmptyWindowGroupError as oe,WindowManagerToken as ce,ExecutionRealmProviderToken as de}from"./index-DunHPFp_.js";import{d as he}from"./defineFactory-DJYNRBNc-BjUmrCbc.js";import"./PluginModule-CRib3PLZ-rw_nkrD1.js";import"./PluginDependency-Boc6-pxl-tjuTwLTj.js";function B(t){return JSON.stringify(Object.fromEntries(Object.entries(t).sort((e,i)=>e[0].localeCompare(i[0]))))}var pe=Object.defineProperty,Q=t=>{throw TypeError(t)},le=(t,e,i)=>e in t?pe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,J=(t,e,i)=>le(t,typeof e!="symbol"?e+"":e,i),O=(t,e,i)=>e.has(t)||Q("Cannot "+i),s=(t,e,i)=>(O(t,e,"read from private field"),i?i.call(t):e.get(t)),m=(t,e,i)=>e.has(t)?Q("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),S=(t,e,i,r)=>(O(t,e,"write to private field"),e.set(t,i),i),ue=(t,e,i)=>(O(t,e,"access private method"),i),n,p,h,v,G,U;class fe{constructor(e,i){m(this,G),m(this,n,new AsyncDisposableStack),m(this,p),m(this,h),J(this,"id"),J(this,"hashKey"),m(this,v,!1),this.id=e.windowId,S(this,h,e.api),this.hashKey=B(e.injectedAs),S(this,p,i),s(this,n).defer(async()=>{s(this,v)||(await Promise.resolve(),await d(s(this,h).closeWindow(),C(D(r=>{s(this,v)||R.error("Failed to close window: "+s(this,v)+" "+this.id,r)}))))}),s(this,n).defer(async()=>s(this,p).close()),ue(this,G,U).call(this)}get group(){return s(this,p).group}createWindow(e){return s(this,n).disposed?A(new ReferenceError("Window is disposed")):s(this,h).createWindow(e)}replaceApp(e){return s(this,n).disposed?A(new ReferenceError("Window is disposed")):(s(this,p).markActive(),s(this,h).replaceApp(e,{transfer:[e.executionRealmData.port]}))}disposeApp(){return s(this,n).disposed?x():(s(this,p).markInactive(),s(this,h).disposeAppAndHide())}activatePlugin(e){return s(this,n).disposed?A(new ReferenceError("Window is disposed")):s(this,h).activatePlugin({plugin:e})}close(){return F(()=>s(this,n).disposeAsync())}[Symbol.asyncDispose](){return s(this,n).disposeAsync()}}n=new WeakMap;p=new WeakMap;h=new WeakMap;v=new WeakMap;G=new WeakSet;U=function(){if(s(this,n).disposed){S(this,v,!0);return}const t=new AbortController;d(ee(this.id,t.signal),K(()=>{R.warn("Window ".concat(this.id," is closed."),{delivery:!1}),S(this,v,!0),s(this,p).close()})),s(this,n).defer(()=>t.abort())};var we=Object.defineProperty,V=t=>{throw TypeError(t)},ve=(t,e,i)=>e in t?we(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,_e=(t,e,i)=>ve(t,e+"",i),T=(t,e,i)=>e.has(t)||V("Cannot "+i),a=(t,e,i)=>(T(t,e,"read from private field"),i?i.call(t):e.get(t)),_=(t,e,i)=>e.has(t)?V("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),We=(t,e,i,r)=>(T(t,e,"write to private field"),e.set(t,i),i),l=(t,e,i)=>(T(t,e,"access private method"),i),E,g,W,y,u,o,L,X,Y,N,P,I;class ge{constructor(e,i){_(this,o),_(this,E,new AsyncDisposableStack),_(this,g,R.createLogger("WindowGroup")),_e(this,"id"),_(this,W),_(this,y,new Set),_(this,u,new Map),this.id=e.groupId,We(this,W,i),l(this,o,N).call(this,e),a(this,E).defer(async()=>{a(this,W).removeWindowGroup(this.id),await d(z(d(a(this,o,L),te(r=>r.close()))),C(D(r=>a(this,g).error("Failure in WindowGroup dispose",r))))})}createWindow(e){return d(l(this,o,X).call(this,e.injectionOptions),H(i=>d(a(this,W).getExecutionRealmData(i.id),H(r=>i.replaceApp({...e,executionRealmData:r})),K(()=>{const r=new AsyncDisposableStack;return r.defer(async()=>{await d(i.disposeApp(),C(D(f=>a(this,g).error("Failure in dispose app",f))))}),{id:i.id,group:i.group,activatePlugin:f=>r.disposed?A(new ie("Window is closed")):i.activatePlugin(f),close:()=>F(()=>r.disposeAsync()),[Symbol.asyncDispose]:()=>r.disposeAsync()}}))))}close(){return x()}[Symbol.asyncDispose](){return a(this,E).disposeAsync()}}E=new WeakMap;g=new WeakMap;W=new WeakMap;y=new WeakMap;u=new WeakMap;o=new WeakSet;L=function(){return se(a(this,y),d(a(this,u).values(),ae(t=>t)))};X=function(t){var e;const i=B(t),r=q((e=a(this,u).get(i))!=null?e:[]);if(r)return a(this,g).verbose("Reusing existing window ".concat(r.id," for injection options ").concat(i,".")),x(r);const f=ne();return a(this,g).verbose("Creating new window ".concat(f," for injection options ").concat(i,".")),d(z([l(this,o,Y).call(this,f,t),a(this,W).waitForConnection(f)]),K(([ke,j])=>l(this,o,N).call(this,j)))};Y=function(t,e){const i=q(a(this,o,L));return i?i.createWindow({windowId:t,injectionOptions:e}):A(new oe(this))};N=function(t){const e=new fe(t,{group:this,markActive:()=>{l(this,o,I).call(this,e),a(this,y).add(e)},markInactive:()=>{a(this,y).delete(e),l(this,o,P).call(this,e)},close:()=>l(this,o,I).call(this,e)});return l(this,o,P).call(this,e),a(this,E).use(e),e};P=function(t){const e=a(this,u).get(t.hashKey);e?e.add(t):a(this,u).set(t.hashKey,new Set([t]))};I=function(t){a(this,y).delete(t);const e=a(this,u).get(t.hashKey);e&&(e.delete(t),e.size===0&&a(this,u).delete(t.hashKey))};var Z=t=>{throw TypeError(t)},b=(t,e,i)=>e.has(t)||Z("Cannot "+i),c=(t,e,i)=>(b(t,e,"read from private field"),i?i.call(t):e.get(t)),$=(t,e,i)=>e.has(t)?Z("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),ye=(t,e,i,r)=>(b(t,e,"write to private field"),e.set(t,i),i),w,k,M;class me{constructor(e){$(this,w,new Map),$(this,k,new Map),$(this,M),ye(this,M,e)}get windowGroups(){return Array.from(c(this,w).values())}getExecutionRealmData(e){return c(this,M).getExecutionRealmData(e)}connect(e){const i=c(this,k).get(e.windowId);i&&i.resolve(e),c(this,k).delete(e.windowId),c(this,w).has(e.groupId)||c(this,w).set(e.groupId,new ge(e,this))}waitForConnection(e){const i=Promise.withResolvers();return c(this,k).set(e,i),F(()=>i.promise)}getWindowGroup(e){var i;return(i=c(this,w).get(e))!=null?i:null}removeWindowGroup(e){c(this,w).delete(e)}}w=new WeakMap;k=new WeakMap;M=new WeakMap;const De=t=>t.getExecutionScopeDefinition("global").register({token:ce,useFactory:he(me,[de])},{lifetime:re.Singleton});export{De as activate};
//# sourceMappingURL=index-BqIYJRu8.js.map
