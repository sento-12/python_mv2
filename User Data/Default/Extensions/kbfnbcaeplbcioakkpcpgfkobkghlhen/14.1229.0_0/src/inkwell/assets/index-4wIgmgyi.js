import{aa as W,S as F,ab as R,k as A,o as P,A as g,B as M,I as N,p as m,v as G,z as $,t as p,K as h,ac as z,w as b,R as C,L,s as V,i as j,h as k,O as H,a as x}from"./index-DbtAbjfk.js";import{h as K,i as d,A as O,T as U,a as Z,b as q,d as J,e as Q,f as X}from"./TextDocumentEntities-Db6vxvBV.js";import{DocumentSessionManagerToken as Y,DocumentSessionToken as B,TextDocumentInfoToken as ee}from"./index-Cq7S5ha4.js";import{d as te}from"./distinctUntilChanged-xQxyKspb.js";import{D as ie}from"./Delta-D-dso3t3-B1UydhvC.js";import{s as I}from"./share-D5q_PZU1.js";import{m as ne}from"./merge-DlpWXwAR.js";import{t as re}from"./take-Dbhfwukx.js";import"./RemoteEntity-CN-1WB86-yD3y8ldD.js";import"./PluginModule-CRib3PLZ-ls39AzbW.js";import"./mergeAll-Ci-uq6t1.js";var ae=function(t){W(e,t);function e(i,r,a){i===void 0&&(i=1/0),r===void 0&&(r=1/0),a===void 0&&(a=R);var n=t.call(this)||this;return n._bufferSize=i,n._windowTime=r,n._timestampProvider=a,n._buffer=[],n._infiniteTimeWindow=!0,n._infiniteTimeWindow=r===1/0,n._bufferSize=Math.max(1,i),n._windowTime=Math.max(1,r),n}return e.prototype.next=function(i){var r=this,a=r.isStopped,n=r._buffer,u=r._infiniteTimeWindow,f=r._timestampProvider,c=r._windowTime;a||(n.push(i),!u&&n.push(f.now()+c)),this._trimBuffer(),t.prototype.next.call(this,i)},e.prototype._subscribe=function(i){this._throwIfClosed(),this._trimBuffer();for(var r=this._innerSubscribe(i),a=this,n=a._infiniteTimeWindow,u=a._buffer,f=u.slice(),c=0;c<f.length&&!i.closed;c+=n?1:2)i.next(f[c]);return this._checkFinalizedStatuses(i),r},e.prototype._trimBuffer=function(){var i=this,r=i._bufferSize,a=i._timestampProvider,n=i._buffer,u=i._infiniteTimeWindow,f=(u?1:2)*r;if(r<1/0&&f<n.length&&n.splice(0,n.length-f),!u){for(var c=a.now(),s=0,o=1;o<n.length&&n[o]<=c;o+=2)s=o;s&&n.splice(0,s+1)}},e}(F);function se(t,e,i,r,a){return function(n,u){var f=i,c=e,s=0;n.subscribe(A(u,function(o){var _=s++;c=f?t(c,o,_):(f=!0,o),u.next(c)},a))}}function oe(t,e){return P(se(t,e,arguments.length>=2,!0))}function v(t,e,i){var r,a,n,u,f=!1;return t&&typeof t=="object"?(r=t.bufferSize,u=r===void 0?1/0:r,a=t.windowTime,e=a===void 0?1/0:a,n=t.refCount,f=n===void 0?!1:n,i=t.scheduler):u=t!=null?t:1/0,I({connector:function(){return new ae(u,e,i)},resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:f})}function ue(t){return g(function(e,i){return t<=i})}var fe=Object.defineProperty,E=t=>{throw TypeError(t)},ce=(t,e,i)=>e in t?fe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,me=(t,e,i)=>ce(t,e+"",i),le=(t,e,i)=>e.has(t)||E("Cannot "+i),S=(t,e,i)=>(le(t,e,"read from private field"),i?i.call(t):e.get(t)),D=(t,e,i)=>e.has(t)?E("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),T,w;class y{constructor(){D(this,T,new DisposableStack),D(this,w,new M(null)),me(this,"activeDocumentId",N(S(this,w)))}setActiveDocumentIdSource(e){S(this,T).use(m($(e),te(),G(S(this,w))))}[Symbol.dispose](){S(this,T).dispose()}}T=new WeakMap;w=new WeakMap;var pe=Object.defineProperty,he=(t,e,i)=>e in t?pe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,l=(t,e,i)=>he(t,typeof e!="symbol"?e+"":e,i);class de{constructor({documentId:e,hasFocus:i,lastFocusAt:r,geometry:a,textChange:n,geometryWillChange:u,selection:f}){l(this,"id"),l(this,"hasFocus"),l(this,"lastFocusAt"),l(this,"geometryWillChange"),l(this,"geometry"),l(this,"textChange"),l(this,"text"),l(this,"selection"),this.id=e,this.hasFocus=m(h(i),v({bufferSize:1,refCount:!0}),p),this.lastFocusAt=m(h(r),v({bufferSize:1,refCount:!0}),p),this.geometryWillChange=m(h(u),I(),p),this.geometry=m(h(a),v({bufferSize:1,refCount:!0}),p),this.selection=m(h(f),v({bufferSize:1,refCount:!0}),p);const c=m(h(n),b(s=>({revision:s.revision,change:new ie(s.change)})),oe((s,{change:o,revision:_})=>s?{revision:_,change:o,content:s.content.compose(o)}:{revision:_,change:o,content:o},null),g(z),v({bufferSize:1,refCount:!0}));this.text=m(c,b(({revision:s,content:o})=>({revision:s,content:o})),p),this.textChange=m(ne(m(c,re(1),b(({revision:s,content:o})=>({revision:s,change:o}))),m(c,ue(1),b(({revision:s,change:o})=>({revision:s,change:o})))),p)}}const Ie=t=>{const e=t.getExecutionScopeDefinition("document-group");return C.all([ve(t),e.register({token:y,useClass:y},{lifetime:L.Singleton}),e.register({token:Y,useToken:y}),V(e.onStart(i=>m(k([H(i.resolve(y)),K(i.realm,O,null)]),j(([r,a])=>r.setActiveDocumentIdSource(a)))))])};function ve(t){return t.registerExecutionScopeReviver("document-session",(e,i,{documentId:r})=>m(k([d(e.realm,U),d(e.realm,Z),d(e.realm,q),d(e.realm,J),d(e.realm,Q),d(e.realm,X)]),x(async([a,n,u,f,c,s])=>C.all([e.register({token:B,useValue:{documentId:r,startedAt:performance.now()}}),e.register({token:ee,useValue:new de({documentId:r,hasFocus:a,lastFocusAt:n,geometry:u,textChange:f,selection:c,geometryWillChange:s})})])),x(a=>(e.use(a),e.start()))))}export{Ie as activate};
//# sourceMappingURL=index-4wIgmgyi.js.map
