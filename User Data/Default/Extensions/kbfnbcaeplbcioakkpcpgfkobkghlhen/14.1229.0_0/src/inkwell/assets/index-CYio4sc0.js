import{l as Pe,p as u,r as q,ac as ri,y as ai,t as ce,b as H,v as Ue,a7 as j,k as li,n as Y,q as A,g as me,h as Ce,ad as ci,U as _e,ae as di,af as ui,d as hi,a3 as pi,C as $e,S as gi,e as fi,R as Ee,s as Q,E as Me,D as Re,a as Ne,i as Oe,A as mi,m as le,L as X,c as vi,w as yi}from"./start-C5OgI2kj.js";import{g as ki}from"./getDecorationStrategy-CCd6cq6g.js";import{c as Ge}from"./PixelFns-BIHP7Exp-Cxsb96Xk.js";import{a as ve,t as wi}from"./subscribable-Cqm5UN_u-CZjzLfrM.js";import{t as _i}from"./subscribableState-Y8YW7N9Z-BMiZmink.js";import{t as bi}from"./timeoutWith-B7tsbJ8--xQN35Om5.js";import{f as Di,T as Si}from"./TextRangeUpdateSemantics-D8MqPOrG-Bdcz8ucb.js";import{s as Ii}from"./startWith-CARy4SXH.js";import{c as Ci}from"./TextRevisionFns-DGbJAFcL-DX1ABpMm.js";import{t as Ei}from"./PointFns-Cqc_hcsO-DfLreJud.js";import{t as Ti}from"./RectFns-ndpeBtT0-CdOd3O5S.js";import{c as Ai}from"./concat-jxnVidBz.js";import{d as Fi}from"./defer-D8jHAjAi.js";import{t as zi}from"./tap-BER5xIXx.js";import{o as Bi}from"./of-BeKGPQlf.js";import{E as Wi}from"./mergeAll-jza3F776.js";import{TextDecorationControllerToken as Le}from"./index-CncmaxA9.js";import{d as ue}from"./defineFactory-DJYNRBNc-BjUmrCbc.js";import"./timer-CgPfXOBl.js";import"./async-CpPJMEP8.js";import"./AsyncScheduler-DuJTneVg.js";import"./PluginModule-CRib3PLZ-rw_nkrD1.js";const Te="#2551DA",Ae="#FFBF47",Fe="#16AC9A",he="#016A5E",pe="#707070",ze="#5E47E5",Be="#EB0A00",We="#027D7D";function Ve(e){var i,t,n,s,r,c,a;return e.hidden&&((i=e.extra_properties)==null?void 0:i.free_premium)==="uphook"?"premiumUphook":e.group==="WritingExpert"?"writingExpert":((t=e.cardLayout)==null?void 0:t.outcome)==="Correctness"?"correctness":((n=e.cardLayout)==null?void 0:n.outcome)==="Tone"?"delivery":((s=e.cardLayout)==null?void 0:s.outcome)==="Clarity"?"clarity":((r=e.cardLayout)==null?void 0:r.outcome)==="Engagement"?"engagement":((c=e.cardLayout)==null?void 0:c.outcome)==="Originality"?"originality":((a=e.cardLayout)==null?void 0:a.outcome)==="Knowledge Hub"?"knowledgeHub":null}const I=Ge(2),C="outside",E=.15,xi={premiumUphook:{underline:{color:Ae,style:"solid",thickness:I,align:C},emphasizedBackground:{color:l(Ae,E)}},writingExpert:{underline:{color:he,style:"ellipsis",thickness:I,align:C},emphasizedBackground:{color:l(pe,E)}},correctness:{underline:{color:Be,style:"solid",thickness:I,align:C},emphasizedBackground:{color:l(Be,E)}},delivery:{underline:{color:ze,style:"solid",thickness:I,align:C},emphasizedBackground:{color:l(ze,E)}},clarity:{underline:{color:Te,style:"solid",thickness:I,align:C},emphasizedBackground:{color:l(Te,E)}},engagement:{underline:{color:he,style:"solid",thickness:I,align:C},emphasizedBackground:{color:l(he,E)}},originality:{underline:{color:We,style:"solid",thickness:I,align:C},emphasizedBackground:{color:l(We,E)}},knowledgeHub:{background:{color:l(Fe,.3)},emphasizedBackground:{color:l(Fe,.5)}},other:{underline:{color:pe,style:"solid",thickness:I,align:C},emphasizedBackground:{color:l(pe,E)}}},d={Red30:"#F27388",Red50:"#EA1537",Blue30:"#79A8F2",Blue50:"#4A6EE0",Green30:"#87E8D1",Green40:"#41D9B5",Green50:"#15C39A",Purple30:"#BD79ED",Purple50:"#8F4CBF",Yellow30:"#FFC940",Yellow50:"#FFA600",Neutral40:"#9FA6BF",Neutral50:"#6D758D",Cyan30:"#75E1EB",Cyan60:"#09A4B2"},p=Ge(3),g="outside",T=.2,B=.8,Pi={premiumUphook:{underline:{color:l(d.Yellow30,B),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Yellow50,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Yellow30,T)}},writingExpert:{underline:{color:d.Green50,style:"ellipsis",thickness:p,align:g},emphasizedUnderline:{color:d.Green50,style:"ellipsis",thickness:p,align:g},emphasizedBackground:{color:l(d.Neutral50,T)}},correctness:{underline:{color:l(d.Red30,B),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Red50,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Red30,T)}},delivery:{underline:{color:l(d.Purple30,B),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Purple50,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Purple30,T)}},clarity:{underline:{color:l(d.Blue30,B),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Blue50,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Blue30,T)}},engagement:{underline:{color:l(d.Green30,B),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Green50,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Green30,T)}},originality:{underline:{color:l(d.Cyan30,B),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Cyan60,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Cyan30,T)}},knowledgeHub:{background:{color:l(d.Green40,.3)},emphasizedBackground:{color:l(d.Green40,.5)}},other:{underline:{color:l(d.Neutral40,B),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Neutral50,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Neutral40,T)}}};function Ui(e){var i;return xi[(i=Ve(e))!=null?i:"other"]}function $i(e){var i;return Pi[(i=Ve(e))!=null?i:"other"]}function l(e,i){return e.length===7?e+Math.round(i*255).toString(16).padStart(2,"0"):e}var Mi=Object.defineProperty,He=e=>{throw TypeError(e)},Ri=(e,i,t)=>i in e?Mi(e,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[i]=t,Ye=(e,i,t)=>Ri(e,i+"",t),be=(e,i,t)=>i.has(e)||He("Cannot "+t),o=(e,i,t)=>(be(e,i,"read from private field"),t?t.call(e):i.get(e)),m=(e,i,t)=>i.has(e)?He("Cannot add the same private member more than once"):i instanceof WeakSet?i.add(e):i.set(e,t),v=(e,i,t,n)=>(be(e,i,"write to private field"),i.set(e,t),t),_=(e,i,t)=>(be(e,i,"access private method"),t),k,b,w,O,F,U,$,S,x,M,G,K,L,P,y,Ke,Je,ye,Qe,Xe,Ze,qe,je,ee;class ie{constructor(i,t,n,s,r){m(this,y),m(this,k),m(this,b,new AsyncDisposableStack),m(this,w),m(this,O),m(this,F),m(this,U,new Set),m(this,$),m(this,S,null),m(this,x,null),m(this,M),m(this,G),m(this,K,new Set),m(this,L,new Set),m(this,P,null),v(this,k,Pe.createLogger("CAPITextDecorationManager",n.id)),v(this,O,i),v(this,w,t),v(this,G,s),v(this,F,n),v(this,$,r.client==="windows"||r.client==="preview-windows"?"windows":"regular")}init(){o(this,b).use(u(ve(o(this,O).onChange),u(Di(o(this,O).getAll()),i=>i?Ii({upserted:i}):ri),q(i=>_(this,y,Je).call(this,i)))),_(this,y,Ze).call(this),o(this,b).use(u(_i(o(this,G).status),ai(i=>i.kind==="connected"&&i.isNewSession),q(()=>o(this,K).clear()))),o(this,b).use(o(this,w).visibleOnscreenDecorations.subscribe(i=>{i.forEach(t=>_(this,y,Ke).call(this,t.metadata.capiAlertId)),o(this,k).verbose("Visible onscreen decorations",{documentID:o(this,F).id,visibleOnscreen:u(i,H(t=>t.id),ce)})}))}addVisibilitySource(i){const t=new Set,n=u(ve(i),Ue(Ni(t)),q(s=>{o(this,k).verbose("Update visibility",{documentID:o(this,F).id,changes:s});const{toShow:r,toHide:c,toEmphasize:a}=Oi(s);c.forEach(h=>t.delete(h)),r.forEach(h=>t.add(h)),a.forEach(h=>t.add(h)),_(this,y,ye).call(this,{toHide:c,toShow:r,toEmphasize:a})}));return o(this,b).use(n),j(()=>{_(this,y,ye).call(this,{toHide:t,toShow:new Set,toEmphasize:new Set}),li(n)})}onTextDecorationInteraction(i,t){const n={observer:i,predicate:t};return o(this,L).add(n),j(()=>o(this,L).delete(n))}onUnhandledTextDecorationInteraction(i){return o(this,P)&&o(this,k).warn("Overwriting unhandledInteractionObserver"),v(this,P,i),j(()=>v(this,P,null))}async[Symbol.asyncDispose](){await o(this,b).disposeAsync()}}k=new WeakMap;b=new WeakMap;w=new WeakMap;O=new WeakMap;F=new WeakMap;U=new WeakMap;$=new WeakMap;S=new WeakMap;x=new WeakMap;M=new WeakMap;G=new WeakMap;K=new WeakMap;L=new WeakMap;P=new WeakMap;y=new WeakSet;Ke=function(e){o(this,K).has(e)||(o(this,K).add(e),u(o(this,G).send({action:"feedback",type:"RENDERED",subtype:"inline",alertId:e}),Y(A(i=>o(this,k).error("Failed to send RENDERED feedback for alert ".concat(e),i)))))};Je=function(e){var i,t;const n=(i=e.removed)!=null?i:[],s=(t=e.upserted)!=null?t:[];me([u(o(this,w).delete(n.map(r=>V(r))),Ce(A(()=>{n.length>0&&o(this,k).verbose("Removed decorations for alerts",{documentID:o(this,F).id,decorationIds:n.map(r=>V(r)),alertIds:n.map(r=>r.id)})})),Y(A(r=>o(this,k).error("Failed to remove decoration on suggestion removal",new Li(r,n.map(c=>c.id)))))),u(me(s.map(r=>_(this,y,Qe).call(this,r))),Ce(A(()=>{s.length>0&&o(this,k).verbose("Upserted decorations for alerts",{documentID:o(this,F).id,decorationIds:s.map(r=>V(r)),alertIds:s.map(r=>r.id)})})),Y(A(r=>o(this,k).error("Failed to upsert decoration on suggestion upsert",new Gi(r,s.map(c=>c.id))))))])};ye=async function({toHide:e,toShow:i,toEmphasize:t}){var n,s;const r=[];r.push(o(this,w).setVisibility(e,!1)),r.push(o(this,w).setVisibility(i,!0)),e.forEach(a=>o(this,U).delete(a)),i.forEach(a=>o(this,U).add(a)),t.forEach(a=>o(this,U).add(a));const c=u(t,ci(1),ce).at(0);if(c){if(c===((n=o(this,S))==null?void 0:n.decorationId))return;r.push(o(this,w).focus(c,o(this,M)))}else((s=o(this,S))==null?void 0:s.decorationId)!==void 0&&i.has(o(this,S).decorationId)&&r.push(o(this,w).focus(null));await bi(u(me(r),Y(A(a=>o(this,k).error("Unexpected error when applying visibility changes",a)))),{timeoutMs:5e3,defaultValue:void 0,onTimeout:()=>o(this,k).warn("Timeout out when applying visibility changes")})};Qe=function(e){var i;const t=V(e),n=((i=o(this,S))==null?void 0:i.decorationId)===t;return o(this,w).upsert({id:t,revision:Ci(e.alert.rev),segments:ei(e.alert,_(this,y,Xe).call(this,e.alert),n,e.alert.transformJson),visibility:n?"focused":o(this,U).has(t)?"visible":"hidden",metadata:{capiAlertId:e.alert.id,suggestionId:e.id}})};Xe=function(e){if(o(this,$)==="windows")return $i(e);if(o(this,$)==="regular")return Ui(e);throw new _e(o(this,$))};Ze=function(){o(this,b).use(o(this,w).onPointerHoverChange.subscribe(({pointerEnter:e,pointerLeave:i})=>{if(i&&o(this,x)===i.decoration.id&&(e==null?void 0:e.decoration.id)!==o(this,x)&&(v(this,x,null),v(this,M,void 0),_(this,y,ee).call(this,i)),e){if(o(this,x)===e.decoration.id)return;v(this,x,e.decoration.id),v(this,M,e.segment.id),_(this,y,ee).call(this,e)}})),o(this,b).use(o(this,w).onPointerClick.subscribe(e=>{v(this,M,e.segment.id),_(this,y,ee).call(this,e)})),o(this,b).use(o(this,w).onFocusChange.subscribe(({decoration:e,segment:i,focused:t})=>{var n;t?(v(this,S,{decorationId:e.id,segmentId:i==null?void 0:i.id}),_(this,y,qe).call(this,e,i)):(((n=o(this,S))==null?void 0:n.decorationId)===e.id&&v(this,S,null),_(this,y,je).call(this,e))}))};qe=function(e,i){e.segments.forEach(t=>t.patch(De({segmentMeta:t.metadata,segmentFocused:t.id===(i==null?void 0:i.id),decorationFocused:!0})))};je=function(e){e.segments.forEach(i=>i.patch(De({segmentMeta:i.metadata,segmentFocused:!1,decorationFocused:!1})))};ee=function({kind:e,rect:i,decorationRects:t,position:n,decoration:s,viewportOffset:r,windowOffset:c}){if(e==="pointerUp"||e==="pointerDown")return;o(this,k).verbose("Sending pointer event",{kind:e,decoration:s.id,documentID:o(this,F).id});const a={kind:e,decorationId:s.id,suggestionId:s.metadata.suggestionId,position:n,rect:i,decorationRects:t,windowOffset:c,viewportOffset:r};let h=!1;u(o(this,L),hi(({predicate:f})=>f(a)),H(A(()=>h=!0)),H(({observer:f})=>f(a)),ui(!h&&o(this,P)?[o(this,P).call(this,a)]:[]),di)};function De({segmentMeta:e,segmentFocused:i,decorationFocused:t}){var n,s,r,c,a,h;return t?{interactive:!0,background:(!e.hasEnclosing||e.kind==="enclosing")&&(s=(n=e.style.emphasizedBackground)!=null?n:e.style.background)!=null?s:null,underline:e.isSuperAlert&&!i?null:e.kind!=="enclosing"&&(c=(r=e.style.emphasizedUnderline)!=null?r:e.style.underline)!=null?c:null}:{interactive:e.kind!=="enclosing",background:(a=e.style.background)!=null?a:null,underline:e.kind==="enclosing"?null:(h=e.style.underline)!=null?h:null}}function Ni(e){return i=>{const t=n=>n.kind==="decoration"?n.decorationId:V({id:n.suggestionId});if(i.partial)return i.changes.map(n=>({decorationId:t(n.id),visibility:n.visibility}));{const n=new Set(i.changes.flatMap(r=>r.visibility==="hidden"?[]:[t(r.id)])),s=u(e.difference(n),H(r=>({decorationId:r,visibility:"hidden"})),ce);return i.changes.map(r=>({decorationId:t(r.id),visibility:r.visibility})).concat(s)}}}function Oi(e){const i=new Set,t=new Set,n=new Set;for(const s of e)if(s.visibility==="hidden")t.add(s.decorationId);else if(s.visibility==="visible")i.add(s.decorationId);else if(s.visibility==="emphasized")i.add(s.decorationId),n.add(s.decorationId);else throw new _e(s.visibility);return{toShow:i,toHide:t,toEmphasize:n}}function V(e){return String(e.id)}function ei(e,i,t,n,s){return n?n.highlights.map(({type:r,s:c,e:a},h,f)=>{var z,J;const R={kind:r==="enclosing"?"enclosing":"main",hasEnclosing:f.some(si=>si.type==="enclosing"),isSuperAlert:s===!0,style:i},{interactive:de,underline:Se,background:Ie}=De({segmentFocused:!1,decorationFocused:t,segmentMeta:R});return{range:{start:c+((z=n==null?void 0:n.context.s)!=null?z:0),end:a+((J=n==null?void 0:n.context.s)!=null?J:0)},updateSemantics:Si.Resize,metadata:R,interactive:de,underline:Se!=null?Se:void 0,background:Ie!=null?Ie:void 0}}):e.subalerts?e.subalerts.flatMap(r=>ei(e,i,t,r.transformJson,!0)).filter(pi):[]}class Gi extends $e{constructor(i,t){super("Failed to upsert decoration",i),Ye(this,"suggestions"),this.suggestions=Array.from(t)}toJSON(){return{...super.toJSON(),suggestions:this.suggestions}}}class Li extends $e{constructor(i,t){super("Failed to remove decoration",i),Ye(this,"suggestions"),this.suggestions=Array.from(t)}toJSON(){return{...super.toJSON(),suggestions:this.suggestions}}}var Vi=Object.defineProperty,ii=e=>{throw TypeError(e)},Hi=(e,i,t)=>i in e?Vi(e,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[i]=t,Yi=(e,i,t)=>Hi(e,i+"",t),ti=(e,i,t)=>i.has(e)||ii("Cannot "+t),N=(e,i,t)=>(ti(e,i,"read from private field"),t?t.call(e):i.get(e)),Z=(e,i,t)=>i.has(e)?ii("Cannot add the same private member more than once"):i instanceof WeakSet?i.add(e):i.set(e,t),ge=(e,i,t,n)=>(ti(e,i,"write to private field"),i.set(e,t),t),te,ne,oe,se;class ke{constructor(i,t,n){Z(this,te),Z(this,ne),Z(this,oe),Z(this,se,Pe.createLogger("ConnectorTextDecorationInteractionObserver")),Yi(this,"onTextDecorationInteraction",({kind:s,suggestionId:r,position:c,rect:a,decorationRects:h,viewportOffset:f})=>{if(r===void 0)return;const z=N(this,ne).getById(r);if(!z)return N(this,se).error("Failed to find suggestion by id");const J=Ei(f),R=Ti(f);u(N(this,oe).notifyTextDecorationInteraction({documentID:N(this,te).id,interactionType:s,alertId:String(z.alert.id),position:J(c),rect:R(a),decorationRects:h.map(R)}),Y(A(de=>N(this,se).error("Failed to send notifyTextDecorationInteraction",de))))}),ge(this,te,i),ge(this,ne,t),ge(this,oe,n)}}te=new WeakMap;ne=new WeakMap;oe=new WeakMap;se=new WeakMap;var Ki=Object.defineProperty,ni=e=>{throw TypeError(e)},Ji=(e,i,t)=>i in e?Ki(e,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[i]=t,Qi=(e,i,t)=>Ji(e,i+"",t),Xi=(e,i,t)=>i.has(e)||ni("Cannot "+t),D=(e,i,t)=>(Xi(e,i,"read from private field"),i.get(e)),fe=(e,i,t)=>i.has(e)?ni("Cannot add the same private member more than once"):i instanceof WeakSet?i.add(e):i.set(e,t),re,W,ae;class we{constructor(i,t){fe(this,re,new DisposableStack),fe(this,W,new Map),fe(this,ae,new gi),Qi(this,"visibilityChanges",wi(Ai(Fi(()=>D(this,W).size>0?Bi({partial:!1,changes:u(D(this,W).entries(),H(([n,s])=>({id:{kind:"suggestion",suggestionId:n},visibility:s})),ce)}):Wi),D(this,ae)))),D(this,re).use(u(ve(t.getTextDecorationVisibilityChangeRequests(i.id)),Ue(n=>({partial:n.partial,changes:n.changes.map(s=>({id:{kind:"suggestion",suggestionId:s.alertId},visibility:s.visibility}))})),zi(n=>{n.partial||D(this,W).clear(),n.changes.forEach(s=>{s.visibility==="hidden"?D(this,W).delete(s.id.suggestionId):D(this,W).set(s.id.suggestionId,s.visibility)})}),q(D(this,ae))))}[Symbol.dispose](){D(this,re).dispose()}}re=new WeakMap;W=new WeakMap;ae=new WeakMap;const xe=vi(Symbol("CAPITextDecorationStore")),St=e=>u(Oe([Q(e.getExecutionScopeDefinition("document-group")),Q(e.getExecutionScopeDefinition("document-session")),e.getPlugin("document-group"),e.getPlugin("document-session"),e.getPlugin("capi-suggestion"),e.getPlugin("text-decoration"),e.getPlugin("connector"),e.getPlugin("capi")]),fi(([i,t,n,s,r,c,a,h])=>Ee.all([...it(t,c,r,s,a,h),Q(t.onStart(async f=>Ee.all([ji(f),et(f)]))),Q(i.onStart(f=>u(f.resolve(Me),Re,Ne(z=>Zi(ki(z.client),f.observeExecutionScope("document-session"),n,f)))))])));function Zi(e,i,t,n){switch(e){case"showActiveDocumentOnly":return oi(t,n);case"showAllDocuments":return qi(i,t);default:throw new _e(e)}}function oi(e,i){return u(i.resolve(e.provides.WindowFactory),Re,Ne(t=>t.createWindow({fitContent:!1,clickThroughTransparent:!0,injectionOptions:{kind:"popup"},scopes:["document-session"],plugins:["inline-decorations"]})))}function qi(e,i){const t=new AsyncDisposableStack;return t.use(e.onStart(n=>oi(i,n))),mi(t)}function ji(e){return u(e.resolve(ie),le(i=>i.init()),le(()=>j(yi)))}function et(e){return u(Oe([e.resolve(we),e.resolve(ke),e.resolve(Le)]),le(([i,t,n])=>{const s=new DisposableStack;return s.use(n.addVisibilitySource(i.visibilityChanges)),s.use(n.onUnhandledTextDecorationInteraction(t.onTextDecorationInteraction)),s}))}function it(e,i,t,n,s,r){return[e.register({token:Le,useToken:ie}),e.register({token:xe,useFactory:c=>u(c.resolve(i.provides.TextDecorationStoreManager),le(a=>a.createStore("capi")))},{lifetime:X.Singleton}),e.register({token:ie,useFactory:ue(ie,[t.provides.CAPISuggestionCollection,xe,n.provides.TextDocument,r.provides.CAPIConnection,Me])},{lifetime:X.Singleton}),e.register({token:we,useFactory:ue(we,[n.provides.TextDocument,s.provides.ConnectorTextDecoration])},{lifetime:X.Singleton}),e.register({token:ke,useFactory:ue(ke,[n.provides.TextDocument,t.provides.CAPISuggestionCollection,s.provides.ConnectorTextDecoration])},{lifetime:X.Singleton})]}export{St as activate};
//# sourceMappingURL=index-CYio4sc0.js.map
