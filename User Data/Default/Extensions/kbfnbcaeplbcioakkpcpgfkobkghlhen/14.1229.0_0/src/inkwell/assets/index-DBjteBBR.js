import{v as A,a6 as E,X as Y,p as m,y,a3 as N,S as P,I as $,a7 as O,_ as z,l as Z,Q as q,L,s as H}from"./start-C5OgI2kj.js";import{t as D,a as tt}from"./subscribable-Cqm5UN_u-CZjzLfrM.js";import{s as et}from"./share-CI8gbLLI.js";import{r as Q,t as ot}from"./tap-BER5xIXx.js";import{t as W}from"./take-CcUs0Iqw.js";import{o as X}from"./of-BeKGPQlf.js";import{a as it}from"./async-CpPJMEP8.js";import{t as nt}from"./timer-CgPfXOBl.js";import{s as rt}from"./startWith-CARy4SXH.js";import{t as st}from"./PointFns-Cqc_hcsO-DfLreJud.js";import{InlineCardWindowToken as G,InlineCardControllerToken as at}from"./index-R4GM1KPr.js";import{d as ct}from"./defineFactory-DJYNRBNc-BjUmrCbc.js";import"./mergeAll-jza3F776.js";import"./AsyncScheduler-DuJTneVg.js";import"./concat-jxnVidBz.js";import"./PluginModule-CRib3PLZ-rw_nkrD1.js";function dt(e){return A(function(){return e})}function ut(e,t){return E(function(o,i){return Y(e(o,i)).pipe(W(1),dt(o))})}function j(e,t){t===void 0&&(t=it);var o=nt(e,t);return ut(function(){return o})}function pt(e){return{x:-e.x,y:-e.y}}function lt(e,t){return{x:e.x+t.x,y:e.y+t.y}}const ft={invert:pt,add:lt};function B(e){return t=>t.kind==="pointerEnter"&&t.decorationId!==e||t.kind==="pointerLeave"&&t.decorationId===e}function ht(e,t){return o=>{const i=o.decorationId;return m(e,y(B(i)),E(()=>Q(m(X({kind:"stop"}),j(t)),m(e,y(r=>r.decorationId===i&&r.kind==="pointerEnter"),W(1),A(()=>null)))),y(N),W(1),rt({kind:"start",event:o}))}}function yt(e,t){const o=tt(e);function i(n){return n.kind==="pointerEnter"}let r={kind:"not-hovering"};return m(o,y(i),y(n=>r.kind==="not-hovering"||n.decorationId!==r.decorationId),E(n=>Q(m(X(n),j(t),E(ht(o,t-1)),ot(a=>{r=a.kind==="start"?{kind:"hovering",decorationId:a.event.decorationId}:{kind:"not-hovering"}})),m(o,y(B(n.decorationId)),W(1),A(()=>null)))),y(N),et(),D)}var J=e=>{throw TypeError(e)},K=(e,t,o)=>t.has(e)||J("Cannot "+o),s=(e,t,o)=>(K(e,t,"read from private field"),o?o.call(e):t.get(e)),l=(e,t,o)=>t.has(e)?J("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,o),b=(e,t,o,i)=>(K(e,t,"write to private field"),t.set(e,o),o),h,S,I,k,x,f,C,F;class M{constructor(t,o,i){this.executionScopeFactory=t,this.window=o,this.decorationController=i,l(this,h,new AsyncDisposableStack),l(this,S,new P),l(this,I,new P),l(this,k,new Set),l(this,x),l(this,f,null),l(this,C),l(this,F,r=>Array.from(s(this,k)).some(n=>n(r))),b(this,C,o),b(this,x,t),s(this,h).use(i.addVisibilitySource(D(s(this,S)))),s(this,h).use(i.onTextDecorationInteraction(r=>s(this,I).next(r),s(this,F))),s(this,h).use(yt(D(s(this,I)),100).subscribe(async r=>{r.kind==="start"?await this.createExecutionScope(r.event):await this.destroyExecutionScope()}))}async createExecutionScope(t){return await this.destroyExecutionScope(),$(async o=>{s(this,S).next({partial:!0,changes:[{id:{kind:"decoration",decorationId:t.decorationId},visibility:"emphasized"}]});const i=ft.add(t.viewportOffset,t.windowOffset),r=st(i),n={decorationId:t.decorationId,suggestionId:t.suggestionId,position:r(t.position),windowId:s(this,C).id};return b(this,f,s(this,h).use(await o(s(this,x).createExecutionScopeController("inline-card-interaction",{data:n})))),s(this,f).use(O(()=>{s(this,S).next({partial:!0,changes:[{id:{kind:"decoration",decorationId:t.decorationId},visibility:"visible"}]})})),s(this,f).start()})}async destroyExecutionScope(){s(this,f)&&(await s(this,f)[Symbol.asyncDispose](),b(this,f,null))}async[Symbol.asyncDispose](){await s(this,h).disposeAsync()}registerTextDecorationCanHandlePredicate(t){return s(this,k).add(t),O(()=>s(this,k).delete(t))}}h=new WeakMap;S=new WeakMap;I=new WeakMap;k=new WeakMap;x=new WeakMap;f=new WeakMap;C=new WeakMap;F=new WeakMap;var mt=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),V=e=>{throw TypeError(e)},R=(e,t,o)=>{if(t!=null){typeof t!="object"&&typeof t!="function"&&V("Object expected");var i;i===void 0&&(i=t[mt("dispose")]),typeof i!="function"&&V("Object not disposable"),e.push([o,i,t])}return t},U=(e,t,o)=>{var i=typeof SuppressedError=="function"?SuppressedError:function(a,c,u,d){return d=Error(u),d.name="SuppressedError",d.error=a,d.suppressed=c,d},r=a=>t=o?new i(a,t,"An error was suppressed during disposal"):(o=!0,a),n=a=>{for(;a=e.pop();)try{var c=a[1]&&a[1].call(a[2]);if(a[0])return Promise.resolve(c).then(n,u=>(r(u),n()))}catch(u){r(u)}if(o)throw t};return n()};const At=async e=>z(t=>{var o=[];try{Z.info("Inline Card activated (background)");const n=R(o,new DisposableStack),a=t(e.getPlugin("inline-decorations")),c=t(e.getPlugin("suggestion")),u=t(e.getPlugin("document-group")),d=e.getExecutionScopeDefinition("document-session"),g=e.getExecutionScopeDefinition("document-group");return n.use(t(d.register({token:M,useFactory:ct(M,[q,G,a.provides.TextDecorationController])},{lifetime:L.Singleton}))),n.use(t(d.register({token:at,useFactory:p=>p.resolve(M)},{lifetime:L.Singleton}))),n.use(g.onStart(async p=>$(async v=>{const w=await v(p.resolve(u.provides.WindowFactory)),_=await v(w.createWindow({injectionOptions:{kind:"popup"},clickThroughTransparent:!1,plugins:["inline-card"],fitContent:!0}));return g.register({token:G,useValue:_})}))),n.use(d.onStart(async p=>gt(p,a,c))),H(n.move())}catch(n){var i=n,r=!0}finally{U(o,i,r)}});function gt(e,t,o){return z(i=>{var r=[];try{const c=R(r,new DisposableStack),u=i(e.resolve(t.provides.TextDecorationController)),d=i(e.resolve(o.provides.SuggestionManager)),g=new P;c.use(u.addVisibilitySource(D(g)));const p=new Set;return c.use(d.getCollection().onChange.subscribe(v=>{var w,_;(w=v.upserted)==null||w.forEach(T=>{p.add(T.id)}),(_=v.removed)==null||_.forEach(T=>{p.delete(T.id)})})),c.defer(()=>g.complete()),H(c.move())}catch(c){var n=c,a=!0}finally{U(r,n,a)}})}export{At as activate,gt as onDocumentSessionStart};
//# sourceMappingURL=index-DBjteBBR.js.map
