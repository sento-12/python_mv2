import{ad as Be,S as v,B as we,t as f,I as _e,p as _,aw as We,ax as He,ay as ke,i as H,x as G,h as q,an as Ne,l as Ee,az as Ie,e as Ge,ac as qe,d as De,q as ye,r as Se,b as me,N as P,U as ze,u as Je,g as Ke,R as Qe,j as Xe,s as Pe,L as Me,m as Ye,c as Ze}from"./index-DbtAbjfk.js";import{e as $e,T as je}from"./index-DIq9RWYQ.js";import{TextDecorationStoreManagerToken as et}from"./index-BA9P4qHp.js";import{d as tt}from"./defineFactory-DJYNRBNc-CQmG8A-U.js";import"./RemoteEntity-CN-1WB86-yD3y8ldD.js";import"./PluginModule-CRib3PLZ-ls39AzbW.js";function Te(){return Be()}var it=Object.defineProperty,Oe=t=>{throw TypeError(t)},st=(t,e,i)=>e in t?it(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,m=(t,e,i)=>st(t,typeof e!="symbol"?e+"":e,i),Ve=(t,e,i)=>e.has(t)||Oe("Cannot "+i),a=(t,e,i)=>(Ve(t,e,"read from private field"),i?i.call(t):e.get(t)),g=(t,e,i)=>e.has(t)?Oe("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),Ce=(t,e,i,s)=>(Ve(t,e,"write to private field"),e.set(t,i),i),k,x,z,J,K,Q,X,Y,Z,j,U,ee;class nt{constructor(e){g(this,k,new DisposableStack),g(this,x),g(this,z),g(this,J,new v),g(this,K,new v),g(this,Q,new v),g(this,X,new v),g(this,Y,new v),g(this,Z,new v),g(this,j,new v),g(this,U,new we(new Set)),g(this,ee,new Map),m(this,"onPointerEnter",f(a(this,J))),m(this,"onPointerLeave",f(a(this,K))),m(this,"onPointerHoverChange",f(a(this,Q))),m(this,"onPointerDown",f(a(this,X))),m(this,"onPointerUp",f(a(this,Y))),m(this,"onPointerClick",f(a(this,Z))),m(this,"onFocusChange",f(a(this,j))),m(this,"visibleOnscreenDecorations",_e(a(this,U))),m(this,"id",Te()),Ce(this,x,e.children),Ce(this,z,e.upsert),e.children.forEach(i=>{a(this,k).use(i.onPointerEnter.subscribe(s=>a(this,J).next(s))),a(this,k).use(i.onPointerLeave.subscribe(s=>a(this,K).next(s))),a(this,k).use(i.onPointerHoverChange.subscribe(s=>a(this,Q).next(s))),a(this,k).use(i.onPointerDown.subscribe(s=>a(this,X).next(s))),a(this,k).use(i.onPointerUp.subscribe(s=>a(this,Y).next(s))),a(this,k).use(i.onPointerClick.subscribe(s=>a(this,Z).next(s))),a(this,k).use(i.onFocusChange.subscribe(s=>a(this,j).next(s))),a(this,k).use(i.visibleOnscreenDecorations.subscribe(s=>{a(this,ee).set(i,s);const r=_(a(this,ee).values(),ke(Ne),He,We);$e(r,a(this,U).getValue())||a(this,U).next(r)}))})}upsert(e){return a(this,z).call(this,e)}delete(e){return _(q(a(this,x).map(i=>i.delete(e))),H(G))}get(e){for(const i of a(this,x)){const s=i.get(e);if(s)return s}}getAll(){return _(a(this,x),ke(e=>e.getAll()))}setVisibility(e,i){return _(q(a(this,x).map(s=>s.setVisibility(e,i))),H(G))}focus(e,i){return _(a(this,x).map(s=>s.focus(e,i)),q,H(G))}async[Symbol.asyncDispose](){a(this,k).dispose()}}k=new WeakMap;x=new WeakMap;z=new WeakMap;J=new WeakMap;K=new WeakMap;Q=new WeakMap;X=new WeakMap;Y=new WeakMap;Z=new WeakMap;j=new WeakMap;U=new WeakMap;ee=new WeakMap;var rt=Object.defineProperty,Le=t=>{throw TypeError(t)},at=(t,e,i)=>e in t?rt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,M=(t,e,i)=>at(t,typeof e!="symbol"?e+"":e,i),ge=(t,e,i)=>e.has(t)||Le("Cannot "+i),n=(t,e,i)=>(ge(t,e,"read from private field"),i?i.call(t):e.get(t)),p=(t,e,i)=>e.has(t)?Le("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),R=(t,e,i,s)=>(ge(t,e,"write to private field"),e.set(t,i),i),S=(t,e,i)=>(ge(t,e,"access private method"),i),ot=(t,e,i,s)=>({set _(r){R(t,e,r)},get _(){return n(t,e,s)}}),E,T,d,w,pe,re,ae,oe,ce,le,he,de,B,C,b,Fe,te,Ae,O;class ct{constructor(e){p(this,b),p(this,E),p(this,T,new AsyncDisposableStack),p(this,d,new Map),p(this,w,null),p(this,pe,0),p(this,re,new v),p(this,ae,new v),p(this,oe,new v),p(this,ce,new v),p(this,le,new v),p(this,he,new v),p(this,de,new v),p(this,B,new we(new Set)),M(this,"onPointerEnter",f(n(this,re))),M(this,"onPointerLeave",f(n(this,ae))),M(this,"onPointerHoverChange",f(n(this,oe))),M(this,"onPointerDown",f(n(this,ce))),M(this,"onPointerUp",f(n(this,le))),M(this,"onPointerClick",f(n(this,he))),M(this,"onFocusChange",f(n(this,de))),M(this,"visibleOnscreenDecorations",_e(n(this,B))),M(this,"id"),p(this,C);var i;this.id=(i=e.id)!=null?i:Te(),R(this,E,Ee.createLogger("TextDecorationStore",e.label)),R(this,C,Ie(e.decorationsViewController)),n(this,T).use(e.segmentPointerEvents.subscribe(s=>S(this,b,Ae).call(this,s))),n(this,T).use(e.visibleOnscreenDecorations.subscribe(s=>{const r=_(s,De(o=>{var h;return(h=n(this,d).get(o))==null?void 0:h.decoration}),Ge(qe),We);$e(r,n(this,B).getValue())||n(this,B).next(r)})),n(this,T).defer(async()=>{e.onDispose(),await this.delete(n(this,d).keys()),n(this,d).clear()})}async upsert(e){var i;const s=n(this,d).get(e.id),r=e.segments.map(l=>({id:"".concat(e.id,"-").concat(ot(this,pe)._++),range:l.range,updateSemantics:l.updateSemantics,interactive:l.interactive,underline:l.underline,background:l.background,metadata:l.metadata})),o=S(this,b,Fe).call(this,e.id,r),h=()=>{var l,A;return(A=(l=n(this,d).get(e.id))==null?void 0:l.visibility)!=null?A:"hidden"},u=()=>{var l;return _((l=n(this,d).get(e.id))==null?void 0:l.segments,A=>A?Array.from(A.values()):[])},F=()=>{var l;return(l=n(this,d).get(e.id))==null?void 0:l.metadata},$=(i=s==null?void 0:s.decoration)!=null?i:{id:e.id,get visibility(){return h()},get metadata(){return F()},get segments(){return u()},focus:l=>this.focus(e.id,l),show:()=>this.setVisibility([e.id],!0),hide:()=>this.setVisibility([e.id],!1),[Symbol.asyncDispose]:async()=>{await _(this.delete([e.id]),ye(Se(l=>n(this,E).error("Unexpected error while disposing decoration ".concat($.id),l))))}};return n(this,d).set(e.id,{decoration:$,metadata:e.metadata,visibility:e.visibility,segments:new Map(o.map(l=>[l.id,l]))}),_(n(this,C).upsert({...e,segments:r,visibility:e.visibility==="focused"?"visible":e.visibility}),H(()=>(n(this,E).verbose("Upserted decoration #".concat($.id),$),$)),ye(Se(l=>{n(this,E).error("Failed to upsert decoration",l),n(this,E).verbose("Failed to upsert decoration ".concat($.id),l),n(this,d).delete(e.id)})))}async delete(e){const i=me(e);if(i.length===0)return P();for(const s of i)n(this,d).delete(s);return n(this,C).remove(i)}get(e){var i;return(i=n(this,d).get(e))==null?void 0:i.decoration}getAll(){return _(n(this,d).values(),De(e=>e.decoration))}setVisibility(e,i){var s,r;const o=me(e);if(o.length===0)return P();let h=P();for(const u of o){const F=n(this,d).get(u);F&&(i?F.visibility=((s=n(this,w))==null?void 0:s.decoration.id)===u?"focused":"visible":(F.visibility="hidden",((r=n(this,w))==null?void 0:r.decoration.id)===u&&(h=this.focus(null))))}return _(q([n(this,C).setVisibility({ids:o,visible:i}),h]),H(G))}focus(e,i){var s,r,o;if(e){const h=n(this,d).get(e),u=i!==void 0?h==null?void 0:h.segments.get(i):void 0;return((s=n(this,w))==null?void 0:s.decoration.id)===e&&((r=n(this,w).segment)==null?void 0:r.id)===(u==null?void 0:u.id)?P():(((o=n(this,w))==null?void 0:o.decoration.id)!==e&&S(this,b,te).call(this,!1),R(this,w,h?{decoration:h.decoration,segment:u}:null),S(this,b,te).call(this,!0),n(this,C).focus(e))}else return n(this,w)===null?P():(S(this,b,te).call(this,!1),R(this,w,null),n(this,C).focus(null))}async[Symbol.asyncDispose](){await n(this,T).disposeAsync()}}E=new WeakMap;T=new WeakMap;d=new WeakMap;w=new WeakMap;pe=new WeakMap;re=new WeakMap;ae=new WeakMap;oe=new WeakMap;ce=new WeakMap;le=new WeakMap;he=new WeakMap;de=new WeakMap;B=new WeakMap;C=new WeakMap;b=new WeakSet;Fe=function(t,e){const i=new Map(e.map(s=>[s.id,{interactive:s.interactive,background:s.background,underline:s.underline,metadata:s.metadata}]));return e.map(s=>({id:s.id,get underline(){var r;return(r=i.get(s.id))==null?void 0:r.underline},get background(){var r;return(r=i.get(s.id))==null?void 0:r.background},get interactive(){var r,o;return(o=(r=i.get(s.id))==null?void 0:r.interactive)!=null?o:!1},get metadata(){var r,o;return(o=(r=i.get(s.id))==null?void 0:r.metadata)!=null?o:s.metadata},patch:({metadata:r,underline:o,background:h,interactive:u})=>(i.set(s.id,{interactive:u!=null?u:s.interactive,metadata:r!=null?r:s.metadata,underline:o===null?void 0:o!=null?o:s.underline,background:h===null?void 0:h!=null?h:s.background}),n(this,C).patchSegment({id:t,segmentId:s.id,patch:{underline:o,background:h,interactive:u}}))}))};te=function(t){if(n(this,w)){const e=n(this,d).get(n(this,w).decoration.id);e&&(e.visibility=t?"focused":e.visibility==="focused"?"visible":e.visibility);const i=n(this,w).decoration,s=n(this,w).segment;n(this,de).next({decoration:i,segment:s,focused:t})}};Ae=function(t){if(t.pointerEnter||t.pointerLeave){const e=S(this,b,O).call(this,t.pointerLeave),i=S(this,b,O).call(this,t.pointerEnter);n(this,oe).next({pointerEnter:i,pointerLeave:e})}t.pointerDown&&S(this,b,O).call(this,t.pointerDown),t.pointerUp&&S(this,b,O).call(this,t.pointerUp),t.pointerClick&&S(this,b,O).call(this,t.pointerClick)};O=function(t){if(!t)return;const e=n(this,d).get(t.id),i=e==null?void 0:e.segments.get(t.segmentId);if(!e||!i)return;const s={kind:t.kind,segment:i,decoration:e.decoration,position:t.position,rect:t.rect,decorationRects:t.decorationRects,viewportOffset:t.viewportOffset,windowOffset:t.windowOffset};switch(t.kind){case"pointerEnter":n(this,re).next(s);break;case"pointerLeave":n(this,ae).next(s);break;case"pointerDown":n(this,ce).next(s);break;case"pointerUp":n(this,le).next(s);break;case"pointerClick":n(this,he).next(s);break;default:throw new ze(t.kind)}return s};var Ue=t=>{throw TypeError(t)},be=(t,e,i)=>e.has(t)||Ue("Cannot "+i),c=(t,e,i)=>(be(t,e,"read from private field"),i?i.call(t):e.get(t)),D=(t,e,i)=>e.has(t)?Ue("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),N=(t,e,i,s)=>(be(t,e,"write to private field"),e.set(t,i),i),lt=(t,e,i)=>(be(t,e,"access private method"),i),V,W,y,ie,ue,se,ve,L,ne,fe,Re;class I{constructor(e){D(this,fe),D(this,V),D(this,W,new AsyncDisposableStack),D(this,y,new Map),D(this,ie),D(this,ue,new we(new Set)),D(this,se,Promise.withResolvers()),D(this,ve,lt(this,fe,Re).call(this)),D(this,L),D(this,ne,!1),N(this,L,e),N(this,V,Ee.createLogger("TextDecorationStoreManager",e.id));const i=c(this,W).use(this.createStore());N(this,ie,c(this,W).use(new nt({children:[...c(this,y).values()].map(s=>s.store).concat(i),upsert:s=>i.upsert(s)}))),c(this,W).defer(()=>c(this,y).clear())}createStore(e){const i=new DisposableStack,s=e!==void 0?c(this,y).get(e):void 0;if(s!=null&&s.store)return s.store;const r=new v,o=c(this,W).use(new ct({id:e,label:c(this,L).id,decorationsViewController:Je(()=>c(this,se).promise),segmentPointerEvents:f(r),visibleOnscreenDecorations:_e(c(this,ue)),onDispose:()=>i.dispose()}));return c(this,V).verbose("Created text decoration store",o),c(this,y).set(o.id,{store:o,segmentPointerEventObserver:r}),i.defer(()=>{c(this,y).delete(o.id)}),i.use(o.onFocusChange.subscribe(h=>{h.focused&&c(this,y).forEach(u=>{u.store!==o&&u.store.focus(null)})})),c(this,W).use(i),o}getStore(e){return e?c(this,y).get(e):c(this,ie)}setTextDecorationsViewController(e){return c(this,ne)?c(this,V).warn("Text decorations controller already connected"):(c(this,V).verbose("Connecting text decorations controller"),c(this,se).resolve(e),N(this,ne,!0)),{entity:c(this,ve)}}async[Symbol.asyncDispose](){await c(this,W).disposeAsync()}}V=new WeakMap;W=new WeakMap;y=new WeakMap;ie=new WeakMap;ue=new WeakMap;se=new WeakMap;ve=new WeakMap;L=new WeakMap;ne=new WeakMap;fe=new WeakSet;Re=function(){return{getRects:t=>c(this,L).getRects(t),getBoundingRects:t=>c(this,L).getBoundingRects(t),onSegmentPointerEvents:t=>(c(this,y).forEach(e=>e.segmentPointerEventObserver.next(t)),P()),onVisibleOnscreenDecorationsDidChange:t=>(c(this,ue).next(t),P())}};const xe=Ze(Symbol("LocalTextDecorationsViewControllerEntity")),_t=t=>_(Xe([Pe(t.getExecutionScopeDefinition("document-session")),t.getPlugin("document-session")]),Ke(([e,i])=>Qe.all(ht(e,i))));function ht(t,e){return[t.register({token:I,useFactory:tt(I,[e.provides.TextDocument])},{lifetime:Me.Singleton}),t.register({token:et,useToken:I}),t.register({token:xe,useFactory:i=>_(i.resolve(I),Ye(s=>r=>s.setTextDecorationsViewController(r.entity)))},{lifetime:Me.Singleton}),Pe(t.onStart(async i=>i.realm.registerEntity({token:je,useToken:xe})))]}export{_t as activate};
//# sourceMappingURL=index-py1qAHBI.js.map
