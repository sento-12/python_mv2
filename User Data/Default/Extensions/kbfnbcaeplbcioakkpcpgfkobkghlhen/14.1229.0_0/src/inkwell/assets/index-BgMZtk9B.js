var ks=Object.defineProperty;var sn=(i,e)=>(e=Symbol[i])?e:Symbol.for("Symbol."+i),Lt=i=>{throw TypeError(i)};var Ss=(i,e,t)=>e in i?ks(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var qt=(i,e,t)=>Ss(i,typeof e!="symbol"?e+"":e,t),Ri=(i,e,t)=>e.has(i)||Lt("Cannot "+t);var c=(i,e,t)=>(Ri(i,e,"read from private field"),t?t.call(i):e.get(i)),y=(i,e,t)=>e.has(i)?Lt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),M=(i,e,t,n)=>(Ri(i,e,"write to private field"),n?n.call(i,t):e.set(i,t),t),q=(i,e,t)=>(Ri(i,e,"access private method"),t);var rn=(i,e,t,n)=>({set _(s){M(i,e,s,t)},get _(){return c(i,e,n)}});var et=(i,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&Lt("Object expected");var n;t&&(n=e[sn("asyncDispose")]),n===void 0&&(n=e[sn("dispose")]),typeof n!="function"&&Lt("Object not disposable"),i.push([t,n,e])}else t&&i.push([t]);return e},tt=(i,e,t)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(r,o,u,l){return l=Error(u),l.name="SuppressedError",l.error=r,l.suppressed=o,l},s=r=>e=t?new n(r,e,"An error was suppressed during disposal"):(t=!0,r),a=r=>{for(;r=i.pop();)try{var o=r[1]&&r[1].call(r[2]);if(r[0])return Promise.resolve(o).then(a,u=>(s(u),a()))}catch(u){s(u)}if(t)throw e};return a()};import{Z as Ts,a9 as an,aa as on,a2 as kn,o as Sn,j as ii,X as Tn,an as Ds,p as m,m as xe,h as Ei,i as ni,R as lt,s as Fe,L as ht,N as Es,c as si,f as Pi,ao as Dn,C as As,w as Bs,l as Yt,S as fe,ac as Oi,r as Oe,t as L,al as Gi,b as W,ap as $e,a3 as K,d as P,aq as En,v as Vi,ar as ln,as as Ut,at as Cs,$ as hn,au as cn,A as ce,n as St,q as mt,U as An,aj as oe,a6 as Is,T as Ws,av as un,k as Fs,aw as $s,H as Mi,ag as dn,e as Bn,B as Ps}from"./start-C5OgI2kj.js";import{A as Os}from"./index-Baxyqz_z.js";import{r as Cn}from"./index-BQHPBdKf.js";import{e as Gs,T as Vs}from"./index-DIq9RWYQ.js";import{TextDecorationsViewToken as Xs}from"./index-BltmXkY3.js";import{e as Ys,i as Xi,n as zs}from"./index-CZH9K_Ds.js";import{d as In}from"./debounceTime-RJRE2uYN.js";import{o as Ls}from"./of-BeKGPQlf.js";import{t as Qt,a as pt,o as qs}from"./subscribable-Cqm5UN_u-CZjzLfrM.js";import{a as Us}from"./asap-CWISApvk.js";import{A as Ns,a as Hs}from"./AsyncScheduler-DuJTneVg.js";import{E as Tt}from"./mergeAll-jza3F776.js";import{b as Qs,c as Zs,i as Dt,e as js,d as Zt,u as Yi,f as Js,g as Ks,a as er}from"./RectFns-ndpeBtT0-CdOd3O5S.js";import{c as Wn,t as fn}from"./PixelFns-BIHP7Exp-Cxsb96Xk.js";import{T as tr}from"./TextRevisionSynchronizedQueue-DQV4bu5q-uUfvwyBY.js";import{i as gn,w as mn,T as ir,a as zi,t as Li,u as nr}from"./TextRangeManager-Cr3iyUZK-B-ilxniI.js";import{m as Fn,f as Et,a as pn}from"./TextRangeUpdateSemantics-D8MqPOrG-Bdcz8ucb.js";import{a as sr}from"./async-CpPJMEP8.js";import{t as $n}from"./timer-CgPfXOBl.js";import{d as Pn}from"./distinctUntilChanged-6npf-yF3.js";import{s as ri}from"./switchMap-CzTQ1pQg.js";import{i as qi}from"./TextRevisionFns-DGbJAFcL-DX1ABpMm.js";import{t as vn}from"./take-CcUs0Iqw.js";import{d as rr}from"./defineFactory-DJYNRBNc-BjUmrCbc.js";import"./RemoteEntity-CN-1WB86-yD3y8ldD.js";import"./PluginModule-CRib3PLZ-rw_nkrD1.js";import"./merge-BdtP_pzV.js";import"./Delta-D-dso3t3-B1UydhvC.js";var ai={schedule:function(i){var e=requestAnimationFrame,t=cancelAnimationFrame,n=ai.delegate;n&&(e=n.requestAnimationFrame,t=n.cancelAnimationFrame);var s=e(function(a){t=void 0,i(a)});return new Ts(function(){return t==null?void 0:t(s)})},requestAnimationFrame:function(){for(var i=[],e=0;e<arguments.length;e++)i[e]=arguments[e];return requestAnimationFrame.apply(void 0,an([],on(i)))},cancelAnimationFrame:function(){for(var i=[],e=0;e<arguments.length;e++)i[e]=arguments[e];var t=ai.delegate;return((t==null?void 0:t.cancelAnimationFrame)||cancelAnimationFrame).apply(void 0,an([],on(i)))},delegate:void 0},ar=function(i){kn(e,i);function e(t,n){var s=i.call(this,t,n)||this;return s.scheduler=t,s.work=n,s}return e.prototype.requestAsyncId=function(t,n,s){return s===void 0&&(s=0),s!==null&&s>0?i.prototype.requestAsyncId.call(this,t,n,s):(t.actions.push(this),t._scheduled||(t._scheduled=ai.requestAnimationFrame(function(){return t.flush(void 0)})))},e.prototype.recycleAsyncId=function(t,n,s){var a;if(s===void 0&&(s=0),s!=null?s>0:this.delay>0)return i.prototype.recycleAsyncId.call(this,t,n,s);var r=t.actions;n!=null&&((a=r[r.length-1])===null||a===void 0?void 0:a.id)!==n&&(ai.cancelAnimationFrame(n),t._scheduled=void 0)},e}(Ns),or=function(i){kn(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e.prototype.flush=function(t){this._active=!0;var n=this._scheduled;this._scheduled=void 0;var s=this.actions,a;t=t||s.shift();do if(a=t.execute(t.state,t.delay))break;while((t=s[0])&&t.id===n&&s.shift());if(this._active=!1,a){for(;(t=s[0])&&t.id===n&&s.shift();)t.unsubscribe();throw a}},e}(Hs),lr=new or(ar);function On(i){return Sn(function(e,t){var n=[];return e.subscribe(ii(t,function(s){return n.push(s)},function(){t.next(n),t.complete()})),Tn(i).subscribe(ii(t,function(){var s=n;n=[],t.next(s)},Ds)),function(){n=null}})}function hr(i,e){return Sn(function(t,n){var s=e!=null?e:{},a=s.leading,r=a===void 0?!0:a,o=s.trailing,u=o===void 0?!1:o,l=!1,f=null,g=null,p=!1,v=function(){g==null||g.unsubscribe(),g=null,u&&(A(),p&&n.complete())},w=function(){g=null,p&&n.complete()},k=function(B){return g=Tn(i(B)).subscribe(ii(n,v,w))},A=function(){if(l){l=!1;var B=f;f=null,n.next(B),!p&&k(B)}};t.subscribe(ii(n,function(B){l=!0,f=B,!(g&&!g.closed)&&(r?A():k(B))},function(){p=!0,!(u&&l&&g&&!g.closed)&&n.complete()}))})}function cr(i,e,t){e===void 0&&(e=sr);var n=$n(i,e);return hr(function(){return n},t)}function ur(i){var s=[];try{const e=et(s,new DisposableStack);const t=si();const n=si();e.use(i.scopeDefinition.onStart(async u=>m(ni([u.resolve(i.localEntityToken),u.resolve(n)]),xe(([l,f])=>{const g=m(u.realm.resolveEntity(i.remoteEntityToken,l),Ei(p=>p.entity));f.resolve(g)}))));return m(lt.all([i.scopeDefinition.register({token:n,useFactory:()=>Fe(Promise.withResolvers())},{lifetime:ht.Singleton}),i.scopeDefinition.register({token:t,useFactory:u=>m(u.resolve(n),xe(l=>Es(l.promise)))},{lifetime:ht.Singleton})]),lt.use(e),xe(()=>{const u=e.move();return{remoteEntityToken:t,[Symbol.dispose]:()=>u.dispose()}}))}catch(a){var r=a,o=!0}finally{tt(s,r,o)}}const dr=(i,e)=>new Promise(t=>{queueMicrotask(async()=>{var n;if((n=e==null?void 0:e.signal)!=null&&n.aborted)return t(Pi(new Gn(e.signal.reason)));try{t(Fe(await i()))}catch(s){t(Dn(s))}})});class Gn extends As{constructor(e){super(e instanceof Error?e.message:String(e))}}function fr(i,e){let t=null,n=!1;const s=r=>{t==null||t.abortController.abort(r),t==null||t.resolvers.resolve(Pi(new Gn(r!=null?r:"signal is aborted without reason"))),t=null},a=({resolvers:r})=>{n=!0,e(async()=>{if(!t)return;const o=t;t=null,await i(...o.args)},{signal:t==null?void 0:t.abortController.signal}).then(o=>{n=!1,r.resolve(m(o,xe(Bs))),t&&a(t)},o=>{Yt.error("Unexpected error when scheduling task in createSingletonTaskQueue()",o),n=!1,r.resolve(Dn(o)),t&&a(t)})};return{enqueue:(...r)=>{var u,l;const o=(u=t==null?void 0:t.resolvers)!=null?u:Promise.withResolvers();return t={resolvers:o,args:r,abortController:(l=t==null?void 0:t.abortController)!=null?l:new AbortController},n||a(t),o.promise},get empty(){return!t},cancel:s,[Symbol.dispose]:s}}function gr(i,e,t,n,s){Vn(i,e,t||0,n||i.length-1,s||mr)}function Vn(i,e,t,n,s){for(;n>t;){if(n-t>600){var a=n-t+1,r=e-t+1,o=Math.log(a),u=.5*Math.exp(2*o/3),l=.5*Math.sqrt(o*u*(a-u)/a)*(r-a/2<0?-1:1),f=Math.max(t,Math.floor(e-r*u/a+l)),g=Math.min(n,Math.floor(e+(a-r)*u/a+l));Vn(i,e,f,g,s)}var p=i[e],v=t,w=n;for(_t(i,t,e),s(i[n],p)>0&&_t(i,t,n);v<w;){for(_t(i,v,w),v++,w--;s(i[v],p)<0;)v++;for(;s(i[w],p)>0;)w--}s(i[t],p)===0?_t(i,t,w):(w++,_t(i,w,n)),w<=e&&(t=w+1),e<=w&&(n=w-1)}}function _t(i,e,t){var n=i[e];i[e]=i[t],i[t]=n}function mr(i,e){return i<e?-1:i>e?1:0}class Xn{constructor(e=9){this._maxEntries=Math.max(4,e),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(e){let t=this.data;const n=[];if(!Ht(e,t))return n;const s=this.toBBox,a=[];for(;t;){for(let r=0;r<t.children.length;r++){const o=t.children[r],u=t.leaf?s(o):o;Ht(e,u)&&(t.leaf?n.push(o):Si(e,u)?this._all(o,n):a.push(o))}t=a.pop()}return n}collides(e){let t=this.data;if(!Ht(e,t))return!1;const n=[];for(;t;){for(let s=0;s<t.children.length;s++){const a=t.children[s],r=t.leaf?this.toBBox(a):a;if(Ht(e,r)){if(t.leaf||Si(e,r))return!0;n.push(a)}}t=n.pop()}return!1}load(e){if(!(e&&e.length))return this;if(e.length<this._minEntries){for(let n=0;n<e.length;n++)this.insert(e[n]);return this}let t=this._build(e.slice(),0,e.length-1,0);if(!this.data.children.length)this.data=t;else if(this.data.height===t.height)this._splitRoot(this.data,t);else{if(this.data.height<t.height){const n=this.data;this.data=t,t=n}this._insert(t,this.data.height-t.height-1,!0)}return this}insert(e){return e&&this._insert(e,this.data.height-1),this}clear(){return this.data=nt([]),this}remove(e,t){if(!e)return this;let n=this.data;const s=this.toBBox(e),a=[],r=[];let o,u,l;for(;n||a.length;){if(n||(n=a.pop(),u=a[a.length-1],o=r.pop(),l=!0),n.leaf){const f=pr(e,n.children,t);if(f!==-1)return n.children.splice(f,1),a.push(n),this._condense(a),this}!l&&!n.leaf&&Si(n,s)?(a.push(n),r.push(o),o=0,u=n,n=n.children[0]):u?(o++,n=u.children[o],l=!1):n=null}return this}toBBox(e){return e}compareMinX(e,t){return e.minX-t.minX}compareMinY(e,t){return e.minY-t.minY}toJSON(){return this.data}fromJSON(e){return this.data=e,this}_all(e,t){const n=[];for(;e;)e.leaf?t.push(...e.children):n.push(...e.children),e=n.pop();return t}_build(e,t,n,s){const a=n-t+1;let r=this._maxEntries,o;if(a<=r)return o=nt(e.slice(t,n+1)),it(o,this.toBBox),o;s||(s=Math.ceil(Math.log(a)/Math.log(r)),r=Math.ceil(a/Math.pow(r,s-1))),o=nt([]),o.leaf=!1,o.height=s;const u=Math.ceil(a/r),l=u*Math.ceil(Math.sqrt(r));wn(e,t,n,l,this.compareMinX);for(let f=t;f<=n;f+=l){const g=Math.min(f+l-1,n);wn(e,f,g,u,this.compareMinY);for(let p=f;p<=g;p+=u){const v=Math.min(p+u-1,g);o.children.push(this._build(e,p,v,s-1))}}return it(o,this.toBBox),o}_chooseSubtree(e,t,n,s){for(;s.push(t),!(t.leaf||s.length-1===n);){let a=1/0,r=1/0,o;for(let u=0;u<t.children.length;u++){const l=t.children[u],f=ki(l),g=yr(e,l)-f;g<r?(r=g,a=f<a?f:a,o=l):g===r&&f<a&&(a=f,o=l)}t=o||t.children[0]}return t}_insert(e,t,n){const s=n?e:this.toBBox(e),a=[],r=this._chooseSubtree(s,this.data,t,a);for(r.children.push(e),bt(r,s);t>=0&&a[t].children.length>this._maxEntries;)this._split(a,t),t--;this._adjustParentBBoxes(s,a,t)}_split(e,t){const n=e[t],s=n.children.length,a=this._minEntries;this._chooseSplitAxis(n,a,s);const r=this._chooseSplitIndex(n,a,s),o=nt(n.children.splice(r,n.children.length-r));o.height=n.height,o.leaf=n.leaf,it(n,this.toBBox),it(o,this.toBBox),t?e[t-1].children.push(o):this._splitRoot(n,o)}_splitRoot(e,t){this.data=nt([e,t]),this.data.height=e.height+1,this.data.leaf=!1,it(this.data,this.toBBox)}_chooseSplitIndex(e,t,n){let s,a=1/0,r=1/0;for(let o=t;o<=n-t;o++){const u=xt(e,0,o,this.toBBox),l=xt(e,o,n,this.toBBox),f=_r(u,l),g=ki(u)+ki(l);f<a?(a=f,s=o,r=g<r?g:r):f===a&&g<r&&(r=g,s=o)}return s||n-t}_chooseSplitAxis(e,t,n){const s=e.leaf?this.compareMinX:vr,a=e.leaf?this.compareMinY:wr,r=this._allDistMargin(e,t,n,s),o=this._allDistMargin(e,t,n,a);r<o&&e.children.sort(s)}_allDistMargin(e,t,n,s){e.children.sort(s);const a=this.toBBox,r=xt(e,0,t,a),o=xt(e,n-t,n,a);let u=Nt(r)+Nt(o);for(let l=t;l<n-t;l++){const f=e.children[l];bt(r,e.leaf?a(f):f),u+=Nt(r)}for(let l=n-t-1;l>=t;l--){const f=e.children[l];bt(o,e.leaf?a(f):f),u+=Nt(o)}return u}_adjustParentBBoxes(e,t,n){for(let s=n;s>=0;s--)bt(t[s],e)}_condense(e){for(let t=e.length-1,n;t>=0;t--)e[t].children.length===0?t>0?(n=e[t-1].children,n.splice(n.indexOf(e[t]),1)):this.clear():it(e[t],this.toBBox)}}function pr(i,e,t){if(!t)return e.indexOf(i);for(let n=0;n<e.length;n++)if(t(i,e[n]))return n;return-1}function it(i,e){xt(i,0,i.children.length,e,i)}function xt(i,e,t,n,s){s||(s=nt(null)),s.minX=1/0,s.minY=1/0,s.maxX=-1/0,s.maxY=-1/0;for(let a=e;a<t;a++){const r=i.children[a];bt(s,i.leaf?n(r):r)}return s}function bt(i,e){return i.minX=Math.min(i.minX,e.minX),i.minY=Math.min(i.minY,e.minY),i.maxX=Math.max(i.maxX,e.maxX),i.maxY=Math.max(i.maxY,e.maxY),i}function vr(i,e){return i.minX-e.minX}function wr(i,e){return i.minY-e.minY}function ki(i){return(i.maxX-i.minX)*(i.maxY-i.minY)}function Nt(i){return i.maxX-i.minX+(i.maxY-i.minY)}function yr(i,e){return(Math.max(e.maxX,i.maxX)-Math.min(e.minX,i.minX))*(Math.max(e.maxY,i.maxY)-Math.min(e.minY,i.minY))}function _r(i,e){const t=Math.max(i.minX,e.minX),n=Math.max(i.minY,e.minY),s=Math.min(i.maxX,e.maxX),a=Math.min(i.maxY,e.maxY);return Math.max(0,s-t)*Math.max(0,a-n)}function Si(i,e){return i.minX<=e.minX&&i.minY<=e.minY&&e.maxX<=i.maxX&&e.maxY<=i.maxY}function Ht(i,e){return e.minX<=i.maxX&&e.minY<=i.maxY&&e.maxX>=i.minX&&e.maxY>=i.minY}function nt(i){return{children:i,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function wn(i,e,t,n,s){const a=[e,t];for(;a.length;){if(t=a.pop(),e=a.pop(),t-e<=n)continue;const r=e+Math.ceil((t-e)/n/2)*n;gr(i,r,e,t,s),a.push(e,r,r,t)}}var Ct,me,It,ut,Se,ze,pe,ve,we,Q,Wt,Te,dt,fi,ft,$,gt,Le,Y,Yn,zn,Ln,qn,jt;class xr{constructor(e){y(this,Y);y(this,Ct);y(this,me,new DisposableStack);y(this,It);y(this,ut);y(this,Se,new Map);y(this,ze,new Map);y(this,pe,null);y(this,ve,new Map);y(this,we,new Set);y(this,Q,new br);y(this,Wt);y(this,Te);y(this,dt,c(this,me).use(fr(()=>q(this,Y,Yn).call(this),dr)));y(this,fi,0);y(this,ft,!0);y(this,$,null);y(this,gt,null);y(this,Le,new fe);qt(this,"onPointerEvent",Qt(c(this,Le)));var n,s;M(this,Ct,Yt.createLogger("InteractiveGeometryManager",e.label)),M(this,Te,e.emitMetrics),M(this,ut,(n=e.pointerPositionThrottleTimeMs)!=null?n:Math.ceil(1e3/30));const t=m(pt(e.pointerMove),c(this,ut)===0?Oi:cr(c(this,ut)));M(this,Wt,e.getViewport),c(this,me).use(m(t,Oe(a=>q(this,Y,zn).call(this,a)))),c(this,me).use(e.pointerDown.subscribe(a=>q(this,Y,Ln).call(this,a))),c(this,me).use(e.pointerUp.subscribe(a=>q(this,Y,qn).call(this,a))),M(this,pe,e.compareZIndex?null:new Map),M(this,It,(s=e.compareZIndex)!=null?s:(a,r)=>{var o,u,l,f;return((u=(o=c(this,pe))==null?void 0:o.get(a.rect))!=null?u:0)-((f=(l=c(this,pe))==null?void 0:l.get(r.rect))!=null?f:0)}),c(this,me).defer(()=>this.clear())}async upsert(e,t){c(this,we).delete(e),c(this,ve).set(e,t),await c(this,dt).enqueue()}async remove(e){c(this,ve).delete(e),c(this,we).add(e),await c(this,dt).enqueue()}clear(){var e,t;c(this,Q).clear(),c(this,Se).clear(),c(this,ze).clear(),(e=c(this,pe))==null||e.clear(),c(this,ve).clear(),c(this,we).clear(),c(this,dt).cancel(),(t=c(this,Te))==null||t.call(this,{interactiveRectCount:0})}disablePointerEvents(){var e;M(this,ft,!1),(e=c(this,Te))==null||e.call(this,{interactiveRectCount:0})}enablePointerEvents(){var e;M(this,ft,!0),(e=c(this,Te))==null||e.call(this,{interactiveRectCount:c(this,Q).size})}[Symbol.dispose](){c(this,me).dispose()}}Ct=new WeakMap,me=new WeakMap,It=new WeakMap,ut=new WeakMap,Se=new WeakMap,ze=new WeakMap,pe=new WeakMap,ve=new WeakMap,we=new WeakMap,Q=new WeakMap,Wt=new WeakMap,Te=new WeakMap,dt=new WeakMap,fi=new WeakMap,ft=new WeakMap,$=new WeakMap,gt=new WeakMap,Le=new WeakMap,Y=new WeakSet,Yn=function(){var s,a,r,o;var u=[];try{const e=m(c(this,we),Gi(p=>{var v;return(v=c(this,Se).get(p))!=null?v:[]}),L);const t=m(c(this,ve),W(([p,v])=>{var w;return[(w=c(this,Se).get(p))!=null?w:[],v]}),L);if(e.length===0&&t.length===0)return;const n=et(u,$e.startSpan("InteractiveGeometryManager.flushQueues()",{attributes:{removals:e.length,updates:t.length,treeSize:c(this,Q).size}}));for(const p of e)c(this,Q).remove(p),c(this,ze).delete(p),(s=c(this,pe))==null||s.delete(p);for(const p of c(this,we))c(this,Se).delete(p),((a=c(this,$))==null?void 0:a.geometry)===p&&M(this,$,null);for(const[p,v]of t)for(const w of p)c(this,Q).remove(w);for(const[p,v]of c(this,ve)){for(const w of v)c(this,ze).set(w,p),(r=c(this,pe))==null||r.set(w,rn(this,fi)._++);c(this,Se).set(p,v)}c(this,Q).load(t.flatMap(([p,v])=>v));c(this,we).clear();c(this,ve).clear();(o=c(this,Te))==null||o.call(this,{interactiveRectCount:c(this,Q).size});c(this,Ct).verbose("queue flushed",{removals:e.length,updates:t.length,treeSize:c(this,Q).size})}catch(l){var f=l,g=!0}finally{tt(u,f,g)}},zn=function(e){var s;const t=q(this,Y,jt).call(this,e),n={};if(t){if(((s=c(this,$))==null?void 0:s.geometry)===t.geometry)return;c(this,$)!==null&&c(this,$).geometry!==t.geometry&&(n.pointerLeave={kind:"pointerLeave",position:e,currentTarget:c(this,$).rect,target:c(this,$).geometry}),n.pointerEnter={kind:"pointerEnter",position:e,currentTarget:t.rect,target:t.geometry},M(this,$,t)}else c(this,$)!==null&&(n.pointerLeave={kind:"pointerLeave",position:e,currentTarget:c(this,$).rect,target:c(this,$).geometry},M(this,$,null));Object.values(n).some(K)&&c(this,Le).next(n)},Ln=function(e){const t=q(this,Y,jt).call(this,e);t&&(M(this,gt,t.geometry),c(this,Le).next({pointerDown:{kind:"pointerDown",position:e,currentTarget:t.rect,target:t.geometry}}))},qn=function(e){const t=q(this,Y,jt).call(this,e);if(!t)return;const n={pointerUp:{kind:"pointerUp",position:e,currentTarget:t.rect,target:t.geometry}};c(this,gt)===t.geometry&&(n.pointerClick={kind:"pointerClick",position:e,currentTarget:t.rect,target:t.geometry}),M(this,gt,null),Object.values(n).some(K)&&c(this,Le).next(n)},jt=function(e){return!Qs(c(this,Wt).call(this),e)||!c(this,ft)?null:m(c(this,Q).search({minX:e.x,minY:e.y,maxX:e.x,maxY:e.y}),W(t=>m(c(this,ze).get(t),n=>n?{rect:t,geometry:n}:null)),P(K),L,t=>{var n;return(n=t.sort((s,a)=>c(this,It).call(this,s,a)).at(-1))!=null?n:null})};let br=class extends Xn{constructor(){super(...arguments);qt(this,"_rects",new Set)}toBBox(t){return{minX:t.x,minY:t.y,maxX:t.x+t.width,maxY:t.y+t.height}}compareMinX(t,n){return t.x-n.x}compareMinY(t,n){return t.y-n.y}load(t){return t.forEach(n=>this._rects.add(n)),super.load(t)}insert(t){return this._rects.add(t),super.insert(t)}remove(t,n){return this._rects.delete(t),super.remove(t,n)}clear(){var t;return(t=this._rects)==null||t.clear(),super.clear()}get size(){return this._rects.size}};function Rr(i,e){return i.text>e.text&&i.geometry>=e.geometry||i.geometry>e.geometry&&i.text>=e.text}function Mr(i,e){return i.text>=e.text&&i.geometry>=e.geometry}function kr({text:i,geometry:e}){return"Revision({ text: ".concat(i,", geometry: ").concat(e," })")}function Sr(i){return{x:i.x,y:i.y}}function Tr(i){return{x:i.x,y:i.y}}function Dr(i){return Tr(i)}function Er(i){return{x:i.x,y:i.y}}function Ar(i){return{x:i.x,y:i.y}}function Br(i){return Ar(i)}function Qe(i){return{x:i.x,y:i.y,width:i.width,height:i.height}}function yn(i){return e=>Qe({x:i(e.x),y:i(e.y),width:i(e.width),height:i(e.height)})}function Cr(i){return{x:i.x,y:i.y,width:i.width,height:i.height}}function Re(i,e,t=Number.EPSILON){return Math.abs(i-e)<=t}function Be(i,e=0){return e===0?.5+i|0:Math.round((i+Number.EPSILON)*10**e)/10**e}function Ir(i,e=1.5,t=1.5){if(i.length===0)return[];if(i.length===1)return[i[0]];const n=[];let s=i[0];const a=i.length;for(let r=1;r<a;r++){const o=i[r],u=o.y+o.height,l=u<s.y,f=Re(u,s.y)&&o.height>0&&s.height>0;if(l||f)continue;const g=Math.min(s.x,o.x),p=Math.min(s.y,o.y),v=Math.max(s.x+s.width,o.x+o.width),w=Math.max(s.y+s.height,u),k=v-g,A=w-p,B=k<=s.width+o.width+e,he=A<=s.height+o.height-t,wt=Re(A,s.height+o.height)&&(Re(o.height,0)||Re(s.height,0));Re(o.width,s.width)&&Re(o.height,s.height)&&Re(o.x,s.x)&&Re(o.y,s.y)||(B&&(he||wt)?s=Zs({y:p,x:g,height:A,width:k}):(n.push(s),s=o))}return n.push(s),n}function Rt(i){return m(i,Wr,Ir)}function Wr(i){return[...i].sort((e,t)=>e.y<t.y?-1:e.y>t.y?1:e.x<t.x?-1:e.x>t.x?1:0)}var ee,De,gi,Ft,Ee,re,ye,_e,qe,$t,te,V,Pt,Ot,le,Un,Nn,Hn,Qn;class Fr{constructor(e){y(this,le);y(this,ee,Yt.createLogger("TextRangeGeometryManager"));y(this,De,new DisposableStack);y(this,gi,new En);y(this,Ft,100);y(this,Ee);y(this,re,new Map);y(this,ye,new Set);y(this,_e,new Set);y(this,qe,new fe);y(this,$t);y(this,te);y(this,V);y(this,Pt);y(this,Ot);M(this,Pt,e.getRects),M(this,Ot,e.getBoundingRects),M(this,$t,e.emitMetrics),M(this,V,e.initialRevision),M(this,te,gn(e.initialVisibleTextRange)?e.initialVisibleTextRange:mn(e.initialVisibleTextRange,c(this,Ft))),M(this,Ee,c(this,De).use(new ir({initialTextRevision:e.initialRevision.text,label:"TextRangeGeometryManager/TextRangeManager"}))),c(this,De).defer(()=>{c(this,qe).complete(),c(this,re).clear(),c(this,ye).clear(),c(this,_e).clear()}),c(this,De).use(m(c(this,qe),On(m(c(this,qe),In(0))),Vi(t=>ln(t,n=>n.minimumRevision)),Oe(t=>{for(const[n,s]of t){Rr(n,c(this,V))&&c(this,ee).warn("Unexpected geometry request for revision ".concat(n," greater than current revision ").concat(c(this,V)));const{visibleGroupsRequests:a,hiddenGroupsRequests:r}=q(this,le,Un).call(this,s);a.length>0&&q(this,le,Nn).call(this,a),r.length>0&&(c(this,ee).warn("Unexpected geometry request for hidden groups [".concat(r.map(({group:o})=>o.id).join(", "),"] for revision ").concat(kr(n))),r.forEach(o=>o.resolve(Fe({rects:[],revision:c(this,V)}))))}})))}get _revisionForTests(){throw new Error("Only available for accessing the revision in tests")}add({id:e,metadata:t,revision:n,ranges:s,visible:a}){const r=ni(m(s,Fn(({id:f,range:g,metadata:p,updateSemantics:v})=>c(this,Ee).add({id:f!=null?f:c(this,gi).next(),range:g,metadata:p,revision:n,updateSemantics:v}))));if(!r.ok)return r;const o=r.value,u=new DisposableStack;u.defer(()=>{l.ranges.forEach(f=>c(this,re).delete(f)),c(this,ye).delete(l.id)});const l=c(this,De).use(new $r({id:e,ranges:o,metadata:t,getRects:f=>{const g=Promise.withResolvers();return c(this,qe).next({group:l,minimumRevision:f.minimumRevision,geometryKind:f.geometryKind,resolve:p=>g.resolve(p)}),g.promise}}));return l.use(u),o.forEach(f=>c(this,re).set(f,l)),a&&c(this,ye).add(l.id),zi(c(this,te),l.boundingRange)&&c(this,_e).add(l.id),Fe(l)}pushTextChange(e){var o=[];try{const t=et(o,$e.startSpan("TextRangeGeometryManager.pushTextChange()",{attributes:{change:e}}));M(this,V,{geometry:c(this,V).geometry,text:e.revision});const{getChangedRanges:n,affectedRanges:s}=c(this,Ee).pushTextChange(e);const a=m(s,W(g=>c(this,re).get(g)),P(K),Ut,L);const r=m(n(),W(g=>c(this,re).get(g)),P(K),Cs(g=>g.boundingRange.start<c(this,te).end),P(g=>g.boundingRange.end>=c(this,te).start),Ut,Et);r==null||r.forEach(g=>{c(this,_e).add(g.id)});c(this,ee).verbose("pushTextChange",{change:e,affectedGroups:a.map(g=>g.id),onScreenChangedGroups:r==null?void 0:r.map(g=>g.id),revision:c(this,V)});return{affected:a,visibleChanged:r!=null?r:[]}}catch(u){var l=u,f=!0}finally{tt(o,l,f)}}pushDocumentGeometryChange(e,t){var a=[];try{const n=et(a,$e.startSpan("TextRangeGeometryManager.pushDocumentGeometryChange()",{attributes:{visibleTextRange:e,geometryRevision:t}}));M(this,V,{text:c(this,V).text,geometry:t});M(this,te,gn(e)?e:mn(e,c(this,Ft)));const s=m(c(this,Ee).getIntersecting(c(this,te)),W(l=>c(this,re).get(l)),P(K),Ut,Et);c(this,_e).clear();s==null||s.forEach(l=>{c(this,_e).add(l.id)});c(this,ee).verbose("pushDocumentGeometryChange",{visibleTextRange:Li(c(this,te)),onScreenGroups:s==null?void 0:s.map(l=>l.id),revision:c(this,V)});return{visible:s!=null?s:[]}}catch(r){var o=r,u=!0}finally{tt(a,o,u)}}getOnscreenTextRangeGroups(){return m(c(this,Ee).getIntersecting(c(this,te)),W(e=>c(this,re).get(e)),P(K),Ut,L)}setVisibility(e,t){for(const n of e)t?c(this,ye).add(n):c(this,ye).delete(n)}[Symbol.dispose](){c(this,De).dispose()}}ee=new WeakMap,De=new WeakMap,gi=new WeakMap,Ft=new WeakMap,Ee=new WeakMap,re=new WeakMap,ye=new WeakMap,_e=new WeakMap,qe=new WeakMap,$t=new WeakMap,te=new WeakMap,V=new WeakMap,Pt=new WeakMap,Ot=new WeakMap,le=new WeakSet,Un=function(e){const t=[],n=[];return e.forEach(s=>{c(this,ye).has(s.group.id)&&c(this,_e).has(s.group.id)?t.push(s):n.push(s)}),{visibleGroupsRequests:t,hiddenGroupsRequests:n}},Nn=async function(e){var p,v,w,k;var A=[];try{const t={...c(this,V)};const n=et(A,$e.startSpan("TextRangeGeometryManager.#requestGeometry()",{attributes:{revision:t,groups:e.map(({group:T,minimumRevision:yt})=>({id:T.id,ranges:T.ranges.length,minimumRevision:yt}))}}));const s=ln(e,({geometryKind:T})=>T==="singleBoundingBox"?"boundingBox":"rects");const a={forRects:(p=s.get("rects"))!=null?p:[],forBoundingBoxes:(v=s.get("boundingBox"))!=null?v:[]};const r={forRects:a.forRects.flatMap(({group:T})=>T.ranges),forBoundingBoxes:a.forBoundingBoxes.flatMap(({group:T})=>T.ranges)};c(this,ee).verbose("geometry request",{revision:t,requestRevision:(w=e[0])==null?void 0:w.minimumRevision,requests:a});const o=m(r.forRects,pn({nonEmpty:T=>q(this,le,Hn).call(this,T),empty:()=>ce({rects:new Map,revision:t})}));const u=m(r.forBoundingBoxes,pn({nonEmpty:T=>q(this,le,Qn).call(this,T),empty:()=>ce({rects:new Map,revision:t})}));const l={forRects:await o,forBoundingBoxes:await u};a.forRects.forEach(({group:T,resolve:yt,geometryKind:_i})=>yt(m(l.forRects,xe(({revision:xi,rects:bi})=>({rects:T.ranges.map(zt=>{var nn;return(nn=bi.get(zt.id))!=null?nn:[]}).map(_i==="lineBoundingBox"?Rt:Oi),revision:xi})))));a.forBoundingBoxes.forEach(({group:T,resolve:yt})=>yt(m(l.forBoundingBoxes,xe(({revision:_i,rects:xi})=>({rects:T.ranges.map(bi=>{var zt;return[(zt=xi.get(bi.id))!=null?zt:[]].flat()}),revision:_i})))));const f=m(l.forRects,hn({success:({rects:T})=>Array.from(T.values()).flat().length,failure:()=>0}));const g=m(l.forBoundingBoxes,hn({success:({rects:T})=>T.size,failure:()=>0}));(k=c(this,$t))==null||k.call(this,{rangeCount:e.flatMap(({group:T})=>T.ranges).length,rectCount:f+g});c(this,ee).verbose("geometry response",{responseRevision:t,requests:a,responses:l})}catch(B){var he=B,wt=!0}finally{tt(A,he,wt)}},Hn=function(e){return cn(()=>m(c(this,Pt).call(this,new Map(m(e,W(t=>[t.id,{start:t.start,end:t.end}])))),St(mt(t=>c(this,ee).error("Unexpected error getting rects",t)))),{maxRetries:3,delayMs:()=>1e3})},Qn=function(e){return cn(()=>m(c(this,Ot).call(this,new Map(m(e,W(t=>[t.id,{start:t.start,end:t.end}])))),St(mt(t=>c(this,ee).error("Unexpected error getting bounding rects",t)))),{maxRetries:3,delayMs:()=>1e3})};var Gt,Vt,Ue,mi,Xt,Ae;class $r{constructor(e){y(this,Gt,new DisposableStack);y(this,Vt);y(this,Ue);y(this,mi,new En);y(this,Xt);y(this,Ae,null);qt(this,"id");var t;this.id=(t=e.id)!=null?t:c(this,mi).next(),M(this,Ue,e.ranges),M(this,Vt,e.metadata),M(this,Xt,e.getRects)}get metadata(){return c(this,Vt)}get revision(){return c(this,Ue)[0].revision}get ranges(){return c(this,Ue)}get boundingRange(){return nr(...c(this,Ue))}getGeometry(e){return c(this,Ae)&&Mr(c(this,Ae).requestedRevision,e.minimumRevision)?c(this,Ae).response:(M(this,Ae,{requestedRevision:e.minimumRevision,response:c(this,Xt).call(this,e)}),c(this,Ae).response)}toString(){const e=this.ranges.map(t=>Li(t)).join(", ");return"TextRangeGroupGeometry({ id: ".concat(this.id,", ranges: [").concat(e,"], revision: ").concat(this.revision," })")}use(e){return c(this,Gt).use(e)}[Symbol.dispose](){c(this,Gt).dispose()}}Gt=new WeakMap,Vt=new WeakMap,Ue=new WeakMap,mi=new WeakMap,Xt=new WeakMap,Ae=new WeakMap;function Ui(i,e){if(i.kind==="fadeIn"){const t=_n(i.startTime,performance.now(),i.duration);return t===1&&(i.running=!1),{alpha:t,running:i.running}}else if(i.kind==="fadeOut"){const t=1-_n(i.startTime,performance.now(),i.duration);return t===0&&(i.running=!1),{alpha:t,running:i.running}}else throw new An(i.kind)}function _n(i,e,t){return Math.min(1,Math.max((e-i)/t,0))}var Pr=Object.defineProperty,Or=(i,e)=>(e=Symbol[i])?e:Symbol.for("Symbol."+i),oi=i=>{throw TypeError(i)},Gr=(i,e,t)=>e in i?Pr(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,xn=(i,e,t)=>Gr(i,typeof e!="symbol"?e+"":e,t),Ni=(i,e,t)=>e.has(i)||oi("Cannot "+t),d=(i,e,t)=>(Ni(i,e,"read from private field"),e.get(i)),D=(i,e,t)=>e.has(i)?oi("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),U=(i,e,t,n)=>(Ni(i,e,"write to private field"),e.set(i,t),t),ct=(i,e,t)=>(Ni(i,e,"access private method"),t),Vr=(i,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&oi("Object expected");var n;n===void 0&&(n=e[Or("dispose")]),typeof n!="function"&&oi("Object not disposable"),i.push([t,n,e])}return e},Xr=(i,e,t)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(r,o,u,l){return l=Error(u),l.name="SuppressedError",l.error=r,l.suppressed=o,l},s=r=>e=t?new n(r,e,"An error was suppressed during disposal"):(t=!0,r),a=r=>{for(;r=i.pop();)try{var o=r[1]&&r[1].call(r[2]);if(r[0])return Promise.resolve(o).then(a,u=>(s(u),a()))}catch(u){s(u)}if(t)throw e};return a()},Hi,Qi,Jt,ge,C,li,ue,Ce,ae,se,ie,ne,At,Ai,Ne,Bt,z,E,Ye,Z,st,Pe,Zn,jn,Jn,Kn,es,ts;class Yr{constructor(e){D(this,Pe),D(this,Hi,!1),D(this,Qi,!1),D(this,Jt,new DisposableStack),D(this,ge),D(this,C),D(this,li),D(this,ue,new Map),D(this,Ce,new Set),D(this,ae,new Set),D(this,se,new Set),D(this,ie,new Set),D(this,ne,new Set),D(this,At,new Set),D(this,Ai,!0),D(this,Ne,new zr({returnAllDrawables:!d(this,Ai)})),D(this,Bt),D(this,z,new fe),D(this,E),D(this,Ye,!1),D(this,Z),D(this,st,null),U(this,ge,e.canvas),U(this,C,e.canvas.getContext("2d")),U(this,E,e.viewportGeometry),U(this,li,e.oversamplingFactor),U(this,Bt,e.emitRenderMetrics),d(this,Jt).use(m(d(this,z),On(m(d(this,z),In(0))),Vi(t=>({reasons:new Set(t.map(n=>n.reason).filter(K)),immediate:t.some(n=>n.immediate)})),Ys(({reasons:t,immediate:n})=>m(Ls(null),qs(n?Us:lr),Is(()=>d(this,st)?ct(this,Pe,Zn).call(this,d(this,st),[...t].join(", ")):Tt))),Oe(t=>{t&&d(this,z).next({reason:"animation"})})))}add(e){for(const{drawable:t,visible:n,onscreen:s}of e)d(this,Ce).add(t),s&&(d(this,ie).add(t),d(this,ae).add(t)),n||d(this,se).add(t);d(this,z).next({reason:"add-drawable"})}remove(e){for(const t of e)d(this,ie).delete(t),d(this,ne).delete(t),d(this,ae).delete(t),d(this,Ce).delete(t),d(this,Ne).remove(t),d(this,At).add(t);d(this,z).next({reason:"remove-drawable"})}requestRender(e){for(const t of e)d(this,ne).add(t);d(this,z).next({reason:"request-render"})}requestLayout(e,t){U(this,st,t);for(const n of e)d(this,ie).add(n);d(this,z).next({reason:"request-layout",immediate:!0})}setViewport(e,t,n){U(this,st,n),U(this,E,t),d(this,ae).clear(),d(this,ie).clear(),d(this,Ne).clear();for(const s of e)d(this,ie).add(s),d(this,ae).add(s);d(this,z).next({reason:"viewport-change",immediate:!0})}setVisibility(e,t){for(const n of e)t?d(this,se).delete(n)&&d(this,ne).add(n):d(this,se).has(n)||(d(this,se).add(n),d(this,ne).add(n));d(this,z).next({reason:"set-visibility"})}showAllVisible(){if(d(this,Ye)){U(this,Ye,!1),U(this,Z,{kind:"fadeIn",startTime:performance.now(),duration:300,running:!0,metadata:void 0});for(const e of d(this,ae))d(this,ne).add(e);d(this,z).next({reason:"show-all-visible"})}}hideAllVisible(){d(this,Ye)||(U(this,Ye,!0),U(this,Z,void 0),d(this,z).next({reason:"hide-all-visible"}))}[Symbol.dispose](){d(this,Jt).dispose()}}Hi=new WeakMap;Qi=new WeakMap;Jt=new WeakMap;ge=new WeakMap;C=new WeakMap;li=new WeakMap;ue=new WeakMap;Ce=new WeakMap;ae=new WeakMap;se=new WeakMap;ie=new WeakMap;ne=new WeakMap;At=new WeakMap;Ai=new WeakMap;Ne=new WeakMap;Bt=new WeakMap;z=new WeakMap;E=new WeakMap;Ye=new WeakMap;Z=new WeakMap;st=new WeakMap;Pe=new WeakSet;Zn=async function(i,e){var t,n,s,a,r=[];try{const l=Vr(r,$e.startSpan("CanvasRenderer.#render()",{attributes:{reason:e,minimumRevision:i}}));if(d(this,Ye)&&!((t=d(this,Z))!=null&&t.running)){d(this,C).clearRect(0,0,d(this,ge).width,d(this,ge).height);const he={drawablesRenderedOnLastRenderLoop:0,renderedVisibleOnscreenDrawables:new Set,visibleDrawables:d(this,Ce).difference(d(this,se)),allDrawables:new Set(d(this,Ce))};return queueMicrotask(()=>d(this,Bt).call(this,he)),!1}let f=(n=d(this,Z))!=null&&n.running&&d(this,Z).kind==="fadeOut"?d(this,E):await ct(this,Pe,es).call(this,i);const g=d(this,li),p=Be(d(this,E).width*g),v=Be(d(this,E).height*g);if((d(this,ge).width!==p||d(this,ge).height!==v)&&(d(this,ge).width=p,d(this,ge).height=v,f=d(this,E)),(s=d(this,Z))!=null&&s.running&&d(this,Z).kind==="fadeIn"&&(f=d(this,E)),!f)return!1;d(this,C).save(),d(this,C).scale(g,g),d(this,C).translate(-Be(d(this,E).x),-Be(d(this,E).y)),d(this,C).globalCompositeOperation="source-over";const w=d(this,Z)?Ui(d(this,Z)).alpha:1;d(this,C).globalAlpha=w;const k=ct(this,Pe,jn).call(this,f),A=ct(this,Pe,Jn).call(this,f,k);d(this,Qi)&&(d(this,C).strokeStyle="blue",d(this,C).strokeRect(d(this,E).x,d(this,E).y,Math.floor(d(this,E).width),Math.floor(d(this,E).height))),d(this,C).restore();const B={drawablesRenderedOnLastRenderLoop:k.size,renderedVisibleOnscreenDrawables:m(d(this,ae).difference(d(this,se)),P(he=>Dt(d(this,E),he.boundingRect)),P(he=>he.visibleRects.some(wt=>Dt(d(this,E),wt))),oe),visibleDrawables:d(this,Ce).difference(d(this,se)),allDrawables:new Set(d(this,Ce))};return queueMicrotask(()=>d(this,Bt).call(this,B)),A||((a=d(this,Z))==null?void 0:a.running)===!0}catch(l){var o=l,u=!0}finally{Xr(r,o,u)}};jn=function(i){return m((js(i,d(this,E))?d(this,ae):d(this,Ne).getIntersections(i)).difference(d(this,se)),P(e=>Dt(d(this,E),e.boundingRect)),oe)};Jn=function(i,e){return d(this,C).clearRect(i.x,i.y,i.width,i.height),d(this,Hi)&&(d(this,C).strokeStyle="red",d(this,C).strokeRect(i.x,i.y,i.width,i.height)),d(this,C).rect(i.x,i.y,i.width,i.height),d(this,C).clip(),ct(this,Pe,Kn).call(this,e)};Kn=function(i){for(const n of d(this,ue).keys())i.has(n)||d(this,ue).delete(n);for(const n of i)d(this,ue).has(n)||d(this,ue).set(n,n.render(d(this,C)));let e=d(this,ue).size;const t=L(d(this,ue).entries()).sort((n,s)=>n[0].zIndex-s[0].zIndex);for(const[n,s]of t){for(const r of n.opaqueRects)d(this,C).clearRect(r.x,r.y,r.width,r.height);const{done:a}=s.next();a?(e--,d(this,ne).delete(n),d(this,ue).set(n,n.render(d(this,C)))):d(this,ne).add(n)}return e>0};es=async function(i){const e=[];if(d(this,ie).size>0){const n=await ct(this,Pe,ts).call(this,i);n&&e.push(n)}for(const n of d(this,ne))!Zt(n.boundingRect)&&Dt(d(this,E),n.boundingRect)&&(e.push(n.boundingRect),d(this,ne).delete(n));for(const n of d(this,At))d(this,At).delete(n),!Zt(n.boundingRect)&&Dt(d(this,E),n.boundingRect)&&e.push(n.boundingRect);const t=m(e.map(Js(1)),Yi(null));return t&&!Zt(t)?Ks(t,d(this,E)):null};ts=async function(i){if(d(this,ie).size===0)return null;const e=[],t=new Set;for(const s of d(this,ie)){if(d(this,se).has(s)||!d(this,ae).has(s))continue;const a=s.boundingRect;e.push([a,s.layout(i)]),t.add(s),d(this,ie).delete(s),d(this,Ne).remove(s)}const n=await Promise.all(e.map(async([s,a])=>[s,await a]));return d(this,Ne).load(t),m(n,Gi(Oi),P(s=>!Zt(s)),L,Yi(null))};class zr extends Xn{constructor(e){var t;super(),xn(this,"_drawables",new Set),xn(this,"_returnAllDrawables"),this._returnAllDrawables=(t=e.returnAllDrawables)!=null?t:!1}toBBox(e){const t=e.boundingRect;return{minX:t.x,minY:t.y,maxX:t.x+t.width,maxY:t.y+t.height}}compareMinX(e,t){const n=e.boundingRect,s=t.boundingRect;return n.x-s.x}compareMinY(e,t){const n=e.boundingRect,s=t.boundingRect;return n.y-s.y}load(e){const t=oe(e);return t.forEach(n=>this._drawables.add(n)),this._returnAllDrawables?this:super.load(L(t))}insert(e){return this._drawables.add(e),super.insert(e)}remove(e){return this._drawables.delete(e),this._returnAllDrawables?this:super.remove(e)}clear(){var e;return(e=this._drawables)==null||e.clear(),this._returnAllDrawables?this:super.clear()}getIntersections(e){return this._returnAllDrawables?this._drawables:new Set(super.search({minX:e.x,minY:e.y,maxX:e.x+e.width,maxY:e.y+e.height}))}}var Lr=Object.defineProperty,is=i=>{throw TypeError(i)},qr=(i,e,t)=>e in i?Lr(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Ur=(i,e,t)=>qr(i,e+"",t),Zi=(i,e,t)=>e.has(i)||is("Cannot "+t),_=(i,e,t)=>(Zi(i,e,"read from private field"),t?t.call(i):e.get(i)),N=(i,e,t)=>e.has(i)?is("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),G=(i,e,t,n)=>(Zi(i,e,"write to private field"),e.set(i,t),t),bn=(i,e,t)=>(Zi(i,e,"access private method"),t),Bi,kt,rt,Me,Mt,F,Ge,Ve,ke,Ci,Kt,Xe,ei,ns,ss;const Nr="outside",rs=Wn(2);function Ti(i,e){return JSON.stringify([i,e])}function Ii(i){const[e,t]=JSON.parse(i);return{decorationId:e,segmentId:t}}let Hr=0;class Qr{constructor(e){N(this,Xe),N(this,Bi,Yt.createLogger("CanvasTextDecoration")),N(this,kt,new DisposableStack),N(this,rt),N(this,Me),N(this,Mt),N(this,F),N(this,Ge,null),N(this,Ve,null),N(this,ke,null),N(this,Ci,Hr++/1e9),N(this,Kt,0),Ur(this,"id"),this.id=e.decorationId,G(this,rt,e.interactiveGeometryManager),G(this,Me,e.rangesGroup),G(this,F,e.segments.map(t=>({...t,rects:[],rawRects:[]}))),G(this,Mt,e.isFocused),_(this,kt).defer(()=>{e.onDispose(),this.removeInteractiveGeometry()})}get segments(){return _(this,F)}get zIndex(){return _(this,Mt).call(this)?Number.MAX_SAFE_INTEGER:_(this,Kt)+_(this,Ci)}get opaqueRects(){return _(this,Mt).call(this)?this.rects:[]}get boundingRect(){return _(this,Ge)?_(this,Ge):(G(this,Ge,m(_(this,F).flatMap(e=>e.rects),Yi(er()))),_(this,Ge))}get boundingTextRange(){return _(this,Me).boundingRange}get visibleRects(){return _(this,ke)?_(this,ke):(G(this,ke,m(_(this,F),P(e=>!!e.background||!!e.underline),Gi(e=>Rt(e.rects)),L)),_(this,ke))}get rects(){return _(this,Ve)?_(this,Ve):(G(this,Ve,m(_(this,F).flatMap(e=>e.rects),Rt)),_(this,Ve))}toString(){return"CanvasTextDecoration({ id: ".concat(this.id,", rangesGroup: ").concat(_(this,Me)," })")}removeInteractiveGeometry(){for(const e of _(this,F))_(this,rt).remove(Ti(this.id,e.id))}registerInteractiveGeometry(){for(const e of _(this,F))e.interactive?_(this,rt).upsert(Ti(this.id,e.id),e.rects):_(this,rt).remove(Ti(this.id,e.id))}patchSegment(e,{interactive:t,underline:n,background:s}){let a=!1;G(this,F,_(this,F).map(r=>{if(r.id!==e)return r;t!==r.interactive&&(a=!0);const o=n===null?void 0:n!=null?n:r.underline,u=s===null?void 0:s!=null?s:r.background;return{id:r.id,rawRects:r.rawRects,rects:r.rawRects.map(Rn(o)),backgroundAnimation:Zr(s,r),underlineAnimation:jr(n,r),interactive:t!=null?t:r.interactive,underline:o,background:u}})),a&&this.registerInteractiveGeometry(),G(this,ke,null)}async layout(e){if(_(this,Xe,ei))return this.boundingRect;const t=await m(_(this,Me).getGeometry({minimumRevision:e,geometryKind:"rects"}),Ws({success:({rects:n})=>n,failure:n=>(_(this,Bi).error("Unexpected error getting rects - returning empty rects",n),[])}));return _(this,Xe,ei)?this.boundingRect:(G(this,F,m(un(_(this,F),t),L,n=>n.map(([s,a])=>({...s,rawRects:m(a,Rt,r=>r.map(yn(Be))),rects:m(a.map(Rn(s.underline)),Rt,r=>r.map(yn(Be)))})))),this.registerInteractiveGeometry(),G(this,Kt,m(un(_(this,F),_(this,Me).ranges),P(([n])=>!!n.interactive),W(([n,s])=>s.start),L,n=>n.length===0?_(this,Me).ranges.map(s=>s.start):n,n=>n.length===0?0:Math.min(...n))),G(this,Ge,null),G(this,Ve,null),G(this,ke,null),this.boundingRect)}*render(e){if(!_(this,Xe,ei))for(;;){e.save();const t=bn(this,Xe,ns).call(this,e),n=bn(this,Xe,ss).call(this,e);if(e.restore(),t||n)yield;else return}}[Symbol.dispose](){_(this,kt).dispose()}}Bi=new WeakMap;kt=new WeakMap;rt=new WeakMap;Me=new WeakMap;Mt=new WeakMap;F=new WeakMap;Ge=new WeakMap;Ve=new WeakMap;ke=new WeakMap;Ci=new WeakMap;Kt=new WeakMap;Xe=new WeakSet;ei=function(){return _(this,kt).disposed};ns=function(i){var e;let t=!1;for(const n of _(this,F)){const s=n.backgroundAnimation,a=(e=n.background)!=null?e:s!=null&&s.running?s==null?void 0:s.metadata.background:void 0;if(a){if(i.save(),s){const{alpha:r,running:o}=Ui(s);t||(t=o),i.globalAlpha=r}for(const r of n.rawRects)r.width<=0||r.height<=0||(i.fillStyle=a.color,i.fillRect(r.x,r.y,r.width,r.height));i.restore()}}return t};ss=function(i){var e;let t=!1;for(const n of _(this,F)){const s=n.underlineAnimation,a=(e=n.underline)!=null?e:s!=null&&s.running?s==null?void 0:s.metadata.underline:void 0;if(!a)continue;const{underlineThickness:r,verticalOffset:o}=os(n.underline);if(i.save(),s){const{alpha:l,running:f}=Ui(s);t||(t=f),i.globalAlpha=l}for(const l of n.rawRects)l.width<=0||l.height<=0||(i.lineWidth=r,i.strokeStyle=a.color,i.setLineDash(a.style==="dotted"?[r,r]:[]),i.lineCap="butt",i.beginPath(),i.moveTo(l.x,l.y+l.height+o),i.lineTo(l.x+l.width,l.y+l.height+o),i.stroke());i.restore();const u=n.rawRects.at(-1);if(a.style==="ellipsis"&&u){if(u.width<=0||u.height<=0)continue;i.beginPath(),i.lineWidth=0,i.fillStyle=a.color;const l=u.x+u.width,f=u.y+u.height+o,{radius:g,gap:p}=as(r),v=2*Math.PI;i.arc(l+p*1,f,g,0,v),i.arc(l+p*2,f,g,0,v),i.arc(l+p*3,f,g,0,v),i.fill()}}return t};function as(i){return{radius:.6*i,gap:2.5*i}}function Zr(i,e){return i&&!e.background?{kind:"fadeIn",startTime:performance.now(),duration:200,metadata:{background:i},running:!0}:i===null&&e.background?{kind:"fadeOut",startTime:performance.now(),duration:150,metadata:{background:e.background},running:!0}:e==null?void 0:e.backgroundAnimation}function jr(i,e){return i&&!e.underline?{kind:"fadeIn",startTime:performance.now(),duration:200,metadata:{underline:i},running:!0}:i===null&&e.underline?{kind:"fadeOut",startTime:performance.now(),duration:150,metadata:{underline:e.underline},running:!0}:e==null?void 0:e.underlineAnimation}function os(i){var e,t;const n=(e=i==null?void 0:i.thickness)!=null?e:rs,s=(t=i==null?void 0:i.align)!=null?t:Nr,a=Wn(s==="inside"?-n/2:s==="center"?0:n/2);return{underlineThickness:fn(n),verticalOffset:fn(a),align:s}}function Rn(i){return e=>{var t;const{underlineThickness:n,align:s}=os(i),a=s==="center"?n/2:s==="outside"?n:0,r=as((t=i==null?void 0:i.thickness)!=null?t:rs),o=(i==null?void 0:i.style)==="ellipsis"?3*r.gap+r.radius:0;return Qe({...e,height:Be(e.height+a+.5),width:Be(e.width+o+.5)})}}var Jr=(i,e)=>(e=Symbol[i])?e:Symbol.for("Symbol."+i),hi=i=>{throw TypeError(i)},ji=(i,e,t)=>e.has(i)||hi("Cannot "+t),h=(i,e,t)=>(ji(i,e,"read from private field"),t?t.call(i):e.get(i)),S=(i,e,t)=>e.has(i)?hi("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),j=(i,e,t,n)=>(ji(i,e,"write to private field"),e.set(i,t),t),R=(i,e,t)=>(ji(i,e,"access private method"),t),Kr=(i,e,t,n)=>({set _(s){j(i,e,s)},get _(){return h(i,e,n)}}),Je=(i,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&hi("Object expected");var n;n===void 0&&(n=e[Jr("dispose")]),typeof n!="function"&&hi("Object not disposable"),i.push([t,n,e])}return e},Ke=(i,e,t)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(r,o,u,l){return l=Error(u),l.name="SuppressedError",l.error=r,l.suppressed=o,l},s=r=>e=t?new n(r,e,"An error was suppressed during disposal"):(t=!0,r),a=r=>{for(;r=i.pop();)try{var o=r[1]&&r[1].call(r[2]);if(r[0])return Promise.resolve(o).then(a,u=>(s(u),a()))}catch(u){s(u)}if(t)throw e};return a()},H,I,ci,Ie,x,ui,We,be,O,pi,vi,wi,at,di,de,ti,Ze,He,J,je,X,vt,b,ls,hs,cs,us,ds,fs,Wi,Ji,Ki,gs,ms,ps,vs,en,ws,ys,_s,xs,tn,Fi,bs,ot;class Di{constructor(e,t,n,s,a){S(this,b),S(this,H,new DisposableStack),S(this,I),S(this,ci),S(this,Ie),S(this,x,{geometry:null,documentFrameScrolling:!1,windowFrameResizing:!1,windowFrameMoving:!1}),S(this,ui,0),S(this,We),S(this,be),S(this,O,new Map),S(this,pi,new fe),S(this,vi,new fe),S(this,wi,new fe),S(this,at,new Map),S(this,di,new Set),S(this,de,new Set),S(this,ti,null),S(this,Ze,new Set),S(this,He,document.createElement("canvas")),S(this,J,null),S(this,je),S(this,X,{documentScrolling:new fe,windowMoving:new fe,windowResizing:new fe}),S(this,vt,new tr),j(this,je,e),j(this,I,Yt.createLogger("TextDecorationsViewController",n.id)),j(this,ci,a),j(this,Ie,n),h(this,He).style.width="100%",h(this,He).style.height="100%",j(this,We,h(this,H).use(R(this,b,cs).call(this))),j(this,be,h(this,H).use(R(this,b,us).call(this)));const r=m(t,Vi(o=>o!==null),Pn());h(this,H).use(R(this,b,ds).call(this,s,r)),h(this,H).use(R(this,b,fs).call(this)),h(this,H).use(R(this,b,ls).call(this,t)),h(this,H).use(n.geometryWillChange.subscribe(o=>R(this,b,ps).call(this,o))),h(this,H).use(h(this,Ie).textChange.subscribe(o=>R(this,b,ms).call(this,o))),h(this,H).use(m(r,ri(o=>o?pt(h(this,Ie).geometry):Tt),Oe(o=>R(this,b,vs).call(this,o))))}[Symbol.dispose](){h(this,H).dispose()}async upsert(e){var t,n,s;const a=await this.remove([e.id]);if(!a.ok)return a;e.visibility==="visible"&&h(this,de).add(e.id);const r=Et(e.segments);if(!r)return Fe();const o=new AbortController;if(h(this,at).set(e.id,o),await h(this,vt).enqueue({kind:"add",options:e},e.revision),h(this,at).get(e.id)===o&&h(this,at).delete(e.id),o.signal.aborted)return Fe();const u=h(this,We).add({id:e.id,revision:e.revision,ranges:m(r,Fn(g=>({id:g.id,range:g.range,updateSemantics:g.updateSemantics,metadata:void 0}))),metadata:e.id,visible:h(this,de).has(e.id)});if(!u.ok)return u;const l=u.value,f=new Qr({decorationId:e.id,rangesGroup:l,segments:r,interactiveGeometryManager:h(this,be),isFocused:()=>h(this,ti)===e.id,onDispose:()=>{Fs(l),m(this.remove([e.id]),St(mt(g=>h(this,I).error("Error removing decoration during dispose",g))))}});return h(this,O).set(e.id,f),(s=h(this,J))==null||s.add([{drawable:f,visible:h(this,de).has(e.id),onscreen:zi(l.boundingRange,(n=(t=h(this,x).geometry)==null?void 0:t.visibleTextRange)!=null?n:{start:0,end:0})}]),h(this,I).verbose("added ".concat(h(this,de).has(e.id)?"visible":"hidden"," decoration"),e.id),Fe()}remove(e){var t,n=[];try{const r=oe(e);r.forEach(l=>{var f;return(f=h(this,at).get(l))==null?void 0:f.abort()});const o=R(this,b,Wi).call(this,r);if(o.length===0)return ce();const u=Je(n,new DisposableStack);return o.map(l=>{h(this,O).delete(l.id),u.use(l)}),(t=h(this,J))==null||t.remove(o),h(this,I).verbose("removed decorations",o.map(l=>l.id)),ce()}catch(r){var s=r,a=!0}finally{Ke(n,s,a)}}setVisibility(e){var t;const n=oe(e.ids);h(this,We).setVisibility(n,e.visible),n.forEach(a=>e.visible?h(this,de).add(a):h(this,de).delete(a));const s=R(this,b,Wi).call(this,n);return s.length===0?ce():(e.visible?s.forEach(a=>a.registerInteractiveGeometry()):s.forEach(a=>a.removeInteractiveGeometry()),(t=h(this,J))==null||t.setVisibility(s,e.visible),h(this,I).verbose(e.visible?"showing decorations":"hiding decorations",s.map(a=>a.id)),ce())}patchSegment({id:e,segmentId:t,patch:n}){var s;const a=h(this,O).get(e);return a?(a.patchSegment(t,n),(s=h(this,J))==null||s.requestRender([a]),h(this,I).verbose("patched segment ".concat(t," of decoration ").concat(e," with"),n),ce()):ce()}focus(e){return j(this,ti,e),ce()}dispose(){h(this,H).dispose()}}H=new WeakMap;I=new WeakMap;ci=new WeakMap;Ie=new WeakMap;x=new WeakMap;ui=new WeakMap;We=new WeakMap;be=new WeakMap;O=new WeakMap;pi=new WeakMap;vi=new WeakMap;wi=new WeakMap;at=new WeakMap;di=new WeakMap;de=new WeakMap;ti=new WeakMap;Ze=new WeakMap;He=new WeakMap;J=new WeakMap;je=new WeakMap;X=new WeakMap;vt=new WeakMap;b=new WeakSet;ls=function(i){let e=null;return m(i,Pn(),Oe(t=>{if(t){t.appendChild(h(this,He));const{renderer:n,disposable:s}=R(this,b,hs).call(this);j(this,J,n),e=s}else h(this,He).remove(),e&&e[Symbol.dispose](),e=null,j(this,J,null)}))};hs=function(){var i,e,t,n,s,a,r,o,u,l,f=[];try{const v=Je(f,new DisposableStack),w=v.use(new Yr({canvas:h(this,He),oversamplingFactor:1,viewportGeometry:Qe({x:(t=(e=(i=h(this,x).geometry)==null?void 0:i.scrollPosition)==null?void 0:e.x)!=null?t:0,y:(a=(s=(n=h(this,x).geometry)==null?void 0:n.scrollPosition)==null?void 0:s.y)!=null?a:0,width:(o=(r=h(this,x).geometry)==null?void 0:r.documentFrame.width)!=null?o:0,height:(l=(u=h(this,x).geometry)==null?void 0:u.documentFrame.height)!=null?l:0}),emitRenderMetrics:k=>{const A=m(k.renderedVisibleOnscreenDrawables,W(B=>B.id),oe);Gs(A,h(this,di))||(j(this,di,A),m(h(this,je).onVisibleOnscreenDecorationsDidChange(A),St(mt(B=>h(this,I).error("Error sending visible onscreen decorations change",B))))),R(this,b,_s).call(this,k)}}));return h(this,Ze).size>0&&(w.hideAllVisible(),h(this,be).disablePointerEvents()),h(this,O).size>0&&w.add(m(h(this,O).values(),W(k=>{var A,B;return{drawable:k,visible:h(this,de).has(k.id),onscreen:zi(k.boundingTextRange,(B=(A=h(this,x).geometry)==null?void 0:A.visibleTextRange)!=null?B:{start:0,end:0})}}))),R(this,b,en).call(this,w),v.defer(()=>{R(this,b,Ki).call(this,["rendererDisposed"]),h(this,I).verbose("renderer disposed")}),R(this,b,Ji).call(this,["rendererDisposed"]),h(this,I).verbose("renderer created"),{renderer:w,disposable:v.move()}}catch(v){var g=v,p=!0}finally{Ke(f,g,p)}};cs=function(){var i,e;return new Fr({initialRevision:{text:qi,geometry:Xi},initialVisibleTextRange:(e=(i=h(this,x).geometry)==null?void 0:i.visibleTextRange)!=null?e:{start:0,end:0},getRects:t=>m(h(this,je).getRects(t),Ei(({rects:n,revision:s})=>{var a,r;return s.geometry!==((a=h(this,x).geometry)==null?void 0:a.revision)&&((r=h(this,x).geometry)==null?void 0:r.scrollPosition)!==void 0&&h(this,I).warn("Expected document geometry revision ".concat(h(this,x).geometry.revision," to equal revision ").concat(s.geometry," from getRects() response"),{delivery:!1}),{rects:new Map(m(n.entries(),W(([o,u])=>[o,u.map(l=>{var f,g,p,v,w,k;return Qe({...l,x:l.x+((p=(g=(f=h(this,x).geometry)==null?void 0:f.scrollPosition)==null?void 0:g.x)!=null?p:0),y:l.y+((k=(w=(v=h(this,x).geometry)==null?void 0:v.scrollPosition)==null?void 0:w.y)!=null?k:0)})})]))),revision:s}})),getBoundingRects:t=>m(h(this,je).getBoundingRects(t),Ei(({rects:n,revision:s})=>{var a,r;return s.geometry!==((a=h(this,x).geometry)==null?void 0:a.revision)&&((r=h(this,x).geometry)==null?void 0:r.scrollPosition)!==void 0&&h(this,I).warn("Expected document geometry revision ".concat(h(this,x).geometry.revision," to equal revision ").concat(s.geometry," from getRects() response"),{delivery:!1}),{rects:new Map(m(n.entries(),W(([o,u])=>{var l,f,g,p,v,w;return[o,Qe({...u,x:u.x+((g=(f=(l=h(this,x).geometry)==null?void 0:l.scrollPosition)==null?void 0:f.x)!=null?g:0),y:u.y+((w=(v=(p=h(this,x).geometry)==null?void 0:p.scrollPosition)==null?void 0:v.y)!=null?w:0)})]}))),revision:s}})),emitMetrics:t=>R(this,b,ws).call(this,t)})};us=function(){return new xr({label:h(this,Ie).id,pointerMove:Qt(h(this,pi)),pointerDown:Qt(h(this,wi)),pointerUp:Qt(h(this,vi)),getViewport:()=>{var i,e,t,n,s,a,r,o,u,l;return Qe({x:(t=(e=(i=h(this,x).geometry)==null?void 0:i.scrollPosition)==null?void 0:e.x)!=null?t:0,y:(a=(s=(n=h(this,x).geometry)==null?void 0:n.scrollPosition)==null?void 0:s.y)!=null?a:0,width:(o=(r=h(this,x).geometry)==null?void 0:r.documentFrame.width)!=null?o:0,height:(l=(u=h(this,x).geometry)==null?void 0:u.documentFrame.height)!=null?l:0})},compareZIndex:(i,e)=>{const t=Ii(i.geometry),n=Ii(e.geometry),s=h(this,O).get(t.decorationId),a=h(this,O).get(n.decorationId);if(!s||!a)return 0;if(s.zIndex===a.zIndex){const r=s.segments.find(f=>f.id===t.segmentId),o=a.segments.find(f=>f.id===n.segmentId);if(!r||!o)return 0;const u=r.underline?1:0,l=o.underline?1:0;return u-l}return s.zIndex-a.zIndex},emitMetrics:i=>R(this,b,ys).call(this,i)})};ds=function(i,e){var t=[];try{const a=Je(t,new DisposableStack);return a.use(m(e,ri(r=>r?pt(i.pointerEvents):Tt),Oe(r=>m(R(this,b,gs).call(this,r),$s(mt(o=>h(this,I).error("Unexpected error handling pointer event",o))))))),a.use(m(e,ri(r=>r?pt(h(this,be).onPointerEvent):Tt),Oe(r=>void m(R(this,b,bs).call(this,r),St(mt(o=>h(this,I).error("Unexpected error sending pointer events to TextDecorationsViewBackgroundController",o))))))),a.move()}catch(a){var n=a,s=!0}finally{Ke(t,n,s)}};fs=function(){var i=[];try{const n=Je(i,new DisposableStack);for(const[s,a,r]of[[h(this,X).documentScrolling,"documentScrolling",250],[h(this,X).windowMoving,"windowMoving",250],[h(this,X).windowResizing,"windowResizing",250]])n.use(m(s,ri(o=>o==="removeAfterTimeout"?$n(r):Tt),Oe(()=>R(this,b,Ji).call(this,[a]))));return n.move()}catch(n){var e=n,t=!0}finally{Ke(i,e,t)}};Wi=function(i){return m(i,W(e=>h(this,O).get(e)),P(K),L)};Ji=function(i){var e;i.length!==0&&(i.forEach(t=>h(this,Ze).delete(t)),!(h(this,Ze).size>0||h(this,O).size===0)&&(h(this,be).enablePointerEvents(),(e=h(this,J))==null||e.showAllVisible()))};Ki=function(i){var e;const t=h(this,Ze).size>0;i.forEach(n=>h(this,Ze).add(n)),!(t||h(this,O).size===0)&&(h(this,be).disablePointerEvents(),(e=h(this,J))==null||e.hideAllVisible())};gs=function(i){var e,t,n,s,a,r,o,u;const l=Sr({x:i.position.x-((s=(n=(t=(e=h(this,x))==null?void 0:e.geometry)==null?void 0:t.scrollPosition)==null?void 0:n.x)!=null?s:0),y:i.position.y-((u=(o=(r=(a=h(this,x))==null?void 0:a.geometry)==null?void 0:r.scrollPosition)==null?void 0:o.y)!=null?u:0)});switch(i.kind){case"pointermove":return Mi(()=>h(this,pi).next(l));case"pointerdown":return Mi(()=>h(this,wi).next(l));case"pointerup":return Mi(()=>h(this,vi).next(l));default:return Pi(new An(i.kind))}};ms=function(i){var e,t,n,s,a,r=[];try{const l=Je(r,$e.startSpan("TextDecorationsViewController.#handleTextDidChange()",{attributes:{change:i}})),{visibleChanged:f}=h(this,We).pushTextChange(i);h(this,vt).pushNewTextRevision(i.revision);const g=m(f,W(p=>h(this,O).get(p.metadata)),P(K),L);(a=h(this,J))==null||a.requestLayout(g,{text:(e=h(this,vt).textRevision)!=null?e:qi,geometry:(s=(n=(t=h(this,x))==null?void 0:t.geometry)==null?void 0:n.revision)!=null?s:Xi}),g.length>0&&h(this,I).verbose("text changed",{change:i,visibleChangedDecorationsCount:g.length,visibleChangedSegmentsCount:Array.from(g).flatMap(p=>p.segments).length})}catch(l){var o=l,u=!0}finally{Ke(r,o,u)}};ps=function(i){var e=[];try{const s=Je(e,$e.startSpan("TextDecorationsViewController.#handleGeometryWillChange()",{attributes:{event:i}})),a=Et([i.documentFrameScrolling?"documentScrolling":null,i.windowFrameResizing?"windowMoving":null,i.windowFrameResizing?"windowResizing":null].filter(K));a&&(a.includes("documentScrolling")&&h(this,X).documentScrolling.next("cancelRemoval"),a.includes("windowMoving")&&h(this,X).windowMoving.next("cancelRemoval"),a.includes("windowResizing")&&h(this,X).windowResizing.next("cancelRemoval"),R(this,b,Ki).call(this,a))}catch(s){var t=s,n=!0}finally{Ke(e,t,n)}};vs=function(i){var e=[];try{const s=Je(e,$e.startSpan("TextDecorationsViewController.#handleGeometryDidChange()",{attributes:{documentGeometry:i}}));if(i.documentFrameScrolling?h(this,X).documentScrolling.next("cancelRemoval"):h(this,X).documentScrolling.next("removeAfterTimeout"),i.windowFrameMoving?h(this,X).windowMoving.next("cancelRemoval"):h(this,X).windowMoving.next("removeAfterTimeout"),i.windowFrameResizing?h(this,X).windowResizing.next("cancelRemoval"):h(this,X).windowResizing.next("removeAfterTimeout"),j(this,x,i),!i.geometry)return;const{visible:a}=h(this,We).pushDocumentGeometryChange(i.geometry.visibleTextRange,i.geometry.revision);R(this,b,en).call(this,h(this,J),a),h(this,I).verbose("geometry changed",{visibleTextRange:Li(i.geometry.visibleTextRange)})}catch(s){var t=s,n=!0}finally{Ke(e,t,n)}};en=function(i,e){var t,n,s,a,r,o,u,l,f,g,p,v,w;h(this,be).clear();const k=m(e!=null?e:h(this,We).getOnscreenTextRangeGroups(),W(A=>h(this,O).get(A.metadata)),P(K),oe);i==null||i.setViewport(k,Qe({x:(s=(n=(t=h(this,x).geometry)==null?void 0:t.scrollPosition)==null?void 0:n.x)!=null?s:0,y:(o=(r=(a=h(this,x).geometry)==null?void 0:a.scrollPosition)==null?void 0:r.y)!=null?o:0,width:(l=(u=h(this,x).geometry)==null?void 0:u.documentFrame.width)!=null?l:0,height:(g=(f=h(this,x).geometry)==null?void 0:f.documentFrame.height)!=null?g:0}),{text:(p=h(this,vt).textRevision)!=null?p:qi,geometry:(w=(v=h(this,x).geometry)==null?void 0:v.revision)!=null?w:Xi})};ws=function(i){h(this,I).verbose("geometry fetch metrics",i)};ys=function(i){h(this,I).verbose("interactive geometry metrics",i)};_s=function(i){const e=m(i.renderedVisibleOnscreenDrawables,W(s=>s.id),oe),t=m(i.visibleDrawables,W(s=>s.id),oe),n=m(i.allDrawables,W(s=>s.id),oe);h(this,I).verbose("render metrics",{decorationsRenderedOnLastRenderLoop:i.drawablesRenderedOnLastRenderLoop,renderedVisibleOnscreenDecorationCount:e.size,visibleDecorationCount:t.size,allDecorationCount:n.size}),i.drawablesRenderedOnLastRenderLoop>0&&(h(this,ui)===0&&R(this,b,xs).call(this),Kr(this,ui)._++)};xs=async function(){const{revision:i}=await dn(m(pt(h(this,Ie).text),vn(1))),e=await dn(m(pt(h(this,Ie).lastFocusAt),vn(1))),t=(zs()-e)/1e3;h(this,ci).duration("first_decoration_render",{labels:{revision_history_info:i<=1?"initial":i<10?"early":"late"}}).close(null,{durationInSeconds:t})};tn=function(i){var e,t,n,s,a,r,o,u,l,f;return Er({x:i.x-((n=(t=(e=h(this,x).geometry)==null?void 0:e.scrollPosition)==null?void 0:t.x)!=null?n:0)+((a=(s=h(this,x).geometry)==null?void 0:s.documentFrame.x)!=null?a:0),y:i.y-((u=(o=(r=h(this,x).geometry)==null?void 0:r.scrollPosition)==null?void 0:o.y)!=null?u:0)+((f=(l=h(this,x).geometry)==null?void 0:l.documentFrame.y)!=null?f:0)})};Fi=function(i){return Cr({...R(this,b,tn).call(this,i),width:i.width,height:i.height})};bs=function(i){return h(this,je).onSegmentPointerEvents({pointerEnter:R(this,b,ot).call(this,i.pointerEnter),pointerLeave:R(this,b,ot).call(this,i.pointerLeave),pointerDown:R(this,b,ot).call(this,i.pointerDown),pointerUp:R(this,b,ot).call(this,i.pointerUp),pointerClick:R(this,b,ot).call(this,i.pointerClick)})};ot=function(i){var e,t,n,s,a,r,o;if(!i)return;const{decorationId:u,segmentId:l}=Ii(i.target),f=h(this,O).get(u),g=Et((n=(t=(e=f==null?void 0:f.segments)==null?void 0:e.find(w=>w.id===l))==null?void 0:t.rects)!=null?n:[]),p=Br((a=(s=h(this,x).geometry)==null?void 0:s.viewportFrame)!=null?a:{x:0,y:0}),v=Dr((o=(r=h(this,x).geometry)==null?void 0:r.windowFrame)!=null?o:{x:0,y:0});return!f||!g?void 0:{kind:i.kind,segmentId:l,id:u,position:R(this,b,tn).call(this,i.position),rect:R(this,b,Fi).call(this,i.currentTarget),decorationRects:f.rects.map(w=>R(this,b,Fi).call(this,w)),viewportOffset:p,windowOffset:v}};var Rs={exports:{}},yi={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ea=Cn,ta=Symbol.for("react.element"),ia=Symbol.for("react.fragment"),na=Object.prototype.hasOwnProperty,sa=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,ra={key:!0,ref:!0,__self:!0,__source:!0};function Ms(i,e,t){var n,s={},a=null,r=null;t!==void 0&&(a=""+t),e.key!==void 0&&(a=""+e.key),e.ref!==void 0&&(r=e.ref);for(n in e)na.call(e,n)&&!ra.hasOwnProperty(n)&&(s[n]=e[n]);if(i&&i.defaultProps)for(n in e=i.defaultProps,e)s[n]===void 0&&(s[n]=e[n]);return{$$typeof:ta,type:i,key:a,ref:r,props:s,_owner:sa.current}}yi.Fragment=ia;yi.jsx=Ms;yi.jsxs=Ms;Rs.exports=yi;var aa=Rs.exports;const oa=({documentId:i,width:e,height:t,onMount:n})=>aa.jsx("div",{"data-document-id":i,style:{width:e,height:t},ref:n});var la=(i,e)=>(e=Symbol[i])?e:Symbol.for("Symbol."+i),Mn=i=>{throw TypeError(i)},ha=(i,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&Mn("Object expected");var n;n===void 0&&(n=e[la("dispose")]),typeof n!="function"&&Mn("Object not disposable"),i.push([t,n,e])}return e},ca=(i,e,t)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(r,o,u,l){return l=Error(u),l.name="SuppressedError",l.error=r,l.suppressed=o,l},s=r=>e=t?new n(r,e,"An error was suppressed during disposal"):(t=!0,r),a=r=>{for(;r=i.pop();)try{var o=r[1]&&r[1].call(r[2]);if(r[0])return Promise.resolve(o).then(a,u=>(s(u),a()))}catch(u){s(u)}if(t)throw e};return a()};const $i=si(),Ya=i=>{const e=i.getExecutionScopeDefinition("document-session");return m(ni([i.getPlugin("document-session"),i.getPlugin("monitoring")]),Bn(([t,n])=>lt.all([e.register({token:Xs,useFactory:s=>m(ni([s.resolve(t.provides.TextDocumentInfo),s.resolve($i)]),xe(([a,r])=>o=>Cn.createElement(oa,{...o,documentId:a.id,onMount:u=>r.next(u)})))},{lifetime:ht.Singleton}),ua(e,t,n)])))};function ua(i,e,t){var n=[];try{const r=ha(n,new DisposableStack),o=si();return m(ur({scopeDefinition:i,remoteEntityToken:Vs,localEntityToken:o}),lt.use(r),Bn(({remoteEntityToken:u})=>lt.all([i.register({token:$i,useFactory:()=>Fe(new Ps(null))},{lifetime:ht.Singleton}),i.register({token:o,useFactory:l=>m(l.resolve(Di),xe(f=>({entity:f,disposable:f})))},{lifetime:ht.Singleton}),i.register({token:Di,useFactory:rr(Di,[u,$i,e.provides.TextDocumentInfo,Os,t.provides.Monitoring])},{lifetime:ht.Singleton})])),lt.use(r),xe(()=>r.move()))}catch(r){var s=r,a=!0}finally{ca(n,s,a)}}export{Ya as activate};
//# sourceMappingURL=index-BgMZtk9B.js.map
