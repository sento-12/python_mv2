import{S as A,l as L,p as S,t as P,b as N,d as U,e as $,R as Q,s as C,g as q,h as z,i as G,L as M,m as O}from"./start-C5OgI2kj.js";import{CAPISuggestionProviderToken as W,CAPISuggestionCollectionToken as B}from"./index-DfGR_rCK.js";import{t as x}from"./subscribable-Cqm5UN_u-CZjzLfrM.js";import{T as H}from"./TextRevisionSynchronizedQueue-DQV4bu5q-uUfvwyBY.js";import{c as k}from"./TextRevisionFns-DGbJAFcL-DX1ABpMm.js";import{d as K}from"./defineFactory-DJYNRBNc-BjUmrCbc.js";import"./PluginModule-CRib3PLZ-rw_nkrD1.js";var V=Object.defineProperty,T=t=>{throw TypeError(t)},X=(t,e,i)=>e in t?V(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,R=(t,e,i)=>X(t,typeof e!="symbol"?e+"":e,i),I=(t,e,i)=>e.has(t)||T("Cannot "+i),s=(t,e,i)=>(I(t,e,"read from private field"),i?i.call(t):e.get(t)),l=(t,e,i)=>e.has(t)?T("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),w=(t,e,i,r)=>(I(t,e,"write to private field"),e.set(t,i),i),_=(t,e,i)=>(I(t,e,"access private method"),i),p,c,a,m,h,f,v,d,u,y,D,E,F;class Y{constructor(e,i){l(this,u),l(this,p),l(this,c,new DisposableStack),l(this,a,new Map),l(this,m,new A),l(this,h,new A),l(this,f),l(this,v,new H),l(this,d,null),R(this,"onSuggestionUpserted",x(s(this,m))),R(this,"onSuggestionRemoved",x(s(this,h))),w(this,f,e),w(this,p,L.createLogger("CAPISuggestionProvider",e.id)),s(this,c).use(i.status.subscribe(r=>{if(r.kind==="connected"&&w(this,d,r.sessionId),r.kind==="connected"&&r.isNewSession){const o=S(s(this,a).entries(),U(([n,{sessionId:g}])=>g!==r.sessionId),N(([n])=>n),P);s(this,h).next(o),o.forEach(n=>s(this,a).delete(n)),s(this,p).verbose("Reset alert collection for document ".concat(s(this,f).id," and session ID ").concat(r.sessionId))}})),s(this,c).use(s(this,v).messages.subscribe(r=>_(this,u,y).call(this,r))),s(this,c).use(i.events.subscribe(r=>s(this,v).enqueue(r,"rev"in r?k(r.rev):void 0))),s(this,c).use(e.text.subscribe(({revision:r})=>s(this,v).pushNewTextRevision(r))),s(this,c).defer(()=>{s(this,h).next(P(s(this,a).keys())),s(this,a).clear(),s(this,p).verbose("Clear alert collection for document ".concat(s(this,f).id))})}[Symbol.dispose](){s(this,c).dispose()}}p=new WeakMap;c=new WeakMap;a=new WeakMap;m=new WeakMap;h=new WeakMap;f=new WeakMap;v=new WeakMap;d=new WeakMap;u=new WeakSet;y=function(t){switch(t.action){case"alert":return _(this,u,D).call(this,t);case"alert_changes":return _(this,u,E).call(this,t);case"remove":return _(this,u,F).call(this,t);default:return}};D=function({action:t,...e}){if(s(this,d)===null)return;const i=String(e.id),r={id:i,kind:"capi",revision:k(e.rev),transforms:b(e),alert:e};s(this,a).set(i,{alert:e,sessionId:s(this,d)}),s(this,m).next([r])};E=function({action:t,...e}){var i;if(s(this,d)===null)return;const r=String(e.id),{alert:o}=(i=s(this,a).get(r))!=null?i:{};if(!o)return;const n={...o,...e},g={id:r,kind:"capi",revision:k(e.rev),transforms:b(e),alert:n};s(this,a).set(r,{alert:n,sessionId:s(this,d)}),s(this,m).next([g])};F=function(t){const e=String(t.id);s(this,a).delete(e),s(this,h).next([e])};function b(t){if(t.transformJson){const e=t.transformJson.context;return[{context:{start:e.s,end:e.e},alternatives:t.transformJson.alternatives}]}else return t.subalerts?t.subalerts.flatMap(b):[]}const ae=t=>S(G([C(t.getExecutionScopeDefinition("document-session")),t.getPlugin("document-session"),t.getPlugin("suggestion"),t.getPlugin("capi")]),$(([e,i,r,o])=>Q.all([...Z(e,i,o,r),C(e.onStart(n=>S(q([n.resolve(r.provides.SuggestionManager),n.resolve(W)]),z(([g,J])=>g.register(J)))))])));function Z(t,e,i,r){return[t.register({token:W,useFactory:K(Y,[e.provides.TextDocument,i.provides.CAPIConnection])},{lifetime:M.Singleton}),t.register({token:B,useFactory:o=>S(o.resolve(r.provides.SuggestionManager),O(n=>n.getCollection("capi")))},{lifetime:M.Singleton})]}export{ae as activate};
//# sourceMappingURL=index-B-9hfcHZ.js.map
