import{k as se,z as pt,l as H,p as h,h as ye,b as ct,B as Ke,S as I,s as re,f as Q,v as dt,m as O,C as Je,A as V,D as K,G as he,H as x,I as Bt,e as mt,y as Nt,_ as Lt,i as gt,J as Ut,r as zt,n as Jt,q as Ht,R as ht,w as Qt,L as y,E as Yt,c as Kt}from"./start-C5OgI2kj.js";import{ConnectorMessageTransportToken as ft,ConnectorToken as Xt,ConnectorDocumentManagerToken as Xe,ConnectorTextDecorationToken as vt,ConnectorExperimentationToken as Zt,ConnectorCAPIToken as lt,CAPIProviderToken as jt}from"./index-D6ls8lv3.js";import{D as Dt}from"./Delta-D-dso3t3-B1UydhvC.js";import{a as wt}from"./subscribableState-Y8YW7N9Z-BMiZmink.js";import{t as D,o as qt,a as Ze}from"./subscribable-Cqm5UN_u-CZjzLfrM.js";import{c as Ie,u as es,a as ts}from"./RectFns-ndpeBtT0-CdOd3O5S.js";import{c as ss}from"./PointFns-Cqc_hcsO-DfLreJud.js";import{c as ns}from"./TextRevisionFns-DGbJAFcL-DX1ABpMm.js";import{L as is}from"./LRUCache-BkqKFOuj-CuqiGFzI.js";import{a as os}from"./asap-CWISApvk.js";import{D as as}from"./CAPIWebSocketTransport-BECrZbf6-B0GFkT4q.js";import{c as rs}from"./concat-jxnVidBz.js";import{d as cs}from"./defer-D8jHAjAi.js";import{o as ds}from"./of-BeKGPQlf.js";import{E as hs}from"./mergeAll-jza3F776.js";import{R as ls}from"./RandomSampler-Ba-P263P-DyiLAlld.js";import{T as us}from"./TextRevisionSynchronizedQueue-DQV4bu5q-uUfvwyBY.js";import{d as T}from"./defineFactory-DJYNRBNc-BjUmrCbc.js";import"./PluginModule-CRib3PLZ-rw_nkrD1.js";import"./PluginDependency-Boc6-pxl-tjuTwLTj.js";import"./AsyncScheduler-DuJTneVg.js";var _t=s=>{throw TypeError(s)},nt=(s,e,t)=>e.has(s)||_t("Cannot "+t),S=(s,e,t)=>(nt(s,e,"read from private field"),t?t.call(s):e.get(s)),xe=(s,e,t)=>e.has(s)?_t("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),ps=(s,e,t,n)=>(nt(s,e,"write to private field"),e.set(s,t),t),ut=(s,e,t)=>(nt(s,e,"access private method"),t),le,A,X,Me,je;class $e{constructor(e,t){xe(this,Me),xe(this,le),xe(this,A,new Map),xe(this,X,new DisposableStack),ps(this,le,e),S(this,X).use(S(this,le).messages.subscribe(n=>ut(this,Me,je).call(this,n.message).next(n))),S(this,X).use(t.documentWillDestroy.subscribe(n=>{se(S(this,A).get(n.id)),S(this,A).delete(n.id)})),S(this,X).defer(()=>{se(S(this,A).values()),S(this,A).clear()})}create(e){return{messages:ut(this,Me,je).call(this,{documentID:e}),send:t=>S(this,le).send({...t,documentID:e})}}[Symbol.dispose](){S(this,X).dispose()}}le=new WeakMap;A=new WeakMap;X=new WeakMap;Me=new WeakSet;je=function(s){const e=s.documentID;let t=S(this,A).get(e);return t||(t=new pt,S(this,A).set(e,t)),t};var ms=Object.defineProperty,Ct=s=>{throw TypeError(s)},gs=(s,e,t)=>e in s?ms(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,l=(s,e,t)=>gs(s,typeof e!="symbol"?e+"":e,t),St=(s,e,t)=>e.has(s)||Ct("Cannot "+t),p=(s,e,t)=>(St(s,e,"read from private field"),t?t.call(s):e.get(s)),Ee=(s,e,t)=>e.has(s)?Ct("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),He=(s,e,t,n)=>(St(s,e,"write to private field"),e.set(s,t),t),Te,P,Z,W;class fs{constructor(e,t={}){Ee(this,Te,new DisposableStack),l(this,"id"),l(this,"hasFocusSubject",new Ke(!1)),l(this,"geometryWillChangeSubject",new I),l(this,"geometryDidChangeSubject",new I),l(this,"textDidChangeSubject",new I),l(this,"selectionDidChangeSubject",new I),l(this,"hasFocus",wt(this.hasFocusSubject)),l(this,"geometryWillChange",D(this.geometryWillChangeSubject)),l(this,"geometryDidChange",D(this.geometryDidChangeSubject)),l(this,"textDidChange",D(this.textDidChangeSubject)),l(this,"selectionDidChange",D(this.selectionDidChangeSubject)),l(this,"settings"),this.id=e,this.settings=t,p(this,Te).defer(()=>{this.hasFocusSubject.complete(),this.geometryDidChangeSubject.complete(),this.geometryWillChangeSubject.complete(),this.selectionDidChangeSubject.complete(),this.textDidChangeSubject.complete(),this.selectionDidChangeSubject.complete()})}[Symbol.dispose](){p(this,Te).dispose()}}Te=new WeakMap;class Qe{constructor(e,t){Ee(this,P),Ee(this,Z),Ee(this,W),l(this,"id"),l(this,"hasFocus"),l(this,"geometryWillChange"),l(this,"geometryDidChange"),l(this,"textDidChange"),l(this,"selectionDidChange"),He(this,Z,H.createLogger("RemoteDocument",e.id)),He(this,W,e),He(this,P,t),this.id=e.id,this.hasFocus=e.hasFocus,this.geometryWillChange=e.geometryWillChange,this.geometryDidChange=e.geometryDidChange,this.textDidChange=e.textDidChange,this.selectionDidChange=e.selectionDidChange}[Symbol.dispose](){p(this,W)[Symbol.dispose]()}async getText(){return await h(p(this,P).getDocumentText({documentID:p(this,W).id}),ye(e=>({revision:e.revision,content:new Dt(e.document.ops)})))}async setText(e){return await p(this,P).applyDocumentTextChange({documentID:p(this,W).id,revision:e.revision,changes:e.change})}async setSelection(e,t){return await p(this,P).setDocumentSelectedTextRanges({documentID:p(this,W).id,revision:e,ranges:t})}getGeometry(){return h(p(this,P).getDocumentGeometry({documentID:p(this,W).id}),ye(e=>{var t;return{windowFrame:Ie(e.windowFrame),viewportFrame:Ie(e.viewportFrame),documentFrame:Ie(e.documentFrame),visibleTextRange:(t=e.visibleTextRange)!=null?t:{start:0,end:1/0},scrollPosition:e.documentScrollOffset?ss(e.documentScrollOffset):void 0}}))}getRectsForRanges(e,t){return t.size===0&&p(this,Z).warn("getRectsForRanges() is called with an empty range map."),h(p(this,P).getBoundingBoxesForTextRanges({documentID:p(this,W).id,revision:e,ranges:Object.fromEntries(t)}),ye(n=>({rects:new Map(h(t.keys(),ct(c=>{const r=n.boundingBoxes[c];return r||p(this,Z).warn("No bounding box found for range with id: ".concat(c)),[c,(r!=null?r:[]).map(i=>Ie(i))]}))),textRevision:ns(n.revision)})))}getBoundingRectForRanges(e,t){return t.size===0&&p(this,Z).warn("getBoundingRectForRanges() is called with an empty range map."),h(this.getRectsForRanges(e,t),ye(n=>({rects:new Map(h(n.rects.entries(),ct(([c,r])=>[c,h(r,es(ts()))]))),textRevision:n.textRevision})))}}P=new WeakMap;Z=new WeakMap;W=new WeakMap;var vs=Object.defineProperty,Ds=(s,e)=>(e=Symbol[s])?e:Symbol.for("Symbol."+s),Ue=s=>{throw TypeError(s)},ws=(s,e,t)=>e in s?vs(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,$=(s,e,t)=>ws(s,typeof e!="symbol"?e+"":e,t),it=(s,e,t)=>e.has(s)||Ue("Cannot "+t),a=(s,e,t)=>(it(s,e,"read from private field"),t?t.call(s):e.get(s)),g=(s,e,t)=>e.has(s)?Ue("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),G=(s,e,t,n)=>(it(s,e,"write to private field"),e.set(s,t),t),v=(s,e,t)=>(it(s,e,"access private method"),t),_s=(s,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&Ue("Object expected");var n;n===void 0&&(n=e[Ds("dispose")]),typeof n!="function"&&Ue("Object not disposable"),s.push([t,n,e])}return e},Cs=(s,e,t)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(i,w,b,_){return _=Error(b),_.name="SuppressedError",_.error=i,_.suppressed=w,_},c=i=>e=t?new n(i,e,"An error was suppressed during disposal"):(t=!0,i),r=i=>{for(;i=s.pop();)try{var w=i[1]&&i[1].call(i[2]);if(i[0])return Promise.resolve(w).then(r,b=>(c(b),r()))}catch(b){c(b)}if(t)throw e};return r()},oe,ne,ue,B,we,ae,_e,pe,ot,Pe,E,m,kt,bt,yt,It,xt,Rt,Wt,Mt,Se,$t,N,j;const Ss="ca77b3794901e345f5f1a3c5872169ec06411679: O Grammarly, O Grammarly, wherefore art thou open devtools? Deny thy debugger and refuse thy console.log; Or, if thou wilt not, be but sworn my love, And I'll no longer be a developer.";class q{constructor(e,t){g(this,m),g(this,oe,H.createLogger("ConnectorDocumentManager")),g(this,ne,new DisposableStack),g(this,ue),g(this,B,a(this,ne).use(new is({capacity:10}))),g(this,we,new I),g(this,ae,new I),g(this,_e,new Ke(!1)),g(this,pe,0),g(this,ot,new Ke(null)),g(this,Pe,{}),g(this,E,null),$(this,"documentDidCreate",D(h(a(this,we),qt(os)))),$(this,"documentWillDestroy",D(a(this,ae))),$(this,"debugEnabled",wt(a(this,_e))),$(this,"handler",{echo:i=>V(i),cancel:()=>V(),documentDidFocus:i=>v(this,m,Wt).call(this,i,a(this,Pe)),documentDidDestroy:i=>K(v(this,m,Mt).call(this,i)),documentGeometryWillChange:i=>K(v(this,m,yt).call(this,i)),documentGeometryDidChange:i=>K(v(this,m,Rt).call(this,i)),documentTextDidChange:i=>K(v(this,m,It).call(this,i)),documentSelectedTextRangesDidChange:i=>K(v(this,m,xt).call(this,i)),handshake:async i=>(G(this,Pe,i.options),i.protocolVersion!==a(this,pe)?he(new ks({protocolVersion:i.protocolVersion,expectedProtocolVersion:a(this,pe)})):re({client:a(this,ue).name,version:a(this,ue).version,protocolVersion:a(this,pe),options:{}}))});var n=[];try{G(this,ue,t);const i=_s(n,new DisposableStack);i.defer(()=>{a(this,we).complete(),a(this,ae).complete(),a(this,_e).complete()}),a(this,ne).use(i.move())}catch(i){var c=i,r=!0}finally{Cs(n,c,r)}}[Symbol.dispose](){a(this,ne).dispose()}getRemoteDocument(e){const t=a(this,B).get(e);return t?re(t):Q(new ce(e))}}oe=new WeakMap;ne=new WeakMap;ue=new WeakMap;B=new WeakMap;we=new WeakMap;ae=new WeakMap;_e=new WeakMap;pe=new WeakMap;ot=new WeakMap;Pe=new WeakMap;E=new WeakMap;m=new WeakSet;kt=function(s){var e;((e=a(this,E))==null?void 0:e.id)===s&&G(this,E,null);const t=a(this,B).get(s);return t?(t[Symbol.dispose](),a(this,B).delete(s),x(()=>a(this,ae).next(t))):Q(new ce(s))};bt=function(s,e){var t;return((t=a(this,E))==null?void 0:t.id)===s&&G(this,E,null),e[Symbol.dispose](),x(()=>a(this,ae).next(e))};yt=function(s){const e=v(this,m,Se).call(this,s.documentID);return e?x(()=>e.geometryWillChangeSubject.next(new Set(s.reasons))):Q(new ce(s.documentID))};It=function(s){const e=v(this,m,Se).call(this,s.documentID);if(!e)return Q(new ce(s.documentID));const t=s.changes.ops.find(n=>"insert"in n&&typeof n.insert=="string");if(t&&String(t.insert).includes(Ss))try{a(this,_e).next(!0)}catch{}return x(()=>e.textDidChangeSubject.next({revision:s.revision,change:new Dt(s.changes.ops)}))};xt=function(s){const e=v(this,m,Se).call(this,s.documentID);return e?x(()=>e.selectionDidChangeSubject.next(s.ranges)):Q(new ce(s.documentID))};Rt=function(s){const e=v(this,m,Se).call(this,s.documentID);return e?x(()=>e.geometryDidChangeSubject.next(new Set(s.reasons))):Q(new ce(s.documentID))};Wt=function(s,e){return Bt(async t=>{const n=s?s.documentID:null;t(x(()=>a(this,ot).next(n)));const c=a(this,E);if(n===null)return c!==null&&(t(x(()=>c.hasFocusSubject.next(!1))),a(this,oe).verbose({context:c.id},"Document blurred"),G(this,E,null)),V();let r=a(this,B).get(n);return r||(r=await t(v(this,m,$t).call(this,n,e))),c!==null&&r.id!==c.id&&(a(this,oe).verbose({context:c.id},"Document blurred"),t(x(()=>c.hasFocusSubject.next(!1)))),G(this,E,r),t(x(()=>r.hasFocusSubject.next(!0))),a(this,oe).verbose({context:r.id},"Document focused"),V()})};Mt=function(s){return v(this,m,kt).call(this,s.documentID)};Se=function(s){return a(this,B).get(s)};$t=function(s,e){a(this,oe).verbose({context:s},"Document created");const t=a(this,ne).use(new fs(s,e)),n=a(this,B).set(s,t);if(n){const[c,r]=n,i=v(this,m,bt).call(this,c,r);if(!i.ok)return i}return h(x(()=>a(this,we).next(t)),O(()=>t))};class Ye{constructor(e,t){g(this,N),g(this,j),$(this,"debugEnabled"),$(this,"documentDidCreate"),$(this,"documentWillDestroy"),G(this,N,e),G(this,j,t.createClient()),this.debugEnabled=a(this,N).debugEnabled,this.documentDidCreate=h(Ze(a(this,N).documentDidCreate),dt(n=>new Qe(n,a(this,j))),D),this.documentWillDestroy=h(Ze(a(this,N).documentWillDestroy),dt(n=>new Qe(n,a(this,j))),D)}getRemoteDocument(e){return h(a(this,N).getRemoteDocument(e),O(t=>new Qe(t,a(this,j))))}}N=new WeakMap;j=new WeakMap;class ce extends Je{constructor(e){super("Document not found"),this.documentId=e}toJSON(){return{...super.toJSON(),documentId:this.documentId}}}class ks extends Je{constructor(e){super("Unsupported protocol version"),$(this,"protocolVersion"),$(this,"expectedProtocolVersion"),this.protocolVersion=e.protocolVersion,this.expectedProtocolVersion=e.expectedProtocolVersion}toJSON(){return{...super.toJSON(),protocolVersion:this.protocolVersion,expectedProtocolVersion:this.expectedProtocolVersion}}}var bs=Object.defineProperty,Et=s=>{throw TypeError(s)},ys=(s,e,t)=>e in s?bs(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ze=(s,e,t)=>ys(s,typeof e!="symbol"?e+"":e,t),at=(s,e,t)=>e.has(s)||Et("Cannot "+t),o=(s,e,t)=>(at(s,e,"read from private field"),t?t.call(s):e.get(s)),k=(s,e,t)=>e.has(s)?Et("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),qe=(s,e,t,n)=>(at(s,e,"write to private field"),e.set(s,t),t),Is=(s,e,t)=>(at(s,e,"access private method"),t),Fe,M,me,et,L,U,Ae,Ce,tt,Tt,F,C,z;class Oe{constructor(e,t){k(this,Fe,new DisposableStack),k(this,M,new I),k(this,me,new Set),k(this,et,H.createLogger("ConnectorCAPI")),k(this,L),k(this,U),ze(this,"messages",D(o(this,M))),ze(this,"handler",{capiConnected:async n=>h(o(this,L).getRemoteDocument(n.documentID),O(()=>{o(this,me).add(n.sessionID),o(this,M).next({kind:"connected",message:n})})),capiDisconnected:async n=>h(o(this,L).getRemoteDocument(n.documentID),O(()=>{o(this,me).delete(n.sessionID),o(this,M).next({kind:"disconnected",message:n})})),capiMessageReceived:async n=>h(o(this,L).getRemoteDocument(n.documentID),O(()=>o(this,M).next({kind:"messageReceived",message:n}))),capiAlertRemoved:async n=>h(o(this,L).getRemoteDocument(n.documentID),mt(()=>o(this,me).has(n.sessionID)?re(o(this,M).next({kind:"messageReceived",message:{documentID:n.documentID,sessionID:n.sessionID,message:{id:parseInt(n.alertID),action:"remove"}}})):(o(this,et).warn("Received capiAlertRemoved for disconnected session ".concat(n.sessionID)),Q(new Rs(n.sessionID))))),capiTextRevision:n=>V(o(this,M).next({kind:"textRevision",message:n})),capiWebSocketCreate:n=>o(this,U).handleCreate(n),capiWebSocketSend:n=>o(this,U).handleSend(n),capiWebSocketConnect:n=>o(this,U).handleConnect(n),capiWebSocketClose:n=>o(this,U).handleClose(n)}),qe(this,L,e),qe(this,U,t),o(this,Fe).defer(()=>o(this,M).complete())}[Symbol.dispose](){o(this,Fe).dispose()}}Fe=new WeakMap;M=new WeakMap;me=new WeakMap;et=new WeakMap;L=new WeakMap;U=new WeakMap;class xs{constructor(e,t,n){k(this,tt),k(this,Ae,new DisposableStack),k(this,Ce),ze(this,"messages"),qe(this,Ce,e.createClient()),this.messages=t.messages,o(this,Ae).use(n.outboundMessages.subscribe(c=>Is(this,tt,Tt).call(this,c)))}[Symbol.dispose](){o(this,Ae).dispose()}send(e){return o(this,Ce).sendCapiMessage(e)}}Ae=new WeakMap;Ce=new WeakMap;tt=new WeakSet;Tt=function(s){const e=o(this,Ce)[s.method];e(s.data)};class Re{constructor(){k(this,F,new DisposableStack),k(this,C,new Map),k(this,z,new I),ze(this,"outboundMessages",D(o(this,z))),o(this,F).defer(()=>{for(const e of o(this,C).values())e[Symbol.dispose]();o(this,C).clear()})}[Symbol.dispose](){o(this,F).dispose()}handleCreate(e){const t=new as(e.endpointUrl);return o(this,C).set(e.documentID,t),o(this,F).use(t.didOpen.subscribe(()=>{o(this,z).next({method:"capiWebSocketOpened",data:{documentID:e.documentID}})})),o(this,F).use(t.didClose.subscribe(n=>{o(this,z).next({method:"capiWebSocketClosed",data:{documentID:e.documentID,code:n.code,reason:n.reason,wasClean:n.wasClean}})})),o(this,F).use(t.messageReceived.subscribe(n=>{o(this,z).next({method:"capiWebSocketMessage",data:{documentID:e.documentID,data:n.data}})})),o(this,F).use(t.didError.subscribe(()=>{o(this,z).next({method:"capiWebSocketError",data:{documentID:e.documentID,message:"An error occurred in the web socket connection."}})})),V()}handleConnect(e){if(o(this,C).has(e.documentID)){const t=o(this,C).get(e.documentID);if(t)return t.connect(),V()}return he(new Error("No socket found"))}handleClose(e){if(o(this,C).has(e.documentID)){const t=o(this,C).get(e.documentID);if(t)return t.close(),o(this,C).delete(e.documentID),t[Symbol.dispose](),V()}return he(new Error("No socket found"))}handleSend(e){if(o(this,C).has(e.documentID)){const t=o(this,C).get(e.documentID);return t?K(t.send(e.data)):he(new Error("Failed to send message"))}return he(new Error("No socket found"))}}F=new WeakMap;C=new WeakMap;z=new WeakMap;class Rs extends Je{constructor(e){super("Unknown CAPI session ID"),this.sessionId=e}toJSON(){return{...super.toJSON(),sessionId:this.sessionId}}}var Ws=Object.defineProperty,Pt=s=>{throw TypeError(s)},Ms=(s,e,t)=>e in s?Ws(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,$s=(s,e,t)=>Ms(s,e+"",t),Ft=(s,e,t)=>e.has(s)||Pt("Cannot "+t),f=(s,e,t)=>(Ft(s,e,"read from private field"),t?t.call(s):e.get(s)),ie=(s,e,t)=>e.has(s)?Pt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),st=(s,e,t,n)=>(Ft(s,e,"write to private field"),e.set(s,t),t),ge,fe,Ve,ee,Ge,Be;class Ne{constructor(e){ie(this,ge,new DisposableStack),ie(this,fe,new I),ie(this,Ve),ie(this,ee,new Map),$s(this,"handler",{setTextDecorationVisibility:async t=>h(f(this,Ve).getRemoteDocument(t.documentID),O(n=>{let c=f(this,ee).get(n.id);c||(c=new Map,f(this,ee).set(n.id,c)),t.partial||c.clear(),t.changes.forEach(r=>{r.visibility==="hidden"?c.delete(r.alertId):c.set(r.alertId,r)}),f(this,fe).next(t)}))}),st(this,Ve,e),f(this,ge).use(e.documentWillDestroy.subscribe(t=>{f(this,ee).delete(t.id)})),f(this,ge).defer(()=>f(this,fe).complete())}getTextDecorationVisibilityChangeRequests(e){return h(rs(cs(()=>{var t;const n=(t=f(this,ee).get(e))!=null?t:new Map;return n.size>0?ds({documentId:e,partial:!1,changes:Array.from(n.values())}):hs}),h(f(this,fe),Nt(t=>t.documentID===e))),D)}[Symbol.dispose](){f(this,ge).dispose()}}ge=new WeakMap;fe=new WeakMap;Ve=new WeakMap;ee=new WeakMap;class Es{constructor(e,t){ie(this,Ge),ie(this,Be),st(this,Ge,e.createClient()),st(this,Be,t)}getTextDecorationVisibilityChangeRequests(e){return f(this,Be).getTextDecorationVisibilityChangeRequests(e)}notifyTextDecorationInteraction(e){return f(this,Ge).handleTextDecorationInteraction(e)}}Ge=new WeakMap;Be=new WeakMap;function Ts(s,e){return Lt(t=>{const[n,c,r,i,w]=t(gt([e.resolve(ft),e.resolve(q),e.resolve(Oe),e.resolve(Ne),e.resolve(s.provides.Monitoring)])),b=new ls({probability:.01});return re(new Ut(n,{logger:{location:"Background",name:"Connector"},handler:{...c.handler,...r.handler,...i.handler},report:w&&b.shouldSelect()?_=>w.duration("".concat(_.kind,"_rpc_call"),{labels:{rpc_method_name:_.action}}).close(_.error,{durationInSeconds:_.durationInMs/1e3}):void 0}))})}var At=s=>{throw TypeError(s)},Ot=(s,e,t)=>e.has(s)||At("Cannot "+t),Ps=(s,e,t)=>(Ot(s,e,"read from private field"),t?t.call(s):e.get(s)),Fs=(s,e,t)=>e.has(s)?At("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),As=(s,e,t,n)=>(Ot(s,e,"write to private field"),e.set(s,t),t),Le;class Os{constructor(e){Fs(this,Le),As(this,Le,e.createClient())}makeExperimentationRequest(e){return Ps(this,Le).makeExperimentationRequest(e)}}Le=new WeakMap;var Vt=s=>{throw TypeError(s)},Gt=(s,e,t)=>e.has(s)||Vt("Cannot "+t),R=(s,e,t)=>(Gt(s,e,"read from private field"),t?t.call(s):e.get(s)),We=(s,e,t)=>e.has(s)?Vt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),Y=(s,e,t,n)=>(Gt(s,e,"write to private field"),e.set(s,t),t),ve,te,J,De;class Vs{constructor(e,t){We(this,ve),We(this,te),We(this,J,null),We(this,De,null),Y(this,te,e),Y(this,ve,t)}[Symbol.dispose](){se(R(this,De))}async create(e){se(R(this,De));let t=R(this,J);const n=H.createLogger("CAPITransport",R(this,te)),c=R(this,te),r=new Map,i=new us,w=new pt,b=new I,_=new I,de=Promise.withResolvers(),ke=new DisposableStack;t!==null&&de.resolve(t);const be=R(this,ve).messages.subscribe(d=>{if(ke.disposed)return H.warn("Received a message after the transport was disposed.");switch(d.kind){case"connected":Y(this,J,d.message.sessionID),t===null?(t=d.message.sessionID,n.verbose("Connected to session ".concat(t)),de.resolve(t)):t!==d.message.sessionID&&(n.warn("Received a 'connected' message for session \"".concat(d.message.sessionID,'" while already connected with the session ').concat(t,".")),se(be),b.next({webSocket:void 0}));break;case"disconnected":R(this,J)===d.message.sessionID&&Y(this,J,null),t===d.message.sessionID?(de.reject(new Gs(t)),n.verbose("Disconnected from session ".concat(t)),t=null,se(be),b.next({webSocket:void 0})):t!==null?n.warn("Received a 'disconnected' message for session \"".concat(d.message.sessionID,'" while connected with the session "').concat(t,'".')):n.warn("Received a 'disconnected' message for session \"".concat(d.message.sessionID,'" while not connected.'));break;case"messageReceived":{const u=d.message.message;t===null?(t=d.message.sessionID,n.verbose("Connected to session ".concat(t)),Y(this,J,t),de.resolve(t),n.warn("Received a '".concat(u.action,"' message before 'connected' message. Assuming CAPI is connected with the session \"").concat(t,'".')),i.enqueue(u,"rev"in u?u.rev:void 0)):t===d.message.sessionID?i.enqueue(u,"rev"in u?u.rev:void 0):n.warn("Received a '".concat(u.action,"' message for session \"").concat(d.message.sessionID,'" while connected with the session "').concat(t,'".'));break}case"textRevision":{const{capiRevision:u,documentRevision:rt}=d.message;t===d.message.sessionID?(n.verbose("Received text revision:",d.message),r.set(u,rt),i.pushNewTextRevision(u)):n.warn("Received a text revision (capi ".concat(u," -> ").concat(rt,') for session "').concat(d.message.sessionID,'" while connected with the session "').concat(t,'".'));break}}});return ke.use(be),Y(this,De,be),ke.use(h(Ze(i.messages),zt(d=>{if("rev"in d){const u=r.get(d.rev);u===void 0?n.warn("Received a message (".concat(d.action,") with unknown revision ").concat(d.rev)):Reflect.set(d,"rev",u)}w.next(d)}))),re({sessionId:de.promise,send:d=>{t===null?(n.warn("Attempt to send a message without a sessionID"),n.verbose("Message:",d)):h(R(this,ve).send({documentID:c,sessionID:t,message:d}),Jt(Ht(u=>{n.error("Failed to send a message",u),n.verbose("Message:",d)})))},didClose:D(b),didError:D(_),didReceive:w,[Symbol.dispose](){ke.dispose()}})}toString(){return"PerDocumentTransportFactory(".concat(R(this,te),")")}}ve=new WeakMap;te=new WeakMap;J=new WeakMap;De=new WeakMap;class Gs extends Je{constructor(e){super("CAPI Transport disconnected (SessionId: ".concat(e,")"))}}const hn=s=>h(s.getPlugin("monitoring"),mt(e=>{const t=s.getExecutionScopeDefinition("global"),n=new Set,c={initialize:r=>{if(n.has(r))return ht.all([]);n.add(r);const i=[],w=s.getExecutionScopeDefinition(r);return i.push(...Ns(w,e)),i.push(re(Bs(w))),H.verbose('Connector plugin is configured for "'.concat(r,'" execution scope.')),ht.all(i)}};return t.register({token:Xt,useValue:c})}));function Bs(s){return s.onStart(async e=>(H.verbose('Connector plugin is starting in "'.concat(e.name,'" execution scope.')),h(gt([e.resolve(Xe),e.resolve(vt),e.resolve($e)]),O(Qt))))}function Ns(s,e){const t=Kt(Symbol("ConnectorRPCToken"));return[s.register({token:t,useFactory:n=>Ts(e,n)},{lifetime:y.Singleton}),s.register({token:Ye,useFactory:T(Ye,[q,t])},{lifetime:y.Singleton}),s.register({token:Xe,useToken:Ye}),s.register({token:Zt,useFactory:T(Os,[t])},{lifetime:y.Singleton}),s.register({token:lt,useFactory:T(xs,[t,Oe,Re])},{lifetime:y.Singleton}),s.register({token:vt,useFactory:T(Es,[t,Ne])},{lifetime:y.Singleton}),s.register({token:$e,useFactory:T($e,[lt,Xe])},{lifetime:y.Singleton}),s.register({token:jt,useFactory:n=>h(n.resolve($e),O(c=>({create:r=>new Vs(r,c.create(r))})))},{lifetime:y.Singleton}),s.register({token:q,useFactory:T(q,[ft,Yt])},{lifetime:y.Singleton}),s.register({token:Re,useClass:Re},{lifetime:y.Singleton}),s.register({token:Oe,useFactory:T(Oe,[q,Re])},{lifetime:y.Singleton}),s.register({token:Ne,useFactory:T(Ne,[q])},{lifetime:y.Singleton})]}export{hn as activate};
//# sourceMappingURL=index-Qsnmn_-U.js.map
