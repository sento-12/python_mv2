import{a2 as W,S as F,j as R,o as P,y as w,B as A,p as c,r as M,v as b,a3 as N,R as C,L as G,s as $,h as j,g as k,D as L,a as D}from"./start-C5OgI2kj.js";import{h as z,i as h,A as V,T as H,a as U,b as Z,d as q,e as J,f as K}from"./TextDocumentEntities-Cun58Ax6.js";import{DocumentSessionManagerToken as O,DocumentSessionToken as Q,TextDocumentInfoToken as X}from"./index-DbXAHXfn.js";import{a as Y,t as B}from"./subscribableState-Y8YW7N9Z-BMiZmink.js";import{d as ee}from"./distinctUntilChanged-6npf-yF3.js";import{t as l,a as d}from"./subscribable-Cqm5UN_u-CZjzLfrM.js";import{D as te}from"./Delta-D-dso3t3-B1UydhvC.js";import{d as ie}from"./mergeAll-jza3F776.js";import{s as I}from"./share-CI8gbLLI.js";import{m as ne}from"./merge-BdtP_pzV.js";import{t as re}from"./take-CcUs0Iqw.js";import"./RemoteEntity-CN-1WB86-yD3y8ldD.js";import"./PluginModule-CRib3PLZ-rw_nkrD1.js";var ae=function(t){W(e,t);function e(i,r,a){i===void 0&&(i=1/0),r===void 0&&(r=1/0),a===void 0&&(a=ie);var n=t.call(this)||this;return n._bufferSize=i,n._windowTime=r,n._timestampProvider=a,n._buffer=[],n._infiniteTimeWindow=!0,n._infiniteTimeWindow=r===1/0,n._bufferSize=Math.max(1,i),n._windowTime=Math.max(1,r),n}return e.prototype.next=function(i){var r=this,a=r.isStopped,n=r._buffer,u=r._infiniteTimeWindow,f=r._timestampProvider,m=r._windowTime;a||(n.push(i),!u&&n.push(f.now()+m)),this._trimBuffer(),t.prototype.next.call(this,i)},e.prototype._subscribe=function(i){this._throwIfClosed(),this._trimBuffer();for(var r=this._innerSubscribe(i),a=this,n=a._infiniteTimeWindow,u=a._buffer,f=u.slice(),m=0;m<f.length&&!i.closed;m+=n?1:2)i.next(f[m]);return this._checkFinalizedStatuses(i),r},e.prototype._trimBuffer=function(){var i=this,r=i._bufferSize,a=i._timestampProvider,n=i._buffer,u=i._infiniteTimeWindow,f=(u?1:2)*r;if(r<1/0&&f<n.length&&n.splice(0,n.length-f),!u){for(var m=a.now(),s=0,o=1;o<n.length&&n[o]<=m;o+=2)s=o;s&&n.splice(0,s+1)}},e}(F);function se(t,e,i,r,a){return function(n,u){var f=i,m=e,s=0;n.subscribe(R(u,function(o){var _=s++;m=f?t(m,o,_):(f=!0,o),u.next(m)},a))}}function oe(t,e){return P(se(t,e,arguments.length>=2,!0))}function v(t,e,i){var r,a,n,u,f=!1;return t&&typeof t=="object"?(r=t.bufferSize,u=r===void 0?1/0:r,a=t.windowTime,e=a===void 0?1/0:a,n=t.refCount,f=n===void 0?!1:n,i=t.scheduler):u=t!=null?t:1/0,I({connector:function(){return new ae(u,e,i)},resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:f})}function ue(t){return w(function(e,i){return t<=i})}var fe=Object.defineProperty,E=t=>{throw TypeError(t)},me=(t,e,i)=>e in t?fe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,ce=(t,e,i)=>me(t,e+"",i),pe=(t,e,i)=>e.has(t)||E("Cannot "+i),S=(t,e,i)=>(pe(t,e,"read from private field"),e.get(t)),x=(t,e,i)=>e.has(t)?E("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),T,g;class y{constructor(){x(this,T,new DisposableStack),x(this,g,new A(null)),ce(this,"activeDocumentId",Y(S(this,g)))}setActiveDocumentIdSource(e){S(this,T).use(c(B(e),ee(),M(S(this,g))))}[Symbol.dispose](){S(this,T).dispose()}}T=new WeakMap;g=new WeakMap;var le=Object.defineProperty,he=(t,e,i)=>e in t?le(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,p=(t,e,i)=>he(t,typeof e!="symbol"?e+"":e,i);class de{constructor({documentId:e,hasFocus:i,lastFocusAt:r,geometry:a,textChange:n,geometryWillChange:u,selection:f}){p(this,"id"),p(this,"hasFocus"),p(this,"lastFocusAt"),p(this,"geometryWillChange"),p(this,"geometry"),p(this,"textChange"),p(this,"text"),p(this,"selection"),this.id=e,this.hasFocus=c(d(i),v({bufferSize:1,refCount:!0}),l),this.lastFocusAt=c(d(r),v({bufferSize:1,refCount:!0}),l),this.geometryWillChange=c(d(u),I(),l),this.geometry=c(d(a),v({bufferSize:1,refCount:!0}),l),this.selection=c(d(f),v({bufferSize:1,refCount:!0}),l);const m=c(d(n),b(s=>({revision:s.revision,change:new te(s.change)})),oe((s,{change:o,revision:_})=>s?{revision:_,change:o,content:s.content.compose(o)}:{revision:_,change:o,content:o},null),w(N),v({bufferSize:1,refCount:!0}));this.text=c(m,b(({revision:s,content:o})=>({revision:s,content:o})),l),this.textChange=c(ne(c(m,re(1),b(({revision:s,content:o})=>({revision:s,change:o}))),c(m,ue(1),b(({revision:s,change:o})=>({revision:s,change:o})))),l)}}const We=t=>{const e=t.getExecutionScopeDefinition("document-group");return C.all([ve(t),e.register({token:y,useClass:y},{lifetime:G.Singleton}),e.register({token:O,useToken:y}),$(e.onStart(i=>c(k([L(i.resolve(y)),z(i.realm,V,null)]),j(([r,a])=>r.setActiveDocumentIdSource(a)))))])};function ve(t){return t.registerExecutionScopeReviver("document-session",(e,i,{documentId:r})=>c(k([h(e.realm,H),h(e.realm,U),h(e.realm,Z),h(e.realm,q),h(e.realm,J),h(e.realm,K)]),D(async([a,n,u,f,m,s])=>C.all([e.register({token:Q,useValue:{documentId:r,startedAt:performance.now()}}),e.register({token:X,useValue:new de({documentId:r,hasFocus:a,lastFocusAt:n,geometry:u,textChange:f,selection:m,geometryWillChange:s})})])),D(a=>(e.use(a),e.start()))))}export{We as activate};
//# sourceMappingURL=index-CqacEAxx.js.map
