import{am as Pe,l as Ue,p as u,v as q,an as ri,K as me,A as ai,z as li,b as ce,d as H,w as $e,G as j,n as ci,U as _e,q as Y,r as A,h as ve,i as Ce,ao as di,ap as ui,aq as hi,e as pi,ac as gi,C as Me,S as fi,t as mi,g as vi,R as Ee,s as Q,E as Ne,O as Re,a as Oe,j as Ge,N as yi,m as le,x as ki,L as X,c as wi}from"./index-DbtAbjfk.js";import{g as _i}from"./getDecorationStrategy-oPtrNUm-.js";import{t as bi}from"./timeoutWith-B7tsbJ8--C_uOzAu5.js";import{f as Di,T as Si}from"./TextRangeUpdateSemantics-D8MqPOrG-Bdcz8ucb.js";import{s as Ii}from"./startWith-LiRdE3gi.js";import{c as Ci}from"./TextRevisionFns-DGbJAFcL-DX1ABpMm.js";import{t as Ei}from"./PointFns-Cqc_hcsO-DfLreJud.js";import{t as Ti}from"./RectFns-ndpeBtT0-CdOd3O5S.js";import{c as Ai}from"./concat-KLZEPRCF.js";import{d as Fi}from"./defer-r6dTVIJu.js";import{t as zi}from"./tap-CTBWtjxW.js";import{o as Bi}from"./of-Bh-sjQwK.js";import{E as Wi}from"./mergeAll-Ci-uq6t1.js";import{TextDecorationControllerToken as Le}from"./index-9L1jk-eQ.js";import{d as ue}from"./defineFactory-DJYNRBNc-CQmG8A-U.js";import"./timer-zq0ZEleB.js";import"./async-C23VpIJo.js";import"./PluginModule-CRib3PLZ-ls39AzbW.js";const Te="#2551DA",Ae="#FFBF47",Fe="#16AC9A",he="#016A5E",pe="#707070",ze="#5E47E5",Be="#EB0A00",We="#027D7D";function Ve(e){var i,t,n,o,r,c,a;return e.hidden&&((i=e.extra_properties)==null?void 0:i.free_premium)==="uphook"?"premiumUphook":e.group==="WritingExpert"?"writingExpert":((t=e.cardLayout)==null?void 0:t.outcome)==="Correctness"?"correctness":((n=e.cardLayout)==null?void 0:n.outcome)==="Tone"?"delivery":((o=e.cardLayout)==null?void 0:o.outcome)==="Clarity"?"clarity":((r=e.cardLayout)==null?void 0:r.outcome)==="Engagement"?"engagement":((c=e.cardLayout)==null?void 0:c.outcome)==="Originality"?"originality":((a=e.cardLayout)==null?void 0:a.outcome)==="Knowledge Hub"?"knowledgeHub":null}const I=Pe(2),C="outside",E=.15,xi={premiumUphook:{underline:{color:Ae,style:"solid",thickness:I,align:C},emphasizedBackground:{color:l(Ae,E)}},writingExpert:{underline:{color:he,style:"ellipsis",thickness:I,align:C},emphasizedBackground:{color:l(pe,E)}},correctness:{underline:{color:Be,style:"solid",thickness:I,align:C},emphasizedBackground:{color:l(Be,E)}},delivery:{underline:{color:ze,style:"solid",thickness:I,align:C},emphasizedBackground:{color:l(ze,E)}},clarity:{underline:{color:Te,style:"solid",thickness:I,align:C},emphasizedBackground:{color:l(Te,E)}},engagement:{underline:{color:he,style:"solid",thickness:I,align:C},emphasizedBackground:{color:l(he,E)}},originality:{underline:{color:We,style:"solid",thickness:I,align:C},emphasizedBackground:{color:l(We,E)}},knowledgeHub:{background:{color:l(Fe,.3)},emphasizedBackground:{color:l(Fe,.5)}},other:{underline:{color:pe,style:"solid",thickness:I,align:C},emphasizedBackground:{color:l(pe,E)}}},d={Red30:"#F27388",Red50:"#EA1537",Blue30:"#79A8F2",Blue50:"#4A6EE0",Green30:"#87E8D1",Green40:"#41D9B5",Green50:"#15C39A",Purple30:"#BD79ED",Purple50:"#8F4CBF",Yellow30:"#FFC940",Yellow50:"#FFA600",Neutral40:"#9FA6BF",Neutral50:"#6D758D",Cyan30:"#75E1EB",Cyan60:"#09A4B2"},p=Pe(3),g="outside",T=.2,B=.8,Pi={premiumUphook:{underline:{color:l(d.Yellow30,B),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Yellow50,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Yellow30,T)}},writingExpert:{underline:{color:d.Green50,style:"ellipsis",thickness:p,align:g},emphasizedUnderline:{color:d.Green50,style:"ellipsis",thickness:p,align:g},emphasizedBackground:{color:l(d.Neutral50,T)}},correctness:{underline:{color:l(d.Red30,B),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Red50,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Red30,T)}},delivery:{underline:{color:l(d.Purple30,B),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Purple50,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Purple30,T)}},clarity:{underline:{color:l(d.Blue30,B),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Blue50,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Blue30,T)}},engagement:{underline:{color:l(d.Green30,B),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Green50,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Green30,T)}},originality:{underline:{color:l(d.Cyan30,B),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Cyan60,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Cyan30,T)}},knowledgeHub:{background:{color:l(d.Green40,.3)},emphasizedBackground:{color:l(d.Green40,.5)}},other:{underline:{color:l(d.Neutral40,B),style:"solid",thickness:p,align:g},emphasizedUnderline:{color:d.Neutral50,style:"solid",thickness:p,align:g},emphasizedBackground:{color:l(d.Neutral40,T)}}};function Ui(e){var i;return xi[(i=Ve(e))!=null?i:"other"]}function $i(e){var i;return Pi[(i=Ve(e))!=null?i:"other"]}function l(e,i){return e.length===7?e+Math.round(i*255).toString(16).padStart(2,"0"):e}var Mi=Object.defineProperty,He=e=>{throw TypeError(e)},Ni=(e,i,t)=>i in e?Mi(e,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[i]=t,Ye=(e,i,t)=>Ni(e,i+"",t),be=(e,i,t)=>i.has(e)||He("Cannot "+t),s=(e,i,t)=>(be(e,i,"read from private field"),t?t.call(e):i.get(e)),m=(e,i,t)=>i.has(e)?He("Cannot add the same private member more than once"):i instanceof WeakSet?i.add(e):i.set(e,t),v=(e,i,t,n)=>(be(e,i,"write to private field"),i.set(e,t),t),_=(e,i,t)=>(be(e,i,"access private method"),t),k,b,w,O,F,U,$,S,x,M,G,K,L,P,y,Ke,Je,ye,Qe,Xe,Ze,qe,je,ee;class ie{constructor(i,t,n,o,r){m(this,y),m(this,k),m(this,b,new AsyncDisposableStack),m(this,w),m(this,O),m(this,F),m(this,U,new Set),m(this,$),m(this,S,null),m(this,x,null),m(this,M),m(this,G),m(this,K,new Set),m(this,L,new Set),m(this,P,null),v(this,k,Ue.createLogger("CAPITextDecorationManager",n.id)),v(this,O,i),v(this,w,t),v(this,G,o),v(this,F,n),v(this,$,r.client==="windows"||r.client==="preview-windows"?"windows":"regular")}init(){s(this,b).use(u(me(s(this,O).onChange),u(Di(s(this,O).getAll()),i=>i?Ii({upserted:i}):ri),q(i=>_(this,y,Je).call(this,i)))),_(this,y,Ze).call(this),s(this,b).use(u(li(s(this,G).status),ai(i=>i.kind==="connected"&&i.isNewSession),q(()=>s(this,K).clear()))),s(this,b).use(s(this,w).visibleOnscreenDecorations.subscribe(i=>{i.forEach(t=>_(this,y,Ke).call(this,t.metadata.capiAlertId)),s(this,k).verbose("Visible onscreen decorations",{documentID:s(this,F).id,visibleOnscreen:u(i,H(t=>t.id),ce)})}))}addVisibilitySource(i){const t=new Set,n=u(me(i),$e(Ri(t)),q(o=>{s(this,k).verbose("Update visibility",{documentID:s(this,F).id,changes:o});const{toShow:r,toHide:c,toEmphasize:a}=Oi(o);c.forEach(h=>t.delete(h)),r.forEach(h=>t.add(h)),a.forEach(h=>t.add(h)),_(this,y,ye).call(this,{toHide:c,toShow:r,toEmphasize:a})}));return s(this,b).use(n),j(()=>{_(this,y,ye).call(this,{toHide:t,toShow:new Set,toEmphasize:new Set}),ci(n)})}onTextDecorationInteraction(i,t){const n={observer:i,predicate:t};return s(this,L).add(n),j(()=>s(this,L).delete(n))}onUnhandledTextDecorationInteraction(i){return s(this,P)&&s(this,k).warn("Overwriting unhandledInteractionObserver"),v(this,P,i),j(()=>v(this,P,null))}async[Symbol.asyncDispose](){await s(this,b).disposeAsync()}}k=new WeakMap;b=new WeakMap;w=new WeakMap;O=new WeakMap;F=new WeakMap;U=new WeakMap;$=new WeakMap;S=new WeakMap;x=new WeakMap;M=new WeakMap;G=new WeakMap;K=new WeakMap;L=new WeakMap;P=new WeakMap;y=new WeakSet;Ke=function(e){s(this,K).has(e)||(s(this,K).add(e),u(s(this,G).send({action:"feedback",type:"RENDERED",subtype:"inline",alertId:e}),Y(A(i=>s(this,k).error("Failed to send RENDERED feedback for alert ".concat(e),i)))))};Je=function(e){var i,t;const n=(i=e.removed)!=null?i:[],o=(t=e.upserted)!=null?t:[];ve([u(s(this,w).delete(n.map(r=>V(r))),Ce(A(()=>{n.length>0&&s(this,k).verbose("Removed decorations for alerts",{documentID:s(this,F).id,decorationIds:n.map(r=>V(r)),alertIds:n.map(r=>r.id)})})),Y(A(r=>s(this,k).error("Failed to remove decoration on suggestion removal",new Li(r,n.map(c=>c.id)))))),u(ve(o.map(r=>_(this,y,Qe).call(this,r))),Ce(A(()=>{o.length>0&&s(this,k).verbose("Upserted decorations for alerts",{documentID:s(this,F).id,decorationIds:o.map(r=>V(r)),alertIds:o.map(r=>r.id)})})),Y(A(r=>s(this,k).error("Failed to upsert decoration on suggestion upsert",new Gi(r,o.map(c=>c.id))))))])};ye=async function({toHide:e,toShow:i,toEmphasize:t}){var n,o;const r=[];r.push(s(this,w).setVisibility(e,!1)),r.push(s(this,w).setVisibility(i,!0)),e.forEach(a=>s(this,U).delete(a)),i.forEach(a=>s(this,U).add(a)),t.forEach(a=>s(this,U).add(a));const c=u(t,di(1),ce).at(0);if(c){if(c===((n=s(this,S))==null?void 0:n.decorationId))return;r.push(s(this,w).focus(c,s(this,M)))}else((o=s(this,S))==null?void 0:o.decorationId)!==void 0&&i.has(s(this,S).decorationId)&&r.push(s(this,w).focus(null));await bi(u(ve(r),Y(A(a=>s(this,k).error("Unexpected error when applying visibility changes",a)))),{timeoutMs:5e3,defaultValue:void 0,onTimeout:()=>s(this,k).warn("Timeout out when applying visibility changes")})};Qe=function(e){var i;const t=V(e),n=((i=s(this,S))==null?void 0:i.decorationId)===t;return s(this,w).upsert({id:t,revision:Ci(e.alert.rev),segments:ei(e.alert,_(this,y,Xe).call(this,e.alert),n,e.alert.transformJson),visibility:n?"focused":s(this,U).has(t)?"visible":"hidden",metadata:{capiAlertId:e.alert.id,suggestionId:e.id}})};Xe=function(e){if(s(this,$)==="windows")return $i(e);if(s(this,$)==="regular")return Ui(e);throw new _e(s(this,$))};Ze=function(){s(this,b).use(s(this,w).onPointerHoverChange.subscribe(({pointerEnter:e,pointerLeave:i})=>{if(i&&s(this,x)===i.decoration.id&&(e==null?void 0:e.decoration.id)!==s(this,x)&&(v(this,x,null),v(this,M,void 0),_(this,y,ee).call(this,i)),e){if(s(this,x)===e.decoration.id)return;v(this,x,e.decoration.id),v(this,M,e.segment.id),_(this,y,ee).call(this,e)}})),s(this,b).use(s(this,w).onPointerClick.subscribe(e=>{v(this,M,e.segment.id),_(this,y,ee).call(this,e)})),s(this,b).use(s(this,w).onFocusChange.subscribe(({decoration:e,segment:i,focused:t})=>{var n;t?(v(this,S,{decorationId:e.id,segmentId:i==null?void 0:i.id}),_(this,y,qe).call(this,e,i)):(((n=s(this,S))==null?void 0:n.decorationId)===e.id&&v(this,S,null),_(this,y,je).call(this,e))}))};qe=function(e,i){e.segments.forEach(t=>t.patch(De({segmentMeta:t.metadata,segmentFocused:t.id===(i==null?void 0:i.id),decorationFocused:!0})))};je=function(e){e.segments.forEach(i=>i.patch(De({segmentMeta:i.metadata,segmentFocused:!1,decorationFocused:!1})))};ee=function({kind:e,rect:i,decorationRects:t,position:n,decoration:o,viewportOffset:r,windowOffset:c}){if(e==="pointerUp"||e==="pointerDown")return;s(this,k).verbose("Sending pointer event",{kind:e,decoration:o.id,documentID:s(this,F).id});const a={kind:e,decorationId:o.id,suggestionId:o.metadata.suggestionId,position:n,rect:i,decorationRects:t,windowOffset:c,viewportOffset:r};let h=!1;u(s(this,L),pi(({predicate:f})=>f(a)),H(A(()=>h=!0)),H(({observer:f})=>f(a)),hi(!h&&s(this,P)?[s(this,P).call(this,a)]:[]),ui)};function De({segmentMeta:e,segmentFocused:i,decorationFocused:t}){var n,o,r,c,a,h;return t?{interactive:!0,background:(!e.hasEnclosing||e.kind==="enclosing")&&(o=(n=e.style.emphasizedBackground)!=null?n:e.style.background)!=null?o:null,underline:e.isSuperAlert&&!i?null:e.kind!=="enclosing"&&(c=(r=e.style.emphasizedUnderline)!=null?r:e.style.underline)!=null?c:null}:{interactive:e.kind!=="enclosing",background:(a=e.style.background)!=null?a:null,underline:e.kind==="enclosing"?null:(h=e.style.underline)!=null?h:null}}function Ri(e){return i=>{const t=n=>n.kind==="decoration"?n.decorationId:V({id:n.suggestionId});if(i.partial)return i.changes.map(n=>({decorationId:t(n.id),visibility:n.visibility}));{const n=new Set(i.changes.flatMap(r=>r.visibility==="hidden"?[]:[t(r.id)])),o=u(e.difference(n),H(r=>({decorationId:r,visibility:"hidden"})),ce);return i.changes.map(r=>({decorationId:t(r.id),visibility:r.visibility})).concat(o)}}}function Oi(e){const i=new Set,t=new Set,n=new Set;for(const o of e)if(o.visibility==="hidden")t.add(o.decorationId);else if(o.visibility==="visible")i.add(o.decorationId);else if(o.visibility==="emphasized")i.add(o.decorationId),n.add(o.decorationId);else throw new _e(o.visibility);return{toShow:i,toHide:t,toEmphasize:n}}function V(e){return String(e.id)}function ei(e,i,t,n,o){return n?n.highlights.map(({type:r,s:c,e:a},h,f)=>{var z,J;const N={kind:r==="enclosing"?"enclosing":"main",hasEnclosing:f.some(oi=>oi.type==="enclosing"),isSuperAlert:o===!0,style:i},{interactive:de,underline:Se,background:Ie}=De({segmentFocused:!1,decorationFocused:t,segmentMeta:N});return{range:{start:c+((z=n==null?void 0:n.context.s)!=null?z:0),end:a+((J=n==null?void 0:n.context.s)!=null?J:0)},updateSemantics:Si.Resize,metadata:N,interactive:de,underline:Se!=null?Se:void 0,background:Ie!=null?Ie:void 0}}):e.subalerts?e.subalerts.flatMap(r=>ei(e,i,t,r.transformJson,!0)).filter(gi):[]}class Gi extends Me{constructor(i,t){super("Failed to upsert decoration",i),Ye(this,"suggestions"),this.suggestions=Array.from(t)}toJSON(){return{...super.toJSON(),suggestions:this.suggestions}}}class Li extends Me{constructor(i,t){super("Failed to remove decoration",i),Ye(this,"suggestions"),this.suggestions=Array.from(t)}toJSON(){return{...super.toJSON(),suggestions:this.suggestions}}}var Vi=Object.defineProperty,ii=e=>{throw TypeError(e)},Hi=(e,i,t)=>i in e?Vi(e,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[i]=t,Yi=(e,i,t)=>Hi(e,i+"",t),ti=(e,i,t)=>i.has(e)||ii("Cannot "+t),R=(e,i,t)=>(ti(e,i,"read from private field"),t?t.call(e):i.get(e)),Z=(e,i,t)=>i.has(e)?ii("Cannot add the same private member more than once"):i instanceof WeakSet?i.add(e):i.set(e,t),ge=(e,i,t,n)=>(ti(e,i,"write to private field"),i.set(e,t),t),te,ne,se,oe;class ke{constructor(i,t,n){Z(this,te),Z(this,ne),Z(this,se),Z(this,oe,Ue.createLogger("ConnectorTextDecorationInteractionObserver")),Yi(this,"onTextDecorationInteraction",({kind:o,suggestionId:r,position:c,rect:a,decorationRects:h,viewportOffset:f})=>{if(r===void 0)return;const z=R(this,ne).getById(r);if(!z)return R(this,oe).error("Failed to find suggestion by id");const J=Ei(f),N=Ti(f);u(R(this,se).notifyTextDecorationInteraction({documentID:R(this,te).id,interactionType:o,alertId:String(z.alert.id),position:J(c),rect:N(a),decorationRects:h.map(N)}),Y(A(de=>R(this,oe).error("Failed to send notifyTextDecorationInteraction",de))))}),ge(this,te,i),ge(this,ne,t),ge(this,se,n)}}te=new WeakMap;ne=new WeakMap;se=new WeakMap;oe=new WeakMap;var Ki=Object.defineProperty,ni=e=>{throw TypeError(e)},Ji=(e,i,t)=>i in e?Ki(e,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[i]=t,Qi=(e,i,t)=>Ji(e,i+"",t),Xi=(e,i,t)=>i.has(e)||ni("Cannot "+t),D=(e,i,t)=>(Xi(e,i,"read from private field"),i.get(e)),fe=(e,i,t)=>i.has(e)?ni("Cannot add the same private member more than once"):i instanceof WeakSet?i.add(e):i.set(e,t),re,W,ae;class we{constructor(i,t){fe(this,re,new DisposableStack),fe(this,W,new Map),fe(this,ae,new fi),Qi(this,"visibilityChanges",mi(Ai(Fi(()=>D(this,W).size>0?Bi({partial:!1,changes:u(D(this,W).entries(),H(([n,o])=>({id:{kind:"suggestion",suggestionId:n},visibility:o})),ce)}):Wi),D(this,ae)))),D(this,re).use(u(me(t.getTextDecorationVisibilityChangeRequests(i.id)),$e(n=>({partial:n.partial,changes:n.changes.map(o=>({id:{kind:"suggestion",suggestionId:o.alertId},visibility:o.visibility}))})),zi(n=>{n.partial||D(this,W).clear(),n.changes.forEach(o=>{o.visibility==="hidden"?D(this,W).delete(o.id.suggestionId):D(this,W).set(o.id.suggestionId,o.visibility)})}),q(D(this,ae))))}[Symbol.dispose](){D(this,re).dispose()}}re=new WeakMap;W=new WeakMap;ae=new WeakMap;const xe=wi(Symbol("CAPITextDecorationStore")),wt=e=>u(Ge([Q(e.getExecutionScopeDefinition("document-group")),Q(e.getExecutionScopeDefinition("document-session")),e.getPlugin("document-group"),e.getPlugin("document-session"),e.getPlugin("capi-suggestion"),e.getPlugin("text-decoration"),e.getPlugin("connector"),e.getPlugin("capi")]),vi(([i,t,n,o,r,c,a,h])=>Ee.all([...it(t,c,r,o,a,h),Q(t.onStart(async f=>Ee.all([ji(f),et(f)]))),Q(i.onStart(f=>u(f.resolve(Ne),Re,Oe(z=>Zi(_i(z.client),f.observeExecutionScope("document-session"),n,f)))))])));function Zi(e,i,t,n){switch(e){case"showActiveDocumentOnly":return si(t,n);case"showAllDocuments":return qi(i,t);default:throw new _e(e)}}function si(e,i){return u(i.resolve(e.provides.WindowFactory),Re,Oe(t=>t.createWindow({fitContent:!1,clickThroughTransparent:!0,injectionOptions:{kind:"popup"},scopes:["document-session"],plugins:["inline-decorations"]})))}function qi(e,i){const t=new AsyncDisposableStack;return t.use(e.onStart(n=>si(i,n))),yi(t)}function ji(e){return u(e.resolve(ie),le(i=>i.init()),le(()=>j(ki)))}function et(e){return u(Ge([e.resolve(we),e.resolve(ke),e.resolve(Le)]),le(([i,t,n])=>{const o=new DisposableStack;return o.use(n.addVisibilitySource(i.visibilityChanges)),o.use(n.onUnhandledTextDecorationInteraction(t.onTextDecorationInteraction)),o}))}function it(e,i,t,n,o,r){return[e.register({token:Le,useToken:ie}),e.register({token:xe,useFactory:c=>u(c.resolve(i.provides.TextDecorationStoreManager),le(a=>a.createStore("capi")))},{lifetime:X.Singleton}),e.register({token:ie,useFactory:ue(ie,[t.provides.CAPISuggestionCollection,xe,n.provides.TextDocument,r.provides.CAPIConnection,Ne])},{lifetime:X.Singleton}),e.register({token:we,useFactory:ue(we,[n.provides.TextDocument,o.provides.ConnectorTextDecoration])},{lifetime:X.Singleton}),e.register({token:ke,useFactory:ue(ke,[n.provides.TextDocument,t.provides.CAPISuggestionCollection,o.provides.ConnectorTextDecoration])},{lifetime:X.Singleton})]}export{wt as activate};
//# sourceMappingURL=index-Dbz7ZhNL.js.map
