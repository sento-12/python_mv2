var X=Object.defineProperty;var M=n=>{throw TypeError(n)};var Y=(n,e,s)=>e in n?X(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s;var A=(n,e,s)=>Y(n,typeof e!="symbol"?e+"":e,s),x=(n,e,s)=>e.has(n)||M("Cannot "+s);var o=(n,e,s)=>(x(n,e,"read from private field"),s?s.call(n):e.get(n)),g=(n,e,s)=>e.has(n)?M("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,s),E=(n,e,s,i)=>(x(n,e,"write to private field"),i?i.call(n,s):e.set(n,s),s),m=(n,e,s)=>(x(n,e,"access private method"),s);import{o as Z,j as ee,S as se,B as te,k as $,l as q,p as l,n as ne,q as U,h as _,r as J,v as ie,a as oe,u as F,w as re,C as G,U as ce,R as H,s as L,x as ae,m as S,y as de,_ as le,e as N,i as W,L as y,E as z,c as D}from"./start-C5OgI2kj.js";import{t as ue}from"./subscribableState-Y8YW7N9Z-BMiZmink.js";import{t as he}from"./subscribable-Cqm5UN_u-CZjzLfrM.js";import{W as pe}from"./CAPIWebSocketTransport-BECrZbf6-B0GFkT4q.js";import{CAPIConnectionToken as K}from"./index-BldbTuRR.js";import"./PluginModule-CRib3PLZ-rw_nkrD1.js";function ge(){return Z(function(n,e){var s,i=!1;n.subscribe(ee(e,function(t){var r=s;s=t,i&&e.next([r,t]),i=!0}))})}var C,c,w,v,f,b,I,p,Q,T,V;class fe{constructor(e,s){g(this,p);g(this,C,new se);g(this,c,new te({kind:"disconnected",sessionId:null}));g(this,w);g(this,v);g(this,f,new DisposableStack);g(this,b,[]);g(this,I,new Map);A(this,"events",he(o(this,C)));A(this,"status",m(this,p,Q).call(this));o(this,f).defer(()=>$(e)),E(this,w,e),E(this,v,s),o(this,f).defer(()=>{const i=o(this,c).getValue();i.kind==="connecting"&&i.controller.abort(),o(this,c).next({kind:"disconnected",sessionId:"sessionId"in i?i.sessionId:null})})}[Symbol.dispose](){o(this,f).dispose()}connect(){if(o(this,f).disposed)return q.warn("Cannot connect after the CAPIClient was disposed.");const e=o(this,c).getValue();if(e.kind==="connecting"||e.kind==="connected")return;const s="sessionId"in e?e.sessionId:null,i=new AbortController;l(o(this,w).create({...o(this,v),previous:e.transport}),U(t=>o(this,c).next({kind:"connecting",transport:t,controller:i})),_(async t=>{if(i.signal.aborted)return $(t);const r=await t.sessionId;o(this,c).next({kind:"connected",transport:t,sessionId:r,isNewSession:r!==s}),m(this,p,V).call(this);let d=!1;const h=new DisposableStack;o(this,f).use(h),h.use(t),h.use(t.didReceive.subscribe(a=>{const u=o(this,I).get(a.id);u&&(o(this,I).delete(a.id),u.resolve(a)),o(this,C).next(a)})),h.use(t.didError.subscribe(a=>{d=!0,o(this,c).next(l(o(this,c).getValue(),u=>({kind:"error",error:a,transport:t,sessionId:"sessionId"in u?u.sessionId:null})))})),h.use(t.didClose.subscribe(()=>{const a=l(o(this,c).getValue(),k=>"sessionId"in k?k.sessionId:null),u=new be(a);o(this,I).forEach(k=>k.reject(u)),o(this,I).clear(),o(this,b).forEach(({onSend:k,onReceive:P})=>{k.reject(u),P==null||P.reject(u)}),o(this,b).length=0,h.dispose(),d||o(this,c).next({kind:"disconnected",transport:t,sessionId:a})}))}),ne(U(t=>{i.signal.aborted||o(this,c).next(l(o(this,c).getValue(),r=>({kind:"error",error:t,sessionId:"sessionId"in r?r.sessionId:null})))})))}toString(){const e=o(this,c).getValue();switch(e.kind){case"connecting":return"Client(connecting)";case"connected":return"Client(connected: ".concat(e.transport,")");case"disconnected":return"Client(disconnected)";case"error":return"Client(error: ".concat(e.error.message,")")}}send(e,s){const i=Promise.withResolvers();return m(this,p,T).call(this,e,i,void 0,s)}sendAndAwaitResponse(e,s){const i=Promise.withResolvers(),t=Promise.withResolvers();return l(m(this,p,T).call(this,e,i,t,s),oe(()=>F(()=>t.promise)))}}C=new WeakMap,c=new WeakMap,w=new WeakMap,v=new WeakMap,f=new WeakMap,b=new WeakMap,I=new WeakMap,p=new WeakSet,Q=function(){const e=s=>{switch(s.kind){case"connecting":return{kind:"connecting"};case"connected":return{kind:"connected",sessionId:s.sessionId,isNewSession:s.isNewSession};case"disconnected":return{kind:"disconnected",sessionId:s.sessionId};case"error":return{kind:"error",sessionId:s.sessionId};default:throw new ce(s)}};return{subscribe:s=>l(o(this,c),ie(e),J(s)),getValue:()=>e(o(this,c).getValue())}},T=function(e,s,i,t){return o(this,b).push({message:e,onSend:s,onReceive:i,signal:t}),m(this,p,V).call(this),l(F(()=>s.promise),_(re))},V=function(){const e=o(this,c).getValue();e.kind==="connected"&&(o(this,b).forEach(({message:s,onSend:i,onReceive:t,signal:r})=>{if(r!=null&&r.aborted){i.reject(new B),t==null||t.reject(new B);return}const d=e.transport.send(s);d===void 0&&t?q.warn("onReceive callbacks are not supported by this transport"):t&&o(this,I).set(d,t),Reflect.set(s,"id",d),i.resolve(s)}),o(this,b).length=0)};class B extends G{constructor(){super("Message aborted")}}class be extends G{constructor(e){super("CAPI Connection closed (SessionId: ".concat(e,")"))}}const j=D(Symbol("CAPIClient")),R=D(Symbol("CAPIProvider")),O=D(Symbol("CAPIWebSocketUrl")),Ae=n=>l(n.getExecutionScopeDefinition("document-session"),e=>H.all([...Ie(n,e),L(e.onStart(s=>ae.all([l(s.resolve(j),S(i=>(i.connect(),l(ue(i.status),ge(),de(([t,r])=>t.kind==="connected"&&r.kind==="disconnected"),J(()=>i.connect()))))),le(i=>{const t=i(n.getPlugin("document-session")),r=i(s.resolve(K)),d=i(s.resolve(t.provides.TextDocument));let h=0,a=0;return L(d.textChange.subscribe(async u=>{await r.send({action:"submit_ot",rev:a,doc_len:h,deltas:[u.change.toJSON()]}),a=u.revision,h+=u.change.changeLength}))})])))]));function Ie(n,e){return[l(W([n.getPlugin("document-session"),n.getPlugin("connector")]),N(([s,i])=>H.all([e.register({token:j,useFactory:t=>l(W([t.resolve(R),t.resolve(s.provides.TextDocument)]),S(([r,d])=>new fe(r.create(d.id),{documentId:d.id,textDidChange:d.textChange,getTextContent:()=>d.text.getValue()})))},{lifetime:y.Singleton}),e.register({token:R,useFactory:t=>l(t.resolve(z),N(r=>r.capiSource==="connector"?t.resolve(i.provides.CAPIProvider):l(t.resolve(O),S(d=>({create:h=>new pe({getURL:()=>d,getMessageSanitizer:()=>({sanitize:a=>a,unsanitize:a=>a})})})))))},{lifetime:y.Singleton})]))),e.register({token:O,useFactory:s=>l(s.resolve(z),S(i=>{switch(i.servicesEnvironment){case"prod":return"wss://capi.grammarly.com/fpws";case"preprod":return"wss://capi.ppgr.io/fpws";case"qa":default:return"wss://capi.qagr.io/fpws"}}))},{lifetime:y.Singleton}),e.register({token:K,useToken:j})]}export{Ae as activate};
//# sourceMappingURL=index-Dd8KMT6C.js.map
