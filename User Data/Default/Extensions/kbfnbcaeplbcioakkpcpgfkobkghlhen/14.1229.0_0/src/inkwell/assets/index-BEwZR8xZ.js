import{V as Xe,o as He,W as Je,X as Ye,j as Ze,Y as Ke,Z as Qe,B as P,S as de,p as d,v as Be,l as ze,s as we,n as Q,q as j,h as te,r as I,y as je,$ as et,a0 as tt,a1 as it,x as ye,a as Me,R as _e,T as st,e as rt,i as nt,m as at,L as We,c as ot}from"./start-C5OgI2kj.js";import{T as ct,c as O,a as lt,b as ut,d as ht,e as mt,f as dt,A as pt,g as ft}from"./TextDocumentEntities-Cun58Ax6.js";import{TextDocumentToken as gt,TextDocumentInfoToken as vt,DocumentSessionToken as wt,DocumentSessionManagerToken as Ee}from"./index-DbXAHXfn.js";import{n as Ce,e as yt,c as _t,i as pe}from"./index-CZH9K_Ds.js";import{D as bt}from"./Delta-D-dso3t3-B1UydhvC.js";import{f as Dt,t as $,a as ie}from"./subscribable-Cqm5UN_u-CZjzLfrM.js";import{a as B,t as A}from"./subscribableState-Y8YW7N9Z-BMiZmink.js";import{t as kt}from"./timeoutWith-B7tsbJ8--xQN35Om5.js";import{t as be}from"./take-CcUs0Iqw.js";import{R as xt}from"./RandomSampler-Ba-P263P-DyiLAlld.js";import{i as St}from"./TextRevisionFns-DGbJAFcL-DX1ABpMm.js";import{d as De}from"./distinctUntilChanged-6npf-yF3.js";import{c as Ft}from"./concat-jxnVidBz.js";import{s as Re}from"./share-CI8gbLLI.js";import{s as Tt}from"./switchMap-CzTQ1pQg.js";import{a as Mt}from"./async-CpPJMEP8.js";import{i as Wt}from"./timer-CgPfXOBl.js";import{t as $e}from"./tap-BER5xIXx.js";import{m as Et}from"./merge-BdtP_pzV.js";import{o as Ct}from"./of-BeKGPQlf.js";import{d as Rt}from"./defineFactory-DJYNRBNc-BjUmrCbc.js";import"./RemoteEntity-CN-1WB86-yD3y8ldD.js";import"./PluginModule-CRib3PLZ-rw_nkrD1.js";import"./mergeAll-jza3F776.js";import"./AsyncScheduler-DuJTneVg.js";var $t=Xe(function(t){return function(i){i===void 0&&(i=null),t(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=i}});function At(t,e){var i=Wt(t)?{first:t}:typeof t=="number"?{each:t}:t,a=i.first,c=i.each,l=i.with,o=l===void 0?Vt:l,r=i.scheduler,u=r===void 0?Mt:r,h=i.meta,n=h===void 0?null:h;if(a==null&&c==null)throw new TypeError("No timeout provided.");return He(function(p,g){var Z,v,V=null,E=0,K=function(me){v=Je(g,u,function(){try{Z.unsubscribe(),Ye(o({meta:n,lastValue:V,seen:E})).subscribe(g)}catch(qe){g.error(qe)}},me)};Z=p.subscribe(Ze(g,function(me){v==null||v.unsubscribe(),E++,g.next(V=me),c>0&&K(c)},void 0,void 0,function(){v!=null&&v.closed||v==null||v.unsubscribe(),V=null})),!E&&K(a!=null?typeof a=="number"?a:+a-u.now():c)})}function Vt(t){throw new $t(t)}function Ot(t){return e=>new Ke(i=>{const a=[],c=new Qe;let l=!1;const o=()=>{for(;a.length>0;){const r=a.shift();i.next(r)}};return c.add(Dt(t).pipe(be(1)).subscribe({next:()=>{l=!0,o()},complete:()=>{l||(i.complete(),c.unsubscribe())},error:r=>{l||i.error(r)}})),c.add(e.subscribe({next:r=>{l?i.next(r):a.push(r)},error:r=>{i.error(r),c.unsubscribe()},complete:()=>{i.complete(),c.unsubscribe()}})),{unsubscribe:()=>c.unsubscribe()}})}var Pt=Object.defineProperty,Ae=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),ce=t=>{throw TypeError(t)},It=(t,e,i)=>e in t?Pt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,M=(t,e,i)=>It(t,typeof e!="symbol"?e+"":e,i),xe=(t,e,i)=>e.has(t)||ce("Cannot "+i),s=(t,e,i)=>(xe(t,e,"read from private field"),i?i.call(t):e.get(t)),f=(t,e,i)=>e.has(t)?ce("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),w=(t,e,i,a)=>(xe(t,e,"write to private field"),e.set(t,i),i),Ve=(t,e,i)=>(xe(t,e,"access private method"),i),fe=(t,e,i)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&ce("Object expected");var a;a=e[Ae("asyncDispose")],a===void 0&&(a=e[Ae("dispose")]),typeof a!="function"&&ce("Object not disposable"),t.push([i,a,e])}else t.push([i]);return e},ge=(t,e,i)=>{var a=typeof SuppressedError=="function"?SuppressedError:function(o,r,u,h){return h=Error(u),h.name="SuppressedError",h.error=o,h.suppressed=r,h},c=o=>e=i?new a(o,e,"An error was suppressed during disposal"):(i=!0,o),l=o=>{for(;o=t.pop();)try{var r=o[1]&&o[1].call(o[2]);if(o[0])return Promise.resolve(r).then(l,u=>(c(u),l()))}catch(u){c(u)}if(i)throw e};return l()},k,F,x,se,N,re,y,_,S,W,ne,L,q,z,U,R,ae,ke;class Bt{constructor(e,i){f(this,ae),f(this,k),f(this,F,new DisposableStack),f(this,x,new P({revision:St,content:new bt})),f(this,se,new P([])),f(this,N,new xt({probability:.01})),f(this,re,new P(Ce())),f(this,y,!1),f(this,_,!1),f(this,S,!1),f(this,W,new P({geometry:null,windowFrameMoving:!1,windowFrameResizing:!1,documentFrameScrolling:!1})),f(this,ne,new de),f(this,L,new P(!1)),f(this,q,new de),f(this,z),f(this,U,{getRects:0,getBoundingRects:0}),f(this,R),M(this,"id"),M(this,"textChange",d(Ft(d(s(this,x),be(1),Be(n=>({revision:n.revision,change:n.content}))),s(this,q)),De((n,p)=>p.revision===n.revision),$)),M(this,"text",B(s(this,x))),M(this,"selection",B(s(this,se))),M(this,"geometry",B(s(this,W))),M(this,"geometryWillChange",$(s(this,ne))),M(this,"hasFocus",B(s(this,L))),M(this,"lastFocusAt",B(s(this,re))),this.id=e.id,w(this,R,e),w(this,z,i),w(this,k,ze.createLogger("TextDocument",e.id));const a=kt(d(e.getText(),te(n=>{s(this,x).next(n),s(this,q).next({revision:n.revision,change:n.content})}),Q(j(n=>{s(this,k).error("Unexpected error when fetching initial text",n)}))),{timeoutMs:5e3,defaultValue:we(),onTimeout:()=>{s(this,k).warn("Did not receive initial text within 5s.",{delivery:!1})}});s(this,F).use(d(ie(e.textDidChange),Ot(a),I(n=>{const p=s(this,x).getValue();if(n.revision<=p.revision)return;const g=p.content.compose(n.change);s(this,x).next({revision:n.revision,content:g}),s(this,q).next(n)}))),s(this,F).use(e.selectionDidChange.subscribe(n=>s(this,se).next(Array.from(n))));const c=ie(e.geometryWillChange).pipe(Re()),l=ie(e.geometryDidChange).pipe(Re());s(this,F).use(d(c,I(n=>{w(this,S,n.has("DocumentFrameScrolled")?!0:s(this,S)),w(this,_,n.has("WindowFrameChanged")?!0:s(this,_)),w(this,y,n.has("WindowFrameChanged")?!0:s(this,y)),s(this,ne).next({reasons:n,documentFrameScrolling:s(this,S),windowFrameResizing:s(this,_),windowFrameMoving:s(this,y)})}))),s(this,F).use(d(l,I(n=>{w(this,S,n.has("DocumentFrameScrolled")?!1:s(this,S)),w(this,y,n.has("WindowFrameChanged")?!1:s(this,y)),w(this,_,n.has("WindowFrameChanged")?!1:s(this,_))}))),s(this,F).use(d(A(e.hasFocus),De(),I(n=>{n?s(this,re).next(Ce()):(w(this,S,!1),w(this,y,!1),w(this,_,!1),s(this,W).next({...s(this,W).getValue(),windowFrameMoving:s(this,y),windowFrameResizing:s(this,_),documentFrameScrolling:s(this,S)})),s(this,L).next(n)})));const o=d(c,Tt(()=>{const n=s(this,y)||s(this,_)?2e3:1e3;return d(l,be(1),At({first:n,with:()=>Ct(null)}),je(p=>p===null),$e(()=>{}))}));let r=pe;const u=new de;let h=0;s(this,F).use(d(Et(A(e.hasFocus),l,o,u),$e(()=>{r=_t(r+1)}),yt(async(n,p)=>{var g=[];try{const E=fe(g,i.duration("get_geometry",{labels:{request_kind:p===0?"initial":"other"},sampler:s(this,N)}),!0);return await d(e.getGeometry(),Q(j(K=>E.close(K))))}catch(E){var Z=E,v=!0}finally{var V=ge(g,Z,v);V&&await V}}),I(et({success:n=>{h=0,s(this,W).next({geometry:{...n,revision:r},windowFrameMoving:s(this,y),windowFrameResizing:s(this,_),documentFrameScrolling:s(this,S)})},failure:n=>{s(this,k).error("Unexpected error when fetching document geometry",n),s(this,L).getValue()&&h<3?(h++,u.next()):s(this,z).count("get_geometry_aborted")}}))))}setText(e){return s(this,R).setText(e)}setSelection(e){return s(this,R).setSelection(s(this,x).getValue().revision,e)}async getRects(e){var i,a=[];try{const r=s(this,W).getValue().geometry;r||s(this,k).warn("Calling TextDocument.getRects() with no geometry revision yet",{delivery:!1});const u=s(this,x).getValue().revision,h=(i=r==null?void 0:r.revision)!=null?i:pe,n=fe(a,s(this,z).duration("get_rects",{labels:{request_kind:s(this,U).getRects===0?"initial":"other",bucket_size:Ve(this,ae,ke).call(this,e.size)},sampler:s(this,N)}),!0);return s(this,U).getRects++,await d(s(this,R).getRectsForRanges(u,e),te(({rects:p,textRevision:g})=>({rects:p,revision:{text:g,geometry:h}})),Q(j(p=>{n.close(p),s(this,k).error("Unexpected error when calling RemoteDocument.getRectsForRanges()",p)})))}catch(r){var c=r,l=!0}finally{var o=ge(a,c,l);o&&await o}}async getBoundingRects(e){var i,a=[];try{const r=s(this,W).getValue().geometry;r||s(this,k).warn("Calling TextDocument.getBoundingRects() with no geometry revision yet",{delivery:!1});const u=(i=r==null?void 0:r.revision)!=null?i:pe,h=fe(a,s(this,z).duration("get_bounding_rects",{labels:{request_kind:s(this,U).getBoundingRects===0?"initial":"other",bucket_size:Ve(this,ae,ke).call(this,e.size)},sampler:s(this,N)}),!0);return s(this,U).getBoundingRects++,await d(s(this,R).getBoundingRectForRanges(s(this,x).getValue().revision,e),te(({rects:n,textRevision:p})=>({rects:n,revision:{text:p,geometry:u}})),Q(j(n=>{h.close(n),s(this,k).error("Unexpected error when calling RemoteDocument.getBoundingRectForRanges()",n)})))}catch(r){var c=r,l=!0}finally{var o=ge(a,c,l);o&&await o}}[Symbol.dispose](){s(this,F).dispose()}}k=new WeakMap;F=new WeakMap;x=new WeakMap;se=new WeakMap;N=new WeakMap;re=new WeakMap;y=new WeakMap;_=new WeakMap;S=new WeakMap;W=new WeakMap;ne=new WeakMap;L=new WeakMap;q=new WeakMap;z=new WeakMap;U=new WeakMap;R=new WeakMap;ae=new WeakSet;ke=function(t){return Math.ceil(t/10).toString()};var zt=Object.defineProperty,Ue=t=>{throw TypeError(t)},Ut=(t,e,i)=>e in t?zt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,ee=(t,e,i)=>Ut(t,typeof e!="symbol"?e+"":e,i),Gt=(t,e,i)=>e.has(t)||Ue("Cannot "+i),ve=(t,e,i)=>(Gt(t,e,"read from private field"),i?i.call(t):e.get(t)),Nt=(t,e,i)=>e.has(t)?Ue("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),X;class Lt{constructor(e,i){Nt(this,X,new AsyncDisposableStack),ee(this,"startedAt",performance.now()),ee(this,"remoteDocument"),ee(this,"document"),ee(this,"documentId"),this.remoteDocument=e,this.documentId=e.id,this.document=ve(this,X).use(new Bt(e,i))}use(e){return ve(this,X).use(e)}async[Symbol.asyncDispose](){await ve(this,X).disposeAsync()}}X=new WeakMap;var qt=Object.defineProperty,Oe=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),le=t=>{throw TypeError(t)},Xt=(t,e,i)=>e in t?qt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,Ht=(t,e,i)=>Xt(t,e+"",i),Se=(t,e,i)=>e.has(t)||le("Cannot "+i),m=(t,e,i)=>(Se(t,e,"read from private field"),i?i.call(t):e.get(t)),C=(t,e,i)=>e.has(t)?le("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),Pe=(t,e,i,a)=>(Se(t,e,"write to private field"),e.set(t,i),i),T=(t,e,i)=>(Se(t,e,"access private method"),i),Ie=(t,e,i)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&le("Object expected");var a;i&&(a=e[Oe("asyncDispose")]),a===void 0&&(a=e[Oe("dispose")]),typeof a!="function"&&le("Object not disposable"),t.push([i,a,e])}else i&&t.push([i]);return e},Jt=(t,e,i)=>{var a=typeof SuppressedError=="function"?SuppressedError:function(o,r,u,h){return h=Error(u),h.name="SuppressedError",h.error=o,h.suppressed=r,h},c=o=>e=i?new a(o,e,"An error was suppressed during disposal"):(i=!0,o),l=o=>{for(;o=t.pop();)try{var r=o[1]&&o[1].call(o[2]);if(o[0])return Promise.resolve(r).then(l,u=>(c(u),l()))}catch(u){c(u)}if(i)throw e};return l()},G,b,ue,J,H,Y,D,Fe,he,Ge,Te,Ne;const Yt=100;class oe{constructor(e,i,a){C(this,D),C(this,G,new AsyncDisposableStack),C(this,b,[]),C(this,ue),C(this,J),C(this,H,new P(null)),C(this,Y,ze.createLogger("DocumentSessionManager")),Ht(this,"activeDocumentId",B(m(this,H))),Pe(this,ue,e),Pe(this,J,a),m(this,G).use(i.documentDidCreate.subscribe(c=>{m(this,G).use(d(A(c.hasFocus),De(),I(l=>{l?(m(this,H).next(c.id),T(this,D,Ge).call(this,c)||T(this,D,Ne).call(this,c)):m(this,H).next(null)})))})),m(this,G).use(i.documentWillDestroy.subscribe(c=>{const l=T(this,D,Te).call(this,c);l&&T(this,D,he).call(this,l,"document will destroy")}))}async[Symbol.asyncDispose](){return m(this,G).disposeAsync()}}G=new WeakMap;b=new WeakMap;ue=new WeakMap;J=new WeakMap;H=new WeakMap;Y=new WeakMap;D=new WeakSet;Fe=function(t){const e=m(this,b).indexOf(t);if(e===-1?m(this,b).push(t):(m(this,b).splice(e,1),m(this,b).push(t)),m(this,b).length>Yt){const i=m(this,b).shift();i!==void 0&&T(this,D,he).call(this,i,"session list is overflown")}};he=function(t,e){const i=m(this,b).indexOf(t);i!==-1&&(m(this,b).splice(i,1),m(this,Y).verbose({context:t.remoteDocument.id},"Disposing session for document because ".concat(e,"."))),tt(t)};Ge=function(t){const e=T(this,D,Te).call(this,t);return e&&T(this,D,Fe).call(this,e),e};Te=function(t){var e;return(e=m(this,b).find(i=>i.remoteDocument.id===t.id))!=null?e:null};Ne=async function(t){var e=[];try{const l=Ie(e,m(this,J).duration("create_session")),o=Ie(e,new AsyncDisposableStack,!0),r=new Lt(t,m(this,J));r.use(t),m(this,Y).verbose({context:r.remoteDocument.id},"Create a session for document."),T(this,D,Fe).call(this,r),o.defer(()=>T(this,D,he).call(this,r,"session is disposed")),await d(m(this,ue).createExecutionScopeController("document-session",{id:it?t.id:void 0,data:{documentId:t.id}}),ye.use(o),Me(u=>d(_e.all([u.register({token:gt,useValue:r.document}),u.register({token:vt,useValue:r.document}),u.register({token:wt,useValue:r}),u.realm.registerEntity({token:ct,useFactory:h=>O($(A(r.document.hasFocus)),h)}),u.realm.registerEntity({token:lt,useFactory:h=>O($(A(r.document.lastFocusAt)),h)}),u.realm.registerEntity({token:ut,useFactory:h=>O($(A(r.document.geometry)),h)}),u.realm.registerEntity({token:ht,useFactory:h=>O(d(ie(r.document.textChange),Be(n=>({revision:n.revision,change:n.change.toJSON()})),$),h)}),u.realm.registerEntity({token:mt,useFactory:h=>O($(A(r.document.selection)),h)}),u.realm.registerEntity({token:dt,useFactory:h=>O(r.document.geometryWillChange,h)})]),ye.use(o),te(()=>u))),Me(u=>u.start()),st({success:()=>{r.use(o.move())},failure:u=>{l.close(u),m(this,Y).error("Failed to create a session due to:",u,{context:r.remoteDocument.id})}}))}catch(l){var i=l,a=!0}finally{var c=Jt(e,i,a);c&&await c}};const Le=ot(),Di=t=>_e.all([d(nt([t.getPlugin("connector"),t.getPlugin("monitoring"),t.getPlugin("document-group"),we(t.getExecutionScopeDefinition("document-group"))]),rt(([e,i,a,c])=>_e.all([...Zt(c,a,e,i),we(c.onStart(async l=>ye.all([l.resolve(oe),l.realm.registerEntity({token:pt,useToken:Le})])))])))]);function Zt(t,e,i,a){return[t.register({token:Le,useFactory:c=>d(c.resolve(Ee),at(l=>o=>ft(l.activeDocumentId,o)))},{lifetime:We.Singleton}),t.register({token:Ee,useToken:oe}),t.register({token:oe,useFactory:Rt(oe,[e.provides.DocumentGroupScope,i.provides.ConnectorDocumentManager,a.provides.Monitoring])},{lifetime:We.Singleton})]}export{Di as activate};
//# sourceMappingURL=index-BEwZR8xZ.js.map
