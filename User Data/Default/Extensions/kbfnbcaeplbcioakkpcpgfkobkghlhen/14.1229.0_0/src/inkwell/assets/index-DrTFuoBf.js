import{w as F,ag as E,a3 as Y,p as g,t as D,A as y,ac as $,K as Z,S as P,T as N,G as O,D as z,l as q,$ as tt,L,s as H}from"./index-DbtAbjfk.js";import{s as et}from"./share-D5q_PZU1.js";import{r as K,t as it}from"./tap-CTBWtjxW.js";import{t as W}from"./take-Dbhfwukx.js";import{o as j}from"./of-Bh-sjQwK.js";import{a as ot}from"./async-C23VpIJo.js";import{t as nt}from"./timer-zq0ZEleB.js";import{s as rt}from"./startWith-LiRdE3gi.js";import{t as st}from"./PointFns-Cqc_hcsO-DfLreJud.js";import{InlineCardWindowToken as G,InlineCardControllerToken as at}from"./index-D2JXN8Q7.js";import{d as ct}from"./defineFactory-DJYNRBNc-CQmG8A-U.js";import"./mergeAll-Ci-uq6t1.js";import"./concat-KLZEPRCF.js";import"./PluginModule-CRib3PLZ-ls39AzbW.js";function dt(e){return F(function(){return e})}function ut(e,t){return E(function(i,o){return Y(e(i,o)).pipe(W(1),dt(i))})}function B(e,t){t===void 0&&(t=ot);var i=nt(e,t);return ut(function(){return i})}function pt(e){return{x:-e.x,y:-e.y}}function lt(e,t){return{x:e.x+t.x,y:e.y+t.y}}const ft={invert:pt,add:lt};function J(e){return t=>t.kind==="pointerEnter"&&t.decorationId!==e||t.kind==="pointerLeave"&&t.decorationId===e}function ht(e,t){return i=>{const o=i.decorationId;return g(e,y(J(o)),E(()=>K(g(j({kind:"stop"}),B(t)),g(e,y(r=>r.decorationId===o&&r.kind==="pointerEnter"),W(1),F(()=>null)))),y($),W(1),rt({kind:"start",event:i}))}}function yt(e,t){const i=Z(e);function o(n){return n.kind==="pointerEnter"}let r={kind:"not-hovering"};return g(i,y(o),y(n=>r.kind==="not-hovering"||n.decorationId!==r.decorationId),E(n=>K(g(j(n),B(t),E(ht(i,t-1)),it(a=>{r=a.kind==="start"?{kind:"hovering",decorationId:a.event.decorationId}:{kind:"not-hovering"}})),g(i,y(J(n.decorationId)),W(1),F(()=>null)))),y($),et(),D)}var Q=e=>{throw TypeError(e)},R=(e,t,i)=>t.has(e)||Q("Cannot "+i),s=(e,t,i)=>(R(e,t,"read from private field"),i?i.call(e):t.get(e)),l=(e,t,i)=>t.has(e)?Q("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,i),b=(e,t,i,o)=>(R(e,t,"write to private field"),t.set(e,i),i),h,S,I,w,x,f,C,A;class M{constructor(t,i,o){this.executionScopeFactory=t,this.window=i,this.decorationController=o,l(this,h,new AsyncDisposableStack),l(this,S,new P),l(this,I,new P),l(this,w,new Set),l(this,x),l(this,f,null),l(this,C),l(this,A,r=>Array.from(s(this,w)).some(n=>n(r))),b(this,C,i),b(this,x,t),s(this,h).use(o.addVisibilitySource(D(s(this,S)))),s(this,h).use(o.onTextDecorationInteraction(r=>s(this,I).next(r),s(this,A))),s(this,h).use(yt(D(s(this,I)),100).subscribe(async r=>{r.kind==="start"?await this.createExecutionScope(r.event):await this.destroyExecutionScope()}))}async createExecutionScope(t){return await this.destroyExecutionScope(),N(async i=>{s(this,S).next({partial:!0,changes:[{id:{kind:"decoration",decorationId:t.decorationId},visibility:"emphasized"}]});const o=ft.add(t.viewportOffset,t.windowOffset),r=st(o),n={decorationId:t.decorationId,suggestionId:t.suggestionId,position:r(t.position),windowId:s(this,C).id};return b(this,f,s(this,h).use(await i(s(this,x).createExecutionScopeController("inline-card-interaction",{data:n})))),s(this,f).use(O(()=>{s(this,S).next({partial:!0,changes:[{id:{kind:"decoration",decorationId:t.decorationId},visibility:"visible"}]})})),s(this,f).start()})}async destroyExecutionScope(){s(this,f)&&(await s(this,f)[Symbol.asyncDispose](),b(this,f,null))}async[Symbol.asyncDispose](){await s(this,h).disposeAsync()}registerTextDecorationCanHandlePredicate(t){return s(this,w).add(t),O(()=>s(this,w).delete(t))}}h=new WeakMap;S=new WeakMap;I=new WeakMap;w=new WeakMap;x=new WeakMap;f=new WeakMap;C=new WeakMap;A=new WeakMap;var gt=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),V=e=>{throw TypeError(e)},U=(e,t,i)=>{if(t!=null){typeof t!="object"&&typeof t!="function"&&V("Object expected");var o;o===void 0&&(o=t[gt("dispose")]),typeof o!="function"&&V("Object not disposable"),e.push([i,o,t])}return t},X=(e,t,i)=>{var o=typeof SuppressedError=="function"?SuppressedError:function(a,c,u,d){return d=Error(u),d.name="SuppressedError",d.error=a,d.suppressed=c,d},r=a=>t=i?new o(a,t,"An error was suppressed during disposal"):(i=!0,a),n=a=>{for(;a=e.pop();)try{var c=a[1]&&a[1].call(a[2]);if(a[0])return Promise.resolve(c).then(n,u=>(r(u),n()))}catch(u){r(u)}if(i)throw t};return n()};const Pt=async e=>z(t=>{var i=[];try{q.info("Inline Card activated (background)");const n=U(i,new DisposableStack),a=t(e.getPlugin("inline-decorations")),c=t(e.getPlugin("suggestion")),u=t(e.getPlugin("document-group")),d=e.getExecutionScopeDefinition("document-session"),m=e.getExecutionScopeDefinition("document-group");return n.use(t(d.register({token:M,useFactory:ct(M,[tt,G,a.provides.TextDecorationController])},{lifetime:L.Singleton}))),n.use(t(d.register({token:at,useFactory:p=>p.resolve(M)},{lifetime:L.Singleton}))),n.use(m.onStart(async p=>N(async v=>{const k=await v(p.resolve(u.provides.WindowFactory)),_=await v(k.createWindow({injectionOptions:{kind:"popup"},clickThroughTransparent:!1,plugins:["inline-card"],fitContent:!0}));return m.register({token:G,useValue:_})}))),n.use(d.onStart(async p=>mt(p,a,c))),H(n.move())}catch(n){var o=n,r=!0}finally{X(i,o,r)}});function mt(e,t,i){return z(o=>{var r=[];try{const c=U(r,new DisposableStack),u=o(e.resolve(t.provides.TextDecorationController)),d=o(e.resolve(i.provides.SuggestionManager)),m=new P;c.use(u.addVisibilitySource(D(m)));const p=new Set;return c.use(d.getCollection().onChange.subscribe(v=>{var k,_;(k=v.upserted)==null||k.forEach(T=>{p.add(T.id)}),(_=v.removed)==null||_.forEach(T=>{p.delete(T.id)})})),c.defer(()=>m.complete()),H(c.move())}catch(c){var n=c,a=!0}finally{X(r,n,a)}})}export{Pt as activate,mt as onDocumentSessionStart};
//# sourceMappingURL=index-DrTFuoBf.js.map
