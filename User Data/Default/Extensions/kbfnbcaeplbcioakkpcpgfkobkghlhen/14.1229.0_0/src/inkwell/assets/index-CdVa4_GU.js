var X=Object.defineProperty;var M=n=>{throw TypeError(n)};var Y=(n,e,s)=>e in n?X(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s;var A=(n,e,s)=>Y(n,typeof e!="symbol"?e+"":e,s),x=(n,e,s)=>e.has(n)||M("Cannot "+s);var o=(n,e,s)=>(x(n,e,"read from private field"),s?s.call(n):e.get(n)),p=(n,e,s)=>e.has(n)?M("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,s),E=(n,e,s,i)=>(x(n,e,"write to private field"),i?i.call(n,s):e.set(n,s),s),C=(n,e,s)=>(x(n,e,"access private method"),s);import{o as Z,k as ee,S as se,B as te,t as ne,n as $,l as q,p as l,q as ie,r as U,i as z,v as J,w as oe,a as re,u as F,x as ce,C as G,U as ae,R as H,s as L,y as de,m as S,z as le,A as ue,D as he,g as N,j as W,L as y,E as _,c as D}from"./index-DbtAbjfk.js";import{CAPIConnectionToken as K}from"./index-OFTk5sUT.js";import{W as ge}from"./CAPIWebSocketTransport-BECrZbf6-DxXm2fku.js";import"./PluginModule-CRib3PLZ-ls39AzbW.js";function pe(){return Z(function(n,e){var s,i=!1;n.subscribe(ee(e,function(t){var r=s;s=t,i&&e.next([r,t]),i=!0}))})}var w,c,m,v,f,b,I,g,Q,T,V;class fe{constructor(e,s){p(this,g);p(this,w,new se);p(this,c,new te({kind:"disconnected",sessionId:null}));p(this,m);p(this,v);p(this,f,new DisposableStack);p(this,b,[]);p(this,I,new Map);A(this,"events",ne(o(this,w)));A(this,"status",C(this,g,Q).call(this));o(this,f).defer(()=>$(e)),E(this,m,e),E(this,v,s),o(this,f).defer(()=>{const i=o(this,c).getValue();i.kind==="connecting"&&i.controller.abort(),o(this,c).next({kind:"disconnected",sessionId:"sessionId"in i?i.sessionId:null})})}[Symbol.dispose](){o(this,f).dispose()}connect(){if(o(this,f).disposed)return q.warn("Cannot connect after the CAPIClient was disposed.");const e=o(this,c).getValue();if(e.kind==="connecting"||e.kind==="connected")return;const s="sessionId"in e?e.sessionId:null,i=new AbortController;l(o(this,m).create({...o(this,v),previous:e.transport}),U(t=>o(this,c).next({kind:"connecting",transport:t,controller:i})),z(async t=>{if(i.signal.aborted)return $(t);const r=await t.sessionId;o(this,c).next({kind:"connected",transport:t,sessionId:r,isNewSession:r!==s}),C(this,g,V).call(this);let d=!1;const h=new DisposableStack;o(this,f).use(h),h.use(t),h.use(t.didReceive.subscribe(a=>{const u=o(this,I).get(a.id);u&&(o(this,I).delete(a.id),u.resolve(a)),o(this,w).next(a)})),h.use(t.didError.subscribe(a=>{d=!0,o(this,c).next(l(o(this,c).getValue(),u=>({kind:"error",error:a,transport:t,sessionId:"sessionId"in u?u.sessionId:null})))})),h.use(t.didClose.subscribe(()=>{const a=l(o(this,c).getValue(),k=>"sessionId"in k?k.sessionId:null),u=new be(a);o(this,I).forEach(k=>k.reject(u)),o(this,I).clear(),o(this,b).forEach(({onSend:k,onReceive:P})=>{k.reject(u),P==null||P.reject(u)}),o(this,b).length=0,h.dispose(),d||o(this,c).next({kind:"disconnected",transport:t,sessionId:a})}))}),ie(U(t=>{i.signal.aborted||o(this,c).next(l(o(this,c).getValue(),r=>({kind:"error",error:t,sessionId:"sessionId"in r?r.sessionId:null})))})))}toString(){const e=o(this,c).getValue();switch(e.kind){case"connecting":return"Client(connecting)";case"connected":return"Client(connected: ".concat(e.transport,")");case"disconnected":return"Client(disconnected)";case"error":return"Client(error: ".concat(e.error.message,")")}}send(e,s){const i=Promise.withResolvers();return C(this,g,T).call(this,e,i,void 0,s)}sendAndAwaitResponse(e,s){const i=Promise.withResolvers(),t=Promise.withResolvers();return l(C(this,g,T).call(this,e,i,t,s),re(()=>F(()=>t.promise)))}}w=new WeakMap,c=new WeakMap,m=new WeakMap,v=new WeakMap,f=new WeakMap,b=new WeakMap,I=new WeakMap,g=new WeakSet,Q=function(){const e=s=>{switch(s.kind){case"connecting":return{kind:"connecting"};case"connected":return{kind:"connected",sessionId:s.sessionId,isNewSession:s.isNewSession};case"disconnected":return{kind:"disconnected",sessionId:s.sessionId};case"error":return{kind:"error",sessionId:s.sessionId};default:throw new ae(s)}};return{subscribe:s=>l(o(this,c),oe(e),J(s)),getValue:()=>e(o(this,c).getValue())}},T=function(e,s,i,t){return o(this,b).push({message:e,onSend:s,onReceive:i,signal:t}),C(this,g,V).call(this),l(F(()=>s.promise),z(ce))},V=function(){const e=o(this,c).getValue();e.kind==="connected"&&(o(this,b).forEach(({message:s,onSend:i,onReceive:t,signal:r})=>{if(r!=null&&r.aborted){i.reject(new B),t==null||t.reject(new B);return}const d=e.transport.send(s);d===void 0&&t?q.warn("onReceive callbacks are not supported by this transport"):t&&o(this,I).set(d,t),Reflect.set(s,"id",d),i.resolve(s)}),o(this,b).length=0)};class B extends G{constructor(){super("Message aborted")}}class be extends G{constructor(e){super("CAPI Connection closed (SessionId: ".concat(e,")"))}}const j=D(Symbol("CAPIClient")),R=D(Symbol("CAPIProvider")),O=D(Symbol("CAPIWebSocketUrl")),Se=n=>l(n.getExecutionScopeDefinition("document-session"),e=>H.all([...Ie(n,e),L(e.onStart(s=>de.all([l(s.resolve(j),S(i=>(i.connect(),l(le(i.status),pe(),ue(([t,r])=>t.kind==="connected"&&r.kind==="disconnected"),J(()=>i.connect()))))),he(i=>{const t=i(n.getPlugin("document-session")),r=i(s.resolve(K)),d=i(s.resolve(t.provides.TextDocument));let h=0,a=0;return L(d.textChange.subscribe(async u=>{await r.send({action:"submit_ot",rev:a,doc_len:h,deltas:[u.change.toJSON()]}),a=u.revision,h+=u.change.changeLength}))})])))]));function Ie(n,e){return[l(W([n.getPlugin("document-session"),n.getPlugin("connector")]),N(([s,i])=>H.all([e.register({token:j,useFactory:t=>l(W([t.resolve(R),t.resolve(s.provides.TextDocument)]),S(([r,d])=>new fe(r.create(d.id),{documentId:d.id,textDidChange:d.textChange,getTextContent:()=>d.text.getValue()})))},{lifetime:y.Singleton}),e.register({token:R,useFactory:t=>l(t.resolve(_),N(r=>r.capiSource==="connector"?t.resolve(i.provides.CAPIProvider):l(t.resolve(O),S(d=>({create:h=>new ge({getURL:()=>d,getMessageSanitizer:()=>({sanitize:a=>a,unsanitize:a=>a})})})))))},{lifetime:y.Singleton})]))),e.register({token:O,useFactory:s=>l(s.resolve(_),S(i=>{switch(i.servicesEnvironment){case"prod":return"wss://capi.grammarly.com/fpws";case"preprod":return"wss://capi.ppgr.io/fpws";case"qa":default:return"wss://capi.qagr.io/fpws"}}))},{lifetime:y.Singleton}),e.register({token:K,useToken:j})]}export{Se as activate};
//# sourceMappingURL=index-CdVa4_GU.js.map
