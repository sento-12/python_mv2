var ft=(s,e)=>(e=Symbol[s])?e:Symbol.for("Symbol."+s),Me=s=>{throw TypeError(s)};var gt=(s,e,t)=>e.has(s)||Me("Cannot "+t);var I=(s,e,t)=>(gt(s,e,"read from private field"),t?t.call(s):e.get(s)),$e=(s,e,t)=>e.has(s)?Me("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),J=(s,e,t,n)=>(gt(s,e,"write to private field"),n?n.call(s,t):e.set(s,t),t);var vt=(s,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&Me("Object expected");var n;t&&(n=e[ft("asyncDispose")]),n===void 0&&(n=e[ft("dispose")]),typeof n!="function"&&Me("Object not disposable"),s.push([t,n,e])}else t&&s.push([t]);return e},Dt=(s,e,t)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(i,u,l,p){return p=Error(l),p.name="SuppressedError",p.error=i,p.suppressed=u,p},r=i=>e=t?new n(i,e,"An error was suppressed during disposal"):(t=!0,i),a=i=>{for(;i=s.pop();)try{var u=i[1]&&i[1].call(i[2]);if(i[0])return Promise.resolve(u).then(a,l=>(r(l),a()))}catch(l){r(l)}if(t)throw e};return a()};import{l as F,G as wt,H as jt,n as oe,p as h,i as Ee,d as _t,B as st,S as R,I as yt,t as S,J as qt,s as ue,f as X,w as Ct,K as nt,m as B,C as je,N,O as j,P as fe,Q as W,T as es,g as It,A as ts,D as ss,j as xt,V as ns,v as is,q as os,r as as,R as St,x as rs,L as x,E as cs,c as ds}from"./index-DbtAbjfk.js";import{ConnectorMessageTransportToken as Rt,ConnectorToken as hs,ConnectorDocumentManagerToken as it,ConnectorTextDecorationToken as Wt,ConnectorExperimentationToken as ls,ConnectorCAPIToken as bt,CAPIProviderToken as us}from"./index-FsU1lD7I.js";import{D as Mt}from"./Delta-D-dso3t3-B1UydhvC.js";import{c as Te,u as ps,a as ms}from"./RectFns-ndpeBtT0-CdOd3O5S.js";import{c as fs}from"./PointFns-Cqc_hcsO-DfLreJud.js";import{c as gs}from"./TextRevisionFns-DGbJAFcL-DX1ABpMm.js";import{L as vs}from"./LRUCache-BkqKFOuj-CuqiGFzI.js";import{a as Ds}from"./asap-cBXyJ2Go.js";import{D as ws}from"./CAPIWebSocketTransport-BECrZbf6-DxXm2fku.js";import{c as _s}from"./concat-KLZEPRCF.js";import{d as Cs}from"./defer-r6dTVIJu.js";import{o as Ss}from"./of-Bh-sjQwK.js";import{E as bs}from"./mergeAll-Ci-uq6t1.js";import{R as ks}from"./RandomSampler-Ba-P263P-DyiLAlld.js";import{T as ys}from"./TextRevisionSynchronizedQueue-DQV4bu5q-CHh_yPL8.js";import{d as A}from"./defineFactory-DJYNRBNc-CQmG8A-U.js";import"./PluginModule-CRib3PLZ-ls39AzbW.js";import"./PluginDependency-Boc6-pxl-tjuTwLTj.js";var he,_,le;class $t{constructor(){$e(this,he,[]);$e(this,_,null);$e(this,le,!1)}next(e){I(this,_)?I(this,_).next(e):I(this,he).push(e)}complete(){var e;(e=I(this,_))==null||e.complete(),J(this,_,null),J(this,le,!0)}error(e){var t;(t=I(this,_))==null||t.error(e),J(this,_,null),J(this,le,!0)}subscribe(e){var n=[];try{if(I(this,le))return F.warn("Cannot subscribe to closed SingleConsumerBufferedEmitter"),wt(()=>{});if(I(this,_))return F.error("SingleConsumerBufferedEmitter supports only one subscriber."),wt(()=>{});const t=vt(n,new DisposableStack);J(this,_,jt(e));t.defer(()=>J(this,_,null));I(this,he).forEach(u=>{var l;return(l=I(this,_))==null?void 0:l.next(u)});I(this,he).length=0;return t.move()}catch(r){var a=r,i=!0}finally{Dt(n,a,i)}}[Symbol.dispose](){this.complete()}}he=new WeakMap,_=new WeakMap,le=new WeakMap;var Et=s=>{throw TypeError(s)},ht=(s,e,t)=>e.has(s)||Et("Cannot "+t),k=(s,e,t)=>(ht(s,e,"read from private field"),t?t.call(s):e.get(s)),Pe=(s,e,t)=>e.has(s)?Et("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),Is=(s,e,t,n)=>(ht(s,e,"write to private field"),e.set(s,t),t),kt=(s,e,t)=>(ht(s,e,"access private method"),t),ge,G,q,Oe,ot;class Ve{constructor(e,t){Pe(this,Oe),Pe(this,ge),Pe(this,G,new Map),Pe(this,q,new DisposableStack),Is(this,ge,e),k(this,q).use(k(this,ge).messages.subscribe(n=>kt(this,Oe,ot).call(this,n.message).next(n))),k(this,q).use(t.documentWillDestroy.subscribe(n=>{oe(k(this,G).get(n.id)),k(this,G).delete(n.id)})),k(this,q).defer(()=>{oe(k(this,G).values()),k(this,G).clear()})}create(e){return{messages:kt(this,Oe,ot).call(this,{documentID:e}),send:t=>k(this,ge).send({...t,documentID:e})}}[Symbol.dispose](){k(this,q).dispose()}}ge=new WeakMap;G=new WeakMap;q=new WeakMap;Oe=new WeakSet;ot=function(s){const e=s.documentID;let t=k(this,G).get(e);return t||(t=new $t,k(this,G).set(e,t)),t};var xs=Object.defineProperty,Tt=s=>{throw TypeError(s)},Rs=(s,e,t)=>e in s?xs(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,m=(s,e,t)=>Rs(s,typeof e!="symbol"?e+"":e,t),Pt=(s,e,t)=>e.has(s)||Tt("Cannot "+t),g=(s,e,t)=>(Pt(s,e,"read from private field"),t?t.call(s):e.get(s)),Ge=(s,e,t)=>e.has(s)?Tt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),qe=(s,e,t,n)=>(Pt(s,e,"write to private field"),e.set(s,t),t),Be,O,ee,$;class Ws{constructor(e,t={}){Ge(this,Be,new DisposableStack),m(this,"id"),m(this,"hasFocusSubject",new st(!1)),m(this,"geometryWillChangeSubject",new R),m(this,"geometryDidChangeSubject",new R),m(this,"textDidChangeSubject",new R),m(this,"selectionDidChangeSubject",new R),m(this,"hasFocus",yt(this.hasFocusSubject)),m(this,"geometryWillChange",S(this.geometryWillChangeSubject)),m(this,"geometryDidChange",S(this.geometryDidChangeSubject)),m(this,"textDidChange",S(this.textDidChangeSubject)),m(this,"selectionDidChange",S(this.selectionDidChangeSubject)),m(this,"settings"),this.id=e,this.settings=t,g(this,Be).defer(()=>{this.hasFocusSubject.complete(),this.geometryDidChangeSubject.complete(),this.geometryWillChangeSubject.complete(),this.selectionDidChangeSubject.complete(),this.textDidChangeSubject.complete(),this.selectionDidChangeSubject.complete()})}[Symbol.dispose](){g(this,Be).dispose()}}Be=new WeakMap;class et{constructor(e,t){Ge(this,O),Ge(this,ee),Ge(this,$),m(this,"id"),m(this,"hasFocus"),m(this,"geometryWillChange"),m(this,"geometryDidChange"),m(this,"textDidChange"),m(this,"selectionDidChange"),qe(this,ee,F.createLogger("RemoteDocument",e.id)),qe(this,$,e),qe(this,O,t),this.id=e.id,this.hasFocus=e.hasFocus,this.geometryWillChange=e.geometryWillChange,this.geometryDidChange=e.geometryDidChange,this.textDidChange=e.textDidChange,this.selectionDidChange=e.selectionDidChange}[Symbol.dispose](){g(this,$)[Symbol.dispose]()}async getText(){return await h(g(this,O).getDocumentText({documentID:g(this,$).id}),Ee(e=>({revision:e.revision,content:new Mt(e.document.ops)})))}async setText(e){return await g(this,O).applyDocumentTextChange({documentID:g(this,$).id,revision:e.revision,changes:e.change})}async setSelection(e,t){return await g(this,O).setDocumentSelectedTextRanges({documentID:g(this,$).id,revision:e,ranges:t})}getGeometry(){return h(g(this,O).getDocumentGeometry({documentID:g(this,$).id}),Ee(e=>{var t;return{windowFrame:Te(e.windowFrame),viewportFrame:Te(e.viewportFrame),documentFrame:Te(e.documentFrame),visibleTextRange:(t=e.visibleTextRange)!=null?t:{start:0,end:1/0},scrollPosition:e.documentScrollOffset?fs(e.documentScrollOffset):void 0}}))}getRectsForRanges(e,t){return t.size===0&&g(this,ee).warn("getRectsForRanges() is called with an empty range map."),h(g(this,O).getBoundingBoxesForTextRanges({documentID:g(this,$).id,revision:e,ranges:Object.fromEntries(t)}),Ee(n=>({rects:new Map(h(t.keys(),_t(r=>{const a=n.boundingBoxes[r];return a||g(this,ee).warn("No bounding box found for range with id: ".concat(r)),[r,(a!=null?a:[]).map(i=>Te(i))]}))),textRevision:gs(n.revision)})))}getBoundingRectForRanges(e,t){return t.size===0&&g(this,ee).warn("getBoundingRectForRanges() is called with an empty range map."),h(this.getRectsForRanges(e,t),Ee(n=>({rects:new Map(h(n.rects.entries(),_t(([r,a])=>[r,h(a,ps(ms()))]))),textRevision:n.textRevision})))}}O=new WeakMap;ee=new WeakMap;$=new WeakMap;var Ms=Object.defineProperty,$s=(s,e)=>(e=Symbol[s])?e:Symbol.for("Symbol."+s),Xe=s=>{throw TypeError(s)},Es=(s,e,t)=>e in s?Ms(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,T=(s,e,t)=>Es(s,typeof e!="symbol"?e+"":e,t),lt=(s,e,t)=>e.has(s)||Xe("Cannot "+t),c=(s,e,t)=>(lt(s,e,"read from private field"),t?t.call(s):e.get(s)),D=(s,e,t)=>e.has(s)?Xe("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),L=(s,e,t,n)=>(lt(s,e,"write to private field"),e.set(s,t),t),C=(s,e,t)=>(lt(s,e,"access private method"),t),Ts=(s,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&Xe("Object expected");var n;n===void 0&&(n=e[$s("dispose")]),typeof n!="function"&&Xe("Object not disposable"),s.push([t,n,e])}return e},Ps=(s,e,t)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(i,u,l,p){return p=Error(l),p.name="SuppressedError",p.error=i,p.suppressed=u,p},r=i=>e=t?new n(i,e,"An error was suppressed during disposal"):(t=!0,i),a=i=>{for(;i=s.pop();)try{var u=i[1]&&i[1].call(i[2]);if(i[0])return Promise.resolve(u).then(a,l=>(r(l),a()))}catch(l){r(l)}if(t)throw e};return a()},ce,ae,ve,U,ke,de,ye,De,ut,Ne,P,v,Ft,At,Ot,Vt,Gt,Bt,Nt,Lt,xe,Ut,z,te;const Fs="ca77b3794901e345f5f1a3c5872169ec06411679: O Grammarly, O Grammarly, wherefore art thou open devtools? Deny thy debugger and refuse thy console.log; Or, if thou wilt not, be but sworn my love, And I'll no longer be a developer.";class se{constructor(e,t){D(this,v),D(this,ce,F.createLogger("ConnectorDocumentManager")),D(this,ae,new DisposableStack),D(this,ve),D(this,U,c(this,ae).use(new vs({capacity:10}))),D(this,ke,new R),D(this,de,new R),D(this,ye,new st(!1)),D(this,De,0),D(this,ut,new st(null)),D(this,Ne,{}),D(this,P,null),T(this,"documentDidCreate",S(h(c(this,ke),qt(Ds)))),T(this,"documentWillDestroy",S(c(this,de))),T(this,"debugEnabled",yt(c(this,ye))),T(this,"handler",{echo:i=>N(i),cancel:()=>N(),documentDidFocus:i=>C(this,v,Nt).call(this,i,c(this,Ne)),documentDidDestroy:i=>j(C(this,v,Lt).call(this,i)),documentGeometryWillChange:i=>j(C(this,v,Ot).call(this,i)),documentGeometryDidChange:i=>j(C(this,v,Bt).call(this,i)),documentTextDidChange:i=>j(C(this,v,Vt).call(this,i)),documentSelectedTextRangesDidChange:i=>j(C(this,v,Gt).call(this,i)),handshake:async i=>(L(this,Ne,i.options),i.protocolVersion!==c(this,De)?fe(new As({protocolVersion:i.protocolVersion,expectedProtocolVersion:c(this,De)})):ue({client:c(this,ve).name,version:c(this,ve).version,protocolVersion:c(this,De),options:{}}))});var n=[];try{L(this,ve,t);const i=Ts(n,new DisposableStack);i.defer(()=>{c(this,ke).complete(),c(this,de).complete(),c(this,ye).complete()}),c(this,ae).use(i.move())}catch(i){var r=i,a=!0}finally{Ps(n,r,a)}}[Symbol.dispose](){c(this,ae).dispose()}getRemoteDocument(e){const t=c(this,U).get(e);return t?ue(t):X(new pe(e))}}ce=new WeakMap;ae=new WeakMap;ve=new WeakMap;U=new WeakMap;ke=new WeakMap;de=new WeakMap;ye=new WeakMap;De=new WeakMap;ut=new WeakMap;Ne=new WeakMap;P=new WeakMap;v=new WeakSet;Ft=function(s){var e;((e=c(this,P))==null?void 0:e.id)===s&&L(this,P,null);const t=c(this,U).get(s);return t?(t[Symbol.dispose](),c(this,U).delete(s),W(()=>c(this,de).next(t))):X(new pe(s))};At=function(s,e){var t;return((t=c(this,P))==null?void 0:t.id)===s&&L(this,P,null),e[Symbol.dispose](),W(()=>c(this,de).next(e))};Ot=function(s){const e=C(this,v,xe).call(this,s.documentID);return e?W(()=>e.geometryWillChangeSubject.next(new Set(s.reasons))):X(new pe(s.documentID))};Vt=function(s){const e=C(this,v,xe).call(this,s.documentID);if(!e)return X(new pe(s.documentID));const t=s.changes.ops.find(n=>"insert"in n&&typeof n.insert=="string");if(t&&String(t.insert).includes(Fs))try{c(this,ye).next(!0)}catch{}return W(()=>e.textDidChangeSubject.next({revision:s.revision,change:new Mt(s.changes.ops)}))};Gt=function(s){const e=C(this,v,xe).call(this,s.documentID);return e?W(()=>e.selectionDidChangeSubject.next(s.ranges)):X(new pe(s.documentID))};Bt=function(s){const e=C(this,v,xe).call(this,s.documentID);return e?W(()=>e.geometryDidChangeSubject.next(new Set(s.reasons))):X(new pe(s.documentID))};Nt=function(s,e){return es(async t=>{const n=s?s.documentID:null;t(W(()=>c(this,ut).next(n)));const r=c(this,P);if(n===null)return r!==null&&(t(W(()=>r.hasFocusSubject.next(!1))),c(this,ce).verbose({context:r.id},"Document blurred"),L(this,P,null)),N();let a=c(this,U).get(n);return a||(a=await t(C(this,v,Ut).call(this,n,e))),r!==null&&a.id!==r.id&&(c(this,ce).verbose({context:r.id},"Document blurred"),t(W(()=>r.hasFocusSubject.next(!1)))),L(this,P,a),t(W(()=>a.hasFocusSubject.next(!0))),c(this,ce).verbose({context:a.id},"Document focused"),N()})};Lt=function(s){return C(this,v,Ft).call(this,s.documentID)};xe=function(s){return c(this,U).get(s)};Ut=function(s,e){c(this,ce).verbose({context:s},"Document created");const t=c(this,ae).use(new Ws(s,e)),n=c(this,U).set(s,t);if(n){const[r,a]=n,i=C(this,v,At).call(this,r,a);if(!i.ok)return i}return h(W(()=>c(this,ke).next(t)),B(()=>t))};class tt{constructor(e,t){D(this,z),D(this,te),T(this,"debugEnabled"),T(this,"documentDidCreate"),T(this,"documentWillDestroy"),L(this,z,e),L(this,te,t.createClient()),this.debugEnabled=c(this,z).debugEnabled,this.documentDidCreate=h(nt(c(this,z).documentDidCreate),Ct(n=>new et(n,c(this,te))),S),this.documentWillDestroy=h(nt(c(this,z).documentWillDestroy),Ct(n=>new et(n,c(this,te))),S)}getRemoteDocument(e){return h(c(this,z).getRemoteDocument(e),B(t=>new et(t,c(this,te))))}}z=new WeakMap;te=new WeakMap;class pe extends je{constructor(e){super("Document not found"),this.documentId=e}toJSON(){return{...super.toJSON(),documentId:this.documentId}}}class As extends je{constructor(e){super("Unsupported protocol version"),T(this,"protocolVersion"),T(this,"expectedProtocolVersion"),this.protocolVersion=e.protocolVersion,this.expectedProtocolVersion=e.expectedProtocolVersion}toJSON(){return{...super.toJSON(),protocolVersion:this.protocolVersion,expectedProtocolVersion:this.expectedProtocolVersion}}}var Os=Object.defineProperty,Jt=s=>{throw TypeError(s)},Vs=(s,e,t)=>e in s?Os(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ze=(s,e,t)=>Vs(s,typeof e!="symbol"?e+"":e,t),pt=(s,e,t)=>e.has(s)||Jt("Cannot "+t),o=(s,e,t)=>(pt(s,e,"read from private field"),t?t.call(s):e.get(s)),y=(s,e,t)=>e.has(s)?Jt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),at=(s,e,t,n)=>(pt(s,e,"write to private field"),e.set(s,t),t),Gs=(s,e,t)=>(pt(s,e,"access private method"),t),Le,E,we,rt,H,Q,Ue,Ie,ct,zt,V,b,K;class Je{constructor(e,t){y(this,Le,new DisposableStack),y(this,E,new R),y(this,we,new Set),y(this,rt,F.createLogger("ConnectorCAPI")),y(this,H),y(this,Q),Ze(this,"messages",S(o(this,E))),Ze(this,"handler",{capiConnected:async n=>h(o(this,H).getRemoteDocument(n.documentID),B(()=>{o(this,we).add(n.sessionID),o(this,E).next({kind:"connected",message:n})})),capiDisconnected:async n=>h(o(this,H).getRemoteDocument(n.documentID),B(()=>{o(this,we).delete(n.sessionID),o(this,E).next({kind:"disconnected",message:n})})),capiMessageReceived:async n=>h(o(this,H).getRemoteDocument(n.documentID),B(()=>o(this,E).next({kind:"messageReceived",message:n}))),capiAlertRemoved:async n=>h(o(this,H).getRemoteDocument(n.documentID),It(()=>o(this,we).has(n.sessionID)?ue(o(this,E).next({kind:"messageReceived",message:{documentID:n.documentID,sessionID:n.sessionID,message:{id:parseInt(n.alertID),action:"remove"}}})):(o(this,rt).warn("Received capiAlertRemoved for disconnected session ".concat(n.sessionID)),X(new Ns(n.sessionID))))),capiTextRevision:n=>N(o(this,E).next({kind:"textRevision",message:n})),capiWebSocketCreate:n=>o(this,Q).handleCreate(n),capiWebSocketSend:n=>o(this,Q).handleSend(n),capiWebSocketConnect:n=>o(this,Q).handleConnect(n),capiWebSocketClose:n=>o(this,Q).handleClose(n)}),at(this,H,e),at(this,Q,t),o(this,Le).defer(()=>o(this,E).complete())}[Symbol.dispose](){o(this,Le).dispose()}}Le=new WeakMap;E=new WeakMap;we=new WeakMap;rt=new WeakMap;H=new WeakMap;Q=new WeakMap;class Bs{constructor(e,t,n){y(this,ct),y(this,Ue,new DisposableStack),y(this,Ie),Ze(this,"messages"),at(this,Ie,e.createClient()),this.messages=t.messages,o(this,Ue).use(n.outboundMessages.subscribe(r=>Gs(this,ct,zt).call(this,r)))}[Symbol.dispose](){o(this,Ue).dispose()}send(e){return o(this,Ie).sendCapiMessage(e)}}Ue=new WeakMap;Ie=new WeakMap;ct=new WeakSet;zt=function(s){const e=o(this,Ie)[s.method];e(s.data)};class Fe{constructor(){y(this,V,new DisposableStack),y(this,b,new Map),y(this,K,new R),Ze(this,"outboundMessages",S(o(this,K))),o(this,V).defer(()=>{for(const e of o(this,b).values())e[Symbol.dispose]();o(this,b).clear()})}[Symbol.dispose](){o(this,V).dispose()}handleCreate(e){const t=new ws(e.endpointUrl);return o(this,b).set(e.documentID,t),o(this,V).use(t.didOpen.subscribe(()=>{o(this,K).next({method:"capiWebSocketOpened",data:{documentID:e.documentID}})})),o(this,V).use(t.didClose.subscribe(n=>{o(this,K).next({method:"capiWebSocketClosed",data:{documentID:e.documentID,code:n.code,reason:n.reason,wasClean:n.wasClean}})})),o(this,V).use(t.messageReceived.subscribe(n=>{o(this,K).next({method:"capiWebSocketMessage",data:{documentID:e.documentID,data:n.data}})})),o(this,V).use(t.didError.subscribe(()=>{o(this,K).next({method:"capiWebSocketError",data:{documentID:e.documentID,message:"An error occurred in the web socket connection."}})})),N()}handleConnect(e){if(o(this,b).has(e.documentID)){const t=o(this,b).get(e.documentID);if(t)return t.connect(),N()}return fe(new Error("No socket found"))}handleClose(e){if(o(this,b).has(e.documentID)){const t=o(this,b).get(e.documentID);if(t)return t.close(),o(this,b).delete(e.documentID),t[Symbol.dispose](),N()}return fe(new Error("No socket found"))}handleSend(e){if(o(this,b).has(e.documentID)){const t=o(this,b).get(e.documentID);return t?j(t.send(e.data)):fe(new Error("Failed to send message"))}return fe(new Error("No socket found"))}}V=new WeakMap;b=new WeakMap;K=new WeakMap;class Ns extends je{constructor(e){super("Unknown CAPI session ID"),this.sessionId=e}toJSON(){return{...super.toJSON(),sessionId:this.sessionId}}}var Ls=Object.defineProperty,Ht=s=>{throw TypeError(s)},Us=(s,e,t)=>e in s?Ls(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Js=(s,e,t)=>Us(s,e+"",t),Qt=(s,e,t)=>e.has(s)||Ht("Cannot "+t),w=(s,e,t)=>(Qt(s,e,"read from private field"),t?t.call(s):e.get(s)),re=(s,e,t)=>e.has(s)?Ht("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),dt=(s,e,t,n)=>(Qt(s,e,"write to private field"),e.set(s,t),t),_e,Ce,ze,ne,He,Qe;class Ke{constructor(e){re(this,_e,new DisposableStack),re(this,Ce,new R),re(this,ze),re(this,ne,new Map),Js(this,"handler",{setTextDecorationVisibility:async t=>h(w(this,ze).getRemoteDocument(t.documentID),B(n=>{let r=w(this,ne).get(n.id);r||(r=new Map,w(this,ne).set(n.id,r)),t.partial||r.clear(),t.changes.forEach(a=>{a.visibility==="hidden"?r.delete(a.alertId):r.set(a.alertId,a)}),w(this,Ce).next(t)}))}),dt(this,ze,e),w(this,_e).use(e.documentWillDestroy.subscribe(t=>{w(this,ne).delete(t.id)})),w(this,_e).defer(()=>w(this,Ce).complete())}getTextDecorationVisibilityChangeRequests(e){return h(_s(Cs(()=>{var t;const n=(t=w(this,ne).get(e))!=null?t:new Map;return n.size>0?Ss({documentId:e,partial:!1,changes:Array.from(n.values())}):bs}),h(w(this,Ce),ts(t=>t.documentID===e))),S)}[Symbol.dispose](){w(this,_e).dispose()}}_e=new WeakMap;Ce=new WeakMap;ze=new WeakMap;ne=new WeakMap;class zs{constructor(e,t){re(this,He),re(this,Qe),dt(this,He,e.createClient()),dt(this,Qe,t)}getTextDecorationVisibilityChangeRequests(e){return w(this,Qe).getTextDecorationVisibilityChangeRequests(e)}notifyTextDecorationInteraction(e){return w(this,He).handleTextDecorationInteraction(e)}}He=new WeakMap;Qe=new WeakMap;function Hs(s,e){return ss(t=>{const[n,r,a,i,u]=t(xt([e.resolve(Rt),e.resolve(se),e.resolve(Je),e.resolve(Ke),e.resolve(s.provides.Monitoring)])),l=new ks({probability:.01});return ue(new ns(n,{logger:{location:"Background",name:"Connector"},handler:{...r.handler,...a.handler,...i.handler},report:u&&l.shouldSelect()?p=>u.duration("".concat(p.kind,"_rpc_call"),{labels:{rpc_method_name:p.action}}).close(p.error,{durationInSeconds:p.durationInMs/1e3}):void 0}))})}var Kt=s=>{throw TypeError(s)},Yt=(s,e,t)=>e.has(s)||Kt("Cannot "+t),Qs=(s,e,t)=>(Yt(s,e,"read from private field"),t?t.call(s):e.get(s)),Ks=(s,e,t)=>e.has(s)?Kt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),Ys=(s,e,t,n)=>(Yt(s,e,"write to private field"),e.set(s,t),t),Ye;class Xs{constructor(e){Ks(this,Ye),Ys(this,Ye,e.createClient())}makeExperimentationRequest(e){return Qs(this,Ye).makeExperimentationRequest(e)}}Ye=new WeakMap;var Xt=s=>{throw TypeError(s)},Zt=(s,e,t)=>e.has(s)||Xt("Cannot "+t),M=(s,e,t)=>(Zt(s,e,"read from private field"),t?t.call(s):e.get(s)),Ae=(s,e,t)=>e.has(s)?Xt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),Z=(s,e,t,n)=>(Zt(s,e,"write to private field"),e.set(s,t),t),Se,ie,Y,be;class Zs{constructor(e,t){Ae(this,Se),Ae(this,ie),Ae(this,Y,null),Ae(this,be,null),Z(this,ie,e),Z(this,Se,t)}[Symbol.dispose](){oe(M(this,be))}async create(e){oe(M(this,be));let t=M(this,Y);const n=F.createLogger("CAPITransport",M(this,ie)),r=M(this,ie),a=new Map,i=new ys,u=new $t,l=new R,p=new R,me=Promise.withResolvers(),Re=new DisposableStack;t!==null&&me.resolve(t);const We=M(this,Se).messages.subscribe(d=>{if(Re.disposed)return F.warn("Received a message after the transport was disposed.");switch(d.kind){case"connected":Z(this,Y,d.message.sessionID),t===null?(t=d.message.sessionID,n.verbose("Connected to session ".concat(t)),me.resolve(t)):t!==d.message.sessionID&&(n.warn("Received a 'connected' message for session \"".concat(d.message.sessionID,'" while already connected with the session ').concat(t,".")),oe(We),l.next({webSocket:void 0}));break;case"disconnected":M(this,Y)===d.message.sessionID&&Z(this,Y,null),t===d.message.sessionID?(me.reject(new js(t)),n.verbose("Disconnected from session ".concat(t)),t=null,oe(We),l.next({webSocket:void 0})):t!==null?n.warn("Received a 'disconnected' message for session \"".concat(d.message.sessionID,'" while connected with the session "').concat(t,'".')):n.warn("Received a 'disconnected' message for session \"".concat(d.message.sessionID,'" while not connected.'));break;case"messageReceived":{const f=d.message.message;t===null?(t=d.message.sessionID,n.verbose("Connected to session ".concat(t)),Z(this,Y,t),me.resolve(t),n.warn("Received a '".concat(f.action,"' message before 'connected' message. Assuming CAPI is connected with the session \"").concat(t,'".')),i.enqueue(f,"rev"in f?f.rev:void 0)):t===d.message.sessionID?i.enqueue(f,"rev"in f?f.rev:void 0):n.warn("Received a '".concat(f.action,"' message for session \"").concat(d.message.sessionID,'" while connected with the session "').concat(t,'".'));break}case"textRevision":{const{capiRevision:f,documentRevision:mt}=d.message;t===d.message.sessionID?(n.verbose("Received text revision:",d.message),a.set(f,mt),i.pushNewTextRevision(f)):n.warn("Received a text revision (capi ".concat(f," -> ").concat(mt,') for session "').concat(d.message.sessionID,'" while connected with the session "').concat(t,'".'));break}}});return Re.use(We),Z(this,be,We),Re.use(h(nt(i.messages),is(d=>{if("rev"in d){const f=a.get(d.rev);f===void 0?n.warn("Received a message (".concat(d.action,") with unknown revision ").concat(d.rev)):Reflect.set(d,"rev",f)}u.next(d)}))),ue({sessionId:me.promise,send:d=>{t===null?(n.warn("Attempt to send a message without a sessionID"),n.verbose("Message:",d)):h(M(this,Se).send({documentID:r,sessionID:t,message:d}),os(as(f=>{n.error("Failed to send a message",f),n.verbose("Message:",d)})))},didClose:S(l),didError:S(p),didReceive:u,[Symbol.dispose](){Re.dispose()}})}toString(){return"PerDocumentTransportFactory(".concat(M(this,ie),")")}}Se=new WeakMap;ie=new WeakMap;Y=new WeakMap;be=new WeakMap;class js extends je{constructor(e){super("CAPI Transport disconnected (SessionId: ".concat(e,")"))}}const Cn=s=>h(s.getPlugin("monitoring"),It(e=>{const t=s.getExecutionScopeDefinition("global"),n=new Set,r={initialize:a=>{if(n.has(a))return St.all([]);n.add(a);const i=[],u=s.getExecutionScopeDefinition(a);return i.push(...en(u,e)),i.push(ue(qs(u))),F.verbose('Connector plugin is configured for "'.concat(a,'" execution scope.')),St.all(i)}};return t.register({token:hs,useValue:r})}));function qs(s){return s.onStart(async e=>(F.verbose('Connector plugin is starting in "'.concat(e.name,'" execution scope.')),h(xt([e.resolve(it),e.resolve(Wt),e.resolve(Ve)]),B(rs))))}function en(s,e){const t=ds(Symbol("ConnectorRPCToken"));return[s.register({token:t,useFactory:n=>Hs(e,n)},{lifetime:x.Singleton}),s.register({token:tt,useFactory:A(tt,[se,t])},{lifetime:x.Singleton}),s.register({token:it,useToken:tt}),s.register({token:ls,useFactory:A(Xs,[t])},{lifetime:x.Singleton}),s.register({token:bt,useFactory:A(Bs,[t,Je,Fe])},{lifetime:x.Singleton}),s.register({token:Wt,useFactory:A(zs,[t,Ke])},{lifetime:x.Singleton}),s.register({token:Ve,useFactory:A(Ve,[bt,it])},{lifetime:x.Singleton}),s.register({token:us,useFactory:n=>h(n.resolve(Ve),B(r=>({create:a=>new Zs(a,r.create(a))})))},{lifetime:x.Singleton}),s.register({token:se,useFactory:A(se,[Rt,cs])},{lifetime:x.Singleton}),s.register({token:Fe,useClass:Fe},{lifetime:x.Singleton}),s.register({token:Je,useFactory:A(Je,[se,Fe])},{lifetime:x.Singleton}),s.register({token:Ke,useFactory:A(Ke,[se])},{lifetime:x.Singleton})]}export{Cn as activate};
//# sourceMappingURL=index-9DVbyFLy.js.map
