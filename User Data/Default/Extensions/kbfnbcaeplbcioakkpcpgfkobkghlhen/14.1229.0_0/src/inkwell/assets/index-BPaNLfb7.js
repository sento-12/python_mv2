var xs=Object.defineProperty;var nn=(i,e)=>(e=Symbol[i])?e:Symbol.for("Symbol."+i),Lt=i=>{throw TypeError(i)};var bs=(i,e,t)=>e in i?xs(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var qt=(i,e,t)=>bs(i,typeof e!="symbol"?e+"":e,t),bi=(i,e,t)=>e.has(i)||Lt("Cannot "+t);var c=(i,e,t)=>(bi(i,e,"read from private field"),t?t.call(i):e.get(i)),y=(i,e,t)=>e.has(i)?Lt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),M=(i,e,t,n)=>(bi(i,e,"write to private field"),n?n.call(i,t):e.set(i,t),t),q=(i,e,t)=>(bi(i,e,"access private method"),t);var sn=(i,e,t,n)=>({set _(s){M(i,e,s,t)},get _(){return c(i,e,n)}});var et=(i,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&Lt("Object expected");var n;t&&(n=e[nn("asyncDispose")]),n===void 0&&(n=e[nn("dispose")]),typeof n!="function"&&Lt("Object not disposable"),i.push([t,n,e])}else t&&i.push([t]);return e},tt=(i,e,t)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(r,o,d,l){return l=Error(d),l.name="SuppressedError",l.error=r,l.suppressed=o,l},s=r=>e=t?new n(r,e,"An error was suppressed during disposal"):(t=!0,r),a=r=>{for(;r=i.pop();)try{var o=r[1]&&r[1].call(r[2]);if(r[0])return Promise.resolve(o).then(a,d=>(s(d),a()))}catch(d){s(d)}if(t)throw e};return a()};import{o as bn,k as ii,a3 as Rn,aA as Rs,f as Pi,s as $e,aB as Mn,C as Ms,p as m,m as xe,x as ks,l as Ft,S as fe,t as Qt,an as Gi,K as mt,v as Oe,b as L,ay as Oi,d as W,aC as Pe,ac as j,e as G,i as Di,j as ni,R as lt,L as ht,X as Ss,c as si,aD as kn,w as Vi,aE as rn,aF as Ut,aG as Ts,a7 as an,aH as on,N as ce,q as St,r as pt,U as Sn,aw as oe,J as Ds,aI as Es,ag as Bs,a0 as Cs,aJ as ln,am as Tn,aK as hn,n as As,aL as Is,Q as Ri,ar as cn,au as Dn,g as En,B as Ws,ak as $s}from"./index-DbtAbjfk.js";import{e as Ps,T as Gs}from"./index-DIq9RWYQ.js";import{TextDecorationsViewToken as Os}from"./index-BA9P4qHp.js";import{e as Vs,i as Xi,n as Xs}from"./index-CAjAjMx_.js";import{d as Bn}from"./debounceTime-DhvmbvtD.js";import{o as Ys}from"./of-Bh-sjQwK.js";import{a as Fs}from"./asap-cBXyJ2Go.js";import{E as Tt}from"./mergeAll-Ci-uq6t1.js";import{b as zs,c as Ls,i as Dt,e as qs,d as Jt,u as Yi,f as Us,g as Ns,a as Hs}from"./RectFns-ndpeBtT0-CdOd3O5S.js";import{T as Qs}from"./TextRevisionSynchronizedQueue-DQV4bu5q-CHh_yPL8.js";import{i as dn,w as un,T as Js,a as Fi,t as zi,u as Ks}from"./TextRangeManager-Cr3iyUZK-BdxXuEeJ.js";import{m as Cn,f as Et,a as fn}from"./TextRangeUpdateSemantics-D8MqPOrG-Bdcz8ucb.js";import{a as Zs}from"./async-C23VpIJo.js";import{t as An}from"./timer-zq0ZEleB.js";import{d as In}from"./distinctUntilChanged-xQxyKspb.js";import{s as ri}from"./switchMap-DLIF-D2S.js";import{i as Li}from"./TextRevisionFns-DGbJAFcL-DX1ABpMm.js";import{t as gn}from"./take-Dbhfwukx.js";import{d as js}from"./defineFactory-DJYNRBNc-CQmG8A-U.js";import"./RemoteEntity-CN-1WB86-yD3y8ldD.js";import"./PluginModule-CRib3PLZ-ls39AzbW.js";import"./merge-DlpWXwAR.js";import"./Delta-D-dso3t3-B1UydhvC.js";function Wn(i){return bn(function(e,t){var n=[];return e.subscribe(ii(t,function(s){return n.push(s)},function(){t.next(n),t.complete()})),Rn(i).subscribe(ii(t,function(){var s=n;n=[],t.next(s)},Rs)),function(){n=null}})}function er(i,e){return bn(function(t,n){var s=e!=null?e:{},a=s.leading,r=a===void 0?!0:a,o=s.trailing,d=o===void 0?!1:o,l=!1,f=null,g=null,p=!1,v=function(){g==null||g.unsubscribe(),g=null,d&&(B(),p&&n.complete())},w=function(){g=null,p&&n.complete()},k=function(C){return g=Rn(i(C)).subscribe(ii(n,v,w))},B=function(){if(l){l=!1;var C=f;f=null,n.next(C),!p&&k(C)}};t.subscribe(ii(n,function(C){l=!0,f=C,!(g&&!g.closed)&&(r?B():k(C))},function(){p=!0,!(d&&l&&g&&!g.closed)&&n.complete()}))})}function tr(i,e,t){e===void 0&&(e=Zs);var n=An(i,e);return er(function(){return n},t)}const ir=(i,e)=>new Promise(t=>{queueMicrotask(async()=>{var n;if((n=e==null?void 0:e.signal)!=null&&n.aborted)return t(Pi(new $n(e.signal.reason)));try{t($e(await i()))}catch(s){t(Mn(s))}})});class $n extends Ms{constructor(e){super(e instanceof Error?e.message:String(e))}}function nr(i,e){let t=null,n=!1;const s=r=>{t==null||t.abortController.abort(r),t==null||t.resolvers.resolve(Pi(new $n(r!=null?r:"signal is aborted without reason"))),t=null},a=({resolvers:r})=>{n=!0,e(async()=>{if(!t)return;const o=t;t=null,await i(...o.args)},{signal:t==null?void 0:t.abortController.signal}).then(o=>{n=!1,r.resolve(m(o,xe(ks))),t&&a(t)},o=>{Ft.error("Unexpected error when scheduling task in createSingletonTaskQueue()",o),n=!1,r.resolve(Mn(o)),t&&a(t)})};return{enqueue:(...r)=>{var d,l;const o=(d=t==null?void 0:t.resolvers)!=null?d:Promise.withResolvers();return t={resolvers:o,args:r,abortController:(l=t==null?void 0:t.abortController)!=null?l:new AbortController},n||a(t),o.promise},get empty(){return!t},cancel:s,[Symbol.dispose]:s}}function sr(i,e,t,n,s){Pn(i,e,t||0,n||i.length-1,s||rr)}function Pn(i,e,t,n,s){for(;n>t;){if(n-t>600){var a=n-t+1,r=e-t+1,o=Math.log(a),d=.5*Math.exp(2*o/3),l=.5*Math.sqrt(o*d*(a-d)/a)*(r-a/2<0?-1:1),f=Math.max(t,Math.floor(e-r*d/a+l)),g=Math.min(n,Math.floor(e+(a-r)*d/a+l));Pn(i,e,f,g,s)}var p=i[e],v=t,w=n;for(_t(i,t,e),s(i[n],p)>0&&_t(i,t,n);v<w;){for(_t(i,v,w),v++,w--;s(i[v],p)<0;)v++;for(;s(i[w],p)>0;)w--}s(i[t],p)===0?_t(i,t,w):(w++,_t(i,w,n)),w<=e&&(t=w+1),e<=w&&(n=w-1)}}function _t(i,e,t){var n=i[e];i[e]=i[t],i[t]=n}function rr(i,e){return i<e?-1:i>e?1:0}class Gn{constructor(e=9){this._maxEntries=Math.max(4,e),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(e){let t=this.data;const n=[];if(!Ht(e,t))return n;const s=this.toBBox,a=[];for(;t;){for(let r=0;r<t.children.length;r++){const o=t.children[r],d=t.leaf?s(o):o;Ht(e,d)&&(t.leaf?n.push(o):ki(e,d)?this._all(o,n):a.push(o))}t=a.pop()}return n}collides(e){let t=this.data;if(!Ht(e,t))return!1;const n=[];for(;t;){for(let s=0;s<t.children.length;s++){const a=t.children[s],r=t.leaf?this.toBBox(a):a;if(Ht(e,r)){if(t.leaf||ki(e,r))return!0;n.push(a)}}t=n.pop()}return!1}load(e){if(!(e&&e.length))return this;if(e.length<this._minEntries){for(let n=0;n<e.length;n++)this.insert(e[n]);return this}let t=this._build(e.slice(),0,e.length-1,0);if(!this.data.children.length)this.data=t;else if(this.data.height===t.height)this._splitRoot(this.data,t);else{if(this.data.height<t.height){const n=this.data;this.data=t,t=n}this._insert(t,this.data.height-t.height-1,!0)}return this}insert(e){return e&&this._insert(e,this.data.height-1),this}clear(){return this.data=nt([]),this}remove(e,t){if(!e)return this;let n=this.data;const s=this.toBBox(e),a=[],r=[];let o,d,l;for(;n||a.length;){if(n||(n=a.pop(),d=a[a.length-1],o=r.pop(),l=!0),n.leaf){const f=ar(e,n.children,t);if(f!==-1)return n.children.splice(f,1),a.push(n),this._condense(a),this}!l&&!n.leaf&&ki(n,s)?(a.push(n),r.push(o),o=0,d=n,n=n.children[0]):d?(o++,n=d.children[o],l=!1):n=null}return this}toBBox(e){return e}compareMinX(e,t){return e.minX-t.minX}compareMinY(e,t){return e.minY-t.minY}toJSON(){return this.data}fromJSON(e){return this.data=e,this}_all(e,t){const n=[];for(;e;)e.leaf?t.push(...e.children):n.push(...e.children),e=n.pop();return t}_build(e,t,n,s){const a=n-t+1;let r=this._maxEntries,o;if(a<=r)return o=nt(e.slice(t,n+1)),it(o,this.toBBox),o;s||(s=Math.ceil(Math.log(a)/Math.log(r)),r=Math.ceil(a/Math.pow(r,s-1))),o=nt([]),o.leaf=!1,o.height=s;const d=Math.ceil(a/r),l=d*Math.ceil(Math.sqrt(r));mn(e,t,n,l,this.compareMinX);for(let f=t;f<=n;f+=l){const g=Math.min(f+l-1,n);mn(e,f,g,d,this.compareMinY);for(let p=f;p<=g;p+=d){const v=Math.min(p+d-1,g);o.children.push(this._build(e,p,v,s-1))}}return it(o,this.toBBox),o}_chooseSubtree(e,t,n,s){for(;s.push(t),!(t.leaf||s.length-1===n);){let a=1/0,r=1/0,o;for(let d=0;d<t.children.length;d++){const l=t.children[d],f=Mi(l),g=hr(e,l)-f;g<r?(r=g,a=f<a?f:a,o=l):g===r&&f<a&&(a=f,o=l)}t=o||t.children[0]}return t}_insert(e,t,n){const s=n?e:this.toBBox(e),a=[],r=this._chooseSubtree(s,this.data,t,a);for(r.children.push(e),bt(r,s);t>=0&&a[t].children.length>this._maxEntries;)this._split(a,t),t--;this._adjustParentBBoxes(s,a,t)}_split(e,t){const n=e[t],s=n.children.length,a=this._minEntries;this._chooseSplitAxis(n,a,s);const r=this._chooseSplitIndex(n,a,s),o=nt(n.children.splice(r,n.children.length-r));o.height=n.height,o.leaf=n.leaf,it(n,this.toBBox),it(o,this.toBBox),t?e[t-1].children.push(o):this._splitRoot(n,o)}_splitRoot(e,t){this.data=nt([e,t]),this.data.height=e.height+1,this.data.leaf=!1,it(this.data,this.toBBox)}_chooseSplitIndex(e,t,n){let s,a=1/0,r=1/0;for(let o=t;o<=n-t;o++){const d=xt(e,0,o,this.toBBox),l=xt(e,o,n,this.toBBox),f=cr(d,l),g=Mi(d)+Mi(l);f<a?(a=f,s=o,r=g<r?g:r):f===a&&g<r&&(r=g,s=o)}return s||n-t}_chooseSplitAxis(e,t,n){const s=e.leaf?this.compareMinX:or,a=e.leaf?this.compareMinY:lr,r=this._allDistMargin(e,t,n,s),o=this._allDistMargin(e,t,n,a);r<o&&e.children.sort(s)}_allDistMargin(e,t,n,s){e.children.sort(s);const a=this.toBBox,r=xt(e,0,t,a),o=xt(e,n-t,n,a);let d=Nt(r)+Nt(o);for(let l=t;l<n-t;l++){const f=e.children[l];bt(r,e.leaf?a(f):f),d+=Nt(r)}for(let l=n-t-1;l>=t;l--){const f=e.children[l];bt(o,e.leaf?a(f):f),d+=Nt(o)}return d}_adjustParentBBoxes(e,t,n){for(let s=n;s>=0;s--)bt(t[s],e)}_condense(e){for(let t=e.length-1,n;t>=0;t--)e[t].children.length===0?t>0?(n=e[t-1].children,n.splice(n.indexOf(e[t]),1)):this.clear():it(e[t],this.toBBox)}}function ar(i,e,t){if(!t)return e.indexOf(i);for(let n=0;n<e.length;n++)if(t(i,e[n]))return n;return-1}function it(i,e){xt(i,0,i.children.length,e,i)}function xt(i,e,t,n,s){s||(s=nt(null)),s.minX=1/0,s.minY=1/0,s.maxX=-1/0,s.maxY=-1/0;for(let a=e;a<t;a++){const r=i.children[a];bt(s,i.leaf?n(r):r)}return s}function bt(i,e){return i.minX=Math.min(i.minX,e.minX),i.minY=Math.min(i.minY,e.minY),i.maxX=Math.max(i.maxX,e.maxX),i.maxY=Math.max(i.maxY,e.maxY),i}function or(i,e){return i.minX-e.minX}function lr(i,e){return i.minY-e.minY}function Mi(i){return(i.maxX-i.minX)*(i.maxY-i.minY)}function Nt(i){return i.maxX-i.minX+(i.maxY-i.minY)}function hr(i,e){return(Math.max(e.maxX,i.maxX)-Math.min(e.minX,i.minX))*(Math.max(e.maxY,i.maxY)-Math.min(e.minY,i.minY))}function cr(i,e){const t=Math.max(i.minX,e.minX),n=Math.max(i.minY,e.minY),s=Math.min(i.maxX,e.maxX),a=Math.min(i.maxY,e.maxY);return Math.max(0,s-t)*Math.max(0,a-n)}function ki(i,e){return i.minX<=e.minX&&i.minY<=e.minY&&e.maxX<=i.maxX&&e.maxY<=i.maxY}function Ht(i,e){return e.minX<=i.maxX&&e.minY<=i.maxY&&e.maxX>=i.minX&&e.maxY>=i.minY}function nt(i){return{children:i,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function mn(i,e,t,n,s){const a=[e,t];for(;a.length;){if(t=a.pop(),e=a.pop(),t-e<=n)continue;const r=e+Math.ceil((t-e)/n/2)*n;sr(i,r,e,t,s),a.push(e,r,r,t)}}var At,me,It,dt,Se,ze,pe,ve,we,Q,Wt,Te,ut,ui,ft,P,gt,Le,F,On,Vn,Xn,Yn,Kt;class dr{constructor(e){y(this,F);y(this,At);y(this,me,new DisposableStack);y(this,It);y(this,dt);y(this,Se,new Map);y(this,ze,new Map);y(this,pe,null);y(this,ve,new Map);y(this,we,new Set);y(this,Q,new ur);y(this,Wt);y(this,Te);y(this,ut,c(this,me).use(nr(()=>q(this,F,On).call(this),ir)));y(this,ui,0);y(this,ft,!0);y(this,P,null);y(this,gt,null);y(this,Le,new fe);qt(this,"onPointerEvent",Qt(c(this,Le)));var n,s;M(this,At,Ft.createLogger("InteractiveGeometryManager",e.label)),M(this,Te,e.emitMetrics),M(this,dt,(n=e.pointerPositionThrottleTimeMs)!=null?n:Math.ceil(1e3/30));const t=m(mt(e.pointerMove),c(this,dt)===0?Gi:tr(c(this,dt)));M(this,Wt,e.getViewport),c(this,me).use(m(t,Oe(a=>q(this,F,Vn).call(this,a)))),c(this,me).use(e.pointerDown.subscribe(a=>q(this,F,Xn).call(this,a))),c(this,me).use(e.pointerUp.subscribe(a=>q(this,F,Yn).call(this,a))),M(this,pe,e.compareZIndex?null:new Map),M(this,It,(s=e.compareZIndex)!=null?s:(a,r)=>{var o,d,l,f;return((d=(o=c(this,pe))==null?void 0:o.get(a.rect))!=null?d:0)-((f=(l=c(this,pe))==null?void 0:l.get(r.rect))!=null?f:0)}),c(this,me).defer(()=>this.clear())}async upsert(e,t){c(this,we).delete(e),c(this,ve).set(e,t),await c(this,ut).enqueue()}async remove(e){c(this,ve).delete(e),c(this,we).add(e),await c(this,ut).enqueue()}clear(){var e,t;c(this,Q).clear(),c(this,Se).clear(),c(this,ze).clear(),(e=c(this,pe))==null||e.clear(),c(this,ve).clear(),c(this,we).clear(),c(this,ut).cancel(),(t=c(this,Te))==null||t.call(this,{interactiveRectCount:0})}disablePointerEvents(){var e;M(this,ft,!1),(e=c(this,Te))==null||e.call(this,{interactiveRectCount:0})}enablePointerEvents(){var e;M(this,ft,!0),(e=c(this,Te))==null||e.call(this,{interactiveRectCount:c(this,Q).size})}[Symbol.dispose](){c(this,me).dispose()}}At=new WeakMap,me=new WeakMap,It=new WeakMap,dt=new WeakMap,Se=new WeakMap,ze=new WeakMap,pe=new WeakMap,ve=new WeakMap,we=new WeakMap,Q=new WeakMap,Wt=new WeakMap,Te=new WeakMap,ut=new WeakMap,ui=new WeakMap,ft=new WeakMap,P=new WeakMap,gt=new WeakMap,Le=new WeakMap,F=new WeakSet,On=function(){var s,a,r,o;var d=[];try{const e=m(c(this,we),Oi(p=>{var v;return(v=c(this,Se).get(p))!=null?v:[]}),L);const t=m(c(this,ve),W(([p,v])=>{var w;return[(w=c(this,Se).get(p))!=null?w:[],v]}),L);if(e.length===0&&t.length===0)return;const n=et(d,Pe.startSpan("InteractiveGeometryManager.flushQueues()",{attributes:{removals:e.length,updates:t.length,treeSize:c(this,Q).size}}));for(const p of e)c(this,Q).remove(p),c(this,ze).delete(p),(s=c(this,pe))==null||s.delete(p);for(const p of c(this,we))c(this,Se).delete(p),((a=c(this,P))==null?void 0:a.geometry)===p&&M(this,P,null);for(const[p,v]of t)for(const w of p)c(this,Q).remove(w);for(const[p,v]of c(this,ve)){for(const w of v)c(this,ze).set(w,p),(r=c(this,pe))==null||r.set(w,sn(this,ui)._++);c(this,Se).set(p,v)}c(this,Q).load(t.flatMap(([p,v])=>v));c(this,we).clear();c(this,ve).clear();(o=c(this,Te))==null||o.call(this,{interactiveRectCount:c(this,Q).size});c(this,At).verbose("queue flushed",{removals:e.length,updates:t.length,treeSize:c(this,Q).size})}catch(l){var f=l,g=!0}finally{tt(d,f,g)}},Vn=function(e){var s;const t=q(this,F,Kt).call(this,e),n={};if(t){if(((s=c(this,P))==null?void 0:s.geometry)===t.geometry)return;c(this,P)!==null&&c(this,P).geometry!==t.geometry&&(n.pointerLeave={kind:"pointerLeave",position:e,currentTarget:c(this,P).rect,target:c(this,P).geometry}),n.pointerEnter={kind:"pointerEnter",position:e,currentTarget:t.rect,target:t.geometry},M(this,P,t)}else c(this,P)!==null&&(n.pointerLeave={kind:"pointerLeave",position:e,currentTarget:c(this,P).rect,target:c(this,P).geometry},M(this,P,null));Object.values(n).some(j)&&c(this,Le).next(n)},Xn=function(e){const t=q(this,F,Kt).call(this,e);t&&(M(this,gt,t.geometry),c(this,Le).next({pointerDown:{kind:"pointerDown",position:e,currentTarget:t.rect,target:t.geometry}}))},Yn=function(e){const t=q(this,F,Kt).call(this,e);if(!t)return;const n={pointerUp:{kind:"pointerUp",position:e,currentTarget:t.rect,target:t.geometry}};c(this,gt)===t.geometry&&(n.pointerClick={kind:"pointerClick",position:e,currentTarget:t.rect,target:t.geometry}),M(this,gt,null),Object.values(n).some(j)&&c(this,Le).next(n)},Kt=function(e){return!zs(c(this,Wt).call(this),e)||!c(this,ft)?null:m(c(this,Q).search({minX:e.x,minY:e.y,maxX:e.x,maxY:e.y}),W(t=>m(c(this,ze).get(t),n=>n?{rect:t,geometry:n}:null)),G(j),L,t=>{var n;return(n=t.sort((s,a)=>c(this,It).call(this,s,a)).at(-1))!=null?n:null})};let ur=class extends Gn{constructor(){super(...arguments);qt(this,"_rects",new Set)}toBBox(t){return{minX:t.x,minY:t.y,maxX:t.x+t.width,maxY:t.y+t.height}}compareMinX(t,n){return t.x-n.x}compareMinY(t,n){return t.y-n.y}load(t){return t.forEach(n=>this._rects.add(n)),super.load(t)}insert(t){return this._rects.add(t),super.insert(t)}remove(t,n){return this._rects.delete(t),super.remove(t,n)}clear(){var t;return(t=this._rects)==null||t.clear(),super.clear()}get size(){return this._rects.size}};function fr(i,e){return i.text>e.text&&i.geometry>=e.geometry||i.geometry>e.geometry&&i.text>=e.text}function gr(i,e){return i.text>=e.text&&i.geometry>=e.geometry}function mr({text:i,geometry:e}){return"Revision({ text: ".concat(i,", geometry: ").concat(e," })")}function pr(i){return{x:i.x,y:i.y}}function vr(i){return{x:i.x,y:i.y}}function wr(i){return vr(i)}function yr(i){return{x:i.x,y:i.y}}function _r(i){return{x:i.x,y:i.y}}function xr(i){return _r(i)}function Qe(i){return{x:i.x,y:i.y,width:i.width,height:i.height}}function pn(i){return e=>Qe({x:i(e.x),y:i(e.y),width:i(e.width),height:i(e.height)})}function br(i){return{x:i.x,y:i.y,width:i.width,height:i.height}}function Re(i,e,t=Number.EPSILON){return Math.abs(i-e)<=t}function Ce(i,e=0){return e===0?.5+i|0:Math.round((i+Number.EPSILON)*10**e)/10**e}function Rr(i,e=1.5,t=1.5){if(i.length===0)return[];if(i.length===1)return[i[0]];const n=[];let s=i[0];const a=i.length;for(let r=1;r<a;r++){const o=i[r],d=o.y+o.height,l=d<s.y,f=Re(d,s.y)&&o.height>0&&s.height>0;if(l||f)continue;const g=Math.min(s.x,o.x),p=Math.min(s.y,o.y),v=Math.max(s.x+s.width,o.x+o.width),w=Math.max(s.y+s.height,d),k=v-g,B=w-p,C=k<=s.width+o.width+e,he=B<=s.height+o.height-t,wt=Re(B,s.height+o.height)&&(Re(o.height,0)||Re(s.height,0));Re(o.width,s.width)&&Re(o.height,s.height)&&Re(o.x,s.x)&&Re(o.y,s.y)||(C&&(he||wt)?s=Ls({y:p,x:g,height:B,width:k}):(n.push(s),s=o))}return n.push(s),n}function Rt(i){return m(i,Mr,Rr)}function Mr(i){return[...i].sort((e,t)=>e.y<t.y?-1:e.y>t.y?1:e.x<t.x?-1:e.x>t.x?1:0)}function kr(i){var s=[];try{const e=et(s,new DisposableStack);const t=si();const n=si();e.use(i.scopeDefinition.onStart(async d=>m(ni([d.resolve(i.localEntityToken),d.resolve(n)]),xe(([l,f])=>{const g=m(d.realm.resolveEntity(i.remoteEntityToken,l),Di(p=>p.entity));f.resolve(g)}))));return m(lt.all([i.scopeDefinition.register({token:n,useFactory:()=>$e(Promise.withResolvers())},{lifetime:ht.Singleton}),i.scopeDefinition.register({token:t,useFactory:d=>m(d.resolve(n),xe(l=>Ss(l.promise)))},{lifetime:ht.Singleton})]),lt.use(e),xe(()=>{const d=e.move();return{remoteEntityToken:t,[Symbol.dispose]:()=>d.dispose()}}))}catch(a){var r=a,o=!0}finally{tt(s,r,o)}}var ee,De,fi,$t,Ee,re,ye,_e,qe,Pt,te,X,Gt,Ot,le,Fn,zn,Ln,qn;class Sr{constructor(e){y(this,le);y(this,ee,Ft.createLogger("TextRangeGeometryManager"));y(this,De,new DisposableStack);y(this,fi,new kn);y(this,$t,100);y(this,Ee);y(this,re,new Map);y(this,ye,new Set);y(this,_e,new Set);y(this,qe,new fe);y(this,Pt);y(this,te);y(this,X);y(this,Gt);y(this,Ot);M(this,Gt,e.getRects),M(this,Ot,e.getBoundingRects),M(this,Pt,e.emitMetrics),M(this,X,e.initialRevision),M(this,te,dn(e.initialVisibleTextRange)?e.initialVisibleTextRange:un(e.initialVisibleTextRange,c(this,$t))),M(this,Ee,c(this,De).use(new Js({initialTextRevision:e.initialRevision.text,label:"TextRangeGeometryManager/TextRangeManager"}))),c(this,De).defer(()=>{c(this,qe).complete(),c(this,re).clear(),c(this,ye).clear(),c(this,_e).clear()}),c(this,De).use(m(c(this,qe),Wn(m(c(this,qe),Bn(0))),Vi(t=>rn(t,n=>n.minimumRevision)),Oe(t=>{for(const[n,s]of t){fr(n,c(this,X))&&c(this,ee).warn("Unexpected geometry request for revision ".concat(n," greater than current revision ").concat(c(this,X)));const{visibleGroupsRequests:a,hiddenGroupsRequests:r}=q(this,le,Fn).call(this,s);a.length>0&&q(this,le,zn).call(this,a),r.length>0&&(c(this,ee).warn("Unexpected geometry request for hidden groups [".concat(r.map(({group:o})=>o.id).join(", "),"] for revision ").concat(mr(n))),r.forEach(o=>o.resolve($e({rects:[],revision:c(this,X)}))))}})))}get _revisionForTests(){throw new Error("Only available for accessing the revision in tests")}add({id:e,metadata:t,revision:n,ranges:s,visible:a}){const r=ni(m(s,Cn(({id:f,range:g,metadata:p,updateSemantics:v})=>c(this,Ee).add({id:f!=null?f:c(this,fi).next(),range:g,metadata:p,revision:n,updateSemantics:v}))));if(!r.ok)return r;const o=r.value,d=new DisposableStack;d.defer(()=>{l.ranges.forEach(f=>c(this,re).delete(f)),c(this,ye).delete(l.id)});const l=c(this,De).use(new Tr({id:e,ranges:o,metadata:t,getRects:f=>{const g=Promise.withResolvers();return c(this,qe).next({group:l,minimumRevision:f.minimumRevision,geometryKind:f.geometryKind,resolve:p=>g.resolve(p)}),g.promise}}));return l.use(d),o.forEach(f=>c(this,re).set(f,l)),a&&c(this,ye).add(l.id),Fi(c(this,te),l.boundingRange)&&c(this,_e).add(l.id),$e(l)}pushTextChange(e){var o=[];try{const t=et(o,Pe.startSpan("TextRangeGeometryManager.pushTextChange()",{attributes:{change:e}}));M(this,X,{geometry:c(this,X).geometry,text:e.revision});const{getChangedRanges:n,affectedRanges:s}=c(this,Ee).pushTextChange(e);const a=m(s,W(g=>c(this,re).get(g)),G(j),Ut,L);const r=m(n(),W(g=>c(this,re).get(g)),G(j),Ts(g=>g.boundingRange.start<c(this,te).end),G(g=>g.boundingRange.end>=c(this,te).start),Ut,Et);r==null||r.forEach(g=>{c(this,_e).add(g.id)});c(this,ee).verbose("pushTextChange",{change:e,affectedGroups:a.map(g=>g.id),onScreenChangedGroups:r==null?void 0:r.map(g=>g.id),revision:c(this,X)});return{affected:a,visibleChanged:r!=null?r:[]}}catch(d){var l=d,f=!0}finally{tt(o,l,f)}}pushDocumentGeometryChange(e,t){var a=[];try{const n=et(a,Pe.startSpan("TextRangeGeometryManager.pushDocumentGeometryChange()",{attributes:{visibleTextRange:e,geometryRevision:t}}));M(this,X,{text:c(this,X).text,geometry:t});M(this,te,dn(e)?e:un(e,c(this,$t)));const s=m(c(this,Ee).getIntersecting(c(this,te)),W(l=>c(this,re).get(l)),G(j),Ut,Et);c(this,_e).clear();s==null||s.forEach(l=>{c(this,_e).add(l.id)});c(this,ee).verbose("pushDocumentGeometryChange",{visibleTextRange:zi(c(this,te)),onScreenGroups:s==null?void 0:s.map(l=>l.id),revision:c(this,X)});return{visible:s!=null?s:[]}}catch(r){var o=r,d=!0}finally{tt(a,o,d)}}getOnscreenTextRangeGroups(){return m(c(this,Ee).getIntersecting(c(this,te)),W(e=>c(this,re).get(e)),G(j),Ut,L)}setVisibility(e,t){for(const n of e)t?c(this,ye).add(n):c(this,ye).delete(n)}[Symbol.dispose](){c(this,De).dispose()}}ee=new WeakMap,De=new WeakMap,fi=new WeakMap,$t=new WeakMap,Ee=new WeakMap,re=new WeakMap,ye=new WeakMap,_e=new WeakMap,qe=new WeakMap,Pt=new WeakMap,te=new WeakMap,X=new WeakMap,Gt=new WeakMap,Ot=new WeakMap,le=new WeakSet,Fn=function(e){const t=[],n=[];return e.forEach(s=>{c(this,ye).has(s.group.id)&&c(this,_e).has(s.group.id)?t.push(s):n.push(s)}),{visibleGroupsRequests:t,hiddenGroupsRequests:n}},zn=async function(e){var p,v,w,k;var B=[];try{const t={...c(this,X)};const n=et(B,Pe.startSpan("TextRangeGeometryManager.#requestGeometry()",{attributes:{revision:t,groups:e.map(({group:T,minimumRevision:yt})=>({id:T.id,ranges:T.ranges.length,minimumRevision:yt}))}}));const s=rn(e,({geometryKind:T})=>T==="singleBoundingBox"?"boundingBox":"rects");const a={forRects:(p=s.get("rects"))!=null?p:[],forBoundingBoxes:(v=s.get("boundingBox"))!=null?v:[]};const r={forRects:a.forRects.flatMap(({group:T})=>T.ranges),forBoundingBoxes:a.forBoundingBoxes.flatMap(({group:T})=>T.ranges)};c(this,ee).verbose("geometry request",{revision:t,requestRevision:(w=e[0])==null?void 0:w.minimumRevision,requests:a});const o=m(r.forRects,fn({nonEmpty:T=>q(this,le,Ln).call(this,T),empty:()=>ce({rects:new Map,revision:t})}));const d=m(r.forBoundingBoxes,fn({nonEmpty:T=>q(this,le,qn).call(this,T),empty:()=>ce({rects:new Map,revision:t})}));const l={forRects:await o,forBoundingBoxes:await d};a.forRects.forEach(({group:T,resolve:yt,geometryKind:yi})=>yt(m(l.forRects,xe(({revision:_i,rects:xi})=>({rects:T.ranges.map(zt=>{var tn;return(tn=xi.get(zt.id))!=null?tn:[]}).map(yi==="lineBoundingBox"?Rt:Gi),revision:_i})))));a.forBoundingBoxes.forEach(({group:T,resolve:yt})=>yt(m(l.forBoundingBoxes,xe(({revision:yi,rects:_i})=>({rects:T.ranges.map(xi=>{var zt;return[(zt=_i.get(xi.id))!=null?zt:[]].flat()}),revision:yi})))));const f=m(l.forRects,an({success:({rects:T})=>Array.from(T.values()).flat().length,failure:()=>0}));const g=m(l.forBoundingBoxes,an({success:({rects:T})=>T.size,failure:()=>0}));(k=c(this,Pt))==null||k.call(this,{rangeCount:e.flatMap(({group:T})=>T.ranges).length,rectCount:f+g});c(this,ee).verbose("geometry response",{responseRevision:t,requests:a,responses:l})}catch(C){var he=C,wt=!0}finally{tt(B,he,wt)}},Ln=function(e){return on(()=>m(c(this,Gt).call(this,new Map(m(e,W(t=>[t.id,{start:t.start,end:t.end}])))),St(pt(t=>c(this,ee).error("Unexpected error getting rects",t)))),{maxRetries:3,delayMs:()=>1e3})},qn=function(e){return on(()=>m(c(this,Ot).call(this,new Map(m(e,W(t=>[t.id,{start:t.start,end:t.end}])))),St(pt(t=>c(this,ee).error("Unexpected error getting bounding rects",t)))),{maxRetries:3,delayMs:()=>1e3})};var Vt,Xt,Ue,gi,Yt,Be;class Tr{constructor(e){y(this,Vt,new DisposableStack);y(this,Xt);y(this,Ue);y(this,gi,new kn);y(this,Yt);y(this,Be,null);qt(this,"id");var t;this.id=(t=e.id)!=null?t:c(this,gi).next(),M(this,Ue,e.ranges),M(this,Xt,e.metadata),M(this,Yt,e.getRects)}get metadata(){return c(this,Xt)}get revision(){return c(this,Ue)[0].revision}get ranges(){return c(this,Ue)}get boundingRange(){return Ks(...c(this,Ue))}getGeometry(e){return c(this,Be)&&gr(c(this,Be).requestedRevision,e.minimumRevision)?c(this,Be).response:(M(this,Be,{requestedRevision:e.minimumRevision,response:c(this,Yt).call(this,e)}),c(this,Be).response)}toString(){const e=this.ranges.map(t=>zi(t)).join(", ");return"TextRangeGroupGeometry({ id: ".concat(this.id,", ranges: [").concat(e,"], revision: ").concat(this.revision," })")}use(e){return c(this,Vt).use(e)}[Symbol.dispose](){c(this,Vt).dispose()}}Vt=new WeakMap,Xt=new WeakMap,Ue=new WeakMap,gi=new WeakMap,Yt=new WeakMap,Be=new WeakMap;function qi(i,e){if(i.kind==="fadeIn"){const t=vn(i.startTime,performance.now(),i.duration);return t===1&&(i.running=!1),{alpha:t,running:i.running}}else if(i.kind==="fadeOut"){const t=1-vn(i.startTime,performance.now(),i.duration);return t===0&&(i.running=!1),{alpha:t,running:i.running}}else throw new Sn(i.kind)}function vn(i,e,t){return Math.min(1,Math.max((e-i)/t,0))}var Dr=Object.defineProperty,Er=(i,e)=>(e=Symbol[i])?e:Symbol.for("Symbol."+i),ai=i=>{throw TypeError(i)},Br=(i,e,t)=>e in i?Dr(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,wn=(i,e,t)=>Br(i,typeof e!="symbol"?e+"":e,t),Ui=(i,e,t)=>e.has(i)||ai("Cannot "+t),u=(i,e,t)=>(Ui(i,e,"read from private field"),e.get(i)),D=(i,e,t)=>e.has(i)?ai("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),U=(i,e,t,n)=>(Ui(i,e,"write to private field"),e.set(i,t),t),ct=(i,e,t)=>(Ui(i,e,"access private method"),t),Cr=(i,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&ai("Object expected");var n;n===void 0&&(n=e[Er("dispose")]),typeof n!="function"&&ai("Object not disposable"),i.push([t,n,e])}return e},Ar=(i,e,t)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(r,o,d,l){return l=Error(d),l.name="SuppressedError",l.error=r,l.suppressed=o,l},s=r=>e=t?new n(r,e,"An error was suppressed during disposal"):(t=!0,r),a=r=>{for(;r=i.pop();)try{var o=r[1]&&r[1].call(r[2]);if(r[0])return Promise.resolve(o).then(a,d=>(s(d),a()))}catch(d){s(d)}if(t)throw e};return a()},Ni,Hi,Zt,ge,A,oi,de,Ae,ae,se,ie,ne,Bt,Ei,Ne,Ct,z,E,Fe,J,st,Ge,Un,Nn,Hn,Qn,Jn,Kn;class Ir{constructor(e){D(this,Ge),D(this,Ni,!1),D(this,Hi,!1),D(this,Zt,new DisposableStack),D(this,ge),D(this,A),D(this,oi),D(this,de,new Map),D(this,Ae,new Set),D(this,ae,new Set),D(this,se,new Set),D(this,ie,new Set),D(this,ne,new Set),D(this,Bt,new Set),D(this,Ei,!0),D(this,Ne,new Wr({returnAllDrawables:!u(this,Ei)})),D(this,Ct),D(this,z,new fe),D(this,E),D(this,Fe,!1),D(this,J),D(this,st,null),U(this,ge,e.canvas),U(this,A,e.canvas.getContext("2d")),U(this,E,e.viewportGeometry),U(this,oi,e.oversamplingFactor),U(this,Ct,e.emitRenderMetrics),u(this,Zt).use(m(u(this,z),Wn(m(u(this,z),Bn(0))),Vi(t=>({reasons:new Set(t.map(n=>n.reason).filter(j)),immediate:t.some(n=>n.immediate)})),Vs(({reasons:t,immediate:n})=>m(Ys(null),Ds(n?Fs:Es),Bs(()=>u(this,st)?ct(this,Ge,Un).call(this,u(this,st),[...t].join(", ")):Tt))),Oe(t=>{t&&u(this,z).next({reason:"animation"})})))}add(e){for(const{drawable:t,visible:n,onscreen:s}of e)u(this,Ae).add(t),s&&(u(this,ie).add(t),u(this,ae).add(t)),n||u(this,se).add(t);u(this,z).next({reason:"add-drawable"})}remove(e){for(const t of e)u(this,ie).delete(t),u(this,ne).delete(t),u(this,ae).delete(t),u(this,Ae).delete(t),u(this,Ne).remove(t),u(this,Bt).add(t);u(this,z).next({reason:"remove-drawable"})}requestRender(e){for(const t of e)u(this,ne).add(t);u(this,z).next({reason:"request-render"})}requestLayout(e,t){U(this,st,t);for(const n of e)u(this,ie).add(n);u(this,z).next({reason:"request-layout",immediate:!0})}setViewport(e,t,n){U(this,st,n),U(this,E,t),u(this,ae).clear(),u(this,ie).clear(),u(this,Ne).clear();for(const s of e)u(this,ie).add(s),u(this,ae).add(s);u(this,z).next({reason:"viewport-change",immediate:!0})}setVisibility(e,t){for(const n of e)t?u(this,se).delete(n)&&u(this,ne).add(n):u(this,se).has(n)||(u(this,se).add(n),u(this,ne).add(n));u(this,z).next({reason:"set-visibility"})}showAllVisible(){if(u(this,Fe)){U(this,Fe,!1),U(this,J,{kind:"fadeIn",startTime:performance.now(),duration:300,running:!0,metadata:void 0});for(const e of u(this,ae))u(this,ne).add(e);u(this,z).next({reason:"show-all-visible"})}}hideAllVisible(){u(this,Fe)||(U(this,Fe,!0),U(this,J,void 0),u(this,z).next({reason:"hide-all-visible"}))}[Symbol.dispose](){u(this,Zt).dispose()}}Ni=new WeakMap;Hi=new WeakMap;Zt=new WeakMap;ge=new WeakMap;A=new WeakMap;oi=new WeakMap;de=new WeakMap;Ae=new WeakMap;ae=new WeakMap;se=new WeakMap;ie=new WeakMap;ne=new WeakMap;Bt=new WeakMap;Ei=new WeakMap;Ne=new WeakMap;Ct=new WeakMap;z=new WeakMap;E=new WeakMap;Fe=new WeakMap;J=new WeakMap;st=new WeakMap;Ge=new WeakSet;Un=async function(i,e){var t,n,s,a,r=[];try{const l=Cr(r,Pe.startSpan("CanvasRenderer.#render()",{attributes:{reason:e,minimumRevision:i}}));if(u(this,Fe)&&!((t=u(this,J))!=null&&t.running)){u(this,A).clearRect(0,0,u(this,ge).width,u(this,ge).height);const he={drawablesRenderedOnLastRenderLoop:0,renderedVisibleOnscreenDrawables:new Set,visibleDrawables:u(this,Ae).difference(u(this,se)),allDrawables:new Set(u(this,Ae))};return queueMicrotask(()=>u(this,Ct).call(this,he)),!1}let f=(n=u(this,J))!=null&&n.running&&u(this,J).kind==="fadeOut"?u(this,E):await ct(this,Ge,Jn).call(this,i);const g=u(this,oi),p=Ce(u(this,E).width*g),v=Ce(u(this,E).height*g);if((u(this,ge).width!==p||u(this,ge).height!==v)&&(u(this,ge).width=p,u(this,ge).height=v,f=u(this,E)),(s=u(this,J))!=null&&s.running&&u(this,J).kind==="fadeIn"&&(f=u(this,E)),!f)return!1;u(this,A).save(),u(this,A).scale(g,g),u(this,A).translate(-Ce(u(this,E).x),-Ce(u(this,E).y)),u(this,A).globalCompositeOperation="source-over";const w=u(this,J)?qi(u(this,J)).alpha:1;u(this,A).globalAlpha=w;const k=ct(this,Ge,Nn).call(this,f),B=ct(this,Ge,Hn).call(this,f,k);u(this,Hi)&&(u(this,A).strokeStyle="blue",u(this,A).strokeRect(u(this,E).x,u(this,E).y,Math.floor(u(this,E).width),Math.floor(u(this,E).height))),u(this,A).restore();const C={drawablesRenderedOnLastRenderLoop:k.size,renderedVisibleOnscreenDrawables:m(u(this,ae).difference(u(this,se)),G(he=>Dt(u(this,E),he.boundingRect)),G(he=>he.visibleRects.some(wt=>Dt(u(this,E),wt))),oe),visibleDrawables:u(this,Ae).difference(u(this,se)),allDrawables:new Set(u(this,Ae))};return queueMicrotask(()=>u(this,Ct).call(this,C)),B||((a=u(this,J))==null?void 0:a.running)===!0}catch(l){var o=l,d=!0}finally{Ar(r,o,d)}};Nn=function(i){return m((qs(i,u(this,E))?u(this,ae):u(this,Ne).getIntersections(i)).difference(u(this,se)),G(e=>Dt(u(this,E),e.boundingRect)),oe)};Hn=function(i,e){return u(this,A).clearRect(i.x,i.y,i.width,i.height),u(this,Ni)&&(u(this,A).strokeStyle="red",u(this,A).strokeRect(i.x,i.y,i.width,i.height)),u(this,A).rect(i.x,i.y,i.width,i.height),u(this,A).clip(),ct(this,Ge,Qn).call(this,e)};Qn=function(i){for(const n of u(this,de).keys())i.has(n)||u(this,de).delete(n);for(const n of i)u(this,de).has(n)||u(this,de).set(n,n.render(u(this,A)));let e=u(this,de).size;const t=L(u(this,de).entries()).sort((n,s)=>n[0].zIndex-s[0].zIndex);for(const[n,s]of t){for(const r of n.opaqueRects)u(this,A).clearRect(r.x,r.y,r.width,r.height);const{done:a}=s.next();a?(e--,u(this,ne).delete(n),u(this,de).set(n,n.render(u(this,A)))):u(this,ne).add(n)}return e>0};Jn=async function(i){const e=[];if(u(this,ie).size>0){const n=await ct(this,Ge,Kn).call(this,i);n&&e.push(n)}for(const n of u(this,ne))!Jt(n.boundingRect)&&Dt(u(this,E),n.boundingRect)&&(e.push(n.boundingRect),u(this,ne).delete(n));for(const n of u(this,Bt))u(this,Bt).delete(n),!Jt(n.boundingRect)&&Dt(u(this,E),n.boundingRect)&&e.push(n.boundingRect);const t=m(e.map(Us(1)),Yi(null));return t&&!Jt(t)?Ns(t,u(this,E)):null};Kn=async function(i){if(u(this,ie).size===0)return null;const e=[],t=new Set;for(const s of u(this,ie)){if(u(this,se).has(s)||!u(this,ae).has(s))continue;const a=s.boundingRect;e.push([a,s.layout(i)]),t.add(s),u(this,ie).delete(s),u(this,Ne).remove(s)}const n=await Promise.all(e.map(async([s,a])=>[s,await a]));return u(this,Ne).load(t),m(n,Oi(Gi),G(s=>!Jt(s)),L,Yi(null))};class Wr extends Gn{constructor(e){var t;super(),wn(this,"_drawables",new Set),wn(this,"_returnAllDrawables"),this._returnAllDrawables=(t=e.returnAllDrawables)!=null?t:!1}toBBox(e){const t=e.boundingRect;return{minX:t.x,minY:t.y,maxX:t.x+t.width,maxY:t.y+t.height}}compareMinX(e,t){const n=e.boundingRect,s=t.boundingRect;return n.x-s.x}compareMinY(e,t){const n=e.boundingRect,s=t.boundingRect;return n.y-s.y}load(e){const t=oe(e);return t.forEach(n=>this._drawables.add(n)),this._returnAllDrawables?this:super.load(L(t))}insert(e){return this._drawables.add(e),super.insert(e)}remove(e){return this._drawables.delete(e),this._returnAllDrawables?this:super.remove(e)}clear(){var e;return(e=this._drawables)==null||e.clear(),this._returnAllDrawables?this:super.clear()}getIntersections(e){return this._returnAllDrawables?this._drawables:new Set(super.search({minX:e.x,minY:e.y,maxX:e.x+e.width,maxY:e.y+e.height}))}}var $r=Object.defineProperty,Zn=i=>{throw TypeError(i)},Pr=(i,e,t)=>e in i?$r(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Gr=(i,e,t)=>Pr(i,e+"",t),Qi=(i,e,t)=>e.has(i)||Zn("Cannot "+t),_=(i,e,t)=>(Qi(i,e,"read from private field"),t?t.call(i):e.get(i)),N=(i,e,t)=>e.has(i)?Zn("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),V=(i,e,t,n)=>(Qi(i,e,"write to private field"),e.set(i,t),t),yn=(i,e,t)=>(Qi(i,e,"access private method"),t),Bi,kt,rt,Me,Mt,$,Ve,Xe,ke,Ci,jt,Ye,ei,jn,es;const Or="outside",ts=Tn(2);function Si(i,e){return JSON.stringify([i,e])}function Ai(i){const[e,t]=JSON.parse(i);return{decorationId:e,segmentId:t}}let Vr=0;class Xr{constructor(e){N(this,Ye),N(this,Bi,Ft.createLogger("CanvasTextDecoration")),N(this,kt,new DisposableStack),N(this,rt),N(this,Me),N(this,Mt),N(this,$),N(this,Ve,null),N(this,Xe,null),N(this,ke,null),N(this,Ci,Vr++/1e9),N(this,jt,0),Gr(this,"id"),this.id=e.decorationId,V(this,rt,e.interactiveGeometryManager),V(this,Me,e.rangesGroup),V(this,$,e.segments.map(t=>({...t,rects:[],rawRects:[]}))),V(this,Mt,e.isFocused),_(this,kt).defer(()=>{e.onDispose(),this.removeInteractiveGeometry()})}get segments(){return _(this,$)}get zIndex(){return _(this,Mt).call(this)?Number.MAX_SAFE_INTEGER:_(this,jt)+_(this,Ci)}get opaqueRects(){return _(this,Mt).call(this)?this.rects:[]}get boundingRect(){return _(this,Ve)?_(this,Ve):(V(this,Ve,m(_(this,$).flatMap(e=>e.rects),Yi(Hs()))),_(this,Ve))}get boundingTextRange(){return _(this,Me).boundingRange}get visibleRects(){return _(this,ke)?_(this,ke):(V(this,ke,m(_(this,$),G(e=>!!e.background||!!e.underline),Oi(e=>Rt(e.rects)),L)),_(this,ke))}get rects(){return _(this,Xe)?_(this,Xe):(V(this,Xe,m(_(this,$).flatMap(e=>e.rects),Rt)),_(this,Xe))}toString(){return"CanvasTextDecoration({ id: ".concat(this.id,", rangesGroup: ").concat(_(this,Me)," })")}removeInteractiveGeometry(){for(const e of _(this,$))_(this,rt).remove(Si(this.id,e.id))}registerInteractiveGeometry(){for(const e of _(this,$))e.interactive?_(this,rt).upsert(Si(this.id,e.id),e.rects):_(this,rt).remove(Si(this.id,e.id))}patchSegment(e,{interactive:t,underline:n,background:s}){let a=!1;V(this,$,_(this,$).map(r=>{if(r.id!==e)return r;t!==r.interactive&&(a=!0);const o=n===null?void 0:n!=null?n:r.underline,d=s===null?void 0:s!=null?s:r.background;return{id:r.id,rawRects:r.rawRects,rects:r.rawRects.map(_n(o)),backgroundAnimation:Yr(s,r),underlineAnimation:Fr(n,r),interactive:t!=null?t:r.interactive,underline:o,background:d}})),a&&this.registerInteractiveGeometry(),V(this,ke,null)}async layout(e){if(_(this,Ye,ei))return this.boundingRect;const t=await m(_(this,Me).getGeometry({minimumRevision:e,geometryKind:"rects"}),Cs({success:({rects:n})=>n,failure:n=>(_(this,Bi).error("Unexpected error getting rects - returning empty rects",n),[])}));return _(this,Ye,ei)?this.boundingRect:(V(this,$,m(ln(_(this,$),t),L,n=>n.map(([s,a])=>({...s,rawRects:m(a,Rt,r=>r.map(pn(Ce))),rects:m(a.map(_n(s.underline)),Rt,r=>r.map(pn(Ce)))})))),this.registerInteractiveGeometry(),V(this,jt,m(ln(_(this,$),_(this,Me).ranges),G(([n])=>!!n.interactive),W(([n,s])=>s.start),L,n=>n.length===0?_(this,Me).ranges.map(s=>s.start):n,n=>n.length===0?0:Math.min(...n))),V(this,Ve,null),V(this,Xe,null),V(this,ke,null),this.boundingRect)}*render(e){if(!_(this,Ye,ei))for(;;){e.save();const t=yn(this,Ye,jn).call(this,e),n=yn(this,Ye,es).call(this,e);if(e.restore(),t||n)yield;else return}}[Symbol.dispose](){_(this,kt).dispose()}}Bi=new WeakMap;kt=new WeakMap;rt=new WeakMap;Me=new WeakMap;Mt=new WeakMap;$=new WeakMap;Ve=new WeakMap;Xe=new WeakMap;ke=new WeakMap;Ci=new WeakMap;jt=new WeakMap;Ye=new WeakSet;ei=function(){return _(this,kt).disposed};jn=function(i){var e;let t=!1;for(const n of _(this,$)){const s=n.backgroundAnimation,a=(e=n.background)!=null?e:s!=null&&s.running?s==null?void 0:s.metadata.background:void 0;if(a){if(i.save(),s){const{alpha:r,running:o}=qi(s);t||(t=o),i.globalAlpha=r}for(const r of n.rawRects)r.width<=0||r.height<=0||(i.fillStyle=a.color,i.fillRect(r.x,r.y,r.width,r.height));i.restore()}}return t};es=function(i){var e;let t=!1;for(const n of _(this,$)){const s=n.underlineAnimation,a=(e=n.underline)!=null?e:s!=null&&s.running?s==null?void 0:s.metadata.underline:void 0;if(!a)continue;const{underlineThickness:r,verticalOffset:o}=ns(n.underline);if(i.save(),s){const{alpha:l,running:f}=qi(s);t||(t=f),i.globalAlpha=l}for(const l of n.rawRects)l.width<=0||l.height<=0||(i.lineWidth=r,i.strokeStyle=a.color,i.setLineDash(a.style==="dotted"?[r,r]:[]),i.lineCap="butt",i.beginPath(),i.moveTo(l.x,l.y+l.height+o),i.lineTo(l.x+l.width,l.y+l.height+o),i.stroke());i.restore();const d=n.rawRects.at(-1);if(a.style==="ellipsis"&&d){if(d.width<=0||d.height<=0)continue;i.beginPath(),i.lineWidth=0,i.fillStyle=a.color;const l=d.x+d.width,f=d.y+d.height+o,{radius:g,gap:p}=is(r),v=2*Math.PI;i.arc(l+p*1,f,g,0,v),i.arc(l+p*2,f,g,0,v),i.arc(l+p*3,f,g,0,v),i.fill()}}return t};function is(i){return{radius:.6*i,gap:2.5*i}}function Yr(i,e){return i&&!e.background?{kind:"fadeIn",startTime:performance.now(),duration:200,metadata:{background:i},running:!0}:i===null&&e.background?{kind:"fadeOut",startTime:performance.now(),duration:150,metadata:{background:e.background},running:!0}:e==null?void 0:e.backgroundAnimation}function Fr(i,e){return i&&!e.underline?{kind:"fadeIn",startTime:performance.now(),duration:200,metadata:{underline:i},running:!0}:i===null&&e.underline?{kind:"fadeOut",startTime:performance.now(),duration:150,metadata:{underline:e.underline},running:!0}:e==null?void 0:e.underlineAnimation}function ns(i){var e,t;const n=(e=i==null?void 0:i.thickness)!=null?e:ts,s=(t=i==null?void 0:i.align)!=null?t:Or,a=Tn(s==="inside"?-n/2:s==="center"?0:n/2);return{underlineThickness:hn(n),verticalOffset:hn(a),align:s}}function _n(i){return e=>{var t;const{underlineThickness:n,align:s}=ns(i),a=s==="center"?n/2:s==="outside"?n:0,r=is((t=i==null?void 0:i.thickness)!=null?t:ts),o=(i==null?void 0:i.style)==="ellipsis"?3*r.gap+r.radius:0;return Qe({...e,height:Ce(e.height+a+.5),width:Ce(e.width+o+.5)})}}var zr=(i,e)=>(e=Symbol[i])?e:Symbol.for("Symbol."+i),li=i=>{throw TypeError(i)},Ji=(i,e,t)=>e.has(i)||li("Cannot "+t),h=(i,e,t)=>(Ji(i,e,"read from private field"),t?t.call(i):e.get(i)),S=(i,e,t)=>e.has(i)?li("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),K=(i,e,t,n)=>(Ji(i,e,"write to private field"),e.set(i,t),t),R=(i,e,t)=>(Ji(i,e,"access private method"),t),Lr=(i,e,t,n)=>({set _(s){K(i,e,s)},get _(){return h(i,e,n)}}),Ze=(i,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&li("Object expected");var n;n===void 0&&(n=e[zr("dispose")]),typeof n!="function"&&li("Object not disposable"),i.push([t,n,e])}return e},je=(i,e,t)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(r,o,d,l){return l=Error(d),l.name="SuppressedError",l.error=r,l.suppressed=o,l},s=r=>e=t?new n(r,e,"An error was suppressed during disposal"):(t=!0,r),a=r=>{for(;r=i.pop();)try{var o=r[1]&&r[1].call(r[2]);if(r[0])return Promise.resolve(o).then(a,d=>(s(d),a()))}catch(d){s(d)}if(t)throw e};return a()},H,I,hi,Ie,x,ci,We,be,O,mi,pi,vi,at,di,ue,ti,Je,He,Z,Ke,Y,vt,b,ss,rs,as,os,ls,hs,Ii,Ki,Zi,cs,ds,us,fs,ji,gs,ms,ps,vs,en,Wi,ws,ot;class Ti{constructor(e,t,n,s,a){S(this,b),S(this,H,new DisposableStack),S(this,I),S(this,hi),S(this,Ie),S(this,x,{geometry:null,documentFrameScrolling:!1,windowFrameResizing:!1,windowFrameMoving:!1}),S(this,ci,0),S(this,We),S(this,be),S(this,O,new Map),S(this,mi,new fe),S(this,pi,new fe),S(this,vi,new fe),S(this,at,new Map),S(this,di,new Set),S(this,ue,new Set),S(this,ti,null),S(this,Je,new Set),S(this,He,document.createElement("canvas")),S(this,Z,null),S(this,Ke),S(this,Y,{documentScrolling:new fe,windowMoving:new fe,windowResizing:new fe}),S(this,vt,new Qs),K(this,Ke,e),K(this,I,Ft.createLogger("TextDecorationsViewController",n.id)),K(this,hi,a),K(this,Ie,n),h(this,He).style.width="100%",h(this,He).style.height="100%",K(this,We,h(this,H).use(R(this,b,as).call(this))),K(this,be,h(this,H).use(R(this,b,os).call(this)));const r=m(t,Vi(o=>o!==null),In());h(this,H).use(R(this,b,ls).call(this,s,r)),h(this,H).use(R(this,b,hs).call(this)),h(this,H).use(R(this,b,ss).call(this,t)),h(this,H).use(n.geometryWillChange.subscribe(o=>R(this,b,us).call(this,o))),h(this,H).use(h(this,Ie).textChange.subscribe(o=>R(this,b,ds).call(this,o))),h(this,H).use(m(r,ri(o=>o?mt(h(this,Ie).geometry):Tt),Oe(o=>R(this,b,fs).call(this,o))))}[Symbol.dispose](){h(this,H).dispose()}async upsert(e){var t,n,s;const a=await this.remove([e.id]);if(!a.ok)return a;e.visibility==="visible"&&h(this,ue).add(e.id);const r=Et(e.segments);if(!r)return $e();const o=new AbortController;if(h(this,at).set(e.id,o),await h(this,vt).enqueue({kind:"add",options:e},e.revision),h(this,at).get(e.id)===o&&h(this,at).delete(e.id),o.signal.aborted)return $e();const d=h(this,We).add({id:e.id,revision:e.revision,ranges:m(r,Cn(g=>({id:g.id,range:g.range,updateSemantics:g.updateSemantics,metadata:void 0}))),metadata:e.id,visible:h(this,ue).has(e.id)});if(!d.ok)return d;const l=d.value,f=new Xr({decorationId:e.id,rangesGroup:l,segments:r,interactiveGeometryManager:h(this,be),isFocused:()=>h(this,ti)===e.id,onDispose:()=>{As(l),m(this.remove([e.id]),St(pt(g=>h(this,I).error("Error removing decoration during dispose",g))))}});return h(this,O).set(e.id,f),(s=h(this,Z))==null||s.add([{drawable:f,visible:h(this,ue).has(e.id),onscreen:Fi(l.boundingRange,(n=(t=h(this,x).geometry)==null?void 0:t.visibleTextRange)!=null?n:{start:0,end:0})}]),h(this,I).verbose("added ".concat(h(this,ue).has(e.id)?"visible":"hidden"," decoration"),e.id),$e()}remove(e){var t,n=[];try{const r=oe(e);r.forEach(l=>{var f;return(f=h(this,at).get(l))==null?void 0:f.abort()});const o=R(this,b,Ii).call(this,r);if(o.length===0)return ce();const d=Ze(n,new DisposableStack);return o.map(l=>{h(this,O).delete(l.id),d.use(l)}),(t=h(this,Z))==null||t.remove(o),h(this,I).verbose("removed decorations",o.map(l=>l.id)),ce()}catch(r){var s=r,a=!0}finally{je(n,s,a)}}setVisibility(e){var t;const n=oe(e.ids);h(this,We).setVisibility(n,e.visible),n.forEach(a=>e.visible?h(this,ue).add(a):h(this,ue).delete(a));const s=R(this,b,Ii).call(this,n);return s.length===0?ce():(e.visible?s.forEach(a=>a.registerInteractiveGeometry()):s.forEach(a=>a.removeInteractiveGeometry()),(t=h(this,Z))==null||t.setVisibility(s,e.visible),h(this,I).verbose(e.visible?"showing decorations":"hiding decorations",s.map(a=>a.id)),ce())}patchSegment({id:e,segmentId:t,patch:n}){var s;const a=h(this,O).get(e);return a?(a.patchSegment(t,n),(s=h(this,Z))==null||s.requestRender([a]),h(this,I).verbose("patched segment ".concat(t," of decoration ").concat(e," with"),n),ce()):ce()}focus(e){return K(this,ti,e),ce()}dispose(){h(this,H).dispose()}}H=new WeakMap;I=new WeakMap;hi=new WeakMap;Ie=new WeakMap;x=new WeakMap;ci=new WeakMap;We=new WeakMap;be=new WeakMap;O=new WeakMap;mi=new WeakMap;pi=new WeakMap;vi=new WeakMap;at=new WeakMap;di=new WeakMap;ue=new WeakMap;ti=new WeakMap;Je=new WeakMap;He=new WeakMap;Z=new WeakMap;Ke=new WeakMap;Y=new WeakMap;vt=new WeakMap;b=new WeakSet;ss=function(i){let e=null;return m(i,In(),Oe(t=>{if(t){t.appendChild(h(this,He));const{renderer:n,disposable:s}=R(this,b,rs).call(this);K(this,Z,n),e=s}else h(this,He).remove(),e&&e[Symbol.dispose](),e=null,K(this,Z,null)}))};rs=function(){var i,e,t,n,s,a,r,o,d,l,f=[];try{const v=Ze(f,new DisposableStack),w=v.use(new Ir({canvas:h(this,He),oversamplingFactor:1,viewportGeometry:Qe({x:(t=(e=(i=h(this,x).geometry)==null?void 0:i.scrollPosition)==null?void 0:e.x)!=null?t:0,y:(a=(s=(n=h(this,x).geometry)==null?void 0:n.scrollPosition)==null?void 0:s.y)!=null?a:0,width:(o=(r=h(this,x).geometry)==null?void 0:r.documentFrame.width)!=null?o:0,height:(l=(d=h(this,x).geometry)==null?void 0:d.documentFrame.height)!=null?l:0}),emitRenderMetrics:k=>{const B=m(k.renderedVisibleOnscreenDrawables,W(C=>C.id),oe);Ps(B,h(this,di))||(K(this,di,B),m(h(this,Ke).onVisibleOnscreenDecorationsDidChange(B),St(pt(C=>h(this,I).error("Error sending visible onscreen decorations change",C))))),R(this,b,ps).call(this,k)}}));return h(this,Je).size>0&&(w.hideAllVisible(),h(this,be).disablePointerEvents()),h(this,O).size>0&&w.add(m(h(this,O).values(),W(k=>{var B,C;return{drawable:k,visible:h(this,ue).has(k.id),onscreen:Fi(k.boundingTextRange,(C=(B=h(this,x).geometry)==null?void 0:B.visibleTextRange)!=null?C:{start:0,end:0})}}))),R(this,b,ji).call(this,w),v.defer(()=>{R(this,b,Zi).call(this,["rendererDisposed"]),h(this,I).verbose("renderer disposed")}),R(this,b,Ki).call(this,["rendererDisposed"]),h(this,I).verbose("renderer created"),{renderer:w,disposable:v.move()}}catch(v){var g=v,p=!0}finally{je(f,g,p)}};as=function(){var i,e;return new Sr({initialRevision:{text:Li,geometry:Xi},initialVisibleTextRange:(e=(i=h(this,x).geometry)==null?void 0:i.visibleTextRange)!=null?e:{start:0,end:0},getRects:t=>m(h(this,Ke).getRects(t),Di(({rects:n,revision:s})=>{var a,r;return s.geometry!==((a=h(this,x).geometry)==null?void 0:a.revision)&&((r=h(this,x).geometry)==null?void 0:r.scrollPosition)!==void 0&&h(this,I).warn("Expected document geometry revision ".concat(h(this,x).geometry.revision," to equal revision ").concat(s.geometry," from getRects() response"),{delivery:!1}),{rects:new Map(m(n.entries(),W(([o,d])=>[o,d.map(l=>{var f,g,p,v,w,k;return Qe({...l,x:l.x+((p=(g=(f=h(this,x).geometry)==null?void 0:f.scrollPosition)==null?void 0:g.x)!=null?p:0),y:l.y+((k=(w=(v=h(this,x).geometry)==null?void 0:v.scrollPosition)==null?void 0:w.y)!=null?k:0)})})]))),revision:s}})),getBoundingRects:t=>m(h(this,Ke).getBoundingRects(t),Di(({rects:n,revision:s})=>{var a,r;return s.geometry!==((a=h(this,x).geometry)==null?void 0:a.revision)&&((r=h(this,x).geometry)==null?void 0:r.scrollPosition)!==void 0&&h(this,I).warn("Expected document geometry revision ".concat(h(this,x).geometry.revision," to equal revision ").concat(s.geometry," from getRects() response"),{delivery:!1}),{rects:new Map(m(n.entries(),W(([o,d])=>{var l,f,g,p,v,w;return[o,Qe({...d,x:d.x+((g=(f=(l=h(this,x).geometry)==null?void 0:l.scrollPosition)==null?void 0:f.x)!=null?g:0),y:d.y+((w=(v=(p=h(this,x).geometry)==null?void 0:p.scrollPosition)==null?void 0:v.y)!=null?w:0)})]}))),revision:s}})),emitMetrics:t=>R(this,b,gs).call(this,t)})};os=function(){return new dr({label:h(this,Ie).id,pointerMove:Qt(h(this,mi)),pointerDown:Qt(h(this,vi)),pointerUp:Qt(h(this,pi)),getViewport:()=>{var i,e,t,n,s,a,r,o,d,l;return Qe({x:(t=(e=(i=h(this,x).geometry)==null?void 0:i.scrollPosition)==null?void 0:e.x)!=null?t:0,y:(a=(s=(n=h(this,x).geometry)==null?void 0:n.scrollPosition)==null?void 0:s.y)!=null?a:0,width:(o=(r=h(this,x).geometry)==null?void 0:r.documentFrame.width)!=null?o:0,height:(l=(d=h(this,x).geometry)==null?void 0:d.documentFrame.height)!=null?l:0})},compareZIndex:(i,e)=>{const t=Ai(i.geometry),n=Ai(e.geometry),s=h(this,O).get(t.decorationId),a=h(this,O).get(n.decorationId);if(!s||!a)return 0;if(s.zIndex===a.zIndex){const r=s.segments.find(f=>f.id===t.segmentId),o=a.segments.find(f=>f.id===n.segmentId);if(!r||!o)return 0;const d=r.underline?1:0,l=o.underline?1:0;return d-l}return s.zIndex-a.zIndex},emitMetrics:i=>R(this,b,ms).call(this,i)})};ls=function(i,e){var t=[];try{const a=Ze(t,new DisposableStack);return a.use(m(e,ri(r=>r?mt(i.pointerEvents):Tt),Oe(r=>m(R(this,b,cs).call(this,r),Is(pt(o=>h(this,I).error("Unexpected error handling pointer event",o))))))),a.use(m(e,ri(r=>r?mt(h(this,be).onPointerEvent):Tt),Oe(r=>void m(R(this,b,ws).call(this,r),St(pt(o=>h(this,I).error("Unexpected error sending pointer events to TextDecorationsViewBackgroundController",o))))))),a.move()}catch(a){var n=a,s=!0}finally{je(t,n,s)}};hs=function(){var i=[];try{const n=Ze(i,new DisposableStack);for(const[s,a,r]of[[h(this,Y).documentScrolling,"documentScrolling",250],[h(this,Y).windowMoving,"windowMoving",250],[h(this,Y).windowResizing,"windowResizing",250]])n.use(m(s,ri(o=>o==="removeAfterTimeout"?An(r):Tt),Oe(()=>R(this,b,Ki).call(this,[a]))));return n.move()}catch(n){var e=n,t=!0}finally{je(i,e,t)}};Ii=function(i){return m(i,W(e=>h(this,O).get(e)),G(j),L)};Ki=function(i){var e;i.length!==0&&(i.forEach(t=>h(this,Je).delete(t)),!(h(this,Je).size>0||h(this,O).size===0)&&(h(this,be).enablePointerEvents(),(e=h(this,Z))==null||e.showAllVisible()))};Zi=function(i){var e;const t=h(this,Je).size>0;i.forEach(n=>h(this,Je).add(n)),!(t||h(this,O).size===0)&&(h(this,be).disablePointerEvents(),(e=h(this,Z))==null||e.hideAllVisible())};cs=function(i){var e,t,n,s,a,r,o,d;const l=pr({x:i.position.x-((s=(n=(t=(e=h(this,x))==null?void 0:e.geometry)==null?void 0:t.scrollPosition)==null?void 0:n.x)!=null?s:0),y:i.position.y-((d=(o=(r=(a=h(this,x))==null?void 0:a.geometry)==null?void 0:r.scrollPosition)==null?void 0:o.y)!=null?d:0)});switch(i.kind){case"pointermove":return Ri(()=>h(this,mi).next(l));case"pointerdown":return Ri(()=>h(this,vi).next(l));case"pointerup":return Ri(()=>h(this,pi).next(l));default:return Pi(new Sn(i.kind))}};ds=function(i){var e,t,n,s,a,r=[];try{const l=Ze(r,Pe.startSpan("TextDecorationsViewController.#handleTextDidChange()",{attributes:{change:i}})),{visibleChanged:f}=h(this,We).pushTextChange(i);h(this,vt).pushNewTextRevision(i.revision);const g=m(f,W(p=>h(this,O).get(p.metadata)),G(j),L);(a=h(this,Z))==null||a.requestLayout(g,{text:(e=h(this,vt).textRevision)!=null?e:Li,geometry:(s=(n=(t=h(this,x))==null?void 0:t.geometry)==null?void 0:n.revision)!=null?s:Xi}),g.length>0&&h(this,I).verbose("text changed",{change:i,visibleChangedDecorationsCount:g.length,visibleChangedSegmentsCount:Array.from(g).flatMap(p=>p.segments).length})}catch(l){var o=l,d=!0}finally{je(r,o,d)}};us=function(i){var e=[];try{const s=Ze(e,Pe.startSpan("TextDecorationsViewController.#handleGeometryWillChange()",{attributes:{event:i}})),a=Et([i.documentFrameScrolling?"documentScrolling":null,i.windowFrameResizing?"windowMoving":null,i.windowFrameResizing?"windowResizing":null].filter(j));a&&(a.includes("documentScrolling")&&h(this,Y).documentScrolling.next("cancelRemoval"),a.includes("windowMoving")&&h(this,Y).windowMoving.next("cancelRemoval"),a.includes("windowResizing")&&h(this,Y).windowResizing.next("cancelRemoval"),R(this,b,Zi).call(this,a))}catch(s){var t=s,n=!0}finally{je(e,t,n)}};fs=function(i){var e=[];try{const s=Ze(e,Pe.startSpan("TextDecorationsViewController.#handleGeometryDidChange()",{attributes:{documentGeometry:i}}));if(i.documentFrameScrolling?h(this,Y).documentScrolling.next("cancelRemoval"):h(this,Y).documentScrolling.next("removeAfterTimeout"),i.windowFrameMoving?h(this,Y).windowMoving.next("cancelRemoval"):h(this,Y).windowMoving.next("removeAfterTimeout"),i.windowFrameResizing?h(this,Y).windowResizing.next("cancelRemoval"):h(this,Y).windowResizing.next("removeAfterTimeout"),K(this,x,i),!i.geometry)return;const{visible:a}=h(this,We).pushDocumentGeometryChange(i.geometry.visibleTextRange,i.geometry.revision);R(this,b,ji).call(this,h(this,Z),a),h(this,I).verbose("geometry changed",{visibleTextRange:zi(i.geometry.visibleTextRange)})}catch(s){var t=s,n=!0}finally{je(e,t,n)}};ji=function(i,e){var t,n,s,a,r,o,d,l,f,g,p,v,w;h(this,be).clear();const k=m(e!=null?e:h(this,We).getOnscreenTextRangeGroups(),W(B=>h(this,O).get(B.metadata)),G(j),oe);i==null||i.setViewport(k,Qe({x:(s=(n=(t=h(this,x).geometry)==null?void 0:t.scrollPosition)==null?void 0:n.x)!=null?s:0,y:(o=(r=(a=h(this,x).geometry)==null?void 0:a.scrollPosition)==null?void 0:r.y)!=null?o:0,width:(l=(d=h(this,x).geometry)==null?void 0:d.documentFrame.width)!=null?l:0,height:(g=(f=h(this,x).geometry)==null?void 0:f.documentFrame.height)!=null?g:0}),{text:(p=h(this,vt).textRevision)!=null?p:Li,geometry:(w=(v=h(this,x).geometry)==null?void 0:v.revision)!=null?w:Xi})};gs=function(i){h(this,I).verbose("geometry fetch metrics",i)};ms=function(i){h(this,I).verbose("interactive geometry metrics",i)};ps=function(i){const e=m(i.renderedVisibleOnscreenDrawables,W(s=>s.id),oe),t=m(i.visibleDrawables,W(s=>s.id),oe),n=m(i.allDrawables,W(s=>s.id),oe);h(this,I).verbose("render metrics",{decorationsRenderedOnLastRenderLoop:i.drawablesRenderedOnLastRenderLoop,renderedVisibleOnscreenDecorationCount:e.size,visibleDecorationCount:t.size,allDecorationCount:n.size}),i.drawablesRenderedOnLastRenderLoop>0&&(h(this,ci)===0&&R(this,b,vs).call(this),Lr(this,ci)._++)};vs=async function(){const{revision:i}=await cn(m(mt(h(this,Ie).text),gn(1))),e=await cn(m(mt(h(this,Ie).lastFocusAt),gn(1))),t=(Xs()-e)/1e3;h(this,hi).duration("first_decoration_render",{labels:{revision_history_info:i<=1?"initial":i<10?"early":"late"}}).close(null,{durationInSeconds:t})};en=function(i){var e,t,n,s,a,r,o,d,l,f;return yr({x:i.x-((n=(t=(e=h(this,x).geometry)==null?void 0:e.scrollPosition)==null?void 0:t.x)!=null?n:0)+((a=(s=h(this,x).geometry)==null?void 0:s.documentFrame.x)!=null?a:0),y:i.y-((d=(o=(r=h(this,x).geometry)==null?void 0:r.scrollPosition)==null?void 0:o.y)!=null?d:0)+((f=(l=h(this,x).geometry)==null?void 0:l.documentFrame.y)!=null?f:0)})};Wi=function(i){return br({...R(this,b,en).call(this,i),width:i.width,height:i.height})};ws=function(i){return h(this,Ke).onSegmentPointerEvents({pointerEnter:R(this,b,ot).call(this,i.pointerEnter),pointerLeave:R(this,b,ot).call(this,i.pointerLeave),pointerDown:R(this,b,ot).call(this,i.pointerDown),pointerUp:R(this,b,ot).call(this,i.pointerUp),pointerClick:R(this,b,ot).call(this,i.pointerClick)})};ot=function(i){var e,t,n,s,a,r,o;if(!i)return;const{decorationId:d,segmentId:l}=Ai(i.target),f=h(this,O).get(d),g=Et((n=(t=(e=f==null?void 0:f.segments)==null?void 0:e.find(w=>w.id===l))==null?void 0:t.rects)!=null?n:[]),p=xr((a=(s=h(this,x).geometry)==null?void 0:s.viewportFrame)!=null?a:{x:0,y:0}),v=wr((o=(r=h(this,x).geometry)==null?void 0:r.windowFrame)!=null?o:{x:0,y:0});return!f||!g?void 0:{kind:i.kind,segmentId:l,id:d,position:R(this,b,en).call(this,i.position),rect:R(this,b,Wi).call(this,i.currentTarget),decorationRects:f.rects.map(w=>R(this,b,Wi).call(this,w)),viewportOffset:p,windowOffset:v}};var ys={exports:{}},wi={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var qr=Dn,Ur=Symbol.for("react.element"),Nr=Symbol.for("react.fragment"),Hr=Object.prototype.hasOwnProperty,Qr=qr.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Jr={key:!0,ref:!0,__self:!0,__source:!0};function _s(i,e,t){var n,s={},a=null,r=null;t!==void 0&&(a=""+t),e.key!==void 0&&(a=""+e.key),e.ref!==void 0&&(r=e.ref);for(n in e)Hr.call(e,n)&&!Jr.hasOwnProperty(n)&&(s[n]=e[n]);if(i&&i.defaultProps)for(n in e=i.defaultProps,e)s[n]===void 0&&(s[n]=e[n]);return{$$typeof:Ur,type:i,key:a,ref:r,props:s,_owner:Qr.current}}wi.Fragment=Nr;wi.jsx=_s;wi.jsxs=_s;ys.exports=wi;var Kr=ys.exports;const Zr=({documentId:i,width:e,height:t,onMount:n})=>Kr.jsx("div",{"data-document-id":i,style:{width:e,height:t},ref:n});var jr=(i,e)=>(e=Symbol[i])?e:Symbol.for("Symbol."+i),xn=i=>{throw TypeError(i)},ea=(i,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&xn("Object expected");var n;n===void 0&&(n=e[jr("dispose")]),typeof n!="function"&&xn("Object not disposable"),i.push([t,n,e])}return e},ta=(i,e,t)=>{var n=typeof SuppressedError=="function"?SuppressedError:function(r,o,d,l){return l=Error(d),l.name="SuppressedError",l.error=r,l.suppressed=o,l},s=r=>e=t?new n(r,e,"An error was suppressed during disposal"):(t=!0,r),a=r=>{for(;r=i.pop();)try{var o=r[1]&&r[1].call(r[2]);if(r[0])return Promise.resolve(o).then(a,d=>(s(d),a()))}catch(d){s(d)}if(t)throw e};return a()};const $i=si(),Da=i=>{const e=i.getExecutionScopeDefinition("document-session");return m(ni([i.getPlugin("document-session"),i.getPlugin("monitoring")]),En(([t,n])=>lt.all([e.register({token:Os,useFactory:s=>m(ni([s.resolve(t.provides.TextDocumentInfo),s.resolve($i)]),xe(([a,r])=>o=>Dn.createElement(Zr,{...o,documentId:a.id,onMount:d=>r.next(d)})))},{lifetime:ht.Singleton}),ia(e,t,n)])))};function ia(i,e,t){var n=[];try{const r=ea(n,new DisposableStack),o=si();return m(kr({scopeDefinition:i,remoteEntityToken:Gs,localEntityToken:o}),lt.use(r),En(({remoteEntityToken:d})=>lt.all([i.register({token:$i,useFactory:()=>$e(new Ws(null))},{lifetime:ht.Singleton}),i.register({token:o,useFactory:l=>m(l.resolve(Ti),xe(f=>({entity:f,disposable:f})))},{lifetime:ht.Singleton}),i.register({token:Ti,useFactory:js(Ti,[d,$i,e.provides.TextDocumentInfo,$s,t.provides.Monitoring])},{lifetime:ht.Singleton})])),lt.use(r),xe(()=>r.move()))}catch(r){var s=r,a=!0}finally{ta(n,s,a)}}export{Da as activate};
//# sourceMappingURL=index-BPaNLfb7.js.map
