var j=Object.defineProperty;var G=s=>{throw TypeError(s)};var ee=(s,e,t)=>e in s?j(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var z=(s,e,t)=>ee(s,typeof e!="symbol"?e+"":e,t),I=(s,e,t)=>e.has(s)||G("Cannot "+t);var l=(s,e,t)=>(I(s,e,"read from private field"),t?t.call(s):e.get(s)),m=(s,e,t)=>e.has(s)?G("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),c=(s,e,t,a)=>(I(s,e,"write to private field"),a?a.call(s,t):e.set(s,t),t);import{p as h,b as T,k as W,m as K,S as te,l as se,d as P,a3 as y,G as A,y as ae,v as ne,C as H,ac as ie,i as J,s as Q,e as re,L as oe}from"./start-C5OgI2kj.js";import{SuggestionManagerToken as le}from"./index-DcjwB2Hh.js";import{T as ue}from"./TextRangeManager-Cr3iyUZK-B-ilxniI.js";import{T as ge,f as d}from"./TextRangeUpdateSemantics-D8MqPOrG-Bdcz8ucb.js";import{D as ce}from"./Delta-D-dso3t3-B1UydhvC.js";import{t as V}from"./subscribable-Cqm5UN_u-CZjzLfrM.js";import{d as de}from"./defineFactory-DJYNRBNc-BjUmrCbc.js";import"./PluginModule-CRib3PLZ-rw_nkrD1.js";import"./TextRevisionFns-DGbJAFcL-DX1ABpMm.js";var x;class fe{constructor(e){m(this,x);c(this,x,new ue({...e,initialTextRevision:e.textRevision,label:"TransformManager/TextRangeManager"}))}pushTextChange({change:e,revision:t}){const a=l(this,x).pushTextChange({change:e,revision:t}),r=[];for(const n of a.affectedRanges)r.push(n.metadata),n.metadata.onEditComplete(e);return{getChangedTransforms:()=>h(a.getChangedRanges(),T(n=>n.metadata)),affectedTransforms:r}}add({context:e,alternatives:t,metadata:a,revision:r}){const n=l(this,x).add({range:e,revision:r,updateSemantics:ge.Resize,metadata:new he({getTextRange:()=>n.ok?n.value:e,getRevision:()=>n.ok?n.value.revision:r,onDispose:()=>W(n),alternatives:t,metadata:a}),onBeforeEditOperation:(o,p)=>h(n,K(k=>k.metadata.onBeforeEditOperation(o,p)))});return h(n,K(o=>o.metadata))}[Symbol.dispose](){W(l(this,x))}}x=new WeakMap;var M,b,R,f,S;class he{constructor(e){m(this,M);m(this,b);m(this,R);m(this,f);m(this,S,null);z(this,"metadata");c(this,M,e.onDispose),c(this,b,e.getTextRange),c(this,R,e.getRevision),c(this,f,e.alternatives),this.metadata=e.metadata}onBeforeEditOperation(e,t){l(this,S)!==null&&c(this,S,this.context.start)}onEditComplete(e){const t=l(this,S);t!==null&&(c(this,f,l(this,f).map(a=>a.compose(e.slice(t)))),c(this,S,null))}get context(){const e=l(this,b).call(this);return{start:e.start,end:e.end}}get alternatives(){return l(this,f)}get absoluteAlternatives(){return l(this,f).map(e=>new ce().retain(this.context.start).compose(e))}get revision(){return l(this,R).call(this)}[Symbol.dispose](){l(this,M).call(this)}}M=new WeakMap,b=new WeakMap,R=new WeakMap,f=new WeakMap,S=new WeakMap;var X=s=>{throw TypeError(s)},N=(s,e,t)=>e.has(s)||X("Cannot "+t),i=(s,e,t)=>(N(s,e,"read from private field"),t?t.call(s):e.get(s)),v=(s,e,t)=>e.has(s)?X("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),q=(s,e,t,a)=>(N(s,e,"write to private field"),e.set(s,t),t),L=(s,e,t)=>(N(s,e,"access private method"),t),C,D,u,_,g,B,w,Y,F;class pe{constructor(e){v(this,w),v(this,C),v(this,D),v(this,u,new Map),v(this,_,new DisposableStack),v(this,g,new te),v(this,B,new Map),q(this,C,se.createLogger("SuggestionManager",e.id)),q(this,D,i(this,_).use(new fe({textRevision:e.text.getValue().revision}))),i(this,_).use(e.textChange.subscribe(t=>{const{affectedTransforms:a}=i(this,D).pushTextChange(t),r=h(new Set(a.map(n=>n.metadata)),T(n=>i(this,u).get(n)),P(y),T(n=>n.suggestion),d);r&&i(this,g).next({affectedByTextChange:r})})),i(this,_).defer(()=>{const t=d(h(i(this,u).values(),T(a=>a.suggestion)));t&&i(this,g).next({removed:t})})}register(e){const t=i(this,B).get(e);if(t)return t;const a=new DisposableStack;return a.use(e.onSuggestionUpserted.subscribe(r=>{r.forEach(o=>L(this,w,Y).call(this,o));const n=d(r);n&&i(this,g).next({upserted:n})})),a.use(e.onSuggestionRemoved.subscribe(r=>{const n=d(r.map(o=>{var p;return(p=i(this,u).get(o))==null?void 0:p.suggestion}).filter(y));r.forEach(o=>L(this,w,F).call(this,o)),n&&i(this,g).next({removed:n})})),i(this,B).set(e,a),i(this,_).use(a),a}apply(e,t){const a=i(this,u).get(e);return a?a.transforms.map(n=>n.absoluteAlternatives[t]).filter(y).length===0?A(new _e(e,t)):(i(this,g).next({removed:[a.suggestion]}),A(new Error("Not implemented"))):A(new ve(e))}getCollection(e){const t=()=>h(i(this,u).values(),T(a=>a.suggestion),e===void 0?ie:P(a=>a.kind===e));return{onChange:e===void 0?V(i(this,g)):h(i(this,g),ne(me(e)),ae(y),V),getAll:t,getById:a=>{var r,n;return(n=(r=i(this,u).get(a))==null?void 0:r.suggestion)!=null?n:null},clear:()=>{const a=d(t());a&&(a.forEach(W),i(this,g).next({removed:a}))}}}[Symbol.dispose](){i(this,_).dispose()}}C=new WeakMap;D=new WeakMap;u=new WeakMap;_=new WeakMap;g=new WeakMap;B=new WeakMap;w=new WeakSet;Y=function(s){const e=s;L(this,w,F).call(this,e.id);const t=J([]);return t.ok?(i(this,u).set(e.id,{suggestion:s,transforms:t.value}),i(this,C).verbose("Upserted suggestion ".concat(e.id),e),Q()):(i(this,C).error("Error upserting suggestion",t.error),i(this,C).verbose("Error upserting suggestion ".concat(e.id),t.error),t)};F=function(s){var e;const t=(e=i(this,u).get(s))==null?void 0:e.transforms;W(t!=null?t:[]),i(this,u).delete(s)};function me(s){return e=>{var t,a,r,n,o,p,k,U,$;const O=Z=>Z.kind===s,E={upserted:(r=d((a=(t=e.upserted)==null?void 0:t.filter(O))!=null?a:[]))!=null?r:void 0,removed:(p=d((o=(n=e.removed)==null?void 0:n.filter(O))!=null?o:[]))!=null?p:void 0,affectedByTextChange:($=d((U=(k=e.affectedByTextChange)==null?void 0:k.filter(O))!=null?U:[]))!=null?$:void 0};return E.upserted||E.removed||E.affectedByTextChange?E:null}}class ve extends H{constructor(e){super("Suggestion ".concat(e," was not found."))}}class _e extends H{constructor(e,t){super("Alternative index ".concat(t," for Suggestion ").concat(e," is out of bounds."))}}const ye=s=>h(J([Q(s.getExecutionScopeDefinition("document-session")),s.getPlugin("document-session")]),re(([e,t])=>e.register({token:le,useFactory:de(pe,[t.provides.TextDocument])},{lifetime:oe.Singleton})));export{ye as activate};
//# sourceMappingURL=index-B3t3CNGG.js.map
