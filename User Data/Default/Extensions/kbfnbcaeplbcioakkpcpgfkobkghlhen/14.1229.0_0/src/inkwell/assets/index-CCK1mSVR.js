import{a1 as He,o as Je,a2 as Ke,a3 as Xe,k as Qe,a4 as Ye,a5 as Ze,a6 as je,B as V,S as me,p as m,t as A,w as ze,I,l as Be,s as we,q as Z,r as j,i as te,v as z,K as ie,z as $,A as et,a7 as tt,a8 as it,a9 as st,y as ye,a as Me,R as _e,a0 as rt,g as nt,j as at,m as ot,L as We,c as ct}from"./index-DbtAbjfk.js";import{T as lt,c as P,a as ut,b as ht,d as dt,e as mt,f as pt,A as ft,g as gt}from"./TextDocumentEntities-Db6vxvBV.js";import{TextDocumentToken as vt,TextDocumentInfoToken as wt,DocumentSessionToken as yt,DocumentSessionManagerToken as Ee}from"./index-Cq7S5ha4.js";import{n as Ce,e as _t,c as bt,i as pe}from"./index-CAjAjMx_.js";import{D as Dt}from"./Delta-D-dso3t3-B1UydhvC.js";import{t as kt}from"./timeoutWith-B7tsbJ8--C_uOzAu5.js";import{t as be}from"./take-Dbhfwukx.js";import{R as xt}from"./RandomSampler-Ba-P263P-DyiLAlld.js";import{i as St}from"./TextRevisionFns-DGbJAFcL-DX1ABpMm.js";import{d as De}from"./distinctUntilChanged-xQxyKspb.js";import{c as Ft}from"./concat-KLZEPRCF.js";import{s as Re}from"./share-D5q_PZU1.js";import{s as Tt}from"./switchMap-DLIF-D2S.js";import{a as Mt}from"./async-C23VpIJo.js";import{i as Wt}from"./timer-zq0ZEleB.js";import{t as Ae}from"./tap-CTBWtjxW.js";import{m as Et}from"./merge-DlpWXwAR.js";import{o as Ct}from"./of-Bh-sjQwK.js";import{d as Rt}from"./defineFactory-DJYNRBNc-CQmG8A-U.js";import"./RemoteEntity-CN-1WB86-yD3y8ldD.js";import"./PluginModule-CRib3PLZ-ls39AzbW.js";import"./mergeAll-Ci-uq6t1.js";var At=He(function(t){return function(i){i===void 0&&(i=null),t(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=i}});function $t(t,e){var i=Wt(t)?{first:t}:typeof t=="number"?{each:t}:t,a=i.first,c=i.each,l=i.with,o=l===void 0?Ot:l,r=i.scheduler,u=r===void 0?Mt:r,h=i.meta,n=h===void 0?null:h;if(a==null&&c==null)throw new TypeError("No timeout provided.");return Je(function(p,g){var Q,v,O=null,E=0,Y=function(de){v=Ke(g,u,function(){try{Q.unsubscribe(),Xe(o({meta:n,lastValue:O,seen:E})).subscribe(g)}catch(qe){g.error(qe)}},de)};Q=p.subscribe(Qe(g,function(de){v==null||v.unsubscribe(),E++,g.next(O=de),c>0&&Y(c)},void 0,void 0,function(){v!=null&&v.closed||v==null||v.unsubscribe(),O=null})),!E&&Y(a!=null?typeof a=="number"?a:+a-u.now():c)})}function Ot(t){throw new At(t)}function Pt(t){return e=>new Ye(i=>{const a=[],c=new je;let l=!1;const o=()=>{for(;a.length>0;){const r=a.shift();i.next(r)}};return c.add(Ze(t).pipe(be(1)).subscribe({next:()=>{l=!0,o()},complete:()=>{l||(i.complete(),c.unsubscribe())},error:r=>{l||i.error(r)}})),c.add(e.subscribe({next:r=>{l?i.next(r):a.push(r)},error:r=>{i.error(r),c.unsubscribe()},complete:()=>{i.complete(),c.unsubscribe()}})),{unsubscribe:()=>c.unsubscribe()}})}var Vt=Object.defineProperty,$e=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),ce=t=>{throw TypeError(t)},It=(t,e,i)=>e in t?Vt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,M=(t,e,i)=>It(t,typeof e!="symbol"?e+"":e,i),xe=(t,e,i)=>e.has(t)||ce("Cannot "+i),s=(t,e,i)=>(xe(t,e,"read from private field"),i?i.call(t):e.get(t)),f=(t,e,i)=>e.has(t)?ce("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),w=(t,e,i,a)=>(xe(t,e,"write to private field"),e.set(t,i),i),Oe=(t,e,i)=>(xe(t,e,"access private method"),i),fe=(t,e,i)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&ce("Object expected");var a;a=e[$e("asyncDispose")],a===void 0&&(a=e[$e("dispose")]),typeof a!="function"&&ce("Object not disposable"),t.push([i,a,e])}else t.push([i]);return e},ge=(t,e,i)=>{var a=typeof SuppressedError=="function"?SuppressedError:function(o,r,u,h){return h=Error(u),h.name="SuppressedError",h.error=o,h.suppressed=r,h},c=o=>e=i?new a(o,e,"An error was suppressed during disposal"):(i=!0,o),l=o=>{for(;o=t.pop();)try{var r=o[1]&&o[1].call(o[2]);if(o[0])return Promise.resolve(r).then(l,u=>(c(u),l()))}catch(u){c(u)}if(i)throw e};return l()},k,F,x,se,N,re,y,_,S,W,ne,L,q,B,U,R,ae,ke;class zt{constructor(e,i){f(this,ae),f(this,k),f(this,F,new DisposableStack),f(this,x,new V({revision:St,content:new Dt})),f(this,se,new V([])),f(this,N,new xt({probability:.01})),f(this,re,new V(Ce())),f(this,y,!1),f(this,_,!1),f(this,S,!1),f(this,W,new V({geometry:null,windowFrameMoving:!1,windowFrameResizing:!1,documentFrameScrolling:!1})),f(this,ne,new me),f(this,L,new V(!1)),f(this,q,new me),f(this,B),f(this,U,{getRects:0,getBoundingRects:0}),f(this,R),M(this,"id"),M(this,"textChange",m(Ft(m(s(this,x),be(1),ze(n=>({revision:n.revision,change:n.content}))),s(this,q)),De((n,p)=>p.revision===n.revision),A)),M(this,"text",I(s(this,x))),M(this,"selection",I(s(this,se))),M(this,"geometry",I(s(this,W))),M(this,"geometryWillChange",A(s(this,ne))),M(this,"hasFocus",I(s(this,L))),M(this,"lastFocusAt",I(s(this,re))),this.id=e.id,w(this,R,e),w(this,B,i),w(this,k,Be.createLogger("TextDocument",e.id));const a=kt(m(e.getText(),te(n=>{s(this,x).next(n),s(this,q).next({revision:n.revision,change:n.content})}),Z(j(n=>{s(this,k).error("Unexpected error when fetching initial text",n)}))),{timeoutMs:5e3,defaultValue:we(),onTimeout:()=>{s(this,k).warn("Did not receive initial text within 5s.",{delivery:!1})}});s(this,F).use(m(ie(e.textDidChange),Pt(a),z(n=>{const p=s(this,x).getValue();if(n.revision<=p.revision)return;const g=p.content.compose(n.change);s(this,x).next({revision:n.revision,content:g}),s(this,q).next(n)}))),s(this,F).use(e.selectionDidChange.subscribe(n=>s(this,se).next(Array.from(n))));const c=ie(e.geometryWillChange).pipe(Re()),l=ie(e.geometryDidChange).pipe(Re());s(this,F).use(m(c,z(n=>{w(this,S,n.has("DocumentFrameScrolled")?!0:s(this,S)),w(this,_,n.has("WindowFrameChanged")?!0:s(this,_)),w(this,y,n.has("WindowFrameChanged")?!0:s(this,y)),s(this,ne).next({reasons:n,documentFrameScrolling:s(this,S),windowFrameResizing:s(this,_),windowFrameMoving:s(this,y)})}))),s(this,F).use(m(l,z(n=>{w(this,S,n.has("DocumentFrameScrolled")?!1:s(this,S)),w(this,y,n.has("WindowFrameChanged")?!1:s(this,y)),w(this,_,n.has("WindowFrameChanged")?!1:s(this,_))}))),s(this,F).use(m($(e.hasFocus),De(),z(n=>{n?s(this,re).next(Ce()):(w(this,S,!1),w(this,y,!1),w(this,_,!1),s(this,W).next({...s(this,W).getValue(),windowFrameMoving:s(this,y),windowFrameResizing:s(this,_),documentFrameScrolling:s(this,S)})),s(this,L).next(n)})));const o=m(c,Tt(()=>{const n=s(this,y)||s(this,_)?2e3:1e3;return m(l,be(1),$t({first:n,with:()=>Ct(null)}),et(p=>p===null),Ae(()=>{}))}));let r=pe;const u=new me;let h=0;s(this,F).use(m(Et($(e.hasFocus),l,o,u),Ae(()=>{r=bt(r+1)}),_t(async(n,p)=>{var g=[];try{const E=fe(g,i.duration("get_geometry",{labels:{request_kind:p===0?"initial":"other"},sampler:s(this,N)}),!0);return await m(e.getGeometry(),Z(j(Y=>E.close(Y))))}catch(E){var Q=E,v=!0}finally{var O=ge(g,Q,v);O&&await O}}),z(tt({success:n=>{h=0,s(this,W).next({geometry:{...n,revision:r},windowFrameMoving:s(this,y),windowFrameResizing:s(this,_),documentFrameScrolling:s(this,S)})},failure:n=>{s(this,k).error("Unexpected error when fetching document geometry",n),s(this,L).getValue()&&h<3?(h++,u.next()):s(this,B).count("get_geometry_aborted")}}))))}setText(e){return s(this,R).setText(e)}setSelection(e){return s(this,R).setSelection(s(this,x).getValue().revision,e)}async getRects(e){var i,a=[];try{const r=s(this,W).getValue().geometry;r||s(this,k).warn("Calling TextDocument.getRects() with no geometry revision yet",{delivery:!1});const u=s(this,x).getValue().revision,h=(i=r==null?void 0:r.revision)!=null?i:pe,n=fe(a,s(this,B).duration("get_rects",{labels:{request_kind:s(this,U).getRects===0?"initial":"other",bucket_size:Oe(this,ae,ke).call(this,e.size)},sampler:s(this,N)}),!0);return s(this,U).getRects++,await m(s(this,R).getRectsForRanges(u,e),te(({rects:p,textRevision:g})=>({rects:p,revision:{text:g,geometry:h}})),Z(j(p=>{n.close(p),s(this,k).error("Unexpected error when calling RemoteDocument.getRectsForRanges()",p)})))}catch(r){var c=r,l=!0}finally{var o=ge(a,c,l);o&&await o}}async getBoundingRects(e){var i,a=[];try{const r=s(this,W).getValue().geometry;r||s(this,k).warn("Calling TextDocument.getBoundingRects() with no geometry revision yet",{delivery:!1});const u=(i=r==null?void 0:r.revision)!=null?i:pe,h=fe(a,s(this,B).duration("get_bounding_rects",{labels:{request_kind:s(this,U).getBoundingRects===0?"initial":"other",bucket_size:Oe(this,ae,ke).call(this,e.size)},sampler:s(this,N)}),!0);return s(this,U).getBoundingRects++,await m(s(this,R).getBoundingRectForRanges(s(this,x).getValue().revision,e),te(({rects:n,textRevision:p})=>({rects:n,revision:{text:p,geometry:u}})),Z(j(n=>{h.close(n),s(this,k).error("Unexpected error when calling RemoteDocument.getBoundingRectForRanges()",n)})))}catch(r){var c=r,l=!0}finally{var o=ge(a,c,l);o&&await o}}[Symbol.dispose](){s(this,F).dispose()}}k=new WeakMap;F=new WeakMap;x=new WeakMap;se=new WeakMap;N=new WeakMap;re=new WeakMap;y=new WeakMap;_=new WeakMap;S=new WeakMap;W=new WeakMap;ne=new WeakMap;L=new WeakMap;q=new WeakMap;B=new WeakMap;U=new WeakMap;R=new WeakMap;ae=new WeakSet;ke=function(t){return Math.ceil(t/10).toString()};var Bt=Object.defineProperty,Ue=t=>{throw TypeError(t)},Ut=(t,e,i)=>e in t?Bt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,ee=(t,e,i)=>Ut(t,typeof e!="symbol"?e+"":e,i),Gt=(t,e,i)=>e.has(t)||Ue("Cannot "+i),ve=(t,e,i)=>(Gt(t,e,"read from private field"),i?i.call(t):e.get(t)),Nt=(t,e,i)=>e.has(t)?Ue("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),H;class Lt{constructor(e,i){Nt(this,H,new AsyncDisposableStack),ee(this,"startedAt",performance.now()),ee(this,"remoteDocument"),ee(this,"document"),ee(this,"documentId"),this.remoteDocument=e,this.documentId=e.id,this.document=ve(this,H).use(new zt(e,i))}use(e){return ve(this,H).use(e)}async[Symbol.asyncDispose](){await ve(this,H).disposeAsync()}}H=new WeakMap;var qt=Object.defineProperty,Pe=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),le=t=>{throw TypeError(t)},Ht=(t,e,i)=>e in t?qt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,Jt=(t,e,i)=>Ht(t,e+"",i),Se=(t,e,i)=>e.has(t)||le("Cannot "+i),d=(t,e,i)=>(Se(t,e,"read from private field"),i?i.call(t):e.get(t)),C=(t,e,i)=>e.has(t)?le("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),Ve=(t,e,i,a)=>(Se(t,e,"write to private field"),e.set(t,i),i),T=(t,e,i)=>(Se(t,e,"access private method"),i),Ie=(t,e,i)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&le("Object expected");var a;i&&(a=e[Pe("asyncDispose")]),a===void 0&&(a=e[Pe("dispose")]),typeof a!="function"&&le("Object not disposable"),t.push([i,a,e])}else i&&t.push([i]);return e},Kt=(t,e,i)=>{var a=typeof SuppressedError=="function"?SuppressedError:function(o,r,u,h){return h=Error(u),h.name="SuppressedError",h.error=o,h.suppressed=r,h},c=o=>e=i?new a(o,e,"An error was suppressed during disposal"):(i=!0,o),l=o=>{for(;o=t.pop();)try{var r=o[1]&&o[1].call(o[2]);if(o[0])return Promise.resolve(r).then(l,u=>(c(u),l()))}catch(u){c(u)}if(i)throw e};return l()},G,b,ue,K,J,X,D,Fe,he,Ge,Te,Ne;const Xt=100;class oe{constructor(e,i,a){C(this,D),C(this,G,new AsyncDisposableStack),C(this,b,[]),C(this,ue),C(this,K),C(this,J,new V(null)),C(this,X,Be.createLogger("DocumentSessionManager")),Jt(this,"activeDocumentId",I(d(this,J))),Ve(this,ue,e),Ve(this,K,a),d(this,G).use(i.documentDidCreate.subscribe(c=>{d(this,G).use(m($(c.hasFocus),De(),z(l=>{l?(d(this,J).next(c.id),T(this,D,Ge).call(this,c)||T(this,D,Ne).call(this,c)):d(this,J).next(null)})))})),d(this,G).use(i.documentWillDestroy.subscribe(c=>{const l=T(this,D,Te).call(this,c);l&&T(this,D,he).call(this,l,"document will destroy")}))}async[Symbol.asyncDispose](){return d(this,G).disposeAsync()}}G=new WeakMap;b=new WeakMap;ue=new WeakMap;K=new WeakMap;J=new WeakMap;X=new WeakMap;D=new WeakSet;Fe=function(t){const e=d(this,b).indexOf(t);if(e===-1?d(this,b).push(t):(d(this,b).splice(e,1),d(this,b).push(t)),d(this,b).length>Xt){const i=d(this,b).shift();i!==void 0&&T(this,D,he).call(this,i,"session list is overflown")}};he=function(t,e){const i=d(this,b).indexOf(t);i!==-1&&(d(this,b).splice(i,1),d(this,X).verbose({context:t.remoteDocument.id},"Disposing session for document because ".concat(e,"."))),it(t)};Ge=function(t){const e=T(this,D,Te).call(this,t);return e&&T(this,D,Fe).call(this,e),e};Te=function(t){var e;return(e=d(this,b).find(i=>i.remoteDocument.id===t.id))!=null?e:null};Ne=async function(t){var e=[];try{const l=Ie(e,d(this,K).duration("create_session")),o=Ie(e,new AsyncDisposableStack,!0),r=new Lt(t,d(this,K));r.use(t),d(this,X).verbose({context:r.remoteDocument.id},"Create a session for document."),T(this,D,Fe).call(this,r),o.defer(()=>T(this,D,he).call(this,r,"session is disposed")),await m(d(this,ue).createExecutionScopeController("document-session",{id:st?t.id:void 0,data:{documentId:t.id}}),ye.use(o),Me(u=>m(_e.all([u.register({token:vt,useValue:r.document}),u.register({token:wt,useValue:r.document}),u.register({token:yt,useValue:r}),u.realm.registerEntity({token:lt,useFactory:h=>P(A($(r.document.hasFocus)),h)}),u.realm.registerEntity({token:ut,useFactory:h=>P(A($(r.document.lastFocusAt)),h)}),u.realm.registerEntity({token:ht,useFactory:h=>P(A($(r.document.geometry)),h)}),u.realm.registerEntity({token:dt,useFactory:h=>P(m(ie(r.document.textChange),ze(n=>({revision:n.revision,change:n.change.toJSON()})),A),h)}),u.realm.registerEntity({token:mt,useFactory:h=>P(A($(r.document.selection)),h)}),u.realm.registerEntity({token:pt,useFactory:h=>P(r.document.geometryWillChange,h)})]),ye.use(o),te(()=>u))),Me(u=>u.start()),rt({success:()=>{r.use(o.move())},failure:u=>{l.close(u),d(this,X).error("Failed to create a session due to:",u,{context:r.remoteDocument.id})}}))}catch(l){var i=l,a=!0}finally{var c=Kt(e,i,a);c&&await c}};const Le=ct(),yi=t=>_e.all([m(at([t.getPlugin("connector"),t.getPlugin("monitoring"),t.getPlugin("document-group"),we(t.getExecutionScopeDefinition("document-group"))]),nt(([e,i,a,c])=>_e.all([...Qt(c,a,e,i),we(c.onStart(async l=>ye.all([l.resolve(oe),l.realm.registerEntity({token:ft,useToken:Le})])))])))]);function Qt(t,e,i,a){return[t.register({token:Le,useFactory:c=>m(c.resolve(Ee),ot(l=>o=>gt(l.activeDocumentId,o)))},{lifetime:We.Singleton}),t.register({token:Ee,useToken:oe}),t.register({token:oe,useFactory:Rt(oe,[e.provides.DocumentGroupScope,i.provides.ConnectorDocumentManager,a.provides.Monitoring])},{lifetime:We.Singleton})]}export{yi as activate};
//# sourceMappingURL=index-CCK1mSVR.js.map
