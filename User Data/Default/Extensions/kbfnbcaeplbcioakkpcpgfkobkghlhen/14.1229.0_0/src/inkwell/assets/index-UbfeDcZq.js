import{c as L,l as j,N as q,G as S,O as ee,A as $,u as re,s as W,P as te,p as k,R as x,i as z,Q as G,e as D,L as J,x as oe,a as ne,T as se,C as U,m as ie}from"./start-C5OgI2kj.js";import{DocumentGroupToken as ae,WindowFactoryToken as ce,ConnectEventSourceToken as pe,DocumentGroupScopeToken as ue}from"./index-IEURydWV.js";import{L as de}from"./LRUCache-BkqKFOuj-CuqiGFzI.js";import{d as le}from"./defineFactory-DJYNRBNc-BjUmrCbc.js";import"./PluginModule-CRib3PLZ-rw_nkrD1.js";import"./PluginDependency-Boc6-pxl-tjuTwLTj.js";var fe=Object.defineProperty,V=r=>{throw TypeError(r)},ge=(r,e,t)=>e in r?fe(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,he=(r,e,t)=>ge(r,e+"",t),B=(r,e,t)=>e.has(r)||V("Cannot "+t),v=(r,e,t)=>(B(r,e,"read from private field"),t?t.call(r):e.get(r)),O=(r,e,t)=>e.has(r)?V("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(r):e.set(r,t),we=(r,e,t,o)=>(B(r,e,"write to private field"),e.set(r,t),t),m,_;class ve{constructor(e,t){O(this,m,new AsyncDisposableStack),O(this,_),he(this,"id"),this.id=e,we(this,_,t)}createWindow(e){return v(this,_).createWindow(e)}documentGroupDisposedByHost(){v(this,_).close()}get disposed(){return v(this,m).disposed}use(e){return v(this,m).use(e)}async[Symbol.asyncDispose](){await v(this,m).disposeAsync()}}m=new WeakMap;_=new WeakMap;var F=(r,e)=>(e=Symbol[r])?e:Symbol.for("Symbol."+r),C=r=>{throw TypeError(r)},A=(r,e,t)=>e.has(r)||C("Cannot "+t),c=(r,e,t)=>(A(r,e,"read from private field"),t?t.call(r):e.get(r)),g=(r,e,t)=>e.has(r)?C("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(r):e.set(r,t),T=(r,e,t,o)=>(A(r,e,"write to private field"),e.set(r,t),t),H=(r,e,t)=>(A(r,e,"access private method"),t),N=(r,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&C("Object expected");var o;t&&(o=e[F("asyncDispose")]),o===void 0&&(o=e[F("dispose")]),typeof o!="function"&&C("Object not disposable"),r.push([t,o,e])}else t&&r.push([t]);return e},me=(r,e,t)=>{var o=typeof SuppressedError=="function"?SuppressedError:function(n,a,p,u){return u=Error(p),u.name="SuppressedError",u.error=n,u.suppressed=a,u},s=n=>e=t?new o(n,e,"An error was suppressed during disposal"):(t=!0,n),i=n=>{for(;n=r.pop();)try{var a=n[1]&&n[1].call(n[2]);if(n[0])return Promise.resolve(a).then(i,p=>(s(p),i()))}catch(p){s(p)}if(t)throw e};return i()},h,E,b,y,w,d,I,Q,K;const X=L(),Y=L();class P{constructor(e,t,o,s){g(this,I),g(this,h,new AsyncDisposableStack),g(this,E),g(this,b),g(this,y),g(this,w,c(this,h).use(new de({capacity:10}))),g(this,d,j.createLogger("DocumentGroupManager")),T(this,E,e),T(this,b,o),T(this,y,s),c(this,h).use(t.subscribe(i=>H(this,I,Q).call(this,i)))}async[Symbol.asyncDispose](){await c(this,h).disposeAsync()}}h=new WeakMap;E=new WeakMap;b=new WeakMap;y=new WeakMap;w=new WeakMap;d=new WeakMap;I=new WeakSet;Q=function(r){const e=Promise.withResolvers(),t=c(this,h).use(r({connect:o=>{c(this,y).connect({groupId:o.groupId,windowId:o.windowId,injectedAs:o.injectedAs,api:q(e.promise)});const s=o.groupId,i=c(this,w).get(s),n=c(this,y).getWindowGroup(o.groupId);if(!n)return S(new Error("WindowGroup not found"));if(i){if(o.connectorPort){const a=new _e(s);return c(this,d).error(a.message,a),S(a)}}else{if(!o.connectorPort){const f=new ye(s);return c(this,d).error(f.message,f),S(f)}const a=c(this,E).createExecutionScopeController("document-group",{id:void 0,data:{groupId:s}});if(ee(a))return S(a.error);const p=a.value,u=c(this,h).use(new ve(s,n)),l=c(this,w).set(s,u);if(l){const[f,M]=l;M[Symbol.asyncDispose]().catch(Z=>c(this,d).error("Unexpected error disposing DocumentGroup ".concat(f),Z))}H(this,I,K).call(this,p,{...o,connectorPort:o.connectorPort},u)}return $()},disposeConnector:o=>{const s=o.groupId,i=c(this,w).get(s);return i?(c(this,d).verbose("Disposing document group ".concat(i.id,".")),c(this,w).delete(s),i.documentGroupDisposedByHost(),re(()=>i[Symbol.asyncDispose]())):$()}}));e.resolve(W(t.createClient()))};K=async function(r,e,t){var o=[];try{const a=N(o,c(this,b).duration("create_document_group")),p=N(o,new AsyncDisposableStack,!0);c(this,d).verbose("Creating document group ".concat(t.id,"."));const u=te(e.connectorPort);return await k(x.all([r.register({token:ae,useValue:t}),r.register({token:X,useValue:u}),r.register({token:Y,useValue:{}}),r.register({token:ce,useFactory:l=>k(z([l.resolve(G)]),D(([f])=>W({createWindow:M=>t.createWindow({...M,executionScopeData:f.serialize()})})))},{lifetime:J.ContainerScoped})]),oe.use(p),ne(()=>r.start()),se({success:()=>{t.disposed||t.use(p.move())},failure:l=>{a.close(l),c(this,d).error("Failed to create a document group:",l,{context:t.id})}}))}catch(a){var s=a,i=!0}finally{var n=me(o,s,i);n&&await n}};class _e extends U{constructor(e){super("Unexpected connectorPort for existing document group"),this.groupId=e}toJSON(){return{...super.toJSON(),groupId:this.groupId}}}class ye extends U{constructor(e){super("Expected a connectorPort to be provided for new document group"),this.groupId=e}toJSON(){return{...super.toJSON(),groupId:this.groupId}}}var Se=(r,e)=>(e=Symbol[r])?e:Symbol.for("Symbol."+r),R=r=>{throw TypeError(r)},ke=(r,e,t)=>{if(e!=null){typeof e!="object"&&typeof e!="function"&&R("Object expected");var o;o===void 0&&(o=e[Se("dispose")]),typeof o!="function"&&R("Object not disposable"),r.push([t,o,e])}return e},De=(r,e,t)=>{var o=typeof SuppressedError=="function"?SuppressedError:function(n,a,p,u){return u=Error(p),u.name="SuppressedError",u.error=n,u.suppressed=a,u},s=n=>e=t?new o(n,e,"An error was suppressed during disposal"):(t=!0,n),i=n=>{for(;n=r.pop();)try{var a=n[1]&&n[1].call(n[2]);if(n[0])return Promise.resolve(a).then(i,p=>(s(p),i()))}catch(p){s(p)}if(t)throw e};return i()};const We=r=>{const e=r.getExecutionScopeDefinition("global"),t=r.getExecutionScopeDefinition("document-group");return k(z([r.getPlugin("monitoring"),r.getPlugin("connector"),r.getPlugin("window-management")]),D(([o,s,i])=>x.all([...Ee(e,t,o,s,i),W(Ce(e,s))])))};function Ce(r,e){return r.onStart(async t=>{var o=[];try{const n=ke(o,new DisposableStack);return k(t.resolve(e.provides.Connector),D(a=>a.initialize("document-group")),x.use(n),D(()=>t.resolve(P)),ie(()=>n.move()))}catch(n){var s=n,i=!0}finally{De(o,s,i)}})}function Ee(r,e,t,o,s){return[r.register({token:P,useFactory:le(P,[G,pe,t.provides.Monitoring,s.provides.WindowManager])},{lifetime:J.Singleton}),e.register({token:ue,useToken:G}),e.register({token:o.consumes.ConnectorConfiguration,useToken:Y}),e.register({token:o.consumes.ConnectorMessageTransport,useToken:X})]}export{We as activate};
//# sourceMappingURL=index-UbfeDcZq.js.map
