(self.webpackChunk=self.webpackChunk||[]).push([[1824],{35878:(e,t,i)=>{i.r(t),i.d(t,{TouchTypistFeatureImpl:()=>Rt,trackTooltipAppearingAndSkipping:()=>It});var r=i(90023),n=i(32073),s=i(59179),a=i(10883),o=i(90572),c=i(29479),l=i(78129),p=i(58303),u=i(72106),h=i(49231),d=i(56424),g=i(64271),m=i(44071),_=i(24666),v=i(20161),y=i(84714),T=i(53976),f=i(32080),k=i(21428),S=i(99529),E=i(47387),x=i(26278),b=i(92524),C=i(44247);const w=({children:e,className:t,coords:i,tooltipWrapperRef:r,tooltipWrapperHandlers:n})=>h.createElement(f.k,{className:t,style:i,ref:r,"data-testid":"hotkeyWrapper",...n},h.createElement(f.k,{className:C.logoWrapper},h.createElement(x.J,{className:C.logoIcon,icon:b.p,accessibilityLabel:"Grammarly logo",size:"small"})),h.createElement(f.k,{className:C.contentWrapper},e));var R,I=i(24335),P=i(57935),A=i(96176);!function(e){e.Initial="Initial",e.Transitional="Transitional",e.Off="Off"}(R||(R={})),function(e){function t(t){switch(t){case 0:return e.Initial;case 1:case 2:return e.Transitional;default:return e.Off}}e.get=t,e.getV2=function(i,r){const n=t(i);if(n===e.Off&&(0,A.ix)(r)){const t=new Date,i=new Date(r);return(0,A.wt)(i)(t)>=P.an(3)?e.Initial:e.Off}return n}}(R||(R={}));const L=({softOnboardingState:e=R.Off})=>{const[t,i]=h.useState(!1),r=e===R.Initial||e===R.Transitional&&!t;return h.useEffect((()=>{e===R.Transitional&&I.HT(P.m9(4)).subscribe((()=>i(!0)))}),[]),r},N=({caretPosition:e,softOnboardingState:t=R.Off,expandedConstantly:i=!1})=>{const[r,n]=h.useState(!1),[s,a]=h.useState(!1),{isLeftAligned:o,coords:c}=(({caretPosition:e})=>{var t;const{bottom:i,right:r}=e,n=i+2,s=r,a=((null===(t=self.visualViewport)||void 0===t?void 0:t.width)||self.innerWidth)-r,o=a>200;return{isLeftAligned:o,coords:o?{top:n,left:s}:{top:n,right:a}}})({caretPosition:e}),l=L({softOnboardingState:t}),p=i||l||r||s,u=h.useRef(null),d=h.useRef(null),g=h.useRef(null);return h.useEffect((()=>{((e,t,i,r)=>{const n=t.current,s=i.current,a=r.current;null==n||n.classList.toggle("tooltipWrapperExpanded",e),s&&(s.style.width=e?"0px":`${s.scrollWidth}px`),a&&(e?(a.style.removeProperty("justify-content"),a.style.width=`${a.scrollWidth}px`,a.style.justifyContent="flex-end"):a.style.width="0px")})(p,u,g,d)}),[p]),{isTooltipHovered:r,isQuickSettingsMenuOpen:s,isOnboardingActive:l,isLeftAligned:o,coords:c,errorsLabel:e=>e&&h.createElement(E.F.Fragment,null,e.view((e=>`${e} error${1===e?"":"s"}`))),setIsQuickSettingsMenuOpen:a,setIsTooltipHovered:n,tooltipWrapperRef:u,expandedContentRef:d,minimizedContentRef:g}};var O=i(17142),M=i(22389),D=i(88640),F=i(87118),H=i(36949);const Q=(0,H.I)("color",(({title:e,titleId:t,desc:i,descId:r,...n})=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",viewBox:"0 0 16 16","aria-hidden":"true","data-icon":"InterfaceSnooze",stroke:"transparent","aria-labelledby":t,"aria-describedby":r,...n},i?h.createElement("desc",{id:r},i):null,e?h.createElement("title",{id:t},e):null,h.createElement("path",{stroke:"#646B81",strokeLinecap:"round",d:"M8 4v4h3.2M8 14A6 6 0 1 0 8 2a6 6 0 0 0 0 12Z"})))),B=(0,H.I)("color",(({title:e,titleId:t,desc:i,descId:r,...n})=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",viewBox:"0 0 16 16","aria-hidden":"true","data-icon":"InterfaceLogout",stroke:"transparent","aria-labelledby":t,"aria-describedby":r,...n},i?h.createElement("desc",{id:r},i):null,e?h.createElement("title",{id:t},e):null,h.createElement("path",{stroke:"#646B81",strokeLinecap:"round",d:"M8 2v6.316m2.139-5.239c1.975.863 3.361 2.884 3.361 5.239C13.5 11.456 11.038 14 8 14s-5.5-2.545-5.5-5.684c0-2.355 1.386-4.376 3.361-5.239"}))));var U=i(37213),G=i(4603),q=i(81259);function W(){return"red"===(0,G.OB)().experimentClient.getTreatment(q.p.TouchTypistProminentTooltip)}var Y=i(48667),z=i(95660);const V=({keyName:e})=>h.createElement(k.x,{className:z.keyIcon,as:"span",variant:"text-xsmall",color:"base-subdued"},e),K=({className:e,quickFixKey:t,quickSettingsIcon:i=O.D,onQuickSettingsMenuUnmount:r,onQuickSettingsButtonClick:n,onQuickSettingsShown:s,onChangeQuickFixKeyTextboxFocus:a,onChangeQuickFixKeyTextboxBlur:o,onTurnOffQuickFixClick:c,onSnoozeQuickFixClick:l})=>{const[p,u]=h.useState(!1),d=h.useRef(null);h.useEffect((()=>r),[]);const g=h.useCallback((()=>{u(!p),n(p)}),[p,n]),m=h.useCallback((e=>{e&&s()}),[s]),_=h.useCallback((e=>{e&&e.addEventListener("focus",a,!0)}),[]);return h.createElement(f.k,{className:z.quickSettingsMenuWrapper},h.createElement(M.h,{...(0,U.Sh)(e,z.quickSettingsMenuButton),size:"small",variant:"tertiary",icon:i,accessibilityLabel:"Quick Settings",onClick:g,"data-testid":"grammarly-touch-typist-hotkey-hint-quick-settings-button"}),p&&h.createElement(f.k,{ref:m,direction:"column",bgColor:"background-base-subdued",borderColor:"base-subdued",borderRadius:1,elevation:"low",className:z.quickSettingsMenu,"data-testid":"grammarly-touch-typist-hotkey-hint-quick-settings-menu"},h.createElement(f.k,{className:z.quickSettingsMenuChangeQuickFixKeySection,direction:"column",gap:2},h.createElement(k.x,{as:"p",variant:"text-xsmall",color:"base-subdued",onClick:()=>{var e;return null===(e=d.current)||void 0===e?void 0:e.focus()}},"Change quick fix key"),h.createElement(E.F.Fragment,null,t.view((e=>h.createElement(D.n,{ref:(0,Y.l)([d,_]),value:e,labelDisplay:"hidden",label:"Change quick fix key",placeholder:"Enter shortcut",onBlur:o})))),h.createElement(k.x,{as:"p",variant:"text-xsmall",color:"base-subdued"},"Try ",h.createElement(V,{keyName:"⇧"})," ",h.createElement(V,{keyName:"/"})," or ",h.createElement(V,{keyName:"->"}))),("snooze"===(0,G.OB)().experimentClient.getTreatment(q.p.TouchTypistProminentTooltip)||W())&&h.createElement(f.k,{className:z.quickSettingsMenuRow},h.createElement(F.z,{className:z.quickSettingsMenuActionButton,variant:"tertiary",iconStart:Q,width:"full",text:"Snooze for 1 hour",onClick:l})),h.createElement(f.k,{className:z.quickSettingsMenuRow},h.createElement(F.z,{className:z.quickSettingsMenuActionButton,variant:"tertiary",iconStart:B,width:"full",text:"Turn off quick fix",onClick:c}))))},$=({caretPosition:e,softOnboardingState:t=R.Initial,errorsCount:i,quickFixKey:r,label:n,onQuickSettingsMenuUnmount:s,onQuickSettingsButtonClick:a,onQuickSettingsShown:o,onChangeQuickFixKeyTextboxFocus:c,onChangeQuickFixKeyTextboxBlur:l,onTurnOffQuickFixClick:p,onSnoozeQuickFixClick:u})=>{const{isQuickSettingsMenuOpen:d,isLeftAligned:g,coords:m,errorsLabel:_,setIsQuickSettingsMenuOpen:v,setIsTooltipHovered:y,tooltipWrapperRef:T,expandedContentRef:x,minimizedContentRef:b}=N({caretPosition:e,softOnboardingState:t}),I=g?C.prominentHotkeyLeft:C.prominentHotkeyRight,P=[C.prominentHotkeyWrapperRed,I].join(" ");return h.createElement(w,{className:P,coords:m,tooltipWrapperRef:T,tooltipWrapperHandlers:{onMouseEnter:()=>y(!0),onMouseLeave:()=>y(!1)}},h.createElement(f.k,{className:C.expandedContent,ref:x,gap:1,"data-testid":"expandedContent"},h.createElement(f.k,{className:C.hintTextWrapper,gap:1},h.createElement(k.x,{className:C.hintText,as:"span",variant:"text-xsmall"},g?h.createElement(h.Fragment,null,"To fix ",_(i),": Press"):h.createElement(h.Fragment,null,"Press")),h.createElement(f.k,{className:C.hintTagWrapper},h.createElement(k.x,{className:C.hintTagExpanded,as:"span",variant:"text-xsmall"},h.createElement(E.F.Fragment,null,n))),!g&&h.createElement(k.x,{className:C.hintText,as:"span",variant:"text-xsmall"},"to fix ",_(i))),h.createElement(f.k,{className:C.quickSettings},h.createElement(K,{className:C.quickSettingsButton,quickFixKey:r,quickSettingsIcon:S.a,onQuickSettingsMenuUnmount:()=>{x.current&&(x.current.style.overflow="hidden"),v(!1),s()},onQuickSettingsButtonClick:e=>{x.current&&(x.current.style.overflow=d?"hidden":"visible"),v(!d),a(e)},onQuickSettingsShown:o,onChangeQuickFixKeyTextboxFocus:c,onChangeQuickFixKeyTextboxBlur:l,onTurnOffQuickFixClick:p,onSnoozeQuickFixClick:u}))),h.createElement(f.k,{className:C.minimizedContent,ref:b,"data-testid":"minimizedContent"},h.createElement(k.x,{className:C.hintTagMinimized,as:"span",variant:"text-xsmall"},h.createElement(E.F.Fragment,null,n))))},X=({caretPosition:e,numberOfFixes:t,softOnboardingState:i=R.Initial})=>{const{isLeftAligned:r,coords:n,errorsLabel:s,tooltipWrapperRef:a,expandedContentRef:o}=N({caretPosition:e,softOnboardingState:i,expandedConstantly:!0}),[c,l]=h.useState(!1),p=r?C.prominentHotkeyLeft:C.prominentHotkeyRight,u=[C.prominentHotkeyWrapperGreen,p].join(" ");return h.useEffect((()=>{I.HT(P.m9(4)).subscribe((()=>l(!0)))}),[]),c?null:h.createElement(w,{className:u,coords:n,tooltipWrapperRef:a},h.createElement(f.k,{className:C.expandedContent,ref:o,gap:1,"data-testid":"expandedContent"},h.createElement(k.x,{className:C.hintText,as:"span",variant:"text-xsmall"},s(t)," fixed!")))};var j=i(23729);const Z=()=>h.createElement(f.k,{className:j.bubbleContainer},h.createElement("svg",{width:"14",height:"14",viewBox:"0 0 14 14",fill:"none",xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink",className:j.bubble},h.createElement("path",{d:"M0 7.00023C0 3.13372 3.13344 0 7.00035 0C10.8673 0 14 3.13372 14 7.00023C14 10.3829 11.6017 13.2049 8.41204 13.8581C7.95631 13.9515 7.48418 14 7.00246 14H0V7.00023Z",fill:"#027E6F"}),h.createElement("path",{d:"M3.92422 7.57649L5.8528 9.50507L10.3528 5.00507",stroke:"white",strokeWidth:"1.25",className:j.checkmark})));var J=i(42743);const ee=({label:e})=>h.createElement(f.k,{className:J.hotkeyHintTagContainer,bgColor:"background-base-default",borderColor:"base-default",borderRadius:1},h.createElement(k.x,{className:J.hotkeyHintTagLabel,as:"small",variant:"text-xsmall",weight:"semibold",color:"base-subdued"},h.createElement(E.F.div,null,e))),te=({show:e,children:t})=>{const[i,r]=h.useState(!1),[n,s]=h.useState(!1),a=(()=>{const e=h.useRef(!0);return h.useEffect((()=>{e.current=!1}),[]),e.current})();h.useEffect((()=>{if(a&&!e)return;let t;r(!0),e||(t=self.setTimeout((()=>r(!1)),300)),s(!e);const i=self.setTimeout((()=>s(e)),50);return()=>[t,i].forEach(clearTimeout)}),[e]);const o={opacity:n?1:0,transition:"opacity 250ms"};return i&&t?h.createElement("div",{style:o,"data-testid":"grammarly-touchtypist-fade-wrapper"},t):null},ie=({label:e,errorsCount:t,softOnboardingState:i=R.Off,caretPosition:r,quickFixKey:n,onQuickSettingsMenuUnmount:s,onQuickSettingsButtonClick:a,onQuickSettingsShown:o,onChangeQuickFixKeyTextboxFocus:c,onChangeQuickFixKeyTextboxBlur:l,onTurnOffQuickFixClick:p,onSnoozeQuickFixClick:u})=>{const d=h.useRef(null),[g,m]=h.useState(0),[_,v]=h.useState(!1),y=L({softOnboardingState:i});h.useEffect((()=>{const e=new ResizeObserver((e=>{for(const t of e)t.target===d.current&&m(t.contentRect.width)}));return d.current&&e.observe(d.current),()=>{e.disconnect()}}),[]);const T=h.createElement(f.k,{ref:d,className:z.hotkeyHintTagWrapper,onMouseEnter:()=>v(!0),onMouseLeave:()=>v(!1),"data-testid":"grammarly-touch-typist-hotkey-hint"},h.createElement(ee,{label:e})),S=h.createElement(f.k,{className:z.hotkeyHintTagPlaceholder,style:{width:g}}),C=h.createElement(E.F.Fragment,null,t.view((e=>`${e} error${1===e?"":"s"}`))),w=h.createElement(f.k,{className:z.expandedHotkeyHint,bgColor:"background-base-subdued",borderRadius:2,align:"center",onMouseEnter:()=>v(!0),onMouseLeave:()=>v(!1),"data-testid":"grammarly-touch-typist-expanded-hotkey-hint"},h.createElement(x.J,{className:z.grammarlyLogo,size:"small",icon:b.p,accessibilityLabel:"Grammarly logo"}),h.createElement(k.x,{className:z.expandedHotkeyHintText,as:"p",variant:"text-xsmall",color:"base-subdued"},"To fix ",C,", press"),S,h.createElement(K,{className:z.quickSettingsButton,quickFixKey:n,onQuickSettingsMenuUnmount:s,onQuickSettingsButtonClick:a,onQuickSettingsShown:o,onChangeQuickFixKeyTextboxFocus:c,onChangeQuickFixKeyTextboxBlur:l,onTurnOffQuickFixClick:p,onSnoozeQuickFixClick:u})),I=h.createElement(f.k,{...(0,U.Sh)(z.expandedHotkeyHint,z.leftAligned),bgColor:"background-base-subdued",borderRadius:2,align:"center",onMouseEnter:()=>v(!0),onMouseLeave:()=>v(!1),"data-testid":"grammarly-touch-typist-expanded-hotkey-hint"},h.createElement(x.J,{className:z.grammarlyLogo,size:"small",icon:b.p,accessibilityLabel:"Grammarly logo"}),h.createElement(k.x,{className:z.expandedHotkeyHintText,as:"p",variant:"text-xsmall",color:"base-subdued"},"Press"),S,h.createElement(k.x,{className:z.expandedHotkeyHintText,as:"p",variant:"text-xsmall",color:"base-subdued"},"to fix ",C),h.createElement(K,{className:z.quickSettingsButton,quickFixKey:n,onQuickSettingsMenuUnmount:s,onQuickSettingsButtonClick:a,onQuickSettingsShown:o,onChangeQuickFixKeyTextboxFocus:c,onChangeQuickFixKeyTextboxBlur:l,onTurnOffQuickFixClick:p,onSnoozeQuickFixClick:u})),{bottom:P,right:A}=r,N=P+6,O=A-g/2,M=O<160?I:w;return h.createElement(f.k,{className:z.hotkeyHintWrapper,style:{top:N,left:O}},T,h.createElement(te,{show:y||_},M))};var re=i(82675);const ne=()=>h.createElement(f.k,{className:re.dotsContainer,"data-testid":"loading-dots"},h.createElement("div",{className:re.dot}),h.createElement("div",{className:re.dot}),h.createElement("div",{className:re.dot}));var se,ae,oe,ce=i(3492),le=i(13712),pe=i(36344),ue=i(63532),he=i(17613),de=i(13391),ge=i(93018);!function(e){function t(e,t){const i=e.ops;if(0===t||0===i.length)return e;const r=i[0];return ge.s.isRetain(r)?{...e,ops:[{retain:t+r.retain},...i.slice(1)]}:{...e,ops:[{retain:t},...i]}}e.offsetDelta=t,e.rebaseByAppliedPreview=function(e){const i=function(e){const t=e.end-e.begin;return e.replacement.length-t}(e);return 0===i?r.yR:r=>r.begin>=e.end?{...r,delta:t(r.delta,i),previewDelta:t(r.previewDelta,i)}:r},e.normalize=function(e){return i=>({...i,begin:e+i.begin,end:e+i.end,delta:t(i.delta,e),previewDelta:t(i.previewDelta,e),highlight:{s:e+i.highlight.s,e:e+i.highlight.e},reverseDelta:t(i.reverseDelta,e)})}}(se||(se={})),function(e){e.normalize=function(e){return t=>({...t,highlightBegin:e+t.highlightBegin,highlightEnd:e+t.highlightEnd})},e.findCorrespondingPreview=function(e){return(0,r.ls)((t=>e.find((e=>e.revertId===t.revertId))),p.ij)}}(ae||(ae={})),function(e){e.rebase=function(e){const t=e.end-e.begin,i=e.replacement.length-t;return 0===i?r.yR:t=>t.correspondingPreview.begin>=e.end?{...t,highlightBegin:t.highlightBegin-i,highlightEnd:t.highlightEnd-i}:t}}(oe||(oe={}));var me,_e=i(90805),ve=i(38508),ye=i(70932),Te=i(32066),fe=i(28710);!function(e){e.IDLE="idle",e.LOADING="loading",e.REPLACING="replacing",e.READY="ready",e.SUCCESS="success"}(me||(me={}));const ke={current:{previews:[],reverts:[],replacementInfo:p.YP},applied:{reverts:[]}},Se={state:me.IDLE,context:ke};class Ee{constructor(e={state:Se,touchTypistTelemetryService:Te.w}){this._params=e,this._subs=new n.w0,this._state=de.h.create(this._params.state),this._newParagraphsSinceRevert=new WeakMap,this._logger=ye.Y.create("TouchTypistStateManagerImpl"),this.state=this._state.view(),this._interrupted=e=>{const{state:t,context:i}=e;return t!==me.IDLE?{state:me.IDLE,context:{current:{previews:[],reverts:[],replacementInfo:p.YP},applied:{reverts:i.applied.reverts}}}:e},this._loading=e=>{const{state:t,context:i}=e;return t===me.IDLE?{state:me.LOADING,context:{current:{previews:[],reverts:[],replacementInfo:p.YP},applied:{reverts:i.applied.reverts}}}:e},this._responseReceived=({response:e,currentText:t})=>i=>{var r;const{state:n,context:s}=i;if(n===me.LOADING){if(!(null===(r=e.previews)||void 0===r?void 0:r.length))return this._interrupted(i);const n=se.normalize(e.textScope.begin),a=e.previews.map((i=>{const r=n(i);return{...r,touchTypistId:e.touchTypistId,original:t.slice(r.begin,r.end),highlight:{...r.highlight,text:t.slice(r.highlight.s,r.highlight.e)},relativeReverseDelta:i.reverseDelta}})),o=ae.findCorrespondingPreview(a),c=ae.normalize(e.textScope.begin),l=e.reverts.reduce(((t,i)=>{const r=o(i);return p.pC(r)&&t.push({...c(i),touchTypistId:e.touchTypistId,highlightText:e.text.slice(i.highlightBegin,i.highlightEnd),isRecent:!0,correspondingPreview:r.value}),t}),[]),u={current:{...s.current,previews:a,reverts:l,replacementInfo:p.G({replacementText:e.text,replacementTextRange:{start:e.textScope.begin,end:e.textScope.end},delta:(0,_e.RZ)(se.offsetDelta(e.delta,e.textScope.begin))})},applied:{reverts:s.applied.reverts}};return{state:me.READY,context:u}}return i},this._responseApplied=e=>{const{state:t,context:i}=e;return t===me.READY&&p.pC(i.current.replacementInfo)?{state:me.SUCCESS,context:{...ke,applied:{reverts:[...i.applied.reverts,...i.current.reverts]}}}:e},this._previewApplied=e=>t=>{const i=t.context.current.previews.find((t=>t.id===e));if(!i){const i=`Received a "${fe._.SINGLE_PREVIEW_APPLIED}" event, but the corresponding preview is missing from the state.`;return this._logger.warn(i,{previewIdInPayload:e,previewsInState:t.context.current.previews}),this._params.touchTypistTelemetryService.warn({message:i,data:{previewIdInPayload:e,previewsInState:t.context.current.previews}}),t}const n=t.context.current.previews.filter((t=>t.id!==e)),s=t.context.current.reverts.filter((t=>t.correspondingPreview.id!==e)),a=se.rebaseByAppliedPreview(i),o=n.map(a),c=(0,r.zG)(t.context.current.replacementInfo,p.UI((e=>{const t=i.end-i.begin,r=i.replacement.length-t;return{...e,replacementTextRange:{...e.replacementTextRange,end:e.replacementTextRange.end+r}}})));return{state:n.length>0?me.READY:me.IDLE,context:{...t.context,current:{...t.context.current,previews:o,reverts:s,replacementInfo:c}}}},this._previewDismissed=e=>t=>{if(t.state!==me.READY)return t;const i=t.context.current.previews.find((t=>t.id===e));if(!i){const i=`Received a "${fe._.SINGLE_PREVIEW_DISMISSED}" event, but the corresponding preview is missing from the state.`;return this._logger.warn(i,{previewIdInPayload:e,previewsInState:t.context.current.previews}),this._params.touchTypistTelemetryService.warn({message:i,data:{previewIdInPayload:e,previewsInState:t.context.current.previews}}),t}const n=t.context.current.previews.filter((e=>e!==i)),s=t.context.current.reverts.find((t=>t.correspondingPreview.id===e)),a=t.context.current.reverts.filter((e=>e!==s)),o=oe.rebase(i),c=a.map(o),l=(0,r.zG)(t.context.current.replacementInfo,p.UI((e=>{const t=(0,ve.l)(new ce.i([...i.relativeReverseDelta.ops]),e.replacementText);return{...e,replacementText:t}})));return{state:0===n.length?me.IDLE:me.READY,context:{...t.context,current:{...t.context.current,previews:n,reverts:c,replacementInfo:l}}}},this._individualRevertApply=e=>t=>{const i=t=>t.filter((t=>t.revertId!==e)),r=i(t.context.applied.reverts);return{state:me.IDLE,context:{...t.context,current:{...t.context.current,reverts:i(t.context.current.reverts)},applied:{...t.context.applied,reverts:r}}}},this._userAddedOrRemovedNewlines=e=>{const t=e=>e.filter((e=>{var t;const i=(null!==(t=this._newParagraphsSinceRevert.get(e))&&void 0!==t?t:0)+1;return 2!=i&&(this._newParagraphsSinceRevert.set(e,i),!0)})),i=t(e.context.current.reverts),r=t(e.context.applied.reverts);return{...e,context:{...e.context,current:{...e.context.current,reverts:i},applied:{...e.context.applied,reverts:r}}}},this._updateReverts=e=>{const t=e.context.applied.reverts.map((e=>({...e,isRecent:!1})));return{...e,context:{...e.context,applied:{...e.context.current,reverts:t}}}},this._replacementStarted=e=>e.state!==me.READY?e:{...e,state:me.REPLACING},this._replacementFinished=e=>e.state!==me.REPLACING?e:{...e,state:me.READY},this._transition=e=>{const t=e.name;switch(t){case fe._.TEXT_SELECTION_OR_CARET_POSITION_CHANGED:case fe._.CAPI_RESPONSE_TIMED_OUT:return this._interrupted;case fe._.SENDING_CAPI_REQUEST_STARTED:return this._loading;case fe._.SENDING_CAPI_REQUEST_FAILED:return this._interrupted;case fe._.CAPI_RESPONSE_RECEIVED:return this._responseReceived(e.payload);case fe._.CAPI_RESPONSE_WITH_UNEXPECTED_CORRELATION_ID_RECEIVED:return this._interrupted;case fe._.APPLYING_ALL_PREVIEWS_SUCCEEDED:return this._responseApplied;case fe._.SINGLE_PREVIEW_APPLIED:return this._previewApplied(e.payload.previewId);case fe._.SINGLE_PREVIEW_DISMISSED:return this._previewDismissed(e.payload.previewId);case fe._.SINGLE_REVERT_APPLIED:return this._individualRevertApply(e.payload.revertId);case fe._.NEWLINES_ADDED_OR_REMOVED_BY_USER:return this._userAddedOrRemovedNewlines;case fe._.TEXT_CHANGED_BY_USER:return(0,r.ls)(this._interrupted,this._updateReverts);case fe._.TEXT_CHANGED_BY_NON_TOUCH_TYPIST_REPLACEMENT:return this._interrupted;case fe._.REPLACEMENT_STARTED:return this._replacementStarted;case fe._.REPLACEMENT_FINISHED:return this._replacementFinished;case fe._.REPLACEMENT_FAILED:return this._interrupted;default:(0,he.L0)(t)}},this.handleEvent=e=>{const t=this.state.get(),i=this._transition(e)(t);this._state.set(i),this._logger.debug("Event handled.",{event:e.name,oldState:t.state,newState:i.state})},this.getTouchTypistId=()=>{const e=this.state.get().context.current.previews;return 0===e.length?null:Number(e[0].touchTypistId)},this._subs.add(this._state.pipe(le.g("state"),v.w((e=>e.state===me.LOADING?I.HT(5e3):pe.E)),ue.b((()=>{this._logger.warn("Request timed out."),this._params.touchTypistTelemetryService.error({message:"Request timed out."}),this.handleEvent({name:fe._.CAPI_RESPONSE_TIMED_OUT})}))).subscribe()),this._logger.debug("Initialized.")}dispose(){this._subs.unsubscribe()}}const xe=({children:e,caretPosition:t})=>h.createElement("div",{style:{position:"fixed",top:d.ux.px(t.bottom+6),left:t.right,transform:"translateX(calc(-50% + 1px))"}},e);var be=i(954),Ce=i(21147),we=i(59833),Re=i(24348),Ie=i(8923),Pe=i(11456),Ae=i(74983);class Le{constructor(e){var t;this._params=e,this._subs=new n.w0,this._previewEq=Ce.f7(((e,t)=>e.id===t.id)),this._revertEq=Ce.f7(((e,t)=>e.revertId===t.revertId)),this.alertFilter=(t=this._params.alertProcessor,t.alerts.state.view((e=>Object.values(e).filter(Boolean).filter(Re.u.is))).pipe(s.U((e=>t=>{if(0===e.length||Pe.S.isTouchTypistAlert(t))return!0;const i=e.filter((e=>e.kind===Re.y.Preview)).flatMap((e=>e.highlightRanges));return!t.highlightRanges.some((e=>i.some((t=>Ae.SV.intersects(e,t)))))})))),[this._createTouchTypistStatePreviewsSubscription(),this._createTouchTypistStateRevertsSubscription()].forEach((e=>this._subs.add(e)))}_createTouchTypistStatePreviewsSubscription(){return this._params.touchTypistState.pipe(s.U((({context:e})=>e.current.previews)),_.x()).pipe(be.O([]),l.G(),o.h((([e,t])=>we.Od(e)||we.Od(t))),s.U((([e,t])=>({previewsToRemove:we.e5(this._previewEq)(t)(e),previewsToAdd:we.e5(this._previewEq)(e)(t)})))).subscribe((({previewsToRemove:e,previewsToAdd:t})=>{e.forEach((e=>this._params.alertProcessor.removeAlert(String(e.id),{_tag:Ie.i.alertUpdate}))),t.forEach((e=>this._params.alertProcessor.addAlert(Re.u.fromPreview()(e))))}))}_createTouchTypistStateRevertsSubscription(){return this._params.touchTypistState.pipe(s.U((({context:e})=>e.applied.reverts)),_.x()).pipe(be.O([]),l.G(),o.h((([e,t])=>we.Od(e)||we.Od(t))),s.U((([e,t])=>({revertsToRemove:we.e5(this._revertEq)(t)(e),revertsToUpdate:we.jV(this._revertEq)(e.filter((e=>e.isRecent)))(t.filter((e=>!e.isRecent))),revertsToAdd:we.e5(this._revertEq)(e)(t)})))).subscribe((({revertsToRemove:e,revertsToUpdate:t,revertsToAdd:i})=>{e.forEach((e=>this._params.alertProcessor.removeAlert(String(e.revertId),{_tag:Ie.i.alertUpdate}))),t.forEach((e=>{const t={id:String(e.revertId),kind:Re.y.Revert};this._params.alertProcessor.changeAlert(t)})),i.forEach((e=>this._params.alertProcessor.addAlert(Re.u.fromRevert()(e))))}))}_removeAllTouchTypistAlerts(){this._params.alertProcessor.removeAllAlertsBy(Re.u.is,{_tag:Ie.i.reset})}dispose(){this._subs.unsubscribe(),this._removeAllTouchTypistAlerts()}}var Ne=i(52303),Oe=i(86399),Me=i(92135),De=i(30033);var Fe=i(10712),He=i(29416);function Qe(e,t,i){return g.T(t.obs.pipe(c.h(null)),e).pipe(be.O(null),l.G(),a.M(i.state.pipe(s.U((e=>e.state)))),o.h((([[e,t],i])=>[e,t].every((e=>null!==e))&&i!==me.REPLACING)),s.U((([[,e]])=>e)))}var Be,Ue,Ge,qe=i(65384);!function(e){e.is=function(e){return 1===e.changes.length&&qe.q.isDel(e.changes[0])}}(Be||(Be={})),function(e){e.is=function(e){return 1===e.changes.length&&qe.q.isIns(e.changes[0])}}(Ue||(Ue={})),function(e){e.is=function(e){return[Ue.is,Be.is].some((t=>t(e)))}}(Ge||(Ge={}));var We=i(68485);var Ye=i(12518),ze=i(56193);const Ve=e=>{if(qe.q.isIns(e)){return e.pos+e.text.length}if(qe.q.isDel(e)){return e.pos}(0,he.L0)(e)};function Ke(e,t,i=!1){const n=ye.Y.create(`TouchTypist.${Ke.name}`),s=Ve(e.changes[0]),a=e.newText,o=(0,r.zG)(((e,t)=>{if(t<0||t>e.length)return Ye.left(new Error("Caret outside of the text boundaries."));let i=t,r=t;for(;i>0&&"\n"!==e.charAt(i-1);)i--;for(;r<e.length&&"\n"!==e.charAt(r);)r++;return Ye.right({start:i,end:r})})(a,s),Ye.fold((e=>(n.error("Failed to get paragraph range containing position.",e,{text:a,position:s}),t.error({message:"Failed to get paragraph range containing position.",error:e,data:{text:a,position:s}}),null)),r.yR));if(!o||o.start===o.end)return n.debug("Paragraph containing text change is empty."),p.YP;if(!(0,ze.Y)()){if(!(o.end===s||i))return n.debug(`Text change end is not at the end of its containing paragraph. Paragraph end: ${o.end}. Text change position: ${s}`),p.YP}return p.G(o)}function $e(e,t=!1){return i=>i.pipe(s.U((i=>Ke(i,e,t))))}class Xe{constructor(e){this._params=e,this._subs=new n.w0,this._activeParagraphRange=de.h.create(p.YP),this._logger=ye.Y.create("TouchTypistParagraphServiceImpl"),this.activeParagraphRange=this._activeParagraphRange.view();const t=(i=this._params.textChangesAsync,r=this._params.replacementListener,l=this._params.stateManager,Qe(i,r,l).pipe(ue.b((()=>{l.handleEvent({name:fe._.TEXT_CHANGED_BY_USER})})),o.h((e=>Ge.is(e))),He.b(1e3))).pipe($e(this._params.touchTypistTelemetryService));var i,r,l;const u=function(e,t){return e.pipe(a.M(t.state.pipe(s.U((e=>e.state)))),o.h((([,e])=>e===me.READY||e===me.REPLACING)),s.U((([e])=>e)))}(this._params.textChangesAsync,this._params.stateManager).pipe($e(this._params.touchTypistTelemetryService,!0)),h=function(e,t){return e.obs.pipe(a.M(t.state.pipe(s.U((e=>e.state)))),o.h((([e])=>e.source!==We.P.touchTypist)),ue.b((([,e])=>{e===me.READY&&t.handleEvent({name:fe._.TEXT_CHANGED_BY_NON_TOUCH_TYPIST_REPLACEMENT})})),c.h(p.YP))}(this._params.replacementListener,this._params.stateManager);this._subs.add(g.T(t,u,h).pipe(I.$f(p.Eh(Ae.SV.eq))).subscribe((e=>{this._activeParagraphRange.set(e)})))}getTextRangeLastLineClientRectangle(e){this._logger.debug("TouchTypistParagraphServiceImpl.getTextRangeLastLineClientRectangle invoked");const t=(0,r.zG)(e,p.UI((i=()=>this._params.textObserver.getCurrentTextMap(),n=this._params.geometryProvider,s=this._params.geometryLayout,e=>(0,r.zG)(p.ij(n.create(e,i(),!0)),p.tS((e=>p.ij(n.getClientRects(e,!0)))),p.tS(Me.nI),p.g_((()=>[]),Oe.UI((e=>De.UL.setPosition(s.getCurrentConversionContext().clientToRelative(e),e))))))),p.VS(we.Z$),p.WG);var i,n,s;if(!t)return this._params.touchTypistTelemetryService.info({message:"Failed to get the position of text range's last line.",data:{textRange:e}}),this._logger.debug("Failed to get the position of text range's last line.",{textRange:Ne.QP(e)}),p.YP;const a=(0,Fe.Z)(t,this._params.textFieldLayout.rect.getCurrent().client,this._params.textFieldLayout.scroll.getCurrent());return p.G({...a})}dispose(){this._subs.unsubscribe()}}var je=i(26326),Ze=i(63770),Je=i(45818),et=i(1124);class tt{constructor(e){this._params=e,this._logger=ye.Y.create("TouchTypistGDocsIntegration"),this._logger.info("TouchTypist integration for GDocs")}get eventsTargetElement(){const e=(0,et.CI)(document);return e||(this._params.telemetry.error({message:"Could not find the target element for text events in GDocs"}),this._logger.error("Could not find the target element for text events"),document.body)}getTextRangeLastLineClientRectangle(e){return this._params.paragraphService.getTextRangeLastLineClientRectangle(e)}}class it{constructor(e){this._params=e,this._logger=ye.Y.create("TouchTypistGenericIntegration"),this._logger.info("TouchTypist integration for non-GDocs")}get eventsTargetElement(){return document.body}getTextRangeLastLineClientRectangle(e){return this._params.paragraphService.getTextRangeLastLineClientRectangle(e)}}var rt=i(70568),nt=i(1747),st=i(84178),at=i(18595),ot=i(31789),ct=i(29919);class lt{constructor(e){this._params=e,this._logger=ye.Y.create("TouchTypistCapiServiceImpl"),this._correlationId=""}triggerTouchTypist(e){const t=this._params.getCheckingService();if(!t)return this._logger.error("Checking service is not available in TouchTypist"),Promise.reject(new Error("Checking service is not available in TouchTypist"));const i=(0,ct.M8)(),n={action:"trigger_touch_typist",mode:"GEC_PROGRESSIVE_RECHECK",features:[rt.zV.individualPreviewReverts],textScope:e,correlationId:i,id:1};return this._params.textChangeBuffer.flush(),(0,r.zG)(t.checkingRevisionInfo,He.b(100),st.q(1),at.L(1e3,ot._((()=>{throw this._logger.error(`TouchTypist request couldn't be sent because latest revision wasn't emitted, correlation id: ${i}`),this._params.touchTypistTelemetryService.error({message:"TouchTypist request couldn't be sent because latest revision wasn't emitted",data:{textScope:e,correlationId:i}}),new Error(`TouchTypist request couldn't be sent because latest revision wasn't emitted, correlation id: ${i}`)}))),ue.b((()=>{t.sendTouchTypistCommand(n),this._correlationId=i})),c.h(void 0)).toPromise()}onTouchTypistTriggerResponse(e){if(this._logger.debug("TouchTypist TriggerResponse received.",e),this._correlationId===e.correlationId){const t=this._params.textObserver.getTextSource().getPlainText();this._params.stateManager.handleEvent({name:fe._.CAPI_RESPONSE_RECEIVED,payload:{response:e,currentText:t}})}else this._params.touchTypistTelemetryService.warn({message:"The correlation id in the response does not match the correlation id in the request."}),this._logger.warn("The correlation id in the response does not match the correlation id in the request."),this._params.stateManager.handleEvent({name:fe._.CAPI_RESPONSE_WITH_UNEXPECTED_CORRELATION_ID_RECEIVED})}_sendCommand(e,t=!0){const i=this._params.getCheckingService();if(!i)throw this._logger.error("Checking service is not available in TouchTypist"),new Error("Checking service is not available in TouchTypist");return t?i.sendTouchTypistCommand(e):(0,r.Q1)()}sendTouchTypistPreviewAction(e,t,i){try{this._sendCommand({actionType:e,previewId:i,touchTypistId:t,action:"touch_typist_action",id:1})}catch(t){this._logger.error(`Failed to send touch typist preview action: ${e} for preview id: ${i} with error: ${t}`)}}sendTouchTypistRevertAction(e,t){try{this._sendCommand({touchTypistId:e,action:"touch_typist_action",id:1,actionType:nt.XN.Revert,revertId:t,location:"REVERT_CARD"})}catch(e){this._logger.error(`Failed to send touch typist revert action for revert id: ${t} with an error ${e}`)}}sendTouchTypistApplyAction(e){try{this._sendCommand({touchTypistId:e,action:"touch_typist_action",id:1,actionType:nt.XN.Apply,location:"HOTKEY",hotkey:"TAB"})}catch(t){this._logger.error(`Failed to send touch typist apply action for touch typist id: ${e} with an error ${t}`)}}sendTouchTypistRevertLookAction(e,t){try{this._sendCommand({action:"touch_typist_action",id:1,actionType:nt.XN.RevertLook,touchTypistId:e,revertId:t})}catch(e){this._logger.error(`Failed to send touch typist revert look action for revert id: ${t} with an error ${e}`)}}sendTouchTypistAppearAction(e){try{this._sendCommand({action:"touch_typist_action",id:1,actionType:nt.XN.Appeared,touchTypistId:e})}catch(t){this._logger.error(`Failed to send touch typist appear action for touch typist id: ${e} with an error ${t}`)}}sendTouchTypistSkipAction(e){try{this._sendCommand({touchTypistId:e,action:"touch_typist_action",id:1,actionType:nt.XN.Skipped})}catch(t){this._logger.error(`Failed to send touch typist skip action for touch typist id: ${e} with an error ${t}`)}}}var pt=i(19486);class ut{constructor(e){this._params=e,this._subs=new n.w0}listeningToHotkeyApply(){this._subs.add(this._params.touchTypistStateValue.pipe(v.w((e=>e===me.READY?(0,pt._w)(this._params.targetElement,this._params.isMac,this._params.hotkey):pe.E)),o.h((({shortcut:e})=>e===this._params.hotkey.get())),ue.b((({events:e})=>{e.forEach((e=>{e.preventDefault()}))}))).subscribe((()=>{this._params.applyChanges().then((()=>this._params.csActions.incrementTouchTypistUserAcceptedCount()))})))}dispose(){this._subs.unsubscribe()}}var ht=i(96837),dt=i(62552);class gt{constructor(e){this._params=e,this._subs=new n.w0,this._textChangesObs=new dt.X({changes:[],prevText:"",newText:"",deltaChange:ht.RI.delta(new ce.i)}),this.textChangesAsyncObs=this._textChangesObs.asObservable(),this._subs.add(this._params.textObserver.contentChanges.async.subscribe((e=>{0!==e.changes.length&&this._textChangesObs.next(e)})))}dispose(){this._subs.unsubscribe()}}class mt{constructor(e){this._params=e}async trackOpenQuickSettingsButtonClicked(){await this._params.gnarClient.touchTypistOpenQuickSettingsButtonClick()}async trackQuickSettingsShown(){await this._params.gnarClient.touchTypistQuickSettingsShow()}async trackQuickSettingsEditHotkeyButtonClicked(){await this._params.gnarClient.touchTypistQuickSettingsEditHotkeyButtonClick()}async trackQuickSettingsTurnOffButtonClicked(){await this._params.gnarClient.touchTypistQuickSettingsTurnOffButtonClick()}async trackQuickSettingsSnoozeButtonClicked(){await this._params.gnarClient.touchTypistQuickSettingsSnoozeButtonClick()}}var _t=i(94592),vt=i(8794),yt=i(98189),Tt=i(35947),ft=i(56412);const kt=(e,t,i,r)=>Ae.SV.translate(Ae.SV.rebase(Ae.SV.translate(e,-r.start),qe.k.fromDiff(t,i)),r.start);class St{constructor(e){this._params=e,this._logger=ye.Y.create("TouchTypistReplacementServiceImpl"),this._subs=new n.w0,this._replacementInfo=de.h.create(p.YP),this._selectionOrCaretPosition=de.h.create(null),this._subs.add(this._params.stateManager.state.pipe(s.U((e=>e.context.current.replacementInfo)),_.x()).subscribe(_t.wW(this._replacementInfo))),this._subs.add(this._params.selectionOrCaretPosition.pipe(o.h(p.pC),s.U(Ne.MH)).subscribe(_t.wW(this._selectionOrCaretPosition)))}canPerformReplacement(e,t){return this._params.replacementService.canPerformReplacement(e,t)}_getApplyType(e,t){return e?"hotkey":t?"individualRevert":"individualPreview"}performReplacement(e,t,i=!0,r=!1){const n=this._getApplyType(i,r),s=de.h.create(null),{pos:a,value:o}=e,c=this._selectionOrCaretPosition.get();if(this.canPerformReplacement({pos:a,oldValue:t,value:o})&&c)return this._params.stateManager.handleEvent({name:fe._.REPLACEMENT_STARTED}),this._logger.debug("Perform replacement",{range:a,newText:o,prevText:t,caretPosition:c}),u.Y3((async()=>{const r=kt(c,t,o,a),l=this._params.textChangesAsync.pipe(vt.T(1));this._subs.add(l.subscribe((e=>s.set(e))));const p=await this._params.replacementService.performReplacement(e,{preserveFormatting:!0,touchTypistApplyType:n});if(await s.pipe(yt.n((e=>null===e)),st.q(1),at.L(500,y.of(null))).toPromise()&&!i&&"gDocsCanvas"===this._params.integrationInfo.integrationName&&await this._params.selectionOrCaretPosition.pipe(He.b(200),st.q(1)).toPromise(),(0,ft.TW)(p)&&this._params.selectionService.setSelection({start:r.start,end:r.end}),this._params.stateManager.handleEvent({name:fe._.REPLACEMENT_FINISHED}),!s.get())throw this._params.touchTypistTelemetryService.error({message:"Text changes emission timed out",data:{replacement:e,prevText:t}}),new Error("Text changes emission timed out");return p}),(i=>(this._logger.error("Failed to perform a replacement",i),this._params.touchTypistTelemetryService.error({message:"Failed to perform a replacement",data:{replacement:e,prevText:t,error:String(i)}}),new Error(`Failed to perform a single replacement. ${String(i)}`))));throw this._params.touchTypistTelemetryService.error({message:"Can't perform replacement at this range",data:{replacement:e,prevText:t}}),new Error("Can't perform replacement at this range")}performBatchReplacements(e,t,i){const r=de.h.create(null),{pos:n,value:s}=t,a=this._selectionOrCaretPosition.get();if(this._logger.debug("Perform batch replacements",{newText:s,prevText:i,caretPosition:a}),this._params.stateManager.handleEvent({name:fe._.REPLACEMENT_STARTED}),a)return u.Y3((async()=>{const o=kt(a,i,s,n),c=this._params.textChangesAsync.pipe(vt.T(1));this._subs.add(c.subscribe((e=>r.set(e))));const l=await this._params.replacementService.performBatchReplacements(e,{preserveFormatting:!0,touchTypistApplyType:"hotkey"});if(await r.pipe(yt.n((e=>null===e)),st.q(1),at.L(500,y.of(null))).toPromise(),await this._params.selectionOrCaretPosition.pipe(He.b(200),st.q(1)).toPromise(),this._params.selectionService.setSelection({start:o.start,end:o.end}),this._params.stateManager.handleEvent({name:fe._.REPLACEMENT_FINISHED}),!r.get())throw this._params.touchTypistTelemetryService.error({message:"Text changes emission timed out",data:{replacements:e,singleReplacement:t,prevText:i}}),new Error("Text changes emission timed out");return l}),(r=>(this._logger.error("Failed to perform a batch replacement",r),this._params.touchTypistTelemetryService.error({message:"Failed to perform a batch replacement",data:{replacements:e,singleReplacement:t,prevText:i,error:String(r)}}),new Error(`Failed to perform a batch replacement. ${String(r)}`))));throw this._params.touchTypistTelemetryService.error({message:"Can't perform batch replacement. Selection is null"}),new Error("Can't perform batch replacement at this range. Selection is null")}async applyChanges(){this._logger.info("Apply TouchTypist suggestions");const e=(0,r.zG)(this._replacementInfo.get(),p.g_(r.gn,r.yR));if(e){const t=this._params.textObserver.getCurrentTextMap().getFormatHelper(),i=null==t?void 0:t.getInfo(e.replacementTextRange.start,e.replacementTextRange.end),r=i&&i.footnoteCount,n=i&&i.hyperlinksCount,s=i&&i.smartChipsCount,a=this._params.textObserver.getCurrentTextMap().getPlainText().slice(e.replacementTextRange.start,e.replacementTextRange.end);let o;if(r||n||s){const t=(0,Tt.g)(e.delta);o=await this.performBatchReplacements(t,{pos:e.replacementTextRange,value:e.replacementText},a)()}else o=await this.performReplacement({pos:e.replacementTextRange,value:e.replacementText},a,!0,!1)();o&&Ye.isRight(o)?this._params.stateManager.handleEvent({name:fe._.APPLYING_ALL_PREVIEWS_SUCCEEDED}):(this._params.touchTypistTelemetryService.info({message:"Failed to apply changes",data:{replacementInfo:e}}),this._params.stateManager.handleEvent({name:fe._.REPLACEMENT_FAILED}))}else this._params.touchTypistTelemetryService.info({message:"No replacement info to apply changes"}),this._params.stateManager.handleEvent({name:fe._.REPLACEMENT_FAILED})}dispose(){this._subs.unsubscribe()}}var Et=i(74822),xt=i(84308),bt=i(84908),Ct=i(83135);class wt{constructor(e){this._params=e,this._subs=new n.w0,this._hotkeyChangeManager=de.h.create(null),this._lastKnownSelectionOrCaretPosition=de.h.create(p.YP),this._restoreSelectionSubject=new Et.x,this._listenToHotkeyChangeSubscription=null,this.hotkey=this._params.csPageState.view((e=>{var t;return(null!==(t=e.touchTypistSettings)&&void 0!==t?t:je.Y).hotkey})),this.numberOfErrors=this._params.stateManager.state.view((e=>e.context.current.previews.length)),this.numberOfFixes=this._params.stateManager.state.view((e=>e.context.applied.reverts.filter((e=>e.isRecent)).length)),this.softOnboardingState=this._params.csPageState.view((e=>{var t;const i=null!==(t=e.touchTypistState)&&void 0!==t?t:je.c;return(0,ze.Y)()?R.getV2(i.userAcceptedCount,i.lastUserAcceptedAt):R.get(i.userAcceptedCount)})),this.displayedQuickFixKey=de.h.create(""),[this.createDisplayedQuickFixKeySubscription(),this.createLastKnownSelectionOrCaretPositionSubscription(),this.createRestoreSelectionSubscription()].forEach((e=>this._subs.add(e)))}initiateQuickFixKeyChange(){if(this.isQuickFixKeyChangeInitiated(this._hotkeyChangeManager.get()))return;const e=new Ct.c("",de.h.create(!0));this._hotkeyChangeManager.set(e),this._listenToHotkeyChangeSubscription=e.listenToHotkeyChange(this._params.isEnvMac),e.onIsActiveHotkeyChange()}confirmQuickFixKeyChange(){var e;const t=this._hotkeyChangeManager.get();if(!this.isQuickFixKeyChangeInitiated(t))return;t.tmpHotkey.get()?t.onApplyHotkeyChange(this._params.csActions):t.onDismissHotkeyChange(),null===(e=this._listenToHotkeyChangeSubscription)||void 0===e||e.unsubscribe(),this._listenToHotkeyChangeSubscription=null,this._hotkeyChangeManager.set(null)}restoreSelection(){this._restoreSelectionSubject.next(void 0)}turnOffQuickFix(){this._params.csActions.toggleTouchTypist(!1)}snoozeQuickFix(){this._params.csActions.snoozeTouchTypist()}trackOpenQuickSettingsButtonClicked(){this._params.gnarTrackingService.trackOpenQuickSettingsButtonClicked()}trackQuickSettingsShown(){this._params.gnarTrackingService.trackQuickSettingsShown()}trackQuickSettingsEditHotkeyButtonClicked(){this._params.gnarTrackingService.trackQuickSettingsEditHotkeyButtonClicked()}trackQuickSettingsTurnOffButtonClicked(){this._params.gnarTrackingService.trackQuickSettingsTurnOffButtonClicked()}trackQuickSettingsSnoozeButtonClicked(){this._params.gnarTrackingService.trackQuickSettingsSnoozeButtonClicked()}dispose(){this.confirmQuickFixKeyChange(),this._subs.unsubscribe()}createDisplayedQuickFixKeySubscription(){const e=this._hotkeyChangeManager.pipe(v.w((e=>{var t;return null!==(t=null==e?void 0:e.tmpHotkey)&&void 0!==t?t:y.of(null)})));return xt.a([this.hotkey,e]).subscribe((([e,t])=>{this.displayedQuickFixKey.set(null===t?e:t)}))}isQuickFixKeyChangeInitiated(e){return null!==e&&null!==this._listenToHotkeyChangeSubscription&&!this._listenToHotkeyChangeSubscription.closed}createLastKnownSelectionOrCaretPositionSubscription(){return this._params.selectionOrCaretPosition.subscribe(_t.wW(this._lastKnownSelectionOrCaretPosition))}createRestoreSelectionSubscription(){return this._restoreSelectionSubject.pipe(bt.p(250)).subscribe((()=>{const e=this._lastKnownSelectionOrCaretPosition.get();p.pC(e)&&this._params.selectionService.setSelection(e.value)}))}}class Rt{constructor(e){var t,i;this._params=e,this._subs=new n.w0,this._disposables=[],this._stateManager=new Ee({state:Se,touchTypistTelemetryService:this._params.touchTypistTelemetryService}),this._textChangesService=new gt({geometryLayout:this._params.geometryLayout,geometryProvider:this._params.geometryProvider,textFieldLayout:this._params.textFieldLayout,textObserver:this._params.textObserver,selectionOrCaretPosition:this._params.selectionOrCaretPosition}),this._paragraphService=new Xe({textChangesAsync:this._textChangesService.textChangesAsyncObs,selectionOrCaretPosition:this._params.selectionOrCaretPosition,replacementListener:this._params.replacementListener,stateManager:this._stateManager,geometryLayout:this._params.geometryLayout,geometryProvider:this._params.geometryProvider,textFieldLayout:this._params.textFieldLayout,textObserver:this._params.textObserver,touchTypistTelemetryService:this._params.touchTypistTelemetryService}),this._integration="gDocsCanvas"===this._params.integrationInfo.integrationName?new tt({paragraphService:this._paragraphService,telemetry:this._params.touchTypistTelemetryService}):new it({paragraphService:this._paragraphService,telemetry:this._params.touchTypistTelemetryService}),this._logger=ye.Y.create("TouchTypistFeatureImpl"),this._touchTypistCapiService=new lt({getCheckingService:this._params.getCheckingService,textChangeBuffer:this._params.textChangeBuffer,touchTypistTelemetryService:this._params.touchTypistTelemetryService,stateManager:this._stateManager,textObserver:this._params.textObserver}),this._replacementService=new St({replacementService:this._params.replacementService,textObserver:this._params.textObserver,textChangesAsync:this._textChangesService.textChangesAsyncObs,selectionService:this._params.selectionService,activeParagraphRange:this._paragraphService.activeParagraphRange,selectionOrCaretPosition:this._params.selectionOrCaretPosition,stateManager:this._stateManager,integrationInfo:this._params.integrationInfo,touchTypistTelemetryService:this._params.touchTypistTelemetryService}),this._touchTypistHotkey=this._params.csPageState.view((e=>{var t;const i=e.touchTypistSettings;return null!==(t=null==i?void 0:i.hotkey)&&void 0!==t?t:je.Y.hotkey})),this._touchTypistHotkeyManager=new ut({csActions:this._params.csActions,hotkey:this._touchTypistHotkey,touchTypistStateValue:this._stateManager.state.pipe(s.U((e=>e.state))),targetElement:this._integration.eventsTargetElement,applyChanges:async()=>{const e=this._stateManager.getTouchTypistId();await this._replacementService.applyChanges(),e&&this._touchTypistCapiService.sendTouchTypistApplyAction(e)},isMac:this._params.isMac}),this._touchTypistAlertService=new Le({alertProcessor:this._params.alertProcessor,touchTypistState:this._stateManager.state}),this._touchTypistGnarTrackingService=new mt({gnarClient:this._params.gnarClient}),this._hotkeyHintViewModel=new wt({csPageState:this._params.csPageState,csActions:this._params.csActions,stateManager:this._stateManager,isEnvMac:this._params.isMac,selectionService:this._params.selectionService,selectionOrCaretPosition:this._params.selectionOrCaretPosition,gnarTrackingService:this._touchTypistGnarTrackingService}),this.alertFilter=this._touchTypistAlertService.alertFilter,this._logger.info("Touch Typist feature is initialized",this._params.integrationInfo),this._disposables.push(this._paragraphService,this._replacementService,this._touchTypistAlertService),this._touchTypistHotkeyManager.listeningToHotkeyApply(),this._disposables.push(this._touchTypistHotkeyManager),this._subs.add(this._paragraphService.activeParagraphRange.pipe(a.M(this._stateManager.state)).pipe(s.U((([e,t])=>{const i=(0,r.zG)(e,p.g_(r.gn,r.yR));i&&t.state===me.IDLE&&(this._logger.info("Send touch typist trigger event",i),this._stateManager.handleEvent({name:fe._.SENDING_CAPI_REQUEST_STARTED}),u.Y3((async()=>await this._touchTypistCapiService.triggerTouchTypist({begin:i.start,end:i.end})),(()=>this._stateManager.handleEvent({name:fe._.SENDING_CAPI_REQUEST_FAILED})))())}))).subscribe()),this._subs.add(this._createUserAddedOrRemovedNewlinesSubscription()),this._subs.add(It(this._stateManager.state,(()=>this._stateManager.getTouchTypistId()),(e=>this._touchTypistCapiService.sendTouchTypistAppearAction(e)),(e=>this._touchTypistCapiService.sendTouchTypistSkipAction(e)))),this._subs.add((t=this._params.selectionOrCaretPosition,i=this._stateManager,t.pipe(a.M(i.state.pipe(s.U((e=>e.state)))),o.h((([,e])=>e!==me.REPLACING)),ue.b((([,e])=>{e===me.READY&&i.handleEvent({name:fe._.TEXT_SELECTION_OR_CARET_POSITION_CHANGED})})),c.h(p.YP))).subscribe())}dispose(){this._disposables.forEach((e=>e.dispose()))}get touchTypistUI(){return function(e,t,i,r,n){const a=g.T(t.scroll.changes,m.R(self,"scroll",{capture:!0})).pipe(c.h(void 0)),o=[me.LOADING,me.READY,me.REPLACING,me.SUCCESS];return r.pipe(s.U((e=>e.state)),_.x(),v.w((t=>{if(!o.includes(t))return y.of(p.YP);const r=e.activeParagraphRange.pipe(s.U((e=>i.getTextRangeLastLineClientRectangle(e))),s.U(p.WG),s.U((e=>{if(!e)return p.YP;if(t===me.LOADING)return p.G(h.createElement(xe,{caretPosition:e},h.createElement(ne,null)));if(t===me.READY||t===me.REPLACING){const t={caretPosition:e,label:n.hotkey,errorsCount:n.numberOfErrors,softOnboardingState:n.softOnboardingState.get(),quickFixKey:n.displayedQuickFixKey,onQuickSettingsMenuUnmount:()=>{n.confirmQuickFixKeyChange()},onQuickSettingsButtonClick:e=>{n.restoreSelection(),e||n.trackOpenQuickSettingsButtonClicked()},onQuickSettingsShown:()=>{n.trackQuickSettingsShown()},onChangeQuickFixKeyTextboxFocus:()=>{n.initiateQuickFixKeyChange(),n.trackQuickSettingsEditHotkeyButtonClicked()},onChangeQuickFixKeyTextboxBlur:()=>{n.confirmQuickFixKeyChange(),n.restoreSelection()},onTurnOffQuickFixClick:()=>{n.turnOffQuickFix(),n.trackQuickSettingsTurnOffButtonClicked()},onSnoozeQuickFixClick:()=>{n.snoozeQuickFix(),n.trackQuickSettingsSnoozeButtonClicked()}};return W()?p.G(h.createElement($,{...t})):p.G(h.createElement(ie,{...t}))}return t===me.SUCCESS?n.softOnboardingState.get()!==R.Off&&W()?p.G(h.createElement(X,{caretPosition:e,softOnboardingState:n.softOnboardingState.get(),numberOfFixes:n.numberOfFixes})):p.G(h.createElement(xe,{caretPosition:e},h.createElement(Z,null))):p.YP})));return g.T(a.pipe(T.c(r)),r)})))}(this._paragraphService,this._params.textFieldLayout,this._integration,this._stateManager.state,this._hotkeyHintViewModel)}onTouchTypistTriggerResponse(e){this._touchTypistCapiService.onTouchTypistTriggerResponse(e)}createPreviewInlineCardModel(e){return new Ze.p(e,this._replacementService,this._stateManager,this._touchTypistCapiService,this._params.alertProcessor,this._params.touchTypistTelemetryService)}createRevertInlineCardModel(e){return new Je.I(e,this._replacementService,this._stateManager,this._touchTypistCapiService)}_createUserAddedOrRemovedNewlinesSubscription(){return Qe(this._textChangesService.textChangesAsyncObs,this._params.replacementListener,this._stateManager).pipe(o.h((e=>e.changes.some((e=>e.text.includes("\n"))))),c.h(void 0)).subscribe((()=>{this._stateManager.handleEvent({name:fe._.NEWLINES_ADDED_OR_REMOVED_BY_USER})}))}}function It(e,t,i,r){let n=null;return e.pipe(l.G()).subscribe((([e,s])=>{const a=t();(a||n)&&(a&&e.state===me.LOADING&&s.state===me.READY&&(n=a,i(a)),n&&e.state===me.READY&&s.state===me.IDLE&&r(n))}))}},83135:(e,t,i)=>{i.d(t,{c:()=>p});var r=i(84308),n=i(59179),s=i(20161),a=i(36344),o=i(63532),c=i(13391),l=i(19486);class p{constructor(e,t){this._lastSubmittedShortcutValue=e,this._isInputFocused=t,this._isActiveHotkeyChange=c.h.create(!1),this.onApplyHotkeyChange=e=>{e.setTouchTypistHotkey({hotkey:this._tmpHotkey.get()}),this._isActiveHotkeyChange.set(!1)},this.onDismissHotkeyChange=()=>{this._tmpHotkey.set(this._lastSubmittedShortcutValue),this._isActiveHotkeyChange.set(!1)},this.onIsActiveHotkeyChange=()=>{this._isActiveHotkeyChange.set(!0)},this._tmpHotkey=c.h.create(this._lastSubmittedShortcutValue)}listenToHotkeyChange(e){return r.a([this._isActiveHotkeyChange,this._isInputFocused]).pipe(n.U((([e,t])=>e&&t)),s.w((t=>t?(0,l.A8)(self,e):a.E)),o.b((({shortcut:e})=>{this._tmpHotkey.set(e)}))).subscribe()}get isActiveHotkeyChange(){return this._isActiveHotkeyChange}get tmpHotkey(){return this._tmpHotkey}}},19486:(e,t,i)=>{i.d(t,{A8:()=>y,_w:()=>T});var r=i(44071),n=i(13712),s=i(29416),a=i(63532),o=i(97092),c=i(59179),l=i(90572),p=i(44045),u=i(13391);function h(e){const t=new Set;return e.filter((e=>{const i=e.code.toLowerCase();return!t.has(i)&&(t.add(i),!0)}))}function d(e,t){return"ControlLeft"===e.code||"ControlRight"===e.code?t?"⌃":"Ctrl":"ShiftLeft"===e.code||"ShiftRight"===e.code?"⇧":"AltLeft"===e.code||"AltRight"===e.code?t?"⌥":"Alt":"MetaLeft"===e.code||"MetaRight"===e.code?t?"⌘":"Win":"ArrowUp"===e.code?"↑":"ArrowDown"===e.code?"↓":"ArrowLeft"===e.code?"←":"ArrowRight"===e.code?"→":"Home"===e.code?"Home":"End"===e.code?"End":"PageUp"===e.code?"PageUp":"PageDown"===e.code?"PageDown":"Backspace"===e.code?"Backspace":"Delete"===e.code?"Delete":"Enter"===e.code?"Enter":"Tab"===e.code?"Tab":"Space"===e.code?"Space":e.code.startsWith("F")&&!isNaN(parseInt(e.code.substring(1),10))?e.code:"Escape"===e.code?"ESC":"CapsLock"===e.code?"CapsLock":"NumLock"===e.code?"NumLock":"ScrollLock"===e.code?"ScrollLock":"PrintScreen"===e.code?"PrintScreen":"Pause"===e.code?"Pause":"MediaPlayPause"===e.code?"MediaPlayPause":"VolumeUp"===e.code?"VolumeUp":"VolumeDown"===e.code?"VolumeDown":"AudioVolumeMute"===e.code?"Mute":e.code.startsWith("Digit")?e.code.slice(5):e.code.startsWith("Numpad")?e.code.slice(6):"Equal"===e.code?e.shiftKey?"plus":"=":"Minus"===e.code?"-":"NumpadAdd"===e.code?"plus":"NumpadSubtract"===e.code?"-":"NumpadEqual"===e.code?"=":null}function g(e){return function(t){return{shortcut:t.map((t=>{const i=d(t,e);return i||(t.code.toLowerCase().startsWith("key")?t.code.slice(3):t.code)})).join("")}}}function m(e,t,i){return r=>{const n=t.get(),s=function(e,t,i){return["Tab","Enter","Backspace","ArrowUp","ArrowDown","ArrowRight","ArrowLeft"].some((r=>e===r&&t===d({code:e},i)))}(r.code,n,i);s&&(r.preventDefault(),r.stopImmediatePropagation()),e.set([...e.get(),r])}}function _(e){e.preventDefault(),e.stopImmediatePropagation()}function v(e){return e.sort(((e,t)=>t.code.length-e.code.length))}function y(e,t){const i=r.R(e,"keydown",{capture:!0}).pipe(n.g("code")),p=r.R(e,"keyup",{capture:!0}).pipe(s.b(50));return i.pipe(a.b(_),o.f(p),c.U(h),l.h((e=>e.length>0)),c.U(v),c.U(g(t)))}function T(e,t,i){const o=r.R(e,"keydown",{capture:!0}).pipe(n.g("code")),d=r.R(e,"keyup",{capture:!0}).pipe(s.b(50)),_=u.h.create([]);return o.pipe(a.b(m(_,i,t)),p.R(d),c.U((()=>_.get())),c.U(h),l.h((e=>e.length>0)),c.U(v),c.U((e=>{const{shortcut:i}=g(t)(e);return{shortcut:i,events:e}})))}},56412:(e,t,i)=>{function r(e){return Boolean(e&&"function"==typeof(null==e?void 0:e[Symbol.iterator]))}function*n(e,t){for(const i of e)t(i)&&(yield i)}function*s(e,t){let i=0;for(const r of e)for(const e of t(r,i++))yield e}function a(e,t,i){let r=0;for(const i of e)if(t(i,r++))return i;return i}function o(e){for(const t of e)return t}function c(e,t){const i=e[Symbol.iterator]();let r=0;const n=t[Symbol.iterator]();let s=0,a=i.next(void 0),o=n.next(void 0);return[function*(){for(;!a.done||!o.done;)yield[a.done?null:a.value,o.done?null:o.value,r,s]}(),function(){a=i.next(void 0),r++},function(){o=n.next(void 0),s++}]}function*l(e){let t=e.length;for(;t--;)yield e[t]}i.d(t,{Em:()=>l,TW:()=>r,VS:()=>s,Xh:()=>o,fV:()=>c,hX:()=>n,sE:()=>a})},95660:e=>{e.exports={hotkeyHintWrapper:"iZ6ee",hotkeyHintTagWrapper:"IyPpR",expandedHotkeyHint:"X6JaN",leftAligned:"UuEaR",grammarlyLogo:"Z5RhC",expandedHotkeyHintText:"kckmf",hotkeyHintTagPlaceholder:"SMZN2",quickSettingsButton:"TkNlC",keyIcon:"VZ8FW",quickSettingsMenuWrapper:"zt9FP",quickSettingsMenuButton:"DSGTg",quickSettingsMenu:"B1fVo",quickSettingsMenuChangeQuickFixKeySection:"i0o98",quickSettingsMenuRow:"uqW10",quickSettingsMenuActionButton:"DsLIc"}},42743:e=>{e.exports={hotkeyHintTagContainer:"N3QjQ",hotkeyHintTagLabel:"t_VtO"}},82675:e=>{e.exports={dotsContainer:"mNIVY",dot:"KcZm9","dot-blink":"LxClj"}},44247:e=>{e.exports={prominentHotkeyWrapperRed:"M2gXg",prominentHotkeyWrapperGreen:"ztrXA",fadeIn:"woBOX",logoWrapper:"KLsi1",prominentHotkeyLeft:"ZsSap",prominentHotkeyRight:"uMznZ",expandedContent:"Uu48u",contentWrapper:"qW9CK",logoIcon:"FWOhe",minimizedContent:"pUU_s",hintText:"vXkkH",hintTextWrapper:"Im_QT",hintTagWrapper:"LtzvA",hintTagExpanded:"SalDJ",hintTagMinimized:"YUP33",quickSettings:"qrNJw",quickSettingsButton:"qc1j4"}},23729:e=>{e.exports={bubbleContainer:"C29Ys",bubble:"Z2bAs","bubble-scale":"L_Apf",checkmark:"cRf3w","draw-checkmark":"xcjpV"}},22389:(e,t,i)=>{i.d(t,{h:()=>l});var r=i(49231),n=i(38907),s=i(90220),a=i(75689),o=i(35672),c=i(26278);const l=r.forwardRef((function(e,t){var i,l;const{buttonProps:p,isPressed:u,ref:h,inProgress:d}=(0,n.zT)(e,t),{isFocusVisible:g,focusProps:m}=(0,a.Fx)();return r.createElement(o.u,{...e.tooltipProps,annotation:e.shortcut},r.createElement(o.aJ,{asChild:!0},r.createElement("button",{className:(0,s.W)((0,n.gj)(e,u,d,g,!0),`gds-icon-button-${e.size||"medium"}`),ref:h,...p,...m,"aria-hidden":e["aria-hidden"],tabIndex:e.tabIndex?e.tabIndex:0},r.createElement(c.J,{icon:e.icon,accessibilityLabel:"",variant:"inherit",size:{small:"small",medium:"medium",large:"large",xlarge:"large"}[e.size||"medium"]}))),r.createElement(o._v,{root:null==(i=e.tooltipContentProps)?void 0:i.root},(null==(l=e.tooltipContentProps)?void 0:l.children)||e.accessibilityLabel))}))},17142:(e,t,i)=>{i.d(t,{D:()=>n});var r=i(49231);const n=(0,i(36949).I)("color",(({title:e,titleId:t,desc:i,descId:n,...s})=>r.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",viewBox:"0 0 16 16","aria-hidden":"true","data-icon":"InterfaceMoreVertical",stroke:"transparent","aria-labelledby":t,"aria-describedby":n,...s},i?r.createElement("desc",{id:n},i):null,e?r.createElement("title",{id:t},e):null,r.createElement("path",{fill:"#646B81",d:"M9.2 8a1.2 1.2 0 1 1-2.4 0 1.2 1.2 0 0 1 2.4 0M9.2 12.8a1.2 1.2 0 1 1-2.4 0 1.2 1.2 0 0 1 2.4 0M9.2 3.2a1.2 1.2 0 1 1-2.4 0 1.2 1.2 0 0 1 2.4 0"}))))},99529:(e,t,i)=>{i.d(t,{a:()=>n});var r=i(49231);const n=(0,i(36949).I)("color",(({title:e,titleId:t,desc:i,descId:n,...s})=>r.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",viewBox:"0 0 16 16","aria-hidden":"true","data-icon":"InterfaceSettings",stroke:"transparent","aria-labelledby":t,"aria-describedby":n,...s},i?r.createElement("desc",{id:n},i):null,e?r.createElement("title",{id:t},e):null,r.createElement("path",{stroke:"#646B81",strokeLinejoin:"round",d:"m11.714 3.143-.028.029C10.642 4.215 8.857 3.476 8.857 2H7.143c0 1.476-1.785 2.215-2.829 1.172l-.028-.03-1.143 1.144.029.028C4.215 5.358 3.476 7.143 2 7.143v1.714c1.476 0 2.215 1.785 1.172 2.829l-.03.028 1.144 1.143.028-.029c1.044-1.043 2.829-.304 2.829 1.172h1.714c0-1.476 1.785-2.215 2.829-1.172l.028.03 1.143-1.144-.029-.028c-1.043-1.044-.304-2.829 1.172-2.829V7.143c-1.476 0-2.215-1.785-1.172-2.829l.03-.028z"}),r.createElement("path",{stroke:"#646B81",strokeLinejoin:"round",d:"M10 8a2 2 0 1 1-4 0 2 2 0 0 1 4 0Z"}))))},92524:(e,t,i)=>{i.d(t,{p:()=>n});var r=i(49231);const n=(0,i(36949).I)("nocolor",(({title:e,titleId:t,desc:i,descId:n,...s})=>r.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:32,height:32,fill:"none",viewBox:"0 0 32 32","aria-hidden":"true","data-icon":"LogoLogomarkMonochromeDefault",stroke:"transparent","aria-labelledby":t,"aria-describedby":n,...s},i?r.createElement("desc",{id:n},i):null,e?r.createElement("title",{id:t},e):null,r.createElement("path",{fill:"var(--color-background-base-inverse)",d:"M0 16C0 7.163 7.162 0 16.001 0s16 7.163 16 16c0 7.732-5.482 14.183-12.773 15.676-1.042.213-2.121.324-3.222.324H0z"}),r.createElement("path",{fill:"var(--color-background-base-default)",d:"m19.876 14.484-1.788 2.94h6.02c-.93 5.116-6.62 8.599-12.304 5.653a6.7 6.7 0 0 1-2.861-2.834c-3.27-6.226 1.197-12.49 7.093-12.49a8.19 8.19 0 0 1 6.2 2.839l1.58-2.6a11.08 11.08 0 0 0-8.566-3.148c-5.562.384-10.071 4.994-10.342 10.56-.309 6.393 4.8 11.688 11.124 11.688s11.14-4.999 11.14-11.14c0-.5-.038-.989-.1-1.468z"}))))}}]);